//============================================================================
//
//■演出処理 new
//
//============================================================================

//-------------------------------------------------------------------------
//
//■演出タスク
//
//-------------------------------------------------------------------------
#=es.EF.TASK
{
	@WSX.BIG=@es.GSX+400
	@WSY.BIG=@es.GSY+400

	$PATH(0)=$T(38,06) //cg
	$PATH(1)=$T(38,01) //bg
	$PATH(2)=$T(38,02) //ev
	$PATH(3)=$T(38,06) //cg
	$PATH(4)=$T(38,04) //tr
	$PATH(5)=$T(38,03) //st
	$PATH(6)=$T(38,05) //mv
	$PATH(7)=$T(38,31) //cgsys

	$CGSYS2.PATH=$T(38,32)

	//同じＺ座標だった際の、キャラ毎の表示優先順位 (数字大きいほうが前面に表示される)
	//
	@CHRLZ(0)=0
	@CHRLZ(1)=1
	@CHRLZ(2)=2
	@CHRLZ(3)=3
	@CHRLZ(4)=4
	@CHRLZ(5)=5
	@CHRLZ(6)=6
	@CHRLZ(7)=7
	@CHRLZ(8)=8

	LOOP[SET=18] @es.BL(@_LC)=@_LC LOOPEND[]


//	CG[ID="SP/"     Z=1 A=256 E=1 SX=@es.GSX SY=@es.GSY]
	CG[ID="SPLDST"  Z=2 A=256 E=0 SX=@es.GSX SY=@es.GSY MODE=0 FILE=""]
	CG[ID="SPLDST2" Z=3 A=000 E=0 SX=@es.GSX SY=@es.GSY MODE=2 FILE=""]
	CGACT[ID="SPLDST"  RECTPAINT=1 SET=0x000000]
	CGACT[ID="SPLDST2" RECTPAINT=1 SET=0xffffff]


IF[@_DEBUGMODE>=@dbg.val]

	CG[ID=CP01 Z=900001*@es.ZEX E=0 A=128 X=9999 Y=9999 FILE=$CGSYS2.PATH+"tip_focus_cm1"]
	CG[ID=CP02 Z=900002*@es.ZEX E=0 A=128 X=9999 Y=9999 FILE=$CGSYS2.PATH+"tip_focus_cm2"]

	CG[ID=CPBUF0 Z=1 E=0 FILE=$CGSYS2.PATH+"tip_bg"] //BGEV板チップ用バッファ
	CG[ID=CPBUF1 Z=1 E=0 FILE=$CGSYS2.PATH+"tip_tp"] //通常チップ用バッファ
	CG[ID=CPBUF2 Z=1 E=0 FILE=$CGSYS2.PATH+"tip_st"] //立ち絵チップ用バッファ
	CG[ID=CPBUF3 Z=1 E=0 FILE=$CGSYS2.PATH+"tip_focus_bg"] //背景中心点用[×]バッファ
	CG[ID=CPBUF4 Z=1 E=0 FILE=$CGSYS2.PATH+"tip_focus_st"] //立ち絵中心点用[田]バッファ

	CG[ID=GR01X Z=190000*@es.ZEX E=0 A=256 X=0 Y=(@es.GSY*1/4)-1 FILE=$CGSYS2.PATH+"tip_gridline_x"]
	CG[ID=GR02X Z=190000*@es.ZEX E=0 A=256 X=0 Y=(@es.GSY*2/4)-1 FILE=$CGSYS2.PATH+"tip_gridline_x"]
	CG[ID=GR03X Z=190000*@es.ZEX E=0 A=256 X=0 Y=(@es.GSY*3/4)-1 FILE=$CGSYS2.PATH+"tip_gridline_x"]
	CG[ID=GR01Y Z=190000*@es.ZEX E=0 A=256 X=(@es.GSX*1/4)-1 Y=0 FILE=$CGSYS2.PATH+"tip_gridline_y"]
	CG[ID=GR02Y Z=190000*@es.ZEX E=0 A=256 X=(@es.GSX*2/4)-1 Y=0 FILE=$CGSYS2.PATH+"tip_gridline_y"]
	CG[ID=GR03Y Z=190000*@es.ZEX E=0 A=256 X=(@es.GSX*3/4)-1 Y=0 FILE=$CGSYS2.PATH+"tip_gridline_y"]
	CGACT[ID=GR01X SIZE=1 SX=@es.GSX SY=3]
	CGACT[ID=GR02X SIZE=1 SX=@es.GSX SY=3]
	CGACT[ID=GR03X SIZE=1 SX=@es.GSX SY=3]
	CGACT[ID=GR01Y SIZE=1 SX=3 SY=@es.GSY]
	CGACT[ID=GR02Y SIZE=1 SX=3 SY=@es.GSY]
	CGACT[ID=GR03Y SIZE=1 SX=3 SY=@es.GSY]

	//SpriteView用レイヤセット
	INT[@DSX=@es.SMV.SX]
	INT[@DSY=@es.SMV.SY]
	CG[ID=:/W2/ SX=@DSX SY=@DSY Z=1]
	CG[ID=:W2/BASE Z=1 X=0 Y=0 FILE=$CGSYS2.PATH+"map_back"]

//	LOOP[SET= 9] CG[ID=":W2/CM0"+$(@_LC  )+"0" Z=900000000000001 E=0 FILE=$CGSYS2.PATH+"tip_camera_0"+$(@_LC  )+"0"] LOOPEND[]
//	LOOP[SET=10] CG[ID=":W2/CM1"+$(@_LC-1)+"0" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_1"+$(@_LC-1)+"0"] LOOPEND[]
//	LOOP[SET=10] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera"] LOOPEND[]
	  IF[@es.GSX== 640] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_640"]
	ELSE[@es.GSX== 800] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_800"]
	ELSE[@es.GSX== 960] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_960"]
	ELSE[@es.GSX==1024] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_1024"]
	ELSE[@es.GSX==1280] CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera_1280"]
	ELSE[]				CG[ID=":W2/CM100" Z=900000000000002 E=0 FILE=$CGSYS2.PATH+"tip_camera"]
	IFEND[]
/*
	LOOP[SET=@SPLN.PXMAX-1]
		CG[ID="SPLN"+$(@_LC+1) Z=900003*@es.ZEX E=0 FILE=$CGSYS2.PATH+"tip_focus_cm1"]
	LOOPEND[]
*/
	//LISTTAB
	CG[ID=":W2/TAB01.OF" Z=900000000000010 E=1 X=001 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_layer_off"]
	CG[ID=":W2/TAB01.OV" Z=900000000000010 E=0 X=001 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_layer_over"]
	CG[ID=":W2/TAB02.OF" Z=900000000000010 E=1 X=062 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_direction_off"]
	CG[ID=":W2/TAB02.OV" Z=900000000000010 E=0 X=062 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_direction_over"]
	CG[ID=":W2/TAB03.OF" Z=900000000000010 E=1 X=123 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_sound_off"]
	CG[ID=":W2/TAB03.OV" Z=900000000000010 E=0 X=123 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_sound_over"]

	CG[ID=":W2/TAB00"    Z=900000000000010 E=1 X=184 Y=@es.SMV.LY-34 FILE=$CGSYS2.PATH+"tip_tab_other"]


	//List[SP]
	CG[ID=":W2/TX01" Z=900000000000003 E=1 X=000 Y=@es.SMV.LY-16 SX=@es.SMV.SX SY=180 FILE=""]CGACT[ID=":W2/TX01" RECTPAINT3=1 SET=0x00000000]
	//List[QUE]
	CG[ID=":W2/TX02" Z=900000000000003 E=1 X=000 Y=@es.SMV.LY-16 SX=@es.SMV.SX SY=180 FILE=""]CGACT[ID=":W2/TX02" RECTPAINT3=1 SET=0x00000000]
	//List[SOUND]
	CG[ID=":W2/TX03" Z=900000000000003 E=1 X=000 Y=@es.SMV.LY-16 SX=@es.SMV.SX SY=180 FILE=""]CGACT[ID=":W2/TX03" RECTPAINT3=1 SET=0x00000000]


	CG[ID=":W2/LISTCUR" Z=900000000000005 E=1 X=001 Y=@es.SMV.LY-16 SX=@es.SMV.SX-2 SY=@DBG.FSY+1 MODE=0 FILE=""]
	CGACT[ID=":W2/LISTCUR" RECTPAINT3=1 SET=0x66bbbbff]
//	CGACT[ID=":W2/LISTCUR" RECTPAINT3=1 SET=0xffffffff]

IFEND[]

	$L.SPID(@LNO_BG )="BG"
	$L.SPID(@LNO_BGF)="BGF"
	$L.SPID(@LNO_CM )="LNO_CM"
	$L.SPID(@LNO_CMF)="LNO_CMF"
	$L.SPID(@LNO_FD )="LNO_FD"

	GOSUB[#=es.SP.QUE.INIT.ALL]


	$comstr(@e_CG	)="CG"
	$comstr(@e_TR	)="TR"
	$comstr(@e_MV	)="MV"
	$comstr(@e_ECG	)="ECG"
	$comstr(@e_TXG	)="TXG"
	$comstr(@e_TXL	)="TXL"
	$comstr(@e_TXS	)="TXS"
	$comstr(@e_ANLP	)="ANLP"
	$comstr(@e_MP	)="MP"
	$comstr(@e_BL	)="BL"
	$comstr(@e_HOR	)="HOR"
	$comstr(@e_VER	)="VER"
	$comstr(@e_REV	)="REV"
	$comstr(@e_MONO	)="MONO"
	$comstr(@e_BLUR	)="BLUR"
	$comstr(@e_MOSA	)="MOSA"
	$comstr(@e_DIFF	)="DIFF"
	$comstr(@e_ROT	)="ROT"
	$comstr(@e_RAS	)="RAS"
	$comstr(@e_WPL	)="WPL"
	$comstr(@e_AKA	)="AKA"
	$comstr(@e_SK	)="SK"
	$comstr(@e_SD	)="SD"
	$comstr(@e_MD	)="MD"
	$comstr(@e_A	)="A"
	$comstr(@e_F1	)="F1"
	$comstr(@e_F2	)="F2"
	$comstr(@e_MX	)="MX"
	$comstr(@e_MY	)="MY"
	$comstr(@e_MZ	)="MZ"
	$comstr(@e_QX	)="QX"
	$comstr(@e_QY	)="QY"
	$comstr(@e_QZ	)="QZ"
	$comstr(@e_RX	)="RX"
	$comstr(@e_RY	)="RY"
	$comstr(@e_RZ	)="RZ"
	$comstr(@e_BX	)="BX"
	$comstr(@e_BY	)="BY"
	$comstr(@e_H	)="H"
	$comstr(@e_TP	)="TP"
	$comstr(@e_V	)="V"
	$comstr(@e_W	)="W"
	$comstr(@e_X	)="X"
	$comstr(@e_Y	)="Y"
	$comstr(@e_Z	)="Z"
	$comstr(@e_PXY	)="PXY"
	$comstr(@e_PXYZ	)="PXYZ"
	$comstr(@e_CLBX	)="CLBX"
	$comstr(@e_CLBY	)="CLBY"
	$comstr(@e_CLA	)="CLA"
	$comstr(@e_CLH	)="CLH"
	$comstr(@e_CLTP	)="CLTP"
	$comstr(@e_CLV	)="CLV"
	$comstr(@e_CLW	)="CLW"
	$comstr(@e_CLX	)="CLX"
	$comstr(@e_CLY	)="CLY"
	$comstr(@e_CLZ	)="CLZ"
	$comstr(@e_CLRX	)="CLRX"
	$comstr(@e_CLRY	)="CLRY"
	$comstr(@e_CLRZ	)="CLRZ"
	$comstr(@e_FIN	)="FIN"
	$comstr(@e_NOP	)="NOP"
	$comstr(@e_END	)="END"
	$comstr(@e_EM_VO)="EM_VO"
	$comstr(@e_EM_VAR)="EM_VAR"
	$comstr(@e_EM_TLP)="EM_TLP"
	$comstr(@e_EM_TLS)="EM_TLS"
	$comstr(@e_EM_TLPA)="EM_TLPA"
	$comstr(@e_EM_TLSA)="EM_TLSA"

	$stcstr(0)=""
	$stcstr(1)="SP.GO"
	$stcstr(2)="SP.GO"
	$stcstr(3)="待機中"
	$stcstr(4)="★演出中★"
	$stcstr(999)="演出終了"

	//デバッグキー登録.
	//
	\_strtocode($T(37,81))(@SMV.KEY.YM(1))			//上(Y-)
	\_strtocode($T(37,82))(@SMV.KEY.YP(1))			//下(Y+)
	\_strtocode($T(37,83))(@SMV.KEY.XM(1))			//左(X-)
	\_strtocode($T(37,84))(@SMV.KEY.XP(1))			//右(X+)
	\_strtocode($T(37,85))(@SMV.KEY.ZM(1))			//前(Z-)
	\_strtocode($T(37,86))(@SMV.KEY.ZP(1))			//後(Z+)
	\_strtocode($T(37,87))(@SMV.KEY.SPLOW(1))		//低速
	\_strtocode($T(37,88))(@SMV.KEY.SPHIGH(1))		//倍速
	\_strtocode($T(37,89))(@SMV.KEY.INIT(1))		//初期位置
	\_strtocode($T(37,90))(@SMV.KEY.GUIDE(1))		//ガイド表示
	\_strtocode($T(37,91))(@SMV.KEY.XYZCOPY(1))		//座標コピー
	\_strtocode($T(37,92))(@SMV.KEY.LISTCHANGE(1))	//リスト表示切替
	\_strtocode($T(37,93))(@SMV.KEY.LISTPREV(1))	//リスト選択[↑]
	\_strtocode($T(37,94))(@SMV.KEY.LISTNEXT(1))	//リスト選択[↓]
	\_strtocode($T(37,95))(@SMV.KEY.UNDO(1))		//アンドゥ
	IF[$T(37,81)==""] @SMV.KEY.YM(1)			=255 IFEND[]
	IF[$T(37,82)==""] @SMV.KEY.YP(1)			=255 IFEND[]
	IF[$T(37,83)==""] @SMV.KEY.XM(1)			=255 IFEND[]
	IF[$T(37,84)==""] @SMV.KEY.XP(1)			=255 IFEND[]
	IF[$T(37,85)==""] @SMV.KEY.ZM(1)			=255 IFEND[]
	IF[$T(37,86)==""] @SMV.KEY.ZP(1)			=255 IFEND[]
	IF[$T(37,87)==""] @SMV.KEY.SPLOW(1)			=255 IFEND[]
	IF[$T(37,88)==""] @SMV.KEY.SPHIGH(1)		=255 IFEND[]
	IF[$T(37,89)==""] @SMV.KEY.INIT(1)			=255 IFEND[]
	IF[$T(37,90)==""] @SMV.KEY.GUIDE(1)			=255 IFEND[]
	IF[$T(37,91)==""] @SMV.KEY.XYZCOPY(1)		=255 IFEND[]
	IF[$T(37,92)==""] @SMV.KEY.LISTCHANGE(1)	=255 IFEND[]
	IF[$T(37,93)==""] @SMV.KEY.LISTPREV(1)		=255 IFEND[]
	IF[$T(37,94)==""] @SMV.KEY.LISTNEXT(1)		=255 IFEND[]
	IF[$T(37,95)==""] @SMV.KEY.UNDO(1)			=255 IFEND[]

/*
IF[0]
	\_strtocode($T(37,101))(@SMV.KEY.YM(2))			//上(Y-)
	\_strtocode($T(37,102))(@SMV.KEY.YP(2))			//下(Y+)
	\_strtocode($T(37,103))(@SMV.KEY.XM(2))			//左(X-)
	\_strtocode($T(37,104))(@SMV.KEY.XP(2))			//右(X+)
	\_strtocode($T(37,105))(@SMV.KEY.ZM(2))			//前(Z-)
	\_strtocode($T(37,106))(@SMV.KEY.ZP(2))			//後(Z+)
	\_strtocode($T(37,107))(@SMV.KEY.SPLOW(2))		//低速
	\_strtocode($T(37,108))(@SMV.KEY.SPHIGH(2))		//倍速
	\_strtocode($T(37,109))(@SMV.KEY.INIT(2))		//初期位置
	\_strtocode($T(37,110))(@SMV.KEY.GUIDE(2))		//ガイド表示
	\_strtocode($T(37,111))(@SMV.KEY.XYZCOPY(2))	//座標コピー
	\_strtocode($T(37,112))(@SMV.KEY.LISTCHANGE(2))	//リスト表示切替
	\_strtocode($T(37,113))(@SMV.KEY.LISTPREV(2))	//リスト選択[↑]
	\_strtocode($T(37,114))(@SMV.KEY.LISTNEXT(2))	//リスト選択[↓]
	\_strtocode($T(37,115))(@SMV.KEY.UNDO(2))		//アンドゥ
	IF[$T(37,101)==""] @SMV.KEY.YM(2)			=255 IFEND[]
	IF[$T(37,102)==""] @SMV.KEY.YP(2)			=255 IFEND[]
	IF[$T(37,103)==""] @SMV.KEY.XM(2)			=255 IFEND[]
	IF[$T(37,104)==""] @SMV.KEY.XP(2)			=255 IFEND[]
	IF[$T(37,105)==""] @SMV.KEY.ZM(2)			=255 IFEND[]
	IF[$T(37,106)==""] @SMV.KEY.ZP(2)			=255 IFEND[]
	IF[$T(37,107)==""] @SMV.KEY.SPLOW(2)		=255 IFEND[]
	IF[$T(37,108)==""] @SMV.KEY.SPHIGH(2)		=255 IFEND[]
	IF[$T(37,109)==""] @SMV.KEY.INIT(2)			=255 IFEND[]
	IF[$T(37,110)==""] @SMV.KEY.GUIDE(2)		=255 IFEND[]
	IF[$T(37,111)==""] @SMV.KEY.XYZCOPY(2)		=255 IFEND[]
	IF[$T(37,112)==""] @SMV.KEY.LISTCHANGE(2)	=255 IFEND[]
	IF[$T(37,113)==""] @SMV.KEY.LISTPREV(2)		=255 IFEND[]
	IF[$T(37,114)==""] @SMV.KEY.LISTNEXT(2)		=255 IFEND[]
	IF[$T(37,115)==""] @SMV.KEY.UNDO(2)			=255 IFEND[]
IFEND[]
*/

	@es.LSD(092,01)=0 //Zカウント

//	TASK[ID=es.EF.TASK.PRE #=es.EF.TASK.PRE Z=@es.63BITMAX]
//	TASK[ID=es.EF.TASK.MAIN #=es.EF.TASK.MAIN Z=10000000]
//	GOSUB[#=es.EF.TASK.PRE]

/*
DEBUGLIST[ADD=@L.ANNUM(@LNO)	STR="@L.ANNUM(@No)"]
DEBUGLIST[ADD=@L.ANTIME(@LNO)	STR="@L.ANTIME(@No)"]
DEBUGLIST[ADD=@L.ANLOOP(@LNO)	STR="@L.ANLOOP(@No)"]
DEBUGLIST[ADD=@L.ANC(@LNO)		STR="@L.ANC(@No)"]
DEBUGLIST[ADD=@L.ANC2(@LNO)		STR="@L.ANC2(@No)"]
DEBUGLIST[ADD=@L.ANC3(@LNO)		STR="@L.ANC3(@No)"]
DEBUGLIST[ADD=@L.ANC4(@LNO)		STR="@L.ANC4(@No)"]
*/

	return[]
}


//-------------------------------------------------------------------------
//
//■演出タスク・メイン
//
//-------------------------------------------------------------------------
/*
#=es.EF.TASK.PRE
{

	LOOP[]
	{
//		IF[@finflag==0] GO[#=es.EF.TASK.PRE.LEnd] IFEND[]
		IF[@finflag==0] WAIT[FRAME=1] LOOPCONTINUE[] IFEND[]

		@finflag=0
		GOSUB[#=es.SP.FINISH.GO pstr=$finspid pstr2=$finname]
		$finspid=""
		$finname=""
		@_MOUSE_L=5
		@_KEY_ENTER=5
		WAIT[FRAME=1]
	}
	LOOPEND[]

//	#=es.EF.TASK.PRE.LEnd
	return[]
}
*/

#=es.EF.TASK.MAIN
{
//	@Wcount+=2
//	IF[@Wcount==2]
//	{
//	@Wcount=0

	//3D用
	CG[ID=DXBUF E=@_DXMODE]

	//-------------------------------------------------------------------------
	// メインループ
	//-------------------------------------------------------------------------
	LOOP[]
	{
		//-------------------------------------------------------------------------
		// ウェイト
		//-------------------------------------------------------------------------
//		WAIT[FRAME=@L.WAIT]

		//-------------------------------------------------------------------------
		// ゲーム中以外は停止
		//-------------------------------------------------------------------------
//		IF[@es.SCENARIOMODE && @es.SAVEMODE==0 && @es.LOADMODE==0 && @es.LOGMODE==0 && @es.CONFIGMODE==0 && @es.SELMODE==0 && @es.MENUMODE==0 && @es.CONFMODE==0]
//		IF[1]
		IF[$es.S.NOW=="ES.GAMEMAIN" && @es.FADEMODE==0 && @es.SCENARIOSTOP==0]
		ELSE[]
		{
			@StopFlag=1
			LOOPBREAK[]
		}
		IFEND[]


		//-------------------------------------------------------------------------
		// 拡大中心点表示
		//-------------------------------------------------------------------------
		FLT[@CMV=                                  @L.V(@LNO_CM)               +@L.CLV(@LNO_CM)               ]
		FLT[@CMW=                                  @L.W(@LNO_CM)               +@L.CLW(@LNO_CM)               ]
		FLT[@CMX=@DBG.LX(@LNO_CM)+@USR.LX(@LNO_CM)+@L.X(@LNO_CM)+@L.AX(@LNO_CM)+@L.CLX(@LNO_CM)+@L.QX(@LNO_CM)]
		FLT[@CMY=@DBG.LY(@LNO_CM)+@USR.LY(@LNO_CM)+@L.Y(@LNO_CM)+@L.AY(@LNO_CM)+@L.CLY(@LNO_CM)+@L.QY(@LNO_CM)]
		FLT[@CMZ=@DBG.LZ(@LNO_CM)+@USR.LZ(@LNO_CM)+@L.Z(@LNO_CM)+@L.AZ(@LNO_CM)+@L.CLZ(@LNO_CM)+@L.QZ(@LNO_CM)]

		//カメラの前進方向とフォーカス表示
		IF[@es.GSD(094,01)] //@DBG.SW
		{
			CG[ID=CP01 E=1 X=@es.GSX/2-7-@CMV Y=@es.GSY/2-7-@CMW]
			CG[ID=CP02 E=1 X=@es.GSX/2-7      Y=@es.GSY/2-7     ]
		}
		ELSE[]
		{
			CG[ID=CP01 E=0]
			CG[ID=CP02 E=0]
		}
		IFEND[]

		//[SpriteView]カメラ表示
		INT[@v]
		FLT[@lz3]

/*
		LOOP[SET= 9] CG[ID=":W2/CM0"+$(@_LC  )+"0" E=0] LOOPEND[]
		LOOP[SET=10] CG[ID=":W2/CM1"+$(@_LC-1)+"0" E=0] LOOPEND[]

		MATH[LET=@lz3 POW=1 SET=2.0 SET2=(-600+(@L.Z(@LNO_CM)-@CMZ))/200.0]
		@lz3=@lz3*5.0
		IF[@CMV<=-100]
			@v=-@CMV*@lz3/100;IF[@v>4] @v=4 IFEND[];IF[@v<1] @v=1 IFEND[]
			CG[ID=":W2/CM0"+$(@v)+"0" E=1 X=200-5-5+@CMX/10.0 Y=300-5+8-@CMZ/2.0]
		ELSE[]
			@v= @CMV*@lz3/100;IF[@v>4] @v=4 IFEND[];IF[@v<0] @v=0 IFEND[]
			CG[ID=":W2/CM1"+$(@v)+"0" E=1 X=200-5-5+@CMX/10.0 Y=300-5+8-@CMZ/2.0]
		IFEND[]
*/
IF[@_DEBUGMODE>=@dbg.val]
{
		CG[ID=":W2/CM100" E=1 X=200-5-5+@CMX/10.0-174 Y=300-5+8-@CMZ/2.0-209]
}
IFEND[]
		//スプライトマップビューウィンドウ
		INT[@lno]
		INT[@WE]
		WINDOWINFO[NO=2 EXIST=1 LET=@WE]

		IF[@_DEBUGMODE>=@dbg.val]
		{
			@DBG.TOTALCGBYTE = 0
		}
		IFEND[]

		IF[@_DEBUGMODE>=@dbg.val && @WE]
		{

		//	FONT[BNO=1 SX=@DBG.FSX SY=@DBG.FSY BOLD=0 COLOR=0xeeeeff COLOR2=0x8888bb ANTIALIASING=0]
			FONT[BNO=1 SX=@DBG.FSX SY=@DBG.FSY BOLD=0 COLOR=0xeeeeff COLOR2=0xeeeeff ANTIALIASING=0]


			IF[@es.GSD(095,01)==0]
			{
				IF[@DBG.REDFONT] FONT[BNO=1 COLOR=0xff2222 COLOR2=0xff2200] IFEND[]

				CGACT[ID=":W2/TX01" RECTPAINT3=1 SET=0x00000000]

				//================================================================================================================
				// レイヤリスト表示
				//================================================================================================================
					@DBG.TY=2

					@IV=@CMV
					@IW=@CMW
					@IX=@CMX
					@IY=@CMY
					@IZ=@CMZ
					\_inttostr(@IX, 4, 0)($SIX)
					\_inttostr(@IY, 4, 0)($SIY)
					\_inttostr(@IZ, 4, 0)($SIZ)

					IF[@DBG.LX(@LNO_CM)!=0 || @DBG.LY(@LNO_CM)!=0 || @DBG.LZ(@LNO_CM)!=0]
						$DBS="*"
					ELSE[]
						$DBS=" "
					IFEND[]

			//		$DBS+="CM=VW("+$(@IV)+","+$(@IW)+"),XYZ("+$SIX+","+$SIY+","+$SIZ+")"
					$DBS+="("+$SIX+","+$SIY+","+$SIZ+")       <CAMERA>"

					CGACT[ID=":W2/TX01" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
					@DBG.TY+=@DBG.FSY
			}
			IFEND[]

		}
		IFEND[]

		IF[@_DEBUGMODE>=@dbg.val]
		{
				@DBG.LISTNUM=0
				LOOP[SET=(@LMAX+1)]
				{
					@lno=(@_LC-1)
	//				IF[$L.FCG(@lno)!="" && $L.SPID(@lno)!="BGF" && $L.SPID(@lno)!="LNO_FD" && $L.SPID(@lno)!="LNO_CM" && $L.SPID(@lno)!="LNO_CMF"]
					IF[$L.SPID(@lno)!="" && $L.SPID(@lno)!="BGF" && $L.SPID(@lno)!="LNO_FD" && $L.SPID(@lno)!="LNO_CM" && $L.SPID(@lno)!="LNO_CMF"]
	//				IF[$L.FCG(@lno)!=""]
					{
						@DBG.CGBYTE = @L.SX(@lno) * @L.SY(@lno) * 4
						IF[@_DXMODE]
					//		@DBG.CGBYTE = (((@L.SX(@lno)+511)/512)*512) * (((@L.SY(@lno)+255)/256)*256) * 4
						IFEND[]

			//			IF[@L.A(@lno)+@L.CLA(@lno)>1]
						{
							@DBG.TOTALCGBYTE += @DBG.CGBYTE //
						}
			//			IFEND[]

							$DBS=" "
							IF[$L.SPID(@lno)=="BG"]
								$DBS="X"
							ELSE[@DBG.LX(@lno)!=0 || @DBG.LY(@lno)!=0 || @DBG.LZ(@lno)!=0]
								$DBS="*"
							IFEND[]

							@IX=@DBG.LX(@lno)+@USR.LX(@lno)+@L.X(@lno)+@L.AX(@lno)+@L.CLX(@lno)+@L.QX(@lno)
							@IY=@DBG.LY(@lno)+@USR.LY(@lno)+@L.Y(@lno)+@L.AY(@lno)+@L.CLY(@lno)+@L.QY(@lno)
							@IZ=@DBG.LZ(@lno)+@USR.LZ(@lno)+@L.Z(@lno)+@L.AZ(@lno)+@L.CLZ(@lno)+@L.QZ(@lno) //*@es.ZEX
							\_inttostr(@IX, 4, 0);$DBS+="("+$_RSTR(1)
							\_inttostr(@IY, 4, 0);$DBS+=","+$_RSTR(1)
							\_inttostr(@IZ, 4, 0);$DBS+=","+$_RSTR(1)

							$DBS+=")("

							@CZ=@DBG.LZ(@LNO_CM)+@USR.LZ(@LNO_CM)+@L.Z(@LNO_CM)+@L.CLZ(@LNO_CM)+@L.QZ(@LNO_CM)
							\_inttostr(@IZ-@CZ, 4, 0);$DBS+=$_RSTR(1)+")"

						//	IF[@L.FTYPE(@lno)!=5]
							{
								IF[@L.TIP(@lno)] $DBS+="C"
								ELSE[]			 $DBS+=" "
								IFEND[]
							}
						//	IFEND[]

							$DBS+="["+$L.SPID(@lno)

							\_strlen($L.SPID(@lno))
							  IF[@_RINT(1)==0] $DBS+="      ] "
							ELSE[@_RINT(1)==1] $DBS+="     ] "
							ELSE[@_RINT(1)==2] $DBS+="    ] "
							ELSE[@_RINT(1)==3] $DBS+="   ] "
							ELSE[@_RINT(1)==4] $DBS+="  ] "
							ELSE[@_RINT(1)==5] $DBS+=" ] "
							ELSE[]             $DBS+="] "
							IFEND[]

							\_inttostr(@L.A(@lno)+@L.CLA(@lno), 3, 0);$DBS+="A"+$_RSTR(1)+" "

							\_inttostr(@L.H(@lno)+@L.CLH(@lno), 3, 0);$DBS+="H"+$_RSTR(1)+" "

							\_inttostr(@L.TP(@lno), 3, 0);$DBS+="T"+$_RSTR(1)+" "

					//		\_inttostr(@L.FTYPE(@lno), 1, 0);$DBS+="Type"+$_RSTR(1)+" "

					//		\_inttostr(@L.BL(@lno), 2, 0);$DBS+="BL"+$_RSTR(1)+" "

					//		\_inttostr(@L.MD(@lno), 8, 0);$DBS+="MD"+$_RSTR(1)+" "

					//		\_inttostr(@L.LZCNT(@lno), 4, 0);$DBS+="LZ"+$_RSTR(1)+" "

							//B(x,y)
							\_inttostr(@L.BX(@lno)+@L.ABX(@lno)+@L.CLBX(@lno), 3, 0);$DBS+="B("+$_RSTR(1)+","
							\_inttostr(@L.BY(@lno)+@L.ABY(@lno)+@L.CLBY(@lno), 3, 0);$DBS+=$_RSTR(1)+") "

							//M(x,y)
					//		\_inttostr(@L.MX(@lno), 3, 0);$DBS+="M("+$_RSTR(1)+","
					//		\_inttostr(@L.MY(@lno), 3, 0);$DBS+=$_RSTR(1)+") "

							//RZ
					//		\_inttostr(@L.RZ(@lno), 5, 0);$DBS+="RZ"+$_RSTR(1)

							//SXxSY
							\_inttostr(@L.SX(@lno), 4, 0);$DBS+=$_RSTR(1)+"x"
							\_inttostr(@L.SY(@lno), 4, 0);$DBS+=$_RSTR(1)+" "

							\_inttostr((@DBG.CGBYTE/1024/1024)+1, 2, 0);$DBS+=$_RSTR(1)


IF[@L.FTYPE(@lno)==6] //ムービーの場合
{
					//		$DBS+="] A"+$(@L.A(@lno)+@L.CLA(@lno))+" T"+$(@L.TP(@lno))+" "+$(@L.SX(@lno))+"x"+$(@L.SY(@lno))+" "+$((@DBG.CGBYTE/1024/1024)+1)+"MB "+$(@L.YMFPS(@lno))+"FPS "+$(@L.ANC4(@lno))+"F"
							$DBS+="M "+$(@L.YMFPS(@lno))+"FPS "+$(@L.ANC4(@lno))+"F"
					//		$DBS+="M "+$(@L.ANTIME(@lno))+"ms L"+$(@L.ANLOOP(@lno))+" "+$(@L.ANC4(@lno)+1)+"F"
}
ELSE[]
{
	IF[@L.ANFLAG(@lno)==1] //連番アニメの場合
	{
							$DBS+="S "+$(@L.ANTIME(@lno))+"ms "+$(@L.ANC2(@lno)+1)+"F"
				//			$DBS+="S "+$(@L.ANTIME(@lno))+"ms L"+$(@L.ANLOOP(@lno))+" "+$(@L.ANC2(@lno)+1)+"F"
					//		$DBS+="S "+$(@mTADD)+"ad "+$(@L.ANC(@lno))+" "+$(@L.ANC2(@lno)+1)+"F"
	}
	ELSE[@L.ANFLAG(@lno)==2] //パターン指定アニメの場合
	{
							$DBS+="P "+$(@L.ANTIME(@lno))+"ms "+$(@L.ANC2(@lno)+1)+"F"
				//			$DBS+="P "+$(@L.ANTIME(@lno))+"ms L"+$(@L.ANLOOP(@lno))+" "+$(@L.ANC2(@lno)+1)+"F"
					//		$DBS+="P "+$(@mTADD)+"ad "+$(@L.ANC(@lno))+" "+$(@L.ANC2(@lno)+1)+"F"
	}
	ELSE[]
	{
						//	$DBS+="] A"+$(@L.A(@lno)+@L.CLA(@lno))+" T"+$(@L.TP(@lno))+" "+$(@L.SX(@lno))+"x"+$(@L.SY(@lno))+" TR"+$L.FTR(@lno)+" "+$((@DBG.CGBYTE/1024/1024)+1)+"MB"
							$DBS+="M"
					//	$DBS+="] L.FTYPE="+$(@L.FTYPE(@lno))+" T"+$(@L.TP(@lno))+" "+$(@L.SX(@lno))+"x"+$(@L.SY(@lno))+" "+$((@DBG.CGBYTE/1024/1024)+1)+"MB"
						//	$DBS+="] A"+$(@L.A(@lno)+@L.CLA(@lno))+" "+$(@L.SX(@lno))+"x"+$(@L.SY(@lno))+" "+$((@DBG.CGBYTE/1024/1024)+1)+"MB"
			//				$DBS+="] A"+$(@L.A(@lno)+@L.CLA(@lno))+" F"+$(@L.F2(@lno))+" "+$(@L.SX(@lno))+"x"+$(@L.SY(@lno))+" "+$((@DBG.CGBYTE/1024/1024)+1)+"MB"
	}
	IFEND[]
}
IFEND[]

							IF[@_DEBUGMODE>=@dbg.val && @WE]
							{
								IF[@es.GSD(095,01)==0]
								{
									IF[@DBG.REDFONT==0]
										  IF[@L.FTYPE(@lno)==1] FONT[BNO=1 COLOR=@T(37,61) COLOR2=@T(37,61)]
										ELSE[@L.FTYPE(@lno)==2] FONT[BNO=1 COLOR=@T(37,62) COLOR2=@T(37,62)]
										ELSE[@L.FTYPE(@lno)==3] FONT[BNO=1 COLOR=@T(37,64) COLOR2=@T(37,64)]
										ELSE[@L.FTYPE(@lno)==5] FONT[BNO=1 COLOR=@T(37,63) COLOR2=@T(37,63)]
										ELSE[@L.FTYPE(@lno)==6] FONT[BNO=1 COLOR=0x77ff77 COLOR2=0x77ff77]
										ELSE[@L.FTYPE(@lno)==7] FONT[BNO=1 COLOR=0x77ff77 COLOR2=0x77ff77]
										IFEND[]
									IFEND[]
									CGACT[ID=":W2/TX01" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
								}
								IFEND[]

								@DBG.TY+=@DBG.FSY
								@DBG.LISTNUM+=1
								@DBG.LISTLNO(@DBG.LISTNUM)=@lno
							}
							IFEND[]

					}
					IFEND[]

				}
				LOOPEND[]

				IF[@DBG.TOTALCGBYTE>=@DBG.TOTALCGBYTE.MAX*1024*1024] @DBG.CGBYTEOVER=1;@DBG.REDFONT=1 IFEND[]

				IF[@DBG.CGBYTEOVER]
				{
					IF[@DBG.CGBYTEOVER.ERR==0]
						@DBG.CGBYTEOVER.ERR=1
						\_dmes("[警告エラー]メモリの使用容量が "+$(@DBG.TOTALCGBYTE.MAX)+" MBを超えました。現在のスクリプトの場所をスクリプターさんに教えてあげてください。")
					IFEND[]
				}
				IFEND[]

		}
		IFEND[]


		IF[@_DEBUGMODE>=@dbg.val && @WE]
		{
			//================================================================================================================
			// メモリステータス表示
			//================================================================================================================
			IF[@es.GSD(095,01)==0]
			{
				FONT[BNO=1 COLOR=0xeeeeff COLOR2=0xeeeeff]

				IF[@DBG.CGBYTEOVER]
					\_inttostr(@DBG.TOTALCGBYTE/1024/1024, 3, 0);$DBS="★超過:MEM-USE"+$_RSTR(1)+"M"
					\_inttostr(@DBG.LISTNUM, 3, 0);$DBS+="  SP-NUM"+$_RSTR(1)+"枚"
					CGACT[ID=":W2/TX01" TEXT=1 BNO=1 X=272 Y=2 SETSTR=$DBS]
				ELSE[]
					\_inttostr(@DBG.TOTALCGBYTE/1024/1024, 3, 0);$DBS="MEM-USE"+$_RSTR(1)+"M"
					\_inttostr(@DBG.LISTNUM, 3, 0);$DBS+="  SP-NUM"+$_RSTR(1)+"枚"
					CGACT[ID=":W2/TX01" TEXT=1 BNO=1 X=272 Y=2 SETSTR=$DBS]
				IFEND[]
			}
			IFEND[]

			//================================================================================================================
			// QUEリスト表示
			//================================================================================================================
			IF[@es.GSD(095,01)==1]
			{
				CGACT[ID=":W2/TX02" RECTPAINT3=1 SET=0x00000000]
				@DBG.TY=2

			//	CGACT[ID=":W2/TX02" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR="▼QUE LIST"]
			//	@DBG.TY+=@DBG.FSY

			//	CGACT[ID=":W2/TX02" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR="COMQNOR="+$(@COMQNOR(@e_A))]
			//	@DBG.TY+=@DBG.FSY

				INT[@qno=-1]
				LOOP[SET=@QUE.MAX]
				{
					IF[@S.FLAG(@_LC)>0]
					{
						IF[@qno!=@S.QNO(@_LC)] @qno=@S.QNO(@_LC) IFEND[]

						  IF[@qno%3==0] FONT[BNO=1 COLOR=0x99ff99 COLOR2=0x99ff99]
						ELSE[@qno%3==1] FONT[BNO=1 COLOR=0xbbbbff COLOR2=0xbbbbff]
						ELSE[@qno%3==2] FONT[BNO=1 COLOR=0xbbffff COLOR2=0xbbffff]
						IFEND[]

				//		\_inttostr(@S.QNO(@_LC), 3, 0)
				//		$DBS=$_RSTR(1)+" "
				//		\_inttostr(@S.QNO2(@_LC), 3, 0)
				//		$DBS+=$_RSTR(1)+" ["+$S.SPID(@_LC)

						$DBS="["+$S.SPID(@_LC)

						\_strlen($S.SPID(@_LC))
						  IF[@_RINT(1)==0] $DBS+="       "
						ELSE[@_RINT(1)==1] $DBS+="      "
						ELSE[@_RINT(1)==2] $DBS+="     "
						ELSE[@_RINT(1)==3] $DBS+="    "
						ELSE[@_RINT(1)==4] $DBS+="   "
						ELSE[@_RINT(1)==5] $DBS+="  "
						ELSE[@_RINT(1)==6] $DBS+=" "
						IFEND[]

						$DBS+="] NAME="+$S.NAME(@_LC)

						\_strlen($S.NAME(@_LC))
						  IF[@_RINT(1)==0] $DBS+="         "
						ELSE[@_RINT(1)==1] $DBS+="        "
						ELSE[@_RINT(1)==2] $DBS+="       "
						ELSE[@_RINT(1)==3] $DBS+="      "
						ELSE[@_RINT(1)==4] $DBS+="     "
						ELSE[@_RINT(1)==5] $DBS+="    "
						ELSE[@_RINT(1)==6] $DBS+="   "
						ELSE[@_RINT(1)==7] $DBS+="  "
						ELSE[@_RINT(1)==8] $DBS+=" "
						IFEND[]

						$DBS+="COM="+$comstr(@S.COM(@_LC))

						\_strlen($comstr(@S.COM(@_LC)))
						  IF[@_RINT(1)==0] $DBS+="      "
						ELSE[@_RINT(1)==1] $DBS+="     "
						ELSE[@_RINT(1)==2] $DBS+="    "
						ELSE[@_RINT(1)==3] $DBS+="   "
						ELSE[@_RINT(1)==4] $DBS+="  "
						ELSE[]             $DBS+=" "
						IFEND[]

						$DBS+=" "+$stcstr(@S.FLAG(@_LC))

						IF[@S.N(@_LC)>0]
							$DBS+=" N="+$(@S.N(@_LC))
						ELSE[]
							$DBS+=" N=∞"
						IFEND[]

						$DBS+=" T="+$(@S.TNOW(@_LC))

						$DBS+="/"+$(@S.T(@_LC))


						CGACT[ID=":W2/TX02" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
						@DBG.TY+=@DBG.FSY
					}
					IFEND[]
				}
				LOOPEND[]

				IF[@qno==-1]
					CGACT[ID=":W2/TX02" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR="(なし)"]
				IFEND[]

			}
			IFEND[]

			//================================================================================================================
			// サウンドリスト表示
			//================================================================================================================
			IF[@es.GSD(095,01)==2]
			{
				CGACT[ID=":W2/TX03" RECTPAINT3=1 SET=0x00000000]
				@DBG.TY=2

				FONT[BNO=1 COLOR=0xbbffff COLOR2=0xbbffff]

					$DBS ="※ループサウンドのみ表示されます."
					CGACT[ID=":W2/TX03" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
					@DBG.TY+=@DBG.FSY

				FONT[BNO=1 COLOR=0x99ff99 COLOR2=0x99ff99]

					LOOP[SET=4]
					{
						GOSUB[#=es.SND.INFO2.GET pstr="BGM/" pint2=00+@_LC]
						$DBS ="[BGM"+$(@_LC)+"]"+$_RSTR(1)
						IF[$_RSTR(1)!=""]
							$DBS+="   "+$(@_RINT(2))+" / "+$(@_RINT(3))+" ms"
						IFEND[]

							CGACT[ID=":W2/TX03" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
							@DBG.TY+=@DBG.FSY
					}
					LOOPEND[]

				FONT[BNO=1 COLOR=0xbbbbff COLOR2=0xbbbbff]

					LOOP[SET=4]
					{
						GOSUB[#=es.SND.INFO2.GET pstr="SE/" pint2=10+@_LC]
						$DBS ="[SE"+$(@_LC)+" ]"+$_RSTR(1)
						IF[$_RSTR(1)!=""]
							$DBS+="   "+$(@_RINT(2))+" / "+$(@_RINT(3))+" ms"
						IFEND[]

							CGACT[ID=":W2/TX03" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
							@DBG.TY+=@DBG.FSY
					}
					LOOPEND[]

				/*
				FONT[BNO=1 COLOR=0xbbffff COLOR2=0xbbffff]

					LOOP[SET=10]
					{
						GOSUB[#=es.SND.INFO2.GET pint=20+@_LC]
						$DBS ="[VO"+$(@_LC)+" ]="+$_RSTR(1)

							CGACT[ID=":W2/TX03" TEXT=1 BNO=1 X=2 Y=@DBG.TY SETSTR=$DBS]
							@DBG.TY+=@DBG.FSY
					}
					LOOPEND[]
				*/
			}
			IFEND[]

		}
		IFEND[]


		//-------------------------------------------------------------------------
		// 新しい演出命令があった
		//-------------------------------------------------------------------------

		//一番若い演出キューを探しておく.
		INT[@qn = @es.64BITMAX]
		INT[@qlc = 1]
		LOOP[SET=@QUE.MAX]
		{
			IF[@S.FLAG(@_LC)==3 && (@S.COM(@_LC)==@e_CG || @S.COM(@_LC)==@e_MV)]
			{
				IF[@S.QNO(@_LC) < @qn]
				{
					@qn = @S.QNO(@_LC)
					@qlc = @_LC
				}
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]

		//まずは画像読込系キューを探す
		LOOP[SET=@QUE.MAX]
		{
			//開始キュー位置から一周していく
			@SNO = @qlc+(@_LC-1)
			IF[@SNO > @QUE.MAX] @SNO-=@QUE.MAX IFEND[]

			IF[@S.FLAG(@SNO)==3 && (@S.COM(@SNO)==@e_CG || @S.COM(@SNO)==@e_MV)]
			{
				GOSUB[#=es.EF.CHECK pint=@SNO pstr2=$S.SPID(@SNO) pint3=@S.COM(@SNO) pstr4=$S.NAME(@SNO) pint5=@S.QNO(@SNO) pint6=@S.QNO2(@SNO)] //同じ命令演出が無いかチェック
				IF[@_RINT(1)==0]
					GOSUB[#=es.EF.INIT]
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]

		//次に他のキューを探す
		LOOP[SET=@QUE.MAX]
		{
			//開始キュー位置から一周していく
			@SNO = @qlc+(@_LC-1)
			IF[@SNO > @QUE.MAX] @SNO-=@QUE.MAX IFEND[]

			IF[@S.FLAG(@SNO)==3]
			{
				GOSUB[#=es.EF.CHECK pint=@SNO pstr2=$S.SPID(@SNO) pint3=@S.COM(@SNO) pstr4=$S.NAME(@SNO) pint5=@S.QNO(@SNO) pint6=@S.QNO2(@SNO)] //同じ命令演出が無いかチェック
				IF[@_RINT(1)==0]
					GOSUB[#=es.EF.INIT]
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]
/*
		//まずは画像読込系を探す
		LOOP[SET=@QUE.MAX]
		{
			@SNO = @_LC
			IF[@S.FLAG(@SNO)==3 && (@S.COM(@SNO)==@e_CG || @S.COM(@SNO)==@e_MV)]
			{
				GOSUB[#=es.EF.CHECK pint=@SNO pstr2=$S.SPID(@SNO) pint3=@S.COM(@SNO) pstr4=$S.NAME(@SNO) pint5=@S.QNO(@SNO) pint6=@S.QNO2(@SNO)] //同じ命令演出が無いかチェック
				IF[@_RINT(1)==0]
					GOSUB[#=es.EF.INIT]
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]

		//次に他の.
		LOOP[SET=@QUE.MAX]
		{
			@SNO = @_LC
			IF[@S.FLAG(@SNO)==3]
			{
				GOSUB[#=es.EF.CHECK pint=@SNO pstr2=$S.SPID(@SNO) pint3=@S.COM(@SNO) pstr4=$S.NAME(@SNO) pint5=@S.QNO(@SNO) pint6=@S.QNO2(@SNO)] //同じ命令演出が無いかチェック
				IF[@_RINT(1)==0]
					GOSUB[#=es.EF.INIT]
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]
*/

		//-------------------------------------------------------------------------
		// カメラが演出中か
		//-------------------------------------------------------------------------
		@DIR_CAMERA=0
		LOOP[SET=@QUE.MAX]
		{
	//		IF[@S.LNO(@_LC)==@LNO_CM]
			IF[@S.LNO(@_LC)==@LNO_CM || @S.LNO(@_LC)==@LNO_BG || @S.LNO(@_LC)==@LNO_BGF]
			{
				@DIR_CAMERA=1

				LOOP[SET=(@LMAX+1)]
				{
					@LNO=@_LC-1

					CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
					IF[@r==0 && @LNO!=@LNO_CM && @LNO!=@LNO_CMF]
					{
						LOOPCONTINUE[]
					}
					IFEND[]

					@DRAW.FLAG(@LNO)=1
				}
				LOOPEND[]

				LOOPBREAK[]
			}
			IFEND[]
		}
		LOOPEND[]


IF[@_DEBUGMODE>=@dbg.val]
{
	IF[@DIR_CAMERA==0]
	{
/*
		LOOP[SET=(@LMAX+1)]
		{

@lno=@_LC-1

//警告

		}
		LOOPEND[]
*/
	}
	IFEND[]


	//ガイド表示
	IF[@_INP(@SMV.KEY.GUIDE(1))==1 || @_INP(@SMV.KEY.GUIDE(2))==1]
	{
		@dbg.pushflag=1
		@es.GSD(094,01)+=1 //@DBG.SW
		@es.GSD(094,01)%=4
	}
	IFEND[]


	//表示内容選択
	//とりあえず今のところ２種
	IF[@_INP(@SMV.KEY.LISTCHANGE(1))==1 || @_INP(@SMV.KEY.LISTCHANGE(2))==1] //リスト表示切替
	{
		@es.GSD(095,01)+=1
		IF[@es.GSD(095,01)>=(3)] @es.GSD(095,01)=0 IFEND[]

		IF[@es.GSD(095,01)==0]
			CG[ID=":W2/TX01" E=1]
			CG[ID=":W2/TX02" E=0]
			CG[ID=":W2/TX03" E=0]
		ELSE[@es.GSD(095,01)==1]
			CG[ID=":W2/TX01" E=0]
			CG[ID=":W2/TX02" E=1]
			CG[ID=":W2/TX03" E=0]
		ELSE[]
			CG[ID=":W2/TX01" E=0]
			CG[ID=":W2/TX02" E=0]
			CG[ID=":W2/TX03" E=1]
		IFEND[]
	}
	IFEND[]


	//スプライトリスト選択
	IF[@es.GSD(095,01)==0] //スプライトリスト表示時
	{
		IF[@_INP(@SMV.KEY.LISTPREV(1))==1 || @_INP(@SMV.KEY.LISTPREV(1))==16 || @_INP(@SMV.KEY.LISTPREV(2))==1 || @_INP(@SMV.KEY.LISTPREV(2))==16] @DBG.LISTCUR-=1; IF[@DBG.LISTCUR<           0] @DBG.LISTCUR=@DBG.LISTNUM IFEND[] IFEND[]
		IF[@_INP(@SMV.KEY.LISTNEXT(1))==1 || @_INP(@SMV.KEY.LISTNEXT(1))==16 || @_INP(@SMV.KEY.LISTNEXT(2))==1 || @_INP(@SMV.KEY.LISTNEXT(2))==16] @DBG.LISTCUR+=1; IF[@DBG.LISTCUR>@DBG.LISTNUM] @DBG.LISTCUR=           0 IFEND[] IFEND[]
		IF[@_INP(@SMV.KEY.LISTPREV(1))>=16] @_INP(@SMV.KEY.LISTPREV(1))=16-5 IFEND[]
		IF[@_INP(@SMV.KEY.LISTNEXT(1))>=16] @_INP(@SMV.KEY.LISTNEXT(1))=16-5 IFEND[]
		IF[@_INP(@SMV.KEY.LISTPREV(2))>=16] @_INP(@SMV.KEY.LISTPREV(2))=16-5 IFEND[]
		IF[@_INP(@SMV.KEY.LISTNEXT(2))>=16] @_INP(@SMV.KEY.LISTNEXT(2))=16-5 IFEND[]
		IF[@DBG.LISTCUR<           0] @DBG.LISTCUR=           0 IFEND[]
		IF[@DBG.LISTCUR>@DBG.LISTNUM] @DBG.LISTCUR=@DBG.LISTNUM IFEND[]

		CG[ID=":W2/LISTCUR" Y=@es.SMV.LY-16+1+@DBG.LISTCUR*@DBG.FSY]
	}
	ELSE[] //違うときはリストバー画像非表示
	{
		CG[ID=":W2/LISTCUR" Y=-9999]
	}
	IFEND[]


	//速度
	INT[@mBAI=100]
	INT[@ln]

	IF[@DBG.LISTCUR==0]	//カメラ移動
	{
		@ln=@LNO_CM
	}
	ELSE[]				//スプライト移動
	{
		@ln=@DBG.LISTLNO(@DBG.LISTCUR)
	}
	IFEND[]

	//背景は動かせないように
	IF[$L.SPID(@ln)=="BG"] @ln=0 IFEND[]


	IF[@_INP(@SMV.KEY.SPHIGH(1))>0 || @_INP(@SMV.KEY.SPHIGH(2))>0] @mBAI=@T(37,74) IFEND[]
	IF[@_INP(@SMV.KEY.SPLOW(1)) >0 || @_INP(@SMV.KEY.SPLOW(2)) >0] @mBAI=@T(37,75) IFEND[]


	//XYZ
	@dbg.xm=0
	@dbg.xp=0
	@dbg.ym=0
	@dbg.yp=0
	@dbg.zm=0
	@dbg.zp=0

	IF[@_INP(@SMV.KEY.XM(1))>0 || @_INP(@SMV.KEY.XM(2))>0] @dbg.xm=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//左(X-)
	IF[@_INP(@SMV.KEY.XP(1))>0 || @_INP(@SMV.KEY.XP(2))>0] @dbg.xp=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//右(X+)
	IF[@_INP(@SMV.KEY.YM(1))>0 || @_INP(@SMV.KEY.YM(2))>0] @dbg.ym=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//上(Y-)
	IF[@_INP(@SMV.KEY.YP(1))>0 || @_INP(@SMV.KEY.YP(2))>0] @dbg.yp=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//下(Y+)
	IF[@_INP(@SMV.KEY.ZP(1))>0 || @_INP(@SMV.KEY.ZP(2))>0] @dbg.zm=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//後(Z+)
	IF[@_INP(@SMV.KEY.ZM(1))>0 || @_INP(@SMV.KEY.ZM(2))>0] @dbg.zp=1;@dbg.pushflag=1;@dbg.pushflag.xyz+=1 IFEND[]	//前(Z-)

	IF[@dbg.xm+@dbg.xp+@dbg.ym+@dbg.yp+@dbg.zm+@dbg.zp==0 && @_MOUSE_L<0] @dbg.pushflag.xyz=0 IFEND[]



			//オブジェクトドラッグ処理
			IF[@_MOUSE_X2>=0 && @_MOUSE_Y2>=0 && @_MOUSE_X2<400 && @_MOUSE_Y2<600]
			{
				INT[@col]
				INT[@no]

				IF[@_MOUSE_L>=1 && @_MOUSE_L<=2]	//ドラッグ開始
				{
					CGINFO[ID=":W2/CM100" ONMOUSE2=2+1 LET=@col]
					IF[@col>254]
					{
						@dbg.dragmode = 10000
						@dbg.dragx  = @_MOUSE_X2
						@dbg.dragy  = @_MOUSE_Y2
						@dbg.dragdx = @DBG.LX(@LNO_CM)
						@dbg.dragdz = @DBG.LZ(@LNO_CM)
						@DBG.LISTCUR = 0
					}
					ELSE[]
					{
						LOOP[SET=(@LMAX+1)]
						{
							@no=@_LC-1

							CGINFO[ID=":W2/CP"+$(@no) ONMOUSE2=2+1 LET=@col]
							IF[@col>64 && @no!=@LNO_BG && @no!=@LNO_BGF]
							{
								@dbg.dragmode = @no
								@dbg.dragx  = @_MOUSE_X2
								@dbg.dragy  = @_MOUSE_Y2
								@dbg.dragdx = @DBG.LX(@dbg.dragmode)
								@dbg.dragdz = @DBG.LZ(@dbg.dragmode)

								LOOP[SET=@DBG.LISTNUM]
								{
									IF[@DBG.LISTLNO(@_LC)==@no] @DBG.LISTCUR = @_LC;LOOPBREAK[] IFEND[]
								}
								LOOPEND[]

								LOOPBREAK[]
							}
							IFEND[]
						}
						LOOPEND[]
					}
					IFEND[]

					@_MOUSE_L=2
				}
				IFEND[]
			}
			IFEND[]

			IF[@_MOUSE_L<0]
			{
				@dbg.dragmode = 0
			}
			IFEND[]

			IF[@dbg.dragmode==10000]
			{
				@dbg.pushflag.xyz+=1
				@DBG.LX(@LNO_CM) = (@dbg.dragdx - (@dbg.dragx - @_MOUSE_X2)*10.0)
				@DBG.LZ(@LNO_CM) = (@dbg.dragdz + (@dbg.dragy - @_MOUSE_Y2)* 2.0)
				@dbg.pushflag=1
			}
			ELSE[@dbg.dragmode>0]
			{
				@dbg.pushflag.xyz+=1
				@DBG.LX(@dbg.dragmode) = (@dbg.dragdx - (@dbg.dragx - @_MOUSE_X2)*10.0)
				@DBG.LZ(@dbg.dragmode) = (@dbg.dragdz + (@dbg.dragy - @_MOUSE_Y2)* 2.0)
				@dbg.pushflag=1
			}
			IFEND[]




	IF[@dbg.pushflag.xyz==1] //Undoデータ記録
	{
		@DBG.UNDO.LX(@ln)=@DBG.LX(@ln)
		@DBG.UNDO.LX(@ln)=@DBG.LX(@ln)
		@DBG.UNDO.LY(@ln)=@DBG.LY(@ln)
		@DBG.UNDO.LY(@ln)=@DBG.LY(@ln)
		@DBG.UNDO.LZ(@ln)=@DBG.LZ(@ln)
		@DBG.UNDO.LZ(@ln)=@DBG.LZ(@ln)
	}
	IFEND[]

	IF[@_INP(@SMV.KEY.UNDO(1))==1 || @_INP(@SMV.KEY.UNDO(2))==1] //Undo
	{
		@dbg.pushflag=1
		@DBG.LX(@ln)=@DBG.UNDO.LX(@ln)
		@DBG.LX(@ln)=@DBG.UNDO.LX(@ln)
		@DBG.LY(@ln)=@DBG.UNDO.LY(@ln)
		@DBG.LY(@ln)=@DBG.UNDO.LY(@ln)
		@DBG.LZ(@ln)=@DBG.UNDO.LZ(@ln)
		@DBG.LZ(@ln)=@DBG.UNDO.LZ(@ln)
	}
	IFEND[]

	IF[@dbg.xm] @DBG.LX(@ln)-=@T(37,71)*@mBAI/100.0 IFEND[]	//左(X-)
	IF[@dbg.xp] @DBG.LX(@ln)+=@T(37,71)*@mBAI/100.0 IFEND[]	//右(X+)
	IF[@dbg.ym] @DBG.LY(@ln)-=@T(37,72)*@mBAI/100.0 IFEND[]	//上(Y-)
	IF[@dbg.yp] @DBG.LY(@ln)+=@T(37,72)*@mBAI/100.0 IFEND[]	//下(Y+)
	IF[@dbg.zm] @DBG.LZ(@ln)+=@T(37,73)*@mBAI/100.0 IFEND[]	//後(Z+)
	IF[@dbg.zp] @DBG.LZ(@ln)-=@T(37,73)*@mBAI/100.0 IFEND[]	//前(Z-)


//	IF[@_KEY_NUM3>0] @dbg.pushflag=1;@DBG.LZ(@ln) =@L.Z(@LNO_BG)-300 IFEND[]
//	IF[@_KEY_NUM9>0] @dbg.pushflag=1;@DBG.LZ(@ln) =@L.Z(@LNO_BG)-200 IFEND[]

	//初期位置
	IF[@_INP(@SMV.KEY.INIT(1))== 1 || @_INP(@SMV.KEY.INIT(2))== 1] @dbg.pushflag=1;@DBG.LX(@ln)=0;@DBG.LY(@ln)=0;@DBG.LZ(@ln)=0 IFEND[]
	IF[@_INP(@SMV.KEY.INIT(1))>=60 || @_INP(@SMV.KEY.INIT(2))>=60] @dbg.pushflag=1;LOOP[SET=\.SP.MAX+1] @DBG.LX(@_LC-1)=0;@DBG.LY(@_LC-1)=0;@DBG.LZ(@_LC-1)=0 LOOPEND[] IFEND[]

	//カメラXYZ座標をコピー
	IF[@_INP(@SMV.KEY.XYZCOPY(1))==1 || @_INP(@SMV.KEY.XYZCOPY(2))==1]
	{
		@IX=@DBG.LX(@ln)+@USR.LX(@ln)+@L.X(@ln)+@L.AX(@ln)+@L.CLX(@ln)+@L.QX(@ln)
		@IY=@DBG.LY(@ln)+@USR.LY(@ln)+@L.Y(@ln)+@L.AY(@ln)+@L.CLY(@ln)+@L.QY(@ln)
		@IZ=@DBG.LZ(@ln)+@USR.LZ(@ln)+@L.Z(@ln)+@L.AZ(@ln)+@L.CLZ(@ln)+@L.QZ(@ln) // *@es.ZEX
		\_inttostr(@IX, 4, 0)($SIX)
		\_inttostr(@IY, 4, 0)($SIY)
		\_inttostr(@IZ, 4, 0)($SIZ)

		CLIPACT[TEXT=1 SET=$SIX+","+$SIY+","+$SIZ]
	}
	IFEND[]



	IF[@dbg.pushflag]
	{
		LOOP[SET=(@LMAX+1)]
		{
			@LNO=@_LC-1

			CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
			IF[@r==0 && @LNO!=@LNO_CM && @LNO!=@LNO_CMF]
			{
				LOOPCONTINUE[]
			}
			IFEND[]

			@DRAW.FLAG(@LNO)=1
		}
		LOOPEND[]

		@dbg.pushflag=0
	}
	IFEND[]




	CGINFO[ID=":W2/TAB01.OF" ONMOUSE2=2+1 LET=@col]
	IF[@col>254]
	{
		CG[ID=":W2/TAB01.OF" E=0]
		CG[ID=":W2/TAB01.OV" E=1]

		IF[@_MOUSE_L==1 || @_MOUSE_L==2]
		{
			@es.GSD(095,01)=0

			IF[@es.GSD(095,01)==0]
				CG[ID=":W2/TX01" E=1]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=0]
			ELSE[@es.GSD(095,01)==1]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=1]
				CG[ID=":W2/TX03" E=0]
			ELSE[]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=1]
			IFEND[]
		}
		IFEND[]
	}
	ELSE[@es.GSD(095,01)==0]
	{
		CG[ID=":W2/TAB01.OF" E=0]
		CG[ID=":W2/TAB01.OV" E=1]
	}
	ELSE[]
	{
		CG[ID=":W2/TAB01.OF" E=1]
		CG[ID=":W2/TAB01.OV" E=0]
	}
	IFEND[]

	CGINFO[ID=":W2/TAB02.OF" ONMOUSE2=2+1 LET=@col]
	IF[@col>254]
	{
		CG[ID=":W2/TAB02.OF" E=0]
		CG[ID=":W2/TAB02.OV" E=1]

		IF[@_MOUSE_L==1 || @_MOUSE_L==2]
		{
			@es.GSD(095,01)=1

			IF[@es.GSD(095,01)==0]
				CG[ID=":W2/TX01" E=1]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=0]
			ELSE[@es.GSD(095,01)==1]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=1]
				CG[ID=":W2/TX03" E=0]
			ELSE[]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=1]
			IFEND[]
		}
		IFEND[]
	}
	ELSE[@es.GSD(095,01)==1]
	{
		CG[ID=":W2/TAB02.OF" E=0]
		CG[ID=":W2/TAB02.OV" E=1]
	}
	ELSE[]
	{
		CG[ID=":W2/TAB02.OF" E=1]
		CG[ID=":W2/TAB02.OV" E=0]
	}
	IFEND[]

	CGINFO[ID=":W2/TAB03.OF" ONMOUSE2=2+1 LET=@col]
	IF[@col>254]
	{
		CG[ID=":W2/TAB03.OF" E=0]
		CG[ID=":W2/TAB03.OV" E=1]

		IF[@_MOUSE_L==1 || @_MOUSE_L==2]
		{
			@es.GSD(095,01)=2

			IF[@es.GSD(095,01)==0]
				CG[ID=":W2/TX01" E=1]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=0]
			ELSE[@es.GSD(095,01)==1]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=1]
				CG[ID=":W2/TX03" E=0]
			ELSE[]
				CG[ID=":W2/TX01" E=0]
				CG[ID=":W2/TX02" E=0]
				CG[ID=":W2/TX03" E=1]
			IFEND[]
		}
		IFEND[]
	}
	ELSE[@es.GSD(095,01)==2]
	{
		CG[ID=":W2/TAB03.OF" E=0]
		CG[ID=":W2/TAB03.OV" E=1]
	}
	ELSE[]
	{
		CG[ID=":W2/TAB03.OF" E=1]
		CG[ID=":W2/TAB03.OV" E=0]
	}
	IFEND[]


}
IFEND[]

		//-------------------------------------------------------------------------
		// ムービースプライト処理
		//-------------------------------------------------------------------------
	//	GOSUB[#=es.L.YMV.MAIN]
		LOOP[SET=(@LMAX+1)]
		{
			IF[@L.FTYPE(@_LC-1)==6] @DRAW.FLAG(@_LC-1)=1 IFEND[]
		}
		LOOPEND[]

		//-------------------------------------------------------------------------
		// 立ち絵アニメーション処理
		//-------------------------------------------------------------------------
		GOSUB[#=es.L.STA.MAIN]

		//-------------------------------------------------------------------------
		// テキスト描画処理
		//-------------------------------------------------------------------------
		LOOP[SET=(@LMAX+1)]
		{
			IF[@L.TXV(@_LC-1)>0]
			{
				IF[@L.TXV(@_LC-1)>10000000]
				{
					IF[$L(@L.TXV(@_LC-1)-10000000)!=$L.TXS(@_LC-1)]
					{
						GOSUB[#=es.SP.LOADCGT PINT=@_LC-1 PINT2=@L.TXV(@_LC-1)]
						@DRAW.FLAG(@_LC-1)=1
					}
					IFEND[]
				}
				ELSE[]
				{
					IF[$G(@L.TXV(@_LC-1)         )!=$L.TXS(@_LC-1)]
					{
						GOSUB[#=es.SP.LOADCGT PINT=@_LC-1 PINT2=@L.TXV(@_LC-1)]
						@DRAW.FLAG(@_LC-1)=1
					}
					IFEND[]
				}
				IFEND[]
			}
			IFEND[]
		}
		LOOPEND[]


		//-------------------------------------------------------------------------
		// 読み込みキュー位置と書き込みキュー位置が同じか否か調べる
		//-------------------------------------------------------------------------
//		LOOP[]
		@OS_TIME = @_OS_TIME(1)

		LOOP[SET=@QUE.MAX]
		{
			@SNO=@_LC

			@LNO = @S.LNO(@SNO)

			//-------------------------------------------------------------------------
			// 停止していた時間はカウントしない
			//-------------------------------------------------------------------------
			IF[@StopFlag]
			{
				@S.TOLD(@SNO) = @OS_TIME
			}
			IFEND[]

			//-------------------------------------------------------------------------
			// カメラが演出中か、レイヤ自体が演出中か、親レイヤが演出中の子レイヤなら
			//-------------------------------------------------------------------------
		//	IF[@S.FLAG.END(@SNO)==0 || (@L.PARENT(@LNO)>0 && @S.FLAG.END( @L.PARENT(@SNO) )==0)]
			IF[@S.FLAG.END(@SNO)==0]
			{

				//----------------------------------------------------------------
				// レイヤの存在チェック
				//----------------------------------------------------------------
					CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
					IF[@r==0 && @LNO!=@LNO_CM && @LNO!=@LNO_CMF]
					{
						//レイヤないならキュー終了させる(でないとずっと残ったまま)
						//
						GOSUB[#=es.EF.END pint=@SNO pstr2=$S.SPID(@SNO)]
						LOOPCONTINUE[]
					}
					IFEND[]

				//----------------------------------------------------------------
				// 親/子レイヤ再描画フラグ
				//----------------------------------------------------------------
					IF[@L.CHILD(@LNO) >0] @DRAW.FLAG(@L.CHILD(@LNO)) =1 IFEND[] //子レイヤがあれば、子レイヤも再描画させる
					IF[@L.PARENT(@LNO)>0] @DRAW.FLAG(@L.PARENT(@LNO))=1 IFEND[] //親レイヤがあれば、親レイヤも再描画させる

				//----------------------------------------------------------------
				// 経過時間算出
				//----------------------------------------------------------------
					@mTADD = @OS_TIME - @S.TOLD(@SNO)
					@S.TOLD(@SNO) = @OS_TIME

				//----------------------------------------------------------------
				// 時間特別調整
				//----------------------------------------------------------------
			//		IF[@es.MG.AUTO==0]
				//		IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP || @es.GSD(112,01)==1)] @mTADD *= @es.GSD(120,05) IFEND[]

					IF[(@S.SK(@SNO)&1)==0] //スキップによるスキップ許可なら
						IF[@es.NGSKIP==0]
							IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)] @mTADD *= @es.GSD(120,05) IFEND[]
						IFEND[]
					IFEND[]
					IF[(@S.SK(@SNO)&2)==0] //クリックによるスキップ許可なら
						IF[@es.NGSKIP==0]
							IF[@es.TEXT.TIPCLICK==1 && @S.N(@SNO)>0] @mTADD = 999999999 IFEND[]
						IFEND[]
					IFEND[]

					IF[@es.GSD(112,01)==1 && @S.N(@SNO)>0] @mTADD = 999999999 IFEND[]

///xCOS
					//	IF[@LNO>=50 && @LNO<=70 && @es.GSD(115,01)==0] @mTADD = 999999999 IFEND[] //カットインでは瞬速スキップ
					//	IF[@LNO>=71 && @LNO<=80 && @es.GSD(110,12)==1] @mTADD = 999999999 IFEND[] //ムービーでは瞬速スキップ
					//	IF[@LNO>=81 && @LNO<=90 && @es.GSD(110,12)==0] @mTADD = 999999999 IFEND[] //ムービーでは瞬速スキップ
					//	IF[@es.COS.AUTO] @mTADD = 999999999 IFEND[]

			//		IFEND[]

					IF[@es.SP.AUTOSKIP==1]
					{
						//フリーズする
//						@mTADD *= @es.GSD(120,05)
//						@mTADD=999999999

						@S.FLAG.END(@SNO)=999
				//		GOSUB[#=es.EF.END pint=@SNO pstr2=$S.SPID(@SNO)]
					}
					IFEND[]

					IF[@es.ESCMODE || @es.HELPMODE] @mTADD=0 IFEND[]


				//----------------------------------------------------------------
				// 時間チェック
				//----------------------------------------------------------------
					@S.TNOW(@SNO) += @mTADD
//INT[@c=0]
					LOOP[SET=10000] //フリーズしないように安全弁
					{
//IF[@c>10000] @S.FLAG.END(@SNO)=999;LOOPBREAK[] IFEND[] //一応フリーズしないように安全弁
						IF[@S.TNOW(@SNO)>=@S.T(@SNO)]
						{
							@S.N(@SNO)-=1
							IF[@S.N(@SNO)!=0] //回数がまだ残っているならもう一度
								@S.TNOW(@SNO)-=@S.T(@SNO)
	//IF[@S.COM(@SNO)==@e_X] @S.TNOW(@SNO)-=500 IFEND[] //回数毎の間隔
	//IF[@S.COM(@SNO)==@e_Y] @S.TNOW(@SNO)-=1200 IFEND[] //回数毎の間隔
//@c+=1
								LOOPCONTINUE[]
							ELSE[] //終了
								@S.FLAG.END(@SNO)=999
							IFEND[]
						}
						IFEND[]

						LOOPBREAK[]
					}
					LOOPEND[]

				//----------------------------------------------------------------
				// 進捗率
				//----------------------------------------------------------------
					FLT[@Per = 1.0 * @S.TNOW(@SNO) / @S.T(@SNO)]
					IF[@S.TNOW(@SNO)<0] @Per=1.0 IFEND[]

					GOSUB[#=es.SP.ACC.GET pint=@S.AC(@SNO) pflt2=@Per]
					FLT[@PerAcc=@_RFLT(1)] //0.0〜1.0

			//		GOSUB[#="es.EF.CC.COM."+$comstr(@S.COM(@SNO)) pint=@S.I1(@SNO) pint2=@S.I2(@SNO) pflt3=@S.F1(@SNO) pflt4=@S.F2(@SNO) pint5=@S.AC(@SNO) pflt6=@PerAcc pint7=@S.I3(@SNO)]
					GOSUB[#="es.EF.CC.COM."+$comstr(@S.COM(@SNO)) pint=@S.I1(@SNO) pint2=@S.I2(@SNO) pflt3=@S.F1(@SNO) pflt4=@S.F2(@SNO) pint5=@S.AC(@SNO) pflt6=@PerAcc pint7=@S.I3(@SNO) pint8=@S.T(@SNO)]
					INT[@PI  = @_RFLT(1)]
					FLT[@PF  = @_RFLT(2)]
					FLT[@PQX = @_RFLT(3)]
					FLT[@PQY = @_RFLT(4)]
					FLT[@PQZ = @_RFLT(5)]
					INT[@PMD = @_RINT(6)]
					FLT[@PCL = @_RFLT(7)]
					GOSUB[#="es.EF.COM."+$comstr(@S.COM(@SNO)) pint=@PI pflt2=@PF pflt3=@PCL pflt4=@PQX pflt5=@PQY pflt6=@PQZ pint7=@PMD]

					@DRAW.FLAG(@LNO)=1 //途中描画
			}
			IFEND[]

			//----------------------------------------------------------------
			// 演出終了チェック
			//----------------------------------------------------------------
			IF[@S.FLAG.END(@SNO)==999]
			{
				GOSUB[#=es.EF.END pint=@SNO pstr2=$S.SPID(@SNO)]

				@DRAW.FLAG(@LNO)=2 //最終描画
			}
			IFEND[]
		}
		LOOPEND[]//キュー

		//-------------------------------------------------------------------------
		// 描画
		//-------------------------------------------------------------------------
		LOOP[SET=(@LMAX)]
		{
			IF[@DRAW.FLAG(@_LC)==1]
				GOSUB[#=es.SP.DRAW pint=@_LC pint2=0 pint3=@DIR_CAMERA] //pint2=0→描画途中フラグ
			ELSE[@DRAW.FLAG(@_LC)==2]
				GOSUB[#=es.SP.DRAW pint=@_LC pint2=1 pint3=@DIR_CAMERA] //pint2=1→最終描画フラグ
			IFEND[]
		}
		LOOPEND[]

		//-------------------------------------------------------------------------
		// POST描画
		//-------------------------------------------------------------------------
		GOSUB[#=es.SP.DRAW.POST]

		//-------------------------------------------------------------------------
		// 初期化
		//-------------------------------------------------------------------------
		LOOP[SET=(@LMAX+1)]
		{
			@DRAW.FLAG(@_LC-1)=0
		}
		LOOPEND[]

		@StopFlag=0

		LOOPBREAK[]
	}
	LOOPEND[]

//	}
//	IFEND[]

	return[]
}


#=es.EF.TASK.MAIN.DRAW
{
	//-------------------------------------------------------------------------
	// 描画
	//-------------------------------------------------------------------------
	@DIR_CAMERA=1
	LOOP[SET=(@LMAX)]
	{
		IF[@DRAW.FLAG(@_LC)==1]
			GOSUB[#=es.SP.DRAW pint=@_LC pint2=0 pint3=@DIR_CAMERA] //pint2=0→描画途中フラグ
		ELSE[@DRAW.FLAG(@_LC)==2]
			GOSUB[#=es.SP.DRAW pint=@_LC pint2=1 pint3=@DIR_CAMERA] //pint2=1→最終描画フラグ
		IFEND[]

	}
	LOOPEND[]

	//-------------------------------------------------------------------------
	// POST描画
	//-------------------------------------------------------------------------
	GOSUB[#=es.SP.DRAW.POST]

	//-------------------------------------------------------------------------
	// 初期化
	//-------------------------------------------------------------------------
	LOOP[SET=(@LMAX+1)]
	{
		@DRAW.FLAG(@_LC-1)=0
	}
	LOOPEND[]

	return[]
}


//■計算
//@S.I1(@SNO), @S.I2(@SNO), @S.F1(@SNO), @S.F2(@SNO), @S.AC(@SNO), @PerACC
//@_PINT(1)    @_PINT(2)    @_PFLT(3)    @_PFLT(4)    @_PINT(5)    @_PFLT(6)
//
#=es.EF.CC.COM.CG
#=es.EF.CC.COM.MV
#=es.EF.CC.COM.ECG
#=es.EF.CC.COM.TXG
#=es.EF.CC.COM.TXL
#=es.EF.CC.COM.ANLP
#=es.EF.CC.COM.TR
#=es.EF.CC.COM.MP
#=es.EF.CC.COM.BL

#=es.EF.CC.COM.HOR
#=es.EF.CC.COM.VER
#=es.EF.CC.COM.MONO

#=es.EF.CC.COM.EM_VO
#=es.EF.CC.COM.EM_VAR
#=es.EF.CC.COM.EM_TLP
#=es.EF.CC.COM.EM_TLS
#=es.EF.CC.COM.EM_TLPA
#=es.EF.CC.COM.EM_TLSA

#=es.EF.CC.COM.SK
#=es.EF.CC.COM.MX
#=es.EF.CC.COM.MY
#=es.EF.CC.COM.MZ
#=es.EF.CC.COM.NOP
#=es.EF.CC.COM.END	{ return[] }
#=es.EF.CC.COM.A
#=es.EF.CC.COM.F1
#=es.EF.CC.COM.F2
#=es.EF.CC.COM.RX
#=es.EF.CC.COM.RY
#=es.EF.CC.COM.RZ
#=es.EF.CC.COM.BX
#=es.EF.CC.COM.BY
#=es.EF.CC.COM.H
#=es.EF.CC.COM.TP
#=es.EF.CC.COM.V
#=es.EF.CC.COM.W
#=es.EF.CC.COM.X
#=es.EF.CC.COM.Y
#=es.EF.CC.COM.Z
#=es.EF.CC.COM.SD

#=es.EF.CC.COM.AKA
#=es.EF.CC.COM.MOSA
#=es.EF.CC.COM.BLUR
#=es.EF.CC.COM.DIFF
#=es.EF.CC.COM.WPL
#=es.EF.CC.COM.ROT
#=es.EF.CC.COM.RAS
#=es.EF.CC.COM.REV
{
	GOSUB[#=es.SP.VAL.GET pflt=@_PINT(1) pflt2=@_PINT(2) pflt3=@_PFLT(6)];FLT[@PF1=@_RFLT(1)]
	GOSUB[#=es.SP.VAL.GET pflt=@_PFLT(3) pflt2=@_PFLT(4) pflt3=@_PFLT(6)];FLT[@PF2=@_RFLT(1)]
	return[rflt=@PF1 rflt2=@PF2 rflt3=0 rflt4=0 rflt5=0 rint6=0 rflt7=0]
}
#=es.EF.CC.COM.MD
{
	GOSUB[#=es.SP.MEIDO.VAL.GET pint=@_PINT(1) pint2=@_PINT(2) pflt3=@_PFLT(6)]
	return[rflt=0 rflt2=0 rflt3=0 rflt4=0 rflt5=0 rint6=@_RINT(1) rflt7=0]
}
#=es.EF.CC.COM.QX
{
	GOSUB[#=es.SP.QUAKE.VAL.GET pint=@_PINT(1) pflt2=@_PFLT(6) pint3=@_PINT(5)]
	return[rflt=0 rflt2=0 rflt3=@_RFLT(1) rflt4=0 rflt5=0 rint6=0 rflt7=0]
}
#=es.EF.CC.COM.QY
{
	GOSUB[#=es.SP.QUAKE.VAL.GET pint=@_PINT(1) pflt2=@_PFLT(6) pint3=@_PINT(5)]
	return[rflt=0 rflt2=0 rflt3=0 rflt4=@_RFLT(1) rflt5=0 rint6=0 rflt7=0]
}
#=es.EF.CC.COM.QZ
{
	GOSUB[#=es.SP.QUAKE.VAL.GET pint=@_PINT(1) pflt2=@_PFLT(6) pint3=@_PINT(5)]
	return[rflt=0 rflt2=0 rflt3=0 rflt4=0 rflt5=@_RFLT(1) rint6=0 rflt7=0]
}
#=es.EF.CC.COM.PXY
{
	FLT[@pasttime = @_PINT(8) * @_PFLT(6)]
	GOSUB[#=SP.SPLN.XYZ.GET pflt=@pasttime]	@L.X(@LNO) = @_RFLT(1);@L.Y(@LNO) = @_RFLT(2)	//経過時間から、その時点のXYZ座標を取得する
	return[]
}
#=es.EF.CC.COM.PXYZ
{
	FLT[@pasttime = @_PINT(8) * @_PFLT(6)]
	GOSUB[#=SP.SPLN.XYZ.GET pflt=@pasttime]	@L.X(@LNO) = @_RFLT(1);@L.Y(@LNO) = @_RFLT(2);@L.Z(@LNO) = @_RFLT(3)	//経過時間から、その時点のXYZ座標を取得する
	return[]
}
#=es.EF.CC.COM.CLBX
#=es.EF.CC.COM.CLBY
#=es.EF.CC.COM.CLA
#=es.EF.CC.COM.CLH
#=es.EF.CC.COM.CLTP
#=es.EF.CC.COM.CLV
#=es.EF.CC.COM.CLW
#=es.EF.CC.COM.CLX
#=es.EF.CC.COM.CLY
#=es.EF.CC.COM.CLZ
#=es.EF.CC.COM.CLRX
#=es.EF.CC.COM.CLRY
#=es.EF.CC.COM.CLRZ
{
	FLT[@PCL]
	IF[@_PINT(7)==0] GOSUB[#=es.SP.CYCLE.VAL.GET pflt=@_PFLT(6) pint2= 0];@PCL=@_PINT(1)*(  @_RFLT(1))/2.0 IFEND[] //中央スタート
	IF[@_PINT(7)==1] GOSUB[#=es.SP.CYCLE.VAL.GET pflt=@_PFLT(6) pint2=90];@PCL=@_PINT(1)*(1-@_RFLT(1))/2.0 IFEND[] //端スタート
	return[rflt=0 rflt2=0 rflt3=0 rflt4=0 rflt5=0 rint6=0 rflt7=@PCL]
}




//■計算２
#=es.EF.COM.CG		{ IF[@L.ANLOOP(@LNO)<=0] @S.FLAG.END(@SNO)=999 IFEND[];return[] }
#=es.EF.COM.MV		{ IF[@L.ANLOOP(@LNO)<=0] @S.FLAG.END(@SNO)=999 IFEND[];return[] }
#=es.EF.COM.ECG
#=es.EF.COM.TXG
#=es.EF.COM.TXL
#=es.EF.COM.ANLP
#=es.EF.COM.TR
#=es.EF.COM.MP
#=es.EF.COM.BL

#=es.EF.COM.HOR
#=es.EF.COM.VER
#=es.EF.COM.MONO

#=es.EF.COM.MX
#=es.EF.COM.MY
#=es.EF.COM.MZ
#=es.EF.COM.SK		{ @S.FLAG.END(@SNO)=999;return[] }
#=es.EF.COM.PXY
{
	FLT[@tmplx]FLT[@tmply]//FLT[@tmplz]
	FLT[@tmpclx]FLT[@tmpcly]//FLT[@tmpclz]
	FLT[@lux]FLT[@luy]
	FLT[@zx]FLT[@zy]

	IF[@es.GSD(094,01)]
	{
		@tmplx = @L.X(@LNO)
		@tmply = @L.Y(@LNO)
//		@tmplz = @L.Z(@LNO)
		@tmpclx = @L.CLX(@LNO)
		@tmpcly = @L.CLY(@LNO)
//		@tmpclz = @L.CLZ(@LNO)

		LOOP[SET=@SPLN.PXNUM(@SNO)]
		{
			@L.X(@LNO) = @SPLN.LX(@SNO,@_LC)
			@L.Y(@LNO) = @SPLN.LY(@SNO,@_LC)
//			@L.Z(@LNO) = @SPLN.LZ(@SNO,@_LC)
			@L.CLX(@LNO) = 0
			@L.CLY(@LNO) = 0
//			@L.CLZ(@LNO) = 0

			GOSUB[#=es.SP.XYZCALC pint=@LNO pint2=@LNO_BG pint3=@LNO_CM pint4=@es.GSX pint5=@es.GSY]
			@lux  = @_RFLT(1)
			@luy  = @_RFLT(2)
			@zx = @_RFLT(3)
			@zy = @_RFLT(4)

			CG[ID="SPLN"+$(@_LC) E=1 X=@lux+@L.CX(@LNO)*@zx/100-7 Y=@luy+@L.CY(@LNO)*@zy/100-7]
		}
		LOOPEND[]
		LOOP[SET=@SPLN.PXMAX-(@SPLN.PXNUM(@SNO))]
		{
			CG[ID="SPLN"+$(@SPLN.PXNUM(@SNO)+@_LC) E=0]
		}
		LOOPEND[]

		@L.X(@LNO) = @tmplx
		@L.Y(@LNO) = @tmply
//		@L.Z(@LNO) = @tmplz
		@L.CLX(@LNO) = @tmpclx
		@L.CLY(@LNO) = @tmpcly
//		@L.CLZ(@LNO) = @tmpclz
	}
	IFEND[]

	return[]
}
#=es.EF.COM.PXYZ
{
	FLT[@tmplx]FLT[@tmply]FLT[@tmplz]
	FLT[@tmpclx]FLT[@tmpcly]FLT[@tmpclz]
	FLT[@lux]FLT[@luy]
	FLT[@zx]FLT[@zy]

	IF[@es.GSD(094,01)]
	{
		@tmplx = @L.X(@LNO)
		@tmply = @L.Y(@LNO)
		@tmplz = @L.Z(@LNO)
		@tmpclx = @L.CLX(@LNO)
		@tmpcly = @L.CLY(@LNO)
		@tmpclz = @L.CLZ(@LNO)

		LOOP[SET=@SPLN.PXNUM(@SNO)]
		{
			@L.X(@LNO) = @SPLN.LX(@SNO,@_LC)
			@L.Y(@LNO) = @SPLN.LY(@SNO,@_LC)
			@L.Z(@LNO) = @SPLN.LZ(@SNO,@_LC)
			@L.CLX(@LNO) = 0
			@L.CLY(@LNO) = 0
			@L.CLZ(@LNO) = 0

			GOSUB[#=es.SP.XYZCALC pint=@LNO pint2=@LNO_BG pint3=@LNO_CM pint4=@es.GSX pint5=@es.GSY]
			@lux  = @_RFLT(1)
			@luy  = @_RFLT(2)
			@zx = @_RFLT(3)
			@zy = @_RFLT(4)

			CG[ID="SPLN"+$(@_LC) E=1 X=@lux+@L.CX(@LNO)*@zx/100-7 Y=@luy+@L.CY(@LNO)*@zy/100-7]
		}
		LOOPEND[]
		LOOP[SET=@SPLN.PXMAX-(@SPLN.PXNUM(@SNO))]
		{
			CG[ID="SPLN"+$(@SPLN.PXNUM(@SNO)+@_LC) E=0]
		}
		LOOPEND[]

		@L.X(@LNO) = @tmplx
		@L.Y(@LNO) = @tmply
		@L.Z(@LNO) = @tmplz
		@L.CLX(@LNO) = @tmpclx
		@L.CLY(@LNO) = @tmpcly
		@L.CLZ(@LNO) = @tmpclz
	}
	IFEND[]

	return[]
}
#=es.EF.COM.NOP
#=es.EF.COM.END		{ return[] }
#=es.EF.COM.A		{ @L.A(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.F1		{ @L.F1(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.F2		{ @L.F2(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.RX		{ @L.RX(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.RY		{ @L.RY(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.RZ		{ @L.RZ(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.BX		{ @L.BX(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.BY		{ @L.BY(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.H		{ @L.H(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.TP		{ @L.TP(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.V		{ @L.V(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.W		{ @L.W(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.X		{ @L.X(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.Y		{ @L.Y(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.Z		{ @L.Z(@LNO)	= @_PFLT(2);return[] }
#=es.EF.COM.CLBX	{ @L.CLBX(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLBY	{ @L.CLBY(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLA		{ @L.CLA(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLH		{ @L.CLH(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLTP	{ @L.CLTP(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLV		{ @L.CLV(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLW		{ @L.CLW(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLX		{ @L.CLX(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLY		{ @L.CLY(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLZ		{ @L.CLZ(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLRX	{ @L.CLRX(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLRY	{ @L.CLRY(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.CLRZ	{ @L.CLRZ(@LNO)	= @_PFLT(3);return[] }
#=es.EF.COM.QX		{ @L.QX(@LNO)	= @_PFLT(4);return[] }
#=es.EF.COM.QY		{ @L.QY(@LNO)	= @_PFLT(5);return[] }
#=es.EF.COM.QZ		{ @L.QZ(@LNO)	= @_PFLT(6);return[] }
#=es.EF.COM.SD		{ @L.SD(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.MD		{ @L.MD(@LNO)	= @_PINT(7);return[] }

#=es.EF.COM.AKA		{ @L.AKA(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.MOSA	{ @L.MOSA(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.BLUR	{ @L.BLUR(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.DIFF	{ @L.DIFF(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.WPL		{ @L.WPL(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.ROT		{ @L.ROT(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.RAS		{ @L.RAS(@LNO)	= @_PINT(1);return[] }
#=es.EF.COM.REV		{ @L.REV(@LNO)	= @_PINT(1);return[] }

#=es.EF.COM.EM_VO	{ return[] }
#=es.EF.COM.EM_VAR	{ return[] }
#=es.EF.COM.EM_TLP	{ return[] }
#=es.EF.COM.EM_TLS	{ return[] }
#=es.EF.COM.EM_TLPA	{ return[] }
#=es.EF.COM.EM_TLSA	{ return[] }


//----------------------------------------------------------------------------
//■STF監視タスク
//----------------------------------------------------------------------------
#=es.STF.CHECK
{
	INT[@ret]
	LOOP[SET=@QUE.MAX]
	{
		IF[@S.FLAG(@_LC)==4 && @S.COM(@_LC)==@e_F2] @ret=1 IFEND[]
	}
	LOOPEND[]

	return[rint=@ret]
}


//----------------------------------------------------------------------------
//■初期化
//----------------------------------------------------------------------------
#=es.EF.INIT
{
	INT[@LNO=0]

	INT[@shinki]

	FLT[@xx]
	FLT[@yy]
	FLT[@zz]

//\_dmes(es.EF.INIT)

	//----------------------------------------------------------------
	// レイヤ存在チェック
	//----------------------------------------------------------------
	/*
		CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
		IF[@r==0 && @LNO!=@LNO_CM] ///x
		{
		//	IFBREAK[LV=2]
			\_mes("レイヤ "+$(@LNO)+" の演出を開始しようとしましたが、この時点でレイヤ "+$(@LNO)+" が存在しませんでした。"+\_R+\_R+"確認をお願いします。", "エラー");END[]
		}
		IFEND[]
	*/

	//----------------------------------------------------------------
	// 各種値セット
	//----------------------------------------------------------------
		@S.FLAG(@SNO)		= 4
		@S.FLAG.END(@SNO)	= 0

		IF[@S.T(@SNO)==0] @S.T(@SNO)=1 IFEND[]


			//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
			GOSUB[#=es.LNO.GET pstr=$S.SPID(@SNO)];@LNO=@_RINT(1)

			IF[@S.COM(@SNO)==@e_CG || @S.COM(@SNO)==@e_MV || @S.COM(@SNO)==@e_ECG]
//				IF[@LNO==0] @shinki=1;GOSUB[#=es.SP.SPID.EMPTYGET];@LNO=@_RINT(1) IFEND[]	//空いているレイヤ番号を取得
				IF[@LNO==0] @shinki=1;GOSUB[#=es.LNO.GET pstr=""];@LNO=@_RINT(1) IFEND[]	//空いているレイヤ番号を取得
			IFEND[]

			@S.LNO(@SNO)	= @LNO


		IF[@S.COM(@SNO)==@e_CG || @S.COM(@SNO)==@e_MV]
		{
//			@LNO = @S.LNO(@SNO)

		//	GOSUB[#=es.SP.INFO.INIT pint=@LNO]
		//	\SP.DEL( $L.SPID(@LNO) )

			@L.FTYPE(@LNO)	= @S.FTYPE(@SNO)
			$L.SPID(@LNO)	= $S.SPID(@SNO)
			$L.FCG(@LNO)	= $S.FCG(@SNO)

			//一応.
			@L.ANFLAG(@LNO)	= 0
			@L.ANX(@LNO)	= 0
			@L.ANY(@LNO)	= 0
			@L.ANNUM(@LNO)	= 0
			@L.ANTIME(@LNO)	= 0
			@L.ANSTOP(@LNO)	= 99999
			@L.ANLOOP(@LNO)	= 0
			@L.ANC(@LNO)	= 0
			@L.ANC2(@LNO)	= 0
			@L.ANC3(@LNO)	= 0
			@L.ANC4(@LNO)	= 0

			IF[@S.FTYPE(@SNO)==5] //立ち絵の場合
			{

					IF[@shinki==0] //画像切替
					{

							@L.ST(@LNO) = 1 //遷移モード開始

							IF[$L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF"] GOSUB[#=es.SP.LOADCGF PINT=@LNO PINT2=@S.I3(@SNO)] IFEND[]

							//----------------------------------------------------------------
							// 遷移合成出力先レイヤとして生成しておく
							//----------------------------------------------------------------
							INT[@sx]INT[@sy]
							CGINFO[ID=$LIDBUF2+$(1+@LNO*100) SX=1 LET=@sx]
							CGINFO[ID=$LIDBUF2+$(1+@LNO*100) SY=1 LET=@sy]
							IF[@sx==0] @sx=1 IFEND[]
							IF[@sy==0] @sy=1 IFEND[]
							CG[ID=$LID+$(1+@LNO*100) Z=1 SX=@sx SY=@sy A=0 FILE=""]
							CGACT[ID=$LID+$(1+@LNO*100) RECTPAINT3=1 SET=0x00000000]

					}
					ELSE[] //新規読込
					{

							IF[@ST.Z.MODE==0] //Zカウント方式
							{
								@es.LSD(092,01)+=1
								@L.LZCNT(@LNO) = @es.LSD(092,01)
								IF[@es.LSD(092,01)>999] \_mes("スプライトZカウントが1000に到達しました。どこかで \\BG,\\EV,\\FOUT,\\FIN 命令を使用してください。");END[] IFEND[]
								//\_dmes("Zカウント="+$(@L.LZCNT(@LNO)))
							}
							IFEND[]

							IF[$L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF"]
							{
								GOSUB[#=es.SP.LOADCG PINT=@LNO PINT2=@S.SDMD.NA(@SNO) PINT3=@S.I3(@SNO)] //pint2→彩度明度無効フラグ
								IF[@S.I3(@SNO)>0] //通常アニメなら
								{
									@L.ANNUM(@LNO)	= @S.I3(@SNO)
									@L.ANTIME(@LNO)	= @S.T(@SNO)
									@L.ANSTOP(@LNO)	= 0
									@L.ANLOOP(@LNO)	= @S.N(@SNO)
									@L.ANC(@LNO)	= 1
									@L.YMTIME(@LNO)	= @_OS_TIME(1)

									//初期化しちゃう
									@S.I3(@SNO)=0
									@S.T(@SNO)=1
									@S.N(@SNO)=0
								}
								IFEND[]
								IF[@S.I3(@SNO)==-1] //パターンアニメ(=-1)なら
								{
									//初期化しちゃう
									@S.I3(@SNO)=0
									@S.T(@SNO)=1
									@S.N(@SNO)=0
								}
								IFEND[]
							}
							IFEND[]

							//親子レイヤ情報セット
							@L.PARENT(@LNO) = 0
							@L.CHILD(@LNO)  = 0
					}
					IFEND[]

			}
			ELSE[] //それ以外の場合
			{

					@L.TIP(@LNO)	= @S.TIP(@SNO)

					@L.F1(@LNO)		= 256

//							IF[@ST.Z.MODE==0] //Zカウント方式
							{
								@es.LSD(092,01)+=1
								@L.LZCNT(@LNO) = @es.LSD(092,01)
								IF[@es.LSD(092,01)>999] \_mes("スプライトZカウントが1000に到達しました。どこかで \\BG,\\EV,\\FOUT,\\FIN 命令を使用してください。");END[] IFEND[]
								//\_dmes("Zカウント="+$(@L.LZCNT(@LNO)))
							}
//							IFEND[]


					IF[@S.COM(@SNO)==@e_CG]
					{
							IF[$L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF"]
							{
								GOSUB[#=es.SP.LOADCG PINT=@LNO PINT2=@S.SDMD.NA(@SNO) PINT3=@S.I3(@SNO)] //pint2→彩度明度無効フラグ pint3→アニメ枚数
								IF[@S.I3(@SNO)>0] //通常アニメなら
								{
									@L.ANNUM(@LNO)	= @S.I3(@SNO)
									@L.ANTIME(@LNO)	= @S.T(@SNO)
									@L.ANSTOP(@LNO)	= 0
									@L.ANLOOP(@LNO)	= @S.N(@SNO)
									@L.ANC(@LNO)	= 1
									@L.YMTIME(@LNO)	= @_OS_TIME(1)

									//初期化しちゃう
									@S.I3(@SNO)=0
									@S.T(@SNO)=1
									@S.N(@SNO)=0
								}
								IFEND[]
								IF[@S.I3(@SNO)==-1] //パターンアニメ(=-1)なら
								{
									//初期化しちゃう
									@S.I3(@SNO)=0
									@S.T(@SNO)=1
									@S.N(@SNO)=0
								}
								IFEND[]
							}
							IFEND[]
					}
					ELSE[@S.COM(@SNO)==@e_MV]
					{
							GOSUB[#=es.L.YMV.INIT pint=@LNO]
							@L.ANSTOP(@LNO)	= 0
					}
					IFEND[]


					//親子レイヤチェック
					IF[@L.CHILD(@LNO)>0] \SP.DEL( $L.SPID(@L.CHILD(@LNO)) ) IFEND[] //もし子レイヤがあったなら消しておく
					IF[@L.CHILD(@L.PARENT(@LNO))] \_mes("指定した親レイヤには、すでに子レイヤが設定されています。"+$(@L.CHILD(@L.PARENT(@LNO))));END[] IFEND[]

					//親子レイヤ情報セット
					@L.PARENT(@LNO) = 0
					@L.CHILD(@LNO)  = 0
					IF[$S.PARENT(@SNO)!=""]
					{
						//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
						GOSUB[#=es.LNO.GET pstr=$S.PARENT(@SNO)]	//$S.PARENT(@SNO) から @L.PARENT(@LNO) 取得
						@L.PARENT(@LNO) = @_RINT(1)

						//親レイヤのほうに子レイヤ情報を教えておく.
						IF[@L.PARENT(@LNO)>0] @L.CHILD(@L.PARENT(@LNO)) = @LNO IFEND[]

		//\_dmes("PARENTID="+$S.PARENT(@SNO)+" LNO="+$(@plno))
		//\_dmes("["+$(@LNO)+"] PARENT="+$(@L.PARENT(@LNO))+" CHILD="+$(@L.CHILD(@LNO)) )
					}
					IFEND[]


					//もう演出終了しちゃっていい
			//		GOSUB[#=es.EF.END pint=@SNO pstr2=$S.SPID(@SNO)]
			//		@DRAW.FLAG(@LNO)=0
				//	@S.FLAG(@SNO) = 1
				//	GOSUB[#=es.SP.QUE.INIT.ONE pint=@SNO]
				//	@S.FLAG(@SNO)		= 0
				//	@S.FLAG.END(@SNO)	= 1

			}
			IFEND[]

		}
		ELSE[@S.COM(@SNO)==@e_ECG ]
		{
			@L.FTYPE(@LNO)	= @S.FTYPE(@SNO)
			$L.SPID(@LNO)	= $S.SPID(@SNO)
			$L.FCG(@LNO)	= $S.FCG(@SNO)

			//一応.
			@L.ANFLAG(@LNO)	= 0
			@L.ANX(@LNO)	= 0
			@L.ANY(@LNO)	= 0
			@L.ANNUM(@LNO)	= 0
			@L.ANTIME(@LNO)	= 0
			@L.ANSTOP(@LNO)	= 99999
			@L.ANLOOP(@LNO)	= 0
			@L.ANC(@LNO)	= 0
			@L.ANC2(@LNO)	= 0
			@L.ANC3(@LNO)	= 0
			@L.ANC4(@LNO)	= 0

			@L.TIP(@LNO)	= @S.TIP(@SNO)

			@L.F1(@LNO)		= 256


//			IF[@ST.Z.MODE==0] //Zカウント方式
			{
				@es.LSD(092,01)+=1
				@L.LZCNT(@LNO) = @es.LSD(092,01)
				IF[@es.LSD(092,01)>999] \_mes("スプライトZカウントが1000に到達しました。どこかで \\BG,\\EV,\\FOUT,\\FIN 命令を使用してください。");END[] IFEND[]
				//\_dmes("Zカウント="+$(@L.LZCNT(@LNO)))
			}
//			IFEND[]


			IF[$L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF"] GOSUB[#=es.SP.LOADCGE PINT=@LNO PINT2=@S.SDMD.NA(@SNO) PINT3=@S.I2(@SNO) PINT4=@S.I3(@SNO)] IFEND[] //pint2→彩度明度無効フラグ

			//親子レイヤチェック
			IF[@L.CHILD(@LNO)>0] \SP.DEL( $L.SPID(@L.CHILD(@LNO)) ) IFEND[] //もし子レイヤがあったなら消しておく
			IF[@L.CHILD(@L.PARENT(@LNO))] \_mes("指定した親レイヤには、すでに子レイヤが設定されています。"+$(@L.CHILD(@L.PARENT(@LNO))));END[] IFEND[]

			//親子レイヤ情報セット
			@L.PARENT(@LNO) = 0
			@L.CHILD(@LNO)  = 0
			IF[$S.PARENT(@SNO)!=""]
			{
				//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
				GOSUB[#=es.LNO.GET pstr=$S.PARENT(@SNO)]	//$S.PARENT(@SNO) から @L.PARENT(@LNO) 取得
				@L.PARENT(@LNO) = @_RINT(1)

				//親レイヤのほうに子レイヤ情報を教えておく.
				IF[@L.PARENT(@LNO)>0] @L.CHILD(@L.PARENT(@LNO)) = @LNO IFEND[]
			}
			IFEND[]

		}
		ELSE[@S.COM(@SNO)==@e_TXG ]
		{
			$L.TXF(@LNO) = $S.TXF(@SNO)
			$L.TXS(@LNO) = $G(@S.I1(@SNO))
			@L.TXV(@LNO) = 00000000+@S.I1(@SNO)

			IF[$S.SPID(@SNO)!="LNO_CM" && $S.SPID(@SNO)!="LNO_CMF"] GOSUB[#=es.SP.LOADCGT PINT=@LNO PINT2=@L.TXV(@LNO)] IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_TXL ]
		{
			$L.TXF(@LNO) = $S.TXF(@SNO)
			$L.TXS(@LNO) = $L(@S.I1(@SNO))
			@L.TXV(@LNO) = 10000000+@S.I1(@SNO)

			IF[$S.SPID(@SNO)!="LNO_CM" && $S.SPID(@SNO)!="LNO_CMF"] GOSUB[#=es.SP.LOADCGT PINT=@LNO PINT2=@L.TXV(@LNO)] IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_TR  ]
		{
		//	@L.FTYPE(@LNO)	= @S.FTYPE(@SNO)

			IF[$S.SPID(@SNO)!="LNO_CM" && $S.SPID(@SNO)!="LNO_CMF"]
			{
				GOSUB[#=es.SP.LOADTR PINT=@SNO PINT2=1 PINT3=@S.I1(@SNO)] //pint2==1…反転 pint3==精度
			}
			IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_BL  ]
		{
			@L.BL(@LNO) = @S.I1(@SNO)
		}

		ELSE[@S.COM(@SNO)==@e_EM_VO ]
		{
		//	$L.EMVO(@LNO) = $S.EMVO(@SNO)

			GOSUB[#=es.EMOTE.EMVO pstr=$S.EMVO(@SNO) pstr2=$LIDBUF+$(1+@LNO*100)]

			$L.EMVO(@LNO) = $_RSTR(1)
			@L.EMVO(@LNO) = @_RINT(2)

	//		\_dmes("$VARNAME = "+$L.EMVO(@LNO)+", @CNO = "+$(@L.EMVO(@LNO)))
		}
		ELSE[@S.COM(@SNO)==@e_EM_VAR ]
		{
			$L.EMV(@LNO) = $S.EMV(@SNO)

			GOSUB[#=es.EMOTE.EMV pstr=$L.EMV(@LNO) pstr2=$LIDBUF+$(1+@LNO*100)]
		}
		ELSE[@S.COM(@SNO)==@e_EM_TLP ]
		{
	//		$L.EMP(@LNO) = $S.EMP(@SNO)
	//		GOSUB[#=es.EMOTE.EMP pstr=$L.EMP(@LNO) pstr2=$LIDBUF+$(1+@LNO*100)]

			GOSUB[#=es.EMOTE.EMP pstr=$S.EMP(@SNO) pstr2=$LIDBUF+$(1+@LNO*100)]
			$L.EMP(@LNO) = $_RSTR(1)
		}
		ELSE[@S.COM(@SNO)==@e_EM_TLS ]
		{
	//		$L.EMS(@LNO) = $S.EMS(@SNO)
	//		GOSUB[#=es.EMOTE.EMS pstr=$L.EMS(@LNO) pstr2=$LIDBUF+$(1+@LNO*100)]

			GOSUB[#=es.EMOTE.EMS pstr=$S.EMS(@SNO) pstr2=$LIDBUF+$(1+@LNO*100)]
			$L.EMS(@LNO) = $_RSTR(1)
		}
		ELSE[@S.COM(@SNO)==@e_EM_TLPA]
		{
	//		$L.EMPA(@LNO) = $S.EMPA(@SNO)
	//		GOSUB[#=es.EMOTE.EMPA pstr=$L.EMPA(@LNO) pstr2=$LIDBUF+$(1+@LNO*100)]

			GOSUB[#=es.EMOTE.EMPA pstr=$S.EMPA(@SNO) pstr2=$LIDBUF+$(1+@LNO*100)]
			$L.EMPA(@LNO) = $_RSTR(1)
		}
		ELSE[@S.COM(@SNO)==@e_EM_TLSA]
		{
	//		$L.EMSA(@LNO) = $S.EMSA(@SNO)
	//		GOSUB[#=es.EMOTE.EMSA pstr=$L.EMSA(@LNO) pstr2=$LIDBUF+$(1+@LNO*100)]

			GOSUB[#=es.EMOTE.EMSA pstr=$S.EMSA(@SNO) pstr2=$LIDBUF+$(1+@LNO*100)]
			$L.EMSA(@LNO) = $_RSTR(1)
		}

		ELSE[@S.COM(@SNO)==@e_HOR ]
		{
			@L.HOR(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_VER ]
		{
			@L.VER(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_MONO]
		{
			@L.MONO(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_AKA ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.AKA(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.AKA(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_MOSA]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.MOSA(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.MOSA(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_BLUR]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.BLUR(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.BLUR(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_DIFF]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.DIFF(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.DIFF(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_WPL]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.WPL(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.WPL(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_ROT ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.ROT(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.ROT(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_RAS ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.RAS(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.RAS(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_REV ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.REV(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.REV(@LNO) IFEND[]
		}

		ELSE[@S.COM(@SNO)==@e_ANLP]
		{
			@L.ANLOOP(@LNO) = @S.I1(@SNO)
		}
//		ELSE[@S.COM(@SNO)==@e_SK  ]
//		{
//		}
		ELSE[@S.COM(@SNO)==@e_MX  ]
		{
			@L.MX(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_MY  ]
		{
			@L.MY(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_MZ  ]
		{
			@L.MZ(@LNO) = @S.I1(@SNO)
		}
		ELSE[@S.COM(@SNO)==@e_A   ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.A(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.A(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_F1  ]
		{
			//立ち絵新規読込時、かつフェード値設定時はAを自動で256にする.
			IF[@L.F1(@LNO)<256] @L.A(@LNO) = 256 IFEND[]

			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.F1(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.F1(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_F2  ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.F2(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.F2(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_H   ]
		{
			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.H(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.H(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_TP  ]
		{
			//\FIN専用
			IF[@S.I3(@SNO)==1] GOSUB[#=es.SP.LOADTR.REV PINT=@SNO] IFEND[] //反転処理

			IF[@S.I1(@SNO)==@es.ZVAL || @S.I1(@SNO)==@es.SVAL] @S.I2(@SNO) += @L.TP(@LNO)*(@S.I1(@SNO)==@es.SVAL);@S.I1(@SNO) = @L.TP(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_RX  ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.RX(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.RX(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_RY  ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.RY(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.RY(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_RZ  ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.RZ(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.RZ(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_BX  ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.BX(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.BX(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_BY  ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.BY(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.BY(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_V   ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.V(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.V(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_W   ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.W(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.W(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_X   ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.X(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.X(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_Y   ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.Y(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.Y(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_Z   ]
		{
			IF[@S.F1(@SNO)==@es.ZVAL || @S.F1(@SNO)==@es.SVAL] @S.F2(@SNO) += @L.Z(@LNO)*(@S.F1(@SNO)==@es.SVAL);@S.F1(@SNO) = @L.Z(@LNO) IFEND[]
		}
		ELSE[@S.COM(@SNO)==@e_PXY  ]
		{
			@SPLN.PXNUM(@SNO) = @S.L4(@SNO)

			IF[@S.F1(@SNO)==@es.SVAL]
			{
				@S.L1(@SNO,0)=0
				@S.L2(@SNO,0)=0
	//			@S.L3(@SNO,0)=0
				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@xx+=@S.L1(@SNO,@_LC-1)
					@yy+=@S.L2(@SNO,@_LC-1)
	//				@zz+=@S.L3(@SNO,@_LC-1)
					@S.L1(@SNO,@_LC-1)=@xx
					@S.L2(@SNO,@_LC-1)=@yy
	//				@S.L3(@SNO,@_LC-1)=@zz
				LOOPEND[]

				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@S.L1(@SNO,@_LC-1)+=@L.X(@LNO)
					@S.L2(@SNO,@_LC-1)+=@L.Y(@LNO)
	//				@S.L3(@SNO,@_LC-1)+=@L.Z(@LNO)
				LOOPEND[]
			}
			ELSE[@S.F1(@SNO)==@es.S2VAL]
			{
				@S.L1(@SNO,0)=0
				@S.L2(@SNO,0)=0
	//			@S.L3(@SNO,0)=0
				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@S.L1(@SNO,@_LC-1)+=@L.X(@LNO)
					@S.L2(@SNO,@_LC-1)+=@L.Y(@LNO)
	//				@S.L3(@SNO,@_LC-1)+=@L.Z(@LNO)
				LOOPEND[]
			}
			ELSE[@S.F1(@SNO)==@es.ZVAL]
			{
				@S.L1(@SNO,0)=@L.X(@LNO)
				@S.L2(@SNO,0)=@L.Y(@LNO)
	//			@S.L3(@SNO,0)=@L.Z(@LNO)
				@S.L1(@SNO,1)=@L.X(@LNO)
				@S.L2(@SNO,1)=@L.Y(@LNO)
	//			@S.L3(@SNO,1)=@L.Z(@LNO)
			}
			IFEND[]

			LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
				@SPLN.LX(@SNO,@_LC-1)=@S.L1(@SNO,@_LC-1)
				@SPLN.LY(@SNO,@_LC-1)=@S.L2(@SNO,@_LC-1)
	//			@SPLN.LZ(@SNO,@_LC-1)=@S.L3(@SNO,@_LC-1)
			LOOPEND[]

			@SPLN.LX(@SNO,0)=@L.X(@LNO)
			@SPLN.LY(@SNO,0)=@L.Y(@LNO)
	//		@SPLN.LZ(@SNO,0)=@L.Z(@LNO)
			GOSUB[#=SP.SPLN.INIT pint=@S.T(@SNO) pint2=@SNO]

		}
		ELSE[@S.COM(@SNO)==@e_PXYZ ]
		{
			@SPLN.PXNUM(@SNO) = @S.L4(@SNO)

			IF[@S.F1(@SNO)==@es.SVAL]
			{
				@S.L1(@SNO,0)=0
				@S.L2(@SNO,0)=0
				@S.L3(@SNO,0)=0
				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@xx+=@S.L1(@SNO,@_LC-1)
					@yy+=@S.L2(@SNO,@_LC-1)
					@zz+=@S.L3(@SNO,@_LC-1)
					@S.L1(@SNO,@_LC-1)=@xx
					@S.L2(@SNO,@_LC-1)=@yy
					@S.L3(@SNO,@_LC-1)=@zz
				LOOPEND[]

				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@S.L1(@SNO,@_LC-1)+=@L.X(@LNO)
					@S.L2(@SNO,@_LC-1)+=@L.Y(@LNO)
					@S.L3(@SNO,@_LC-1)+=@L.Z(@LNO)
				LOOPEND[]
			}
			ELSE[@S.F1(@SNO)==@es.S2VAL]
			{
				@S.L1(@SNO,0)=0
				@S.L2(@SNO,0)=0
				@S.L3(@SNO,0)=0
				LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
					@S.L1(@SNO,@_LC-1)+=@L.X(@LNO)
					@S.L2(@SNO,@_LC-1)+=@L.Y(@LNO)
					@S.L3(@SNO,@_LC-1)+=@L.Z(@LNO)
				LOOPEND[]
			}
			ELSE[@S.F1(@SNO)==@es.ZVAL]
			{
				@S.L1(@SNO,0)=@L.X(@LNO)
				@S.L2(@SNO,0)=@L.Y(@LNO)
				@S.L3(@SNO,0)=@L.Z(@LNO)
				@S.L1(@SNO,1)=@L.X(@LNO)
				@S.L2(@SNO,1)=@L.Y(@LNO)
				@S.L3(@SNO,1)=@L.Z(@LNO)
			}
			IFEND[]

			LOOP[SET=@SPLN.PXNUM(@SNO)+1] // スプラインデータ初期化
				@SPLN.LX(@SNO,@_LC-1)=@S.L1(@SNO,@_LC-1)
				@SPLN.LY(@SNO,@_LC-1)=@S.L2(@SNO,@_LC-1)
				@SPLN.LZ(@SNO,@_LC-1)=@S.L3(@SNO,@_LC-1)
			LOOPEND[]

			@SPLN.LX(@SNO,0)=@L.X(@LNO)
			@SPLN.LY(@SNO,0)=@L.Y(@LNO)
			@SPLN.LZ(@SNO,0)=@L.Z(@LNO)
			GOSUB[#=SP.SPLN.INIT pint=@S.T(@SNO) pint2=@SNO]

		}
		ELSE[@S.COM(@SNO)==@e_QX  ]
		ELSE[@S.COM(@SNO)==@e_QY  ]
		ELSE[@S.COM(@SNO)==@e_QZ  ]
		ELSE[@S.COM(@SNO)==@e_CLBX]
		ELSE[@S.COM(@SNO)==@e_CLBY]
		ELSE[@S.COM(@SNO)==@e_CLA ]
		ELSE[@S.COM(@SNO)==@e_CLH ]
		ELSE[@S.COM(@SNO)==@e_CLV ]
		ELSE[@S.COM(@SNO)==@e_CLW ]
		ELSE[@S.COM(@SNO)==@e_CLX ]
		ELSE[@S.COM(@SNO)==@e_CLY ]
		ELSE[@S.COM(@SNO)==@e_CLZ ]
		ELSE[@S.COM(@SNO)==@e_CLRZ]
		ELSE[@S.COM(@SNO)==@e_SD  ]
		ELSE[@S.COM(@SNO)==@e_MD  ]
		ELSE[@S.COM(@SNO)==@e_FIN ]
		IFEND[]


	//画像読込後におくこと.
		@S.TOLD(@SNO)		= @_OS_TIME(1)


	return[]
}


//----------------------------------------------------------------------------
//■演出終了
//----------------------------------------------------------------------------
#=es.EF.END
{
	INT[@sno=@_PINT(1)]
	STR[$sid=$_PSTR(2)]

	INT[@endflag]
	STR[$endflagid]
	INT[@lno]
	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$sid];@lno=@_RINT(1)

//\_log("＠＠EF.END="+$(@sno))

//\_dmes("FLAG.END SNO="+$(@sno)+", LNO="+$(@lno)+" COM="+$(@S.COM(@sno)))

		@S.FLAG.END(@sno) = 1

		IF[@S.QNO2(@sno)<=@COMQNOR(@S.COM(@sno))]
		{
			@COMQNOR(@S.COM(@sno))=@S.QNO2(@sno)+1
		}
		IFEND[]

		IF[@S.COM(@sno)==@e_CG  ] IFEND[]
		IF[@S.COM(@sno)==@e_TR  ] IFEND[]
		IF[@S.COM(@sno)==@e_BL  ] IFEND[]

		IF[@S.COM(@sno)==@e_HOR ] IFEND[]
		IF[@S.COM(@sno)==@e_VER ] IFEND[]
		IF[@S.COM(@sno)==@e_MONO] IFEND[]
		IF[@S.COM(@sno)==@e_AKA ] @L.AKA(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_MOSA] @L.MOSA(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_BLUR] @L.BLUR(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_DIFF] @L.DIFF(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_WPL ] @L.WPL(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_ROT ] @L.ROT(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_RAS ] @L.RAS(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_REV ] @L.REV(@lno)  = @S.I2(@sno) IFEND[]

		IF[@S.COM(@sno)==@e_SK  ] IFEND[]
		IF[@S.COM(@sno)==@e_NOP ] IFEND[]
		IF[@S.COM(@sno)==@e_END ] @endflag=1;$endflagid=$L.SPID(@lno);IFEND[]
		IF[@S.COM(@sno)==@e_F2  ]
		{
		//	@L.F2(@lno)  = @S.I2(@sno)
			@L.F2(@lno)  = 0

			//立ち絵切り替え完了なら、バッファへコピー
			IF[@L.ST(@lno)]
			{
				GOSUB[#=es.SP.INFO.CHANGE pint=@lno]
				@L.ST(@lno) = 0
			}
			IFEND[]

			//子レイヤ削除
			IF[@L.CHILD(@lno)>0] \SP.DEL( $L.SPID(@L.CHILD(@lno)) ) IFEND[] //もし子レイヤがあったなら消しておく

			CGEND[ID=$LIDBUF2+$(1+@LNO*100+@L.ANC2(@LNO))]
			CGEND[ID=$LIDBUF3+$(1+@LNO*100+@L.ANC2(@LNO))]

/*
			IF[@L.CHILD(@L.PARENT(@lno))]
			{
				\_mes("指定した親レイヤには、すでに子レイヤが設定されています。"+$(@L.CHILD(@L.PARENT(@LNO))))
				END[]
			}
			IFEND[]
*/
		}
		IFEND[]
		IF[@S.COM(@sno)==@e_A   ] @L.A(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_F1  ] @L.F1(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_RX  ] @L.RX(@lno) = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_RY  ] @L.RY(@lno) = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_RZ  ] @L.RZ(@lno) = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_BX  ] @L.BX(@lno) = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_BY  ] @L.BY(@lno) = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_H   ] @L.H(@lno)  = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_TP  ] @L.TP(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_V   ] @L.V(@lno)  = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_W   ] @L.W(@lno)  = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_X   ] @L.X(@lno)  = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_Y   ] @L.Y(@lno)  = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_Z   ] @L.Z(@lno)  = @S.F2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_SD  ] @L.SD(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_MD  ] @L.MD(@lno) = @S.I2(@sno) IFEND[]
		IF[@S.COM(@sno)==@e_MX  ] IFEND[]
		IF[@S.COM(@sno)==@e_MY  ] IFEND[]
		IF[@S.COM(@sno)==@e_MZ  ] IFEND[]
		IF[@S.COM(@sno)==@e_PXY ]
		{
			@L.X(@lno)    = @S.L1(@sno,@S.L4(@sno))
			@L.Y(@lno)    = @S.L2(@sno,@S.L4(@sno))
			@SPLINE.FLAG=0
		//	IF[@es.GSD(094,01)]
				LOOP[SET=@SPLN.PXMAX] CG[ID="SPLN"+$(@_LC) E=0] LOOPEND[]
		//	IFEND[]

			@SPLN.PXNUM(@sno) = 0
/*
			INT[@lc]
			LOOP[SET=12]
				@SPLN.LX(@sno,@_LC-1)=0
				@SPLN.LY(@sno,@_LC-1)=0
				@SPLN.LZ(@sno,@_LC-1)=0
				@lc=@_LC
				LOOP[SET=21]
					@spln.t(@sno,@lc-1,@_LC-1)=0
				LOOPEND[]
			LOOPEND[]

			LOOP[SET=3]
				@lc=@_LC
				LOOP[SET=21]
					@spln.a(@sno,@lc-1,@_LC-1)=0
					@spln.b(@sno,@lc-1,@_LC-1)=0
					@spln.c(@sno,@lc-1,@_LC-1)=0
					@spln.d(@sno,@lc-1,@_LC-1)=0
				LOOPEND[]
			LOOPEND[]
*/
		}
		IFEND[]
		IF[@S.COM(@sno)==@e_PXYZ]
		{
			@L.X(@lno)    = @S.L1(@sno,@S.L4(@sno))
			@L.Y(@lno)    = @S.L2(@sno,@S.L4(@sno))
			@L.Z(@lno)    = @S.L3(@sno,@S.L4(@sno))
			@SPLINE.FLAG=0
		//	IF[@es.GSD(094,01)]
				LOOP[SET=@SPLN.PXMAX] CG[ID="SPLN"+$(@_LC) E=0] LOOPEND[]
		//	IFEND[]

			@SPLN.PXNUM(@sno) = 0
/*
			INT[@lc]
			LOOP[SET=12]
				@SPLN.LX(@sno,@_LC-1)=0
				@SPLN.LY(@sno,@_LC-1)=0
				@SPLN.LZ(@sno,@_LC-1)=0
				@lc=@_LC
				LOOP[SET=21]
					@spln.t(@sno,@lc-1,@_LC-1)=0
				LOOPEND[]
			LOOPEND[]

			LOOP[SET=3]
				@lc=@_LC
				LOOP[SET=21]
					@spln.a(@sno,@lc-1,@_LC-1)=0
					@spln.b(@sno,@lc-1,@_LC-1)=0
					@spln.c(@sno,@lc-1,@_LC-1)=0
					@spln.d(@sno,@lc-1,@_LC-1)=0
				LOOPEND[]
			LOOPEND[]
*/
		}
		IFEND[]
		IF[@S.COM(@sno)==@e_QX  ] @L.QX(@lno)   = 0 IFEND[]
		IF[@S.COM(@sno)==@e_QY  ] @L.QY(@lno)   = 0 IFEND[]
		IF[@S.COM(@sno)==@e_QZ  ] @L.QZ(@lno)   = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLBX] @L.CLBX(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLBY] @L.CLBY(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLA ] @L.CLA(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLH ] @L.CLH(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLTP] @L.CLTP(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLV ] @L.CLV(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLW ] @L.CLW(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLX ] @L.CLX(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLY ] @L.CLY(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLZ ] @L.CLZ(@lno)  = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLRX] @L.CLRX(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLRY] @L.CLRY(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_CLRZ] @L.CLRZ(@lno) = 0 IFEND[]
		IF[@S.COM(@sno)==@e_FIN ]
		{
			LOOP[SET=@QUE.MAX]	//@lnoで演出中の全演出を終了させる
			{
				IF[@S.FLAG(@_LC)==4 && @S.LNO(@_LC)==@lno] @S.FLAG.END(@_LC)=999 IFEND[]
			}
			LOOPEND[]
		}
		IFEND[]


	//----------------------------------------------------------------
	// キュー初期化
	//----------------------------------------------------------------
		GOSUB[#=es.SP.QUE.INIT.ONE pint=@sno]
		@S.FLAG(@sno)		= 0
		@S.FLAG.END(@sno)	= 1


	//削除
//	IF[@endflag] \SP.DEL($endflagid) IFEND[]
	IF[@endflag] GOSUB[#=es.SP.DEL2.SET pstr=$endflagid] IFEND[]

	return[]
}


//----------------------------------------------------------------------------
//■レイヤＩＤからレイヤ番号を取得
//----------------------------------------------------------------------------
#=es.LNO.GET
{
	INT[@lno]
	VARINFO[SEARCH=1 SET=$L.SPID() STR=$_PSTR(1) NO=1 LET=@lno]
	IF[@lno==-1] @lno=0 IFEND[]
	return[rint=@lno]
}

/*
//----------------------------------------------------------------------------
//■空いているレイヤ番号取得
//----------------------------------------------------------------------------
#=es.SP.SPID.EMPTYGET
{
	INT[@lno]
	VARINFO[SEARCH=1 SET=$L.SPID() STR="" NO=1 LET=@lno]
	IF[@lno==-1] @lno=0 IFEND[]
	return[rint=@lno]
}
*/

//----------------------------------------------------------------------------
//■空いているキュー番号取得
//----------------------------------------------------------------------------
#=es.SP.QUE.EMPTYGET
{
/*
	INT[@ret]
	LOOP[SET=@QUE.MAX]
	{
		IF[@S.FLAG(@_LC)==0] @ret=@_LC;LOOPBREAK[] IFEND[]
//		IF[@S.COM(@_LC)==0] @ret=@_LC;LOOPBREAK[] IFEND[]
	}
	LOOPEND[]
*/
	INT[@count]
	LOOP[]
	{
		//本来はこれでも正常に動かないといけない.
		//(どんな順番でキューを入れてもの意)
		//
//		@QUE.W-=1
//		IF[@QUE.W<1] @QUE.W+=@QUE.MAX-1 IFEND[]

		@QUE.W+=1
		IF[@QUE.W==@QUE.MAX] @QUE.W-=@QUE.MAX-1 IFEND[]

		IF[@S.FLAG(@QUE.W)==0] LOOPBREAK[] IFEND[]

		@count+=1
		IF[@count>=@QUE.MAX]
			\_mes("キューバッファが満杯になりました。", "エラー")
			@count=0
			WAIT[TIME=1000]
			LOOPCONTINUE[]
		IFEND[]
	}
	LOOPEND[]

	//キュー初期化
	GOSUB[#=es.SP.QUE.INIT.ONE pint=@QUE.W]
	@S.FLAG(@QUE.W)		= 0
	@S.FLAG.END(@QUE.W)	= 1

	return[rint=@QUE.W]
}

//----------------------------------------------------------------------------
//■同じ命令演出が無いかチェック
//----------------------------------------------------------------------------
#=es.EF.CHECK
{
	INT[@sno =@_PINT(1)]
	STR[$sid =$_PSTR(2)]
	INT[@com =@_PINT(3)]
	STR[$name=$_PSTR(4)]
	INT[@qno =@_PINT(5)]
	INT[@qno2=@_PINT(6)]
	INT[@ret]

	IF[@com>0]
	{
		IF[$name!=""] //演出名あり
		{
				LOOP[SET=@QUE.MAX]
				{

			//		IF[@S.COM(@_LC)==@com && @S.QNO2(@_LC)<@S.QNO2(@sno)] //
			//		IF[@S.QNO2(@_LC)<@S.QNO2(@sno)] //
					IF[@S.QNO(@_LC)<@S.QNO(@sno)] //
			//		IF[@_LC < @sno] //
					{
			//			IF[$S.SPID(@_LC)==$sid && @S.FLAG(@_LC)>=3]
						IF[@S.FLAG(@_LC)>=3]
						{
							IF[$S.NAME(@_LC)==$name]
							{
								//正規の連続演出のストックなので、演出開始しない
								@ret=1;LOOPBREAK[] //演出開始禁止.
							}
							ELSE[] //別の演出名(演出名なしも含む)の場合は、一括で終わらせる
							{

			//					IF[                       @com==@S.COM(@_LC) && @com!=@e_NOP] //同じ命令の場合
								IF[$S.SPID(@_LC)==$sid && @com==@S.COM(@_LC) && @com!=@e_NOP] //同じ命令の場合
								{
									IF[@S.QNO2(@_LC)==@COMQNOR(@com)] //一番若い演出セットならば
									{
										//演出強制終了
										@S.FLAG.END(@_LC)=999
										GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
									}
									IFEND[]

									@ret=1;LOOPBREAK[] //演出開始禁止.
								}
								ELSE[] //違う命令の場合
								{
									//同時演出を許可する
								}
								IFEND[]
							}
							IFEND[]

							//ホントはSP.FINISHのようにリスタートさせたい...
						}
						IFEND[]
					}
					IFEND[]
				}
				LOOPEND[]
		}
		ELSE[] //演出名なし
		{

		//	INT[@restartflag]
		//	LOOP[]
		//	{
		//		@restartflag=0

				LOOP[SET=@QUE.MAX]
				{
					IF[@S.COM(@_LC)==@com]
					{
						IF[@S.QNO2(@_LC)<@S.QNO2(@sno)] //
			//			IF[@_LC < @sno] //
				//		IF[@S.QNO(@_LC)<@S.QNO(@sno)] //
						{
							IF[$S.SPID(@_LC)==$sid && @S.FLAG(@_LC)==4]
					//		IF[@S.FLAG(@_LC)==4]
							{
	//							IF[@S.QNO2(@_LC)==@COMQNOR(@com)] //一番若い演出セットならば
								{
									//演出強制終了
									@S.FLAG.END(@_LC)=999
									GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
								}
	//							IFEND[]

								@ret=1;LOOPBREAK[] //演出開始禁止.

			//					@restartflag=1
							}
							IFEND[]
						}
						IFEND[]
					}
					ELSE[] //
					{
						IF[(@com==@e_PXY && (@S.COM(@_LC)==@e_X || @S.COM(@_LC)==@e_Y)) || (@com==@e_PXYZ && (@S.COM(@_LC)==@e_X || @S.COM(@_LC)==@e_Y || @S.COM(@_LC)==@e_Z))] //PXY & X,Y命令、もしくはPXYZ & X,Y,Z命令なら
						{
	//						IF[@S.QNO2(@_LC)==@COMQNOR(@com)] //一番若い演出セットならば
							{
								//演出強制終了
								@S.FLAG.END(@_LC)=999
								GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
							}
	//						IFEND[]

							@ret=1;LOOPBREAK[] //演出開始禁止.
						}
						ELSE[(@S.COM(@_LC)==@e_PXY && (@com==@e_X || @com==@e_Y)) || (@S.COM(@_LC)==@e_PXYZ && (@com==@e_X || @com==@e_Y || @com==@e_Z))] //PXY & X,Y命令、もしくは PXYZ & X,Y,Z命令なら
						{
	//						IF[@S.QNO2(@_LC)==@COMQNOR(@com)] //一番若い演出セットならば
							{
								//演出強制終了
								@S.FLAG.END(@_LC)=999
								GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
							}
	//						IFEND[]

							@ret=1;LOOPBREAK[] //演出開始禁止.
						}
						IFEND[]
					}
					IFEND[]
				}
				LOOPEND[]

		//		IF[@restartflag==0] LOOPBREAK[] IFEND[] //指定したスプライトが無くなったら終了.

			//	IF[@count==@QUE.MAX*2] \_mes("内部の問題により演出が終了出来ません。");END[] IFEND[]

		//		GOSUB[#=es.EF.TASK.MAIN] //連続演出をどんどん終わらせる
		//	}
		//	LOOPEND[]

		}
		IFEND[]
	}
	IFEND[]

	return[rint=@ret]
}


////

/*
#=es.SP.HIDEALL
{
	INT[@No]
	LOOP[SET=(@LMAX+1)]
	{
		@No=@_LC-1
		LOOP[SET=100] ///xアニメ数数える.
		{
			CG[ID=$LIDBUF+$(1+@No*100+@_LC-1) E=0]
			CG[ID=$LID   +$(1+@No*100+@_LC-1) E=0]
		}
		LOOPEND[]
	}
	LOOPEND[]

	return[]
}

#=es.SP.SHOWALL
{
	INT[@No]
	LOOP[SET=(@LMAX+1)]
	{
		@No=@_LC-1
		LOOP[SET=100] ///xアニメ数数える.
		{
			CG[ID=$LIDBUF+$(1+@No*100+@_LC-1) E=1]
			CG[ID=$LID   +$(1+@No*100+@_LC-1) E=1]
		}
		LOOPEND[]
	}
	LOOPEND[]

	return[]
}
*/


//----------------------------------------------------------------------------
//
//■画像消去
//
//----------------------------------------------------------------------------
#=es.SP.DEL2.SET //強制削除
{
	STR[$spid = $_PSTR(1)]
	INT[@No]

	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$spid];@No=@_RINT(1)

	//演出が残っていたら強制的に終わらす(必須)
//	\SP.FINISH($spid)

	//YMVレイヤなら専用終了処理
	IF[@L.FTYPE(@No)==6] YMVEND[ID=$LIDBUF+$(1+@No*100)] IFEND[]

	LOOP[SET=100] ///xアニメ数数える.
	{
		CGEND[ID=$LIDBUF  +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDBUF2 +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDBUF3 +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LID     +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDTR   +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDTRBUF+$(1+@No*100+@_LC-1)]
	}
	LOOPEND[]

	//[SpriteView]チップレイヤ削除
IF[@_DEBUGMODE>=@dbg.val]
{
	CGEND[ID=":W2/CP"+$(@No)]

	//拡大縮小点削除
	CGEND[ID=CP+$(@No)]
}
IFEND[]

	GOSUB[#=es.SP.INFO.INIT pint=@No]

	return[]
}

#=es.SP.DELALL2.SET
{
	INT[@LNO]
	LOOP[SET=(@LMAX+1)]
	{
		@LNO=@_LC-1
		GOSUB[#=es.SP.DEL2.SET pstr=$L.SPID(@LNO)]
	}
	LOOPEND[]

	return[]
}



#=es.SP.DEL.SET
{
	STR[$spid = $_PSTR(1)]
	INT[@No]

	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$spid];@No=@_RINT(1)

	//演出が残っていたら強制的に終わらす(必須)
	\SP.FINISH($spid)

	//YMVレイヤなら専用終了処理
	IF[@L.FTYPE(@No)==6] YMVEND[ID=$LIDBUF+$(1+@No*100)] IFEND[]

	LOOP[SET=100] ///xアニメ数数える.
	{
		CGEND[ID=$LIDBUF  +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDBUF2 +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDBUF3 +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LID     +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDTR   +$(1+@No*100+@_LC-1)]
		CGEND[ID=$LIDTRBUF+$(1+@No*100+@_LC-1)]
	}
	LOOPEND[]

	//[SpriteView]チップレイヤ削除
IF[@_DEBUGMODE>=@dbg.val]
{
	CGEND[ID=":W2/CP"+$(@No)]

	//拡大縮小点削除
	CGEND[ID=CP+$(@No)]
}
IFEND[]

	GOSUB[#=es.SP.INFO.INIT pint=@No]

	return[]
}

#=es.SP.DELALL.SET
{
	STR[$EXC_ID1=$_PSTR(1)] //例外ID1
	STR[$EXC_ID2=$_PSTR(2)] //例外ID2
	STR[$EXC_ID3=$_PSTR(3)] //例外ID3
	STR[$EXC_ID4=$_PSTR(4)] //例外ID4

	INT[@LNO]
	LOOP[SET=(@LMAX+1)]
	{
		@LNO=@_LC-1

		IF[$L.SPID(@LNO)!="" && $L.SPID(@LNO)!=$EXC_ID1 && $L.SPID(@LNO)!=$EXC_ID2 && $L.SPID(@LNO)!=$EXC_ID3 && $L.SPID(@LNO)!=$EXC_ID4]
		{
			IF[$L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF" && $L.SPID(@LNO)!="LNO_FD"]
				GOSUB[#=es.SP.DEL.SET pstr=$L.SPID(@LNO)]
			IFEND[]
		}
		IFEND[]
	}
	LOOPEND[]

	return[]
}


//----------------------------------------------------------------------------
//■フェードアウトマクロ
//----------------------------------------------------------------------------
#=MAC.FOUT
{
	INT[@TIME=@_PINT(1)]
	STR[$TR  =$_PSTR(2)]
	STR[$CG  =$_PSTR(3)]
	INT[@TA  =@_PINT(4)]
	INT[@BL  =@_PINT(5)] //幕レイヤのブレンドモード

//\SAVE.OFF //この間だけセーブできない

//	IF[@es.GSD(112,01)==1] $TR="bg/black" IFEND[]

	\SP.BG( $CG,,1,1 ) //BG //第5パラメータ:彩度明度
	\SP.BL( @BL )
	\SP.TR( $TR, @TA )
	\SP.ZXYZ(@es.GSX/2, @es.GSY/2, 0, 0)
	\SP.2A(0, 256, 0)
	\SP.2TP(0, 256, @TIME)
//\_dmes("time="+$(@TIME))
	\SP.GO("LNO_FD")
	\SP.WA("LNO_FD")

/*
	//カメラ位置初期化(必要？)
	\CM.ZVW(0, 0, 0)
	\CM.ZXYZ(0, 0, 0, 0)
	\CM.GO
	\CM.WA
*/

	\SP.DELALL

	\WA(1)

	@es.LSD(092,01)=0 //立ち絵表示Zカウント

//\SAVE.ON
\SCRIPTPOS_SAVE

	return[]
}


//----------------------------------------------------------------------------
//■アイキャッチ中のオートセーブ準備
//----------------------------------------------------------------------------
#=ES.AUTOSAVE.SS.READY
{
	IF[@es.GSD(121,01)==0]
	{
		//アイキャッチOFFなら、専用幕レイヤを張り見えなくする。
		\SP.BG("black")
		\SP.ZA(256, 0)
		\SP.ZXYZ(0, 0, 100, 0)
		\SP.GO(MAKU_FOR_EC)

		//演出スキップ状態.
		\SP.SKIP
	}
	IFEND[]

	return[]
}

//----------------------------------------------------------------------------
//■フェードインマクロ
//----------------------------------------------------------------------------
#=MAC.FIN
{
	INT[@TIME=@_PINT(1)]
	STR[$TR  =$_PSTR(2)]
	INT[@TA  =@_PINT(3)]
	INT[@WAIT=@_PINT(4)] //フェードイン終了まで待つフラグ

//\SAVE.OFF //この間だけセーブできない

	IF[$TR!=""] \SP.TR( $TR, @TA ) IFEND[]
	\SP.2TP(257, 0, @TIME) //Rev(反転)するために257と指定.
	\SP.GO("LNO_FD")

//	@es.LSD(092,01)=0 //立ち絵表示Zカウント ///xFINでは初期化してはならない.

	IF[@WAIT==1] \SP.WA("LNO_FD") IFEND[]

//IF[@MAC.FIN.NOSAVE==0]
//{
	//\SAVE.ON
	\SCRIPTPOS_SAVE
//}
//IFEND[]

//	@MAC.FIN.NOSAVE=0

IF[@es.AUTOSAVEFLAG] \AUTOSAVE(0) IFEND[]
@es.LOADTHRU=0 //フェードイン後の演出を有効にする

	return[]
}

/*
#=MAC.FIN.NOSAVE
{
//	@MAC.FIN.NOSAVE=1
	return[]
}
*/


//----------------------------------------------------------------------------
//■BG.CMXYZマクロ
//----------------------------------------------------------------------------
#=MAC.BG.CMXYZ
{
	@LNO_CMFLAG = 1
//	@LNO_CMV = 0
//	@LNO_CMW = 0
	@LNO_CMX = @_PFLT(1)
	@LNO_CMY = @_PFLT(2)
	@LNO_CMZ = @_PFLT(3)

	return[]
}

#=MAC.EV.CMXYZ
{
	@LNO_CMFLAG = 1
//	@LNO_CMV = 0
//	@LNO_CMW = 0
	@LNO_CMX = @_PFLT(1)
	@LNO_CMY = @_PFLT(2)
	@LNO_CMZ = @_PFLT(3)

	return[]
}


//----------------------------------------------------------------------------
//■BGマクロ
//----------------------------------------------------------------------------
#=MAC.BG
{
	STR[$FN  =$_PSTR(1)]
	FLT[@Z   =@_PFLT(2)]
	INT[@TIME=@_PINT(3)]
	STR[$TR  =$_PSTR(4)]
	INT[@TA  =@_PINT(5)]
	INT[@SK1 =@_PINT(6)]
	INT[@SK2 =@_PINT(7)]
//	INT[@V   =@_PINT(5)]
//	INT[@W   =@_PINT(6)]

	IF[@TIME==-1] @TIME=@T(23,01) IFEND[]

	INT[@mCMFLAG = @LNO_CMFLAG]
	FLT[@mCMV    = @LNO_CMV]
	FLT[@mCMW    = @LNO_CMW]
	FLT[@mCMX    = @LNO_CMX]
	FLT[@mCMY    = @LNO_CMY]
	FLT[@mCMZ    = @LNO_CMZ]

@es.LSD(092,02)=-9999999 ///xTOC暫定

//\SAVE.OFF //この間だけセーブできない

//	\CMVIEW(120, 120)

/*
	IF[@V!=-9999999 && @W!=-9999999]
	{
		\CM.ZVW(@V, @W)
		\CM.GO
	}
	IFEND[]
*/

	\SP.FINISH() //全演出終了

	\SP.BG($FN)


	IF[@SK1==-2] @SK1=@es.LSD(033,05) IFEND[]
	IF[@SK2==-2] @SK2=@es.LSD(033,06) IFEND[]
	\SP.SK(@SK1,@SK2)


	IF[$TR==""] //通常フェード
		\SP.2A(0, 256, @TIME)
	ELSE[]
		\SP.2A(0, 256, 0)
		\SP.TR($TR, @TA)
		\SP.2TP(0, 256, @TIME)
	IFEND[]

//	IF[$L.FCG(@LNO_BG)==""] //背景ない状態
	IF[0] //背景ない状態
	{
		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
//\_dmes("Z="+$(@Z))
		IFEND[]

		\SP.GO(BG)
		\SP.WA(BG)
	}
	ELSE[] //背景ある状態なら特殊クロスフェード
	{
		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
//\_dmes("Z="+$(@Z))
		IFEND[]

@BGF.FLAG=1
		\SP.GO(BGF)
		\SP.WA(BGF)

//切り替え時にこのタイミングでカメラの演出を終わらす
\SP.FINISH //全演出終了
\WA(1)

	@LNO_CMFLAG = @mCMFLAG
	@LNO_CMV    = @mCMV
	@LNO_CMW    = @mCMW
	@LNO_CMX    = @mCMX
	@LNO_CMY    = @mCMY
	@LNO_CMZ    = @mCMZ

		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
		ELSE[]
			\SP.ZXY(0, 0, 0) //必要。BG動かしながらの時に読み込まれると位置が変わってしまう。
		IFEND[]

	//	\SP.BG($FN)
		\SP.BGCOPY($FN)
		\SP.2A(0, 256, 0)
		\SP.GO(BG)
		\SP.WA(BG)

		\SP.DELALL(BG) //BG以外を全て削除

	}
	IFEND[]

	@es.LSD(092,01)=0 //立ち絵表示Zカウント

//\SAVE.ON
\SCRIPTPOS_SAVE

IF[@es.AUTOSAVEFLAG] \AUTOSAVE(0) IFEND[]
@es.LOADTHRU=0 //フェードイン後の演出を有効にする

@es.LSD(092,02)=-9999999

	return[]
}

//----------------------------------------------------------------------------
//■EVマクロ
//----------------------------------------------------------------------------
#=MAC.EV
{
	STR[$FN  =$_PSTR(1)]
	FLT[@Z   =@_PFLT(2)]
	INT[@TIME=@_PINT(3)]
	STR[$TR  =$_PSTR(4)]
	INT[@TA  =@_PINT(5)]
	INT[@SK1 =@_PINT(6)]
	INT[@SK2 =@_PINT(7)]
	INT[@W_NK=@_PINT(8)] //白ヌキ画像を同時に読み込む
//	INT[@V   =@_PINT(5)]
//	INT[@W   =@_PINT(6)]

	IF[@TIME==-1] @TIME=@T(24,01) IFEND[]

	INT[@mCMFLAG = @LNO_CMFLAG]
	FLT[@mCMV    = @LNO_CMV]
	FLT[@mCMW    = @LNO_CMW]
	FLT[@mCMX    = @LNO_CMX]
	FLT[@mCMY    = @LNO_CMY]
	FLT[@mCMZ    = @LNO_CMZ]

@es.LSD(092,02)=-9999999 ///xTOC暫定

//\SAVE.OFF //この間だけセーブできない

//	\CMVIEW(100, 100)

/*
	IF[@V!=-9999999 && @W!=-9999999]
	{
		\CM.ZVW(@V, @W)
		\CM.GO
	}
	IFEND[]
*/
	\SP.FINISH //全演出終了

	\SP.EV($FN)


	IF[@SK1==-2] @SK1=@es.LSD(033,07) IFEND[]
	IF[@SK2==-2] @SK2=@es.LSD(033,08) IFEND[]
	\SP.SK(@SK1,@SK2)


	IF[$TR==""] //通常フェード
		\SP.2A(0, 256, @TIME)
	ELSE[]
		\SP.2A(0, 256, 0)
		\SP.TR($TR, @TA)
		\SP.2TP(0, 256, @TIME)
	IFEND[]

//	IF[$L.FCG(@LNO_BG)==""] //背景ない状態
	IF[0] //背景ない状態
	{
		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
//\_dmes("Z="+$(@Z))
		IFEND[]

		\SP.GO(BG)
		\SP.WA(BG)
	}
	ELSE[] //背景ある状態なら特殊クロスフェード
	{
		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
//\_dmes("Z="+$(@Z))
		IFEND[]

@BGF.FLAG=1
		\SP.GO(BGF)
		\SP.WA(BGF)

//切り替え時にこのタイミングでカメラの演出を終わらす
\SP.FINISH //全演出終了
\WA(1)

	@LNO_CMFLAG = @mCMFLAG
	@LNO_CMV    = @mCMV
	@LNO_CMW    = @mCMW
	@LNO_CMX    = @mCMX
	@LNO_CMY    = @mCMY
	@LNO_CMZ    = @mCMZ

		IF[@Z!=-1]
			\SP.ZXYZ(0, 0, @Z, 0)
@es.LSD(092,02)=@Z ///xTOC暫定
		ELSE[]
			\SP.ZXY(0, 0, 0) //必要。EV動かしながらの時に読み込まれると位置が変わってしまう。
		IFEND[]

	//	\SP.EV($FN)
		\SP.EVCOPY($FN)
		\SP.2A(0, 256, 0)
		\SP.GO(BG)
		\SP.WA(BG)

		\SP.DELALL(BG) //BG以外を全て削除

	}
	IFEND[]

	@es.LSD(092,01)=0 //立ち絵表示Zカウント

	//同時に白ヌキ画像を読み込む
	IF[@W_NK]
	{
//\_dmes("ev/"+$FN+"_w")
		\SP.CG("ev/"+$FN+"_w")
		\SP.ZXYZ(0,0,@DEFZ,0)
		\SP.GO(EV_W)
	}
	IFEND[]

//\SAVE.ON
\SCRIPTPOS_SAVE

IF[@es.AUTOSAVEFLAG] \AUTOSAVE(0) IFEND[]
@es.LOADTHRU=0 //フェードイン後の演出を有効にする

@es.LSD(092,02)=-9999999

	return[]
}


//----------------------------------------------------------------------------
//■FLASHマクロ
//----------------------------------------------------------------------------
#=MAC.FLASH
{
	INT[@TIME=@_PINT(1)]
	INT[@NUM =@_PINT(2)]
	INT[@ACC =@_PINT(3)]
	INT[@WAIT=@_PINT(4)]

	IF[@NUM>0]
	{
		\SP.BG("white",,1)
		\SP.2XYZ(@es.GSX/2, @es.GSY/2, 1, @es.GSX/2, @es.GSY/2, 1, 0)
		\SP.BL(1)
		\SP.2A(256, 0, @TIME, @ACC, @NUM)
		\SP.GO(MAC_FLASH, MAC_FLASH, , 17)

		IF[@WAIT==1]
				\SP.WA(MAC_FLASH)
		IFEND[]

		\SP.END
		\SP.GO(MAC_FLASH, MAC_FLASH)

		IF[@WAIT==1]
			\SP.WA(MAC_FLASH)
		IFEND[]

//		\SP.DEL(MAC_FLASH)
//		\WA(1)
	}
	IFEND[]

	return[]
}


//----------------------------------------------------------------------------
//■演出レイヤセーブ
//----------------------------------------------------------------------------
#=es.L.SAVE
{
///xE-mote
	INT[@texchk]
	INT[@mLC]
	INT[@play]
	LOOP[SET=(@LMAX+1)]
	{
		@mLC = @_LC-1
		CGINFO[ID=$LIDBUF+$(1+@mLC*100) TEX=1 LET=@texchk]
		IF[@texchk==2]
		{
			EMOTEINFO[ID=$LIDBUF+$(1+@mLC*100) DATA=1 LET=$L.EMDATA(@mLC)]

//			\_dmes("$L.SPID = "+$L.SPID(@mLC)+$_CHR(13)+"DATA = "+$L.EMDATA(@mLC))

			EMOTEINFO[ID=$LIDBUF+$(1+@mLC*100) LABEL=$L.EMP(@mLC) PLAY=1 LET=@play] //TLPLAYフラグ
			IF[@play==0] $L.EMP(@mLC)="" IFEND[]

			EMOTEINFO[ID=$LIDBUF+$(1+@mLC*100) LABEL=$L.EMPA(@mLC) PLAY=1 LET=@play] //TLPLAYフラグ
			IF[@play==0] $L.EMPA(@mLC)="" IFEND[]
		}
		IFEND[]
	}
	LOOPEND[]


	INT[@dno=@_PINT(1)]

	SAVE[DNO=@dno+000 SET=@L.CHRNO()]
	SAVE[DNO=@dno+001 SET=@L.LZCNT()]
	SAVE[DNO=@dno+002 SET=@L.FTYPE()]
	SAVE[DNO=@dno+003 SET=$L.SPID()]
	SAVE[DNO=@dno+004 SET=$L.FCG()]
	SAVE[DNO=@dno+005 SET=$L.FTR()]
	SAVE[DNO=@dno+006 SET=$L.TXF()]
	SAVE[DNO=@dno+007 SET=$L.TXS()]
	SAVE[DNO=@dno+008 SET=@L.TXV()]
	SAVE[DNO=@dno+009 SET=@L.TRA()]
	SAVE[DNO=@dno+010 SET=@L.TRR()]
	SAVE[DNO=@dno+011 SET=@L.TIP()]
	SAVE[DNO=@dno+012 SET=@L.ST()]
	SAVE[DNO=@dno+013 SET=@L.BL()]

	SAVE[DNO=@dno+014 SET=@L.HOR()]
	SAVE[DNO=@dno+015 SET=@L.VER()]
	SAVE[DNO=@dno+016 SET=@L.REV()]
	SAVE[DNO=@dno+017 SET=@L.MONO()]
	SAVE[DNO=@dno+018 SET=@L.BLUR()]
	SAVE[DNO=@dno+019 SET=@L.MOSA()]
	SAVE[DNO=@dno+020 SET=@L.DIFF()]
	SAVE[DNO=@dno+021 SET=@L.ROT()]
	SAVE[DNO=@dno+022 SET=@L.RAS()]
	SAVE[DNO=@dno+023 SET=@L.WPL()]
	SAVE[DNO=@dno+024 SET=@L.AKA()]

	SAVE[DNO=@dno+025 SET=@L.PARENT()]
	SAVE[DNO=@dno+026 SET=@L.CHILD()]
	SAVE[DNO=@dno+027 SET=@L.SX()]
	SAVE[DNO=@dno+028 SET=@L.SY()]
	SAVE[DNO=@dno+029 SET=@L.LV()]
	SAVE[DNO=@dno+030 SET=@L.CX()]
	SAVE[DNO=@dno+031 SET=@L.CY()]
	SAVE[DNO=@dno+032 SET=@L.A()]
	SAVE[DNO=@dno+033 SET=@L.AX()]
	SAVE[DNO=@dno+034 SET=@L.AY()]
	SAVE[DNO=@dno+035 SET=@L.AZ()]
	SAVE[DNO=@dno+036 SET=@L.ABX()]
	SAVE[DNO=@dno+037 SET=@L.ABY()]
	SAVE[DNO=@dno+038 SET=@L.F1()]
	SAVE[DNO=@dno+039 SET=@L.F2()]
	SAVE[DNO=@dno+040 SET=@L.MX()]
	SAVE[DNO=@dno+041 SET=@L.MY()]
	SAVE[DNO=@dno+042 SET=@L.MZ()]
	SAVE[DNO=@dno+043 SET=@L.QX()]
	SAVE[DNO=@dno+044 SET=@L.QY()]
	SAVE[DNO=@dno+045 SET=@L.QZ()]
	SAVE[DNO=@dno+046 SET=@L.RX()]
	SAVE[DNO=@dno+047 SET=@L.RY()]
	SAVE[DNO=@dno+048 SET=@L.RZ()]
	SAVE[DNO=@dno+049 SET=@L.CLBX()]
	SAVE[DNO=@dno+050 SET=@L.CLBY()]
	SAVE[DNO=@dno+051 SET=@L.CLA()]
	SAVE[DNO=@dno+052 SET=@L.CLH()]
	SAVE[DNO=@dno+053 SET=@L.CLTP()]
	SAVE[DNO=@dno+054 SET=@L.CLV()]
	SAVE[DNO=@dno+055 SET=@L.CLW()]
	SAVE[DNO=@dno+056 SET=@L.CLX()]
	SAVE[DNO=@dno+057 SET=@L.CLY()]
	SAVE[DNO=@dno+058 SET=@L.CLZ()]
	SAVE[DNO=@dno+059 SET=@L.CLRX()]
	SAVE[DNO=@dno+060 SET=@L.CLRY()]
	SAVE[DNO=@dno+061 SET=@L.CLRZ()]
	SAVE[DNO=@dno+062 SET=@L.BX()]
	SAVE[DNO=@dno+063 SET=@L.BY()]
	SAVE[DNO=@dno+064 SET=@L.H()]
	SAVE[DNO=@dno+065 SET=@L.TP()]
	SAVE[DNO=@dno+066 SET=@L.V()]
	SAVE[DNO=@dno+067 SET=@L.W()]
	SAVE[DNO=@dno+068 SET=@L.X()]
	SAVE[DNO=@dno+069 SET=@L.Y()]
	SAVE[DNO=@dno+070 SET=@L.Z()]
	SAVE[DNO=@dno+071 SET=@L.SD()]
	SAVE[DNO=@dno+072 SET=@L.MD()]

	SAVE[DNO=@dno+073 SET=$L.EMVO()]
	SAVE[DNO=@dno+074 SET=@L.EMVO()]
	SAVE[DNO=@dno+075 SET=$L.EMV()]
	SAVE[DNO=@dno+076 SET=$L.EMP()]
	SAVE[DNO=@dno+077 SET=$L.EMS()]
	SAVE[DNO=@dno+078 SET=$L.EMPA()]
	SAVE[DNO=@dno+079 SET=$L.EMSA()]

	SAVE[DNO=@dno+080 SET=@L.ANFLAG()]
	SAVE[DNO=@dno+081 SET=@L.ANC()]
	SAVE[DNO=@dno+082 SET=@L.ANC2()]
//	SAVE[DNO=@dno+083 SET=@L.ANC3()]
	SAVE[DNO=@dno+084 SET=@L.ANC4()]
	SAVE[DNO=@dno+085 SET=@L.ANX()]
	SAVE[DNO=@dno+086 SET=@L.ANY()]
	SAVE[DNO=@dno+087 SET=@L.ANNUM()]
	SAVE[DNO=@dno+088 SET=@L.ANTIME()]
	SAVE[DNO=@dno+089 SET=@L.ANSTOP()]
	SAVE[DNO=@dno+090 SET=@L.ANLOOP()]

	SAVE[DNO=@dno+100 SET=@S.FLAG()]
	SAVE[DNO=@dno+101 SET=@S.FLAG.END()]
	SAVE[DNO=@dno+102 SET=@S.TNOW()]
	SAVE[DNO=@dno+103 SET=@S.TOLD()]
	SAVE[DNO=@dno+104 SET=$S.NAME()]
	SAVE[DNO=@dno+105 SET=$S.SPID()]
	SAVE[DNO=@dno+106 SET=@S.QNO()]
	SAVE[DNO=@dno+107 SET=@S.QNO2()]
	SAVE[DNO=@dno+108 SET=@S.LNO()]
	SAVE[DNO=@dno+109 SET=@S.COM()]
	SAVE[DNO=@dno+110 SET=@S.FTYPE()]
	SAVE[DNO=@dno+111 SET=$S.FCG()]
	SAVE[DNO=@dno+112 SET=$S.FTR()]
	SAVE[DNO=@dno+113 SET=$S.TXF()]
	SAVE[DNO=@dno+114 SET=$S.TXS()]
	SAVE[DNO=@dno+115 SET=@S.YMP()]
	SAVE[DNO=@dno+116 SET=@S.TIP()]
	SAVE[DNO=@dno+117 SET=@S.SK()]
	SAVE[DNO=@dno+118 SET=@S.I1()]
	SAVE[DNO=@dno+119 SET=@S.I2()]
	SAVE[DNO=@dno+120 SET=@S.I3()]
	SAVE[DNO=@dno+121 SET=@S.I4()]
	SAVE[DNO=@dno+122 SET=@S.F1()]
	SAVE[DNO=@dno+123 SET=@S.F2()]
	SAVE[DNO=@dno+124 SET=@S.L1()]
	SAVE[DNO=@dno+125 SET=@S.L2()]
	SAVE[DNO=@dno+126 SET=@S.L3()]
	SAVE[DNO=@dno+127 SET=@S.L4()]
	SAVE[DNO=@dno+128 SET=@S.N()]
	SAVE[DNO=@dno+129 SET=@S.T()]
	SAVE[DNO=@dno+130 SET=@S.AC()]
	SAVE[DNO=@dno+131 SET=$S.PARENT()]
	SAVE[DNO=@dno+132 SET=@S.SDMD.NA()]
	SAVE[DNO=@dno+133 SET=@S.F3()]
	SAVE[DNO=@dno+134 SET=@S.F4()]

	SAVE[DNO=@dno+135 SET=$S.EMVO()]
	SAVE[DNO=@dno+136 SET=$S.EMV()]
	SAVE[DNO=@dno+137 SET=$S.EMP()]
	SAVE[DNO=@dno+138 SET=$S.EMS()]
	SAVE[DNO=@dno+139 SET=$S.EMPA()]
	SAVE[DNO=@dno+140 SET=$S.EMSA()]

	SAVE[DNO=@dno+200 SET=@P.I1()]
	SAVE[DNO=@dno+201 SET=@P.I2()]
	SAVE[DNO=@dno+202 SET=@P.I3()]
	SAVE[DNO=@dno+203 SET=@P.I4()]
	SAVE[DNO=@dno+204 SET=@P.F1()]
	SAVE[DNO=@dno+205 SET=@P.F2()]
	SAVE[DNO=@dno+206 SET=@P.L1()]
	SAVE[DNO=@dno+207 SET=@P.L2()]
	SAVE[DNO=@dno+208 SET=@P.L3()]
	SAVE[DNO=@dno+209 SET=@P.L4]
	SAVE[DNO=@dno+210 SET=$P.S1()]
	SAVE[DNO=@dno+211 SET=$P.S2()]
	SAVE[DNO=@dno+212 SET=@P.N()]
	SAVE[DNO=@dno+213 SET=@P.T()]
	SAVE[DNO=@dno+214 SET=@P.AC()]
	SAVE[DNO=@dno+215 SET=$P.PARENT()]
	SAVE[DNO=@dno+216 SET=@P.SDMD.NA()]

	SAVE[DNO=@dno+221 SET=@QUE.R]
	SAVE[DNO=@dno+222 SET=@QUE.W]
	SAVE[DNO=@dno+223 SET=@g.QNOW]
	SAVE[DNO=@dno+224 SET=@COMQNOR()]
	SAVE[DNO=@dno+225 SET=@COMQNOW()]

	SAVE[DNO=@dno+231 SET=@es.EF.SAIDO]
	SAVE[DNO=@dno+232 SET=@es.EF.MEIDO]

	SAVE[DNO=@dno+241 SET=@es.MIMI.STOP()]
//	SAVE[DNO=@dno+242 SET=@es.MIMI.COM.INIT()]
//	SAVE[DNO=@dno+243 SET=@es.MIMI.COM.COUNT()]
//	SAVE[DNO=@dno+244 SET=@es.MIMI.COM.WAIT()]

	SAVE[DNO=@dno+251 SET=@SPLN.LX()]
	SAVE[DNO=@dno+252 SET=@SPLN.LY()]
	SAVE[DNO=@dno+253 SET=@SPLN.LZ()]
	SAVE[DNO=@dno+254 SET=@SPLN.PXNUM()]

	SAVE[DNO=@dno+261 SET=@spln.a()]
	SAVE[DNO=@dno+262 SET=@spln.b()]
	SAVE[DNO=@dno+263 SET=@spln.c()]
	SAVE[DNO=@dno+264 SET=@spln.d()]
	SAVE[DNO=@dno+265 SET=@spln.t()] //２点間の移動時間
//	SAVE[DNO=@dno+266 SET=@spln.x()]
//	SAVE[DNO=@dno+267 SET=@spln.y()]
//	SAVE[DNO=@dno+268 SET=@spln.z()]

///xE-mote
	SAVE[DNO=@dno+270 SET=$L.EMDATA()]

	return[]
}



//----------------------------------------------------------------------------
//■演出レイヤロード
//----------------------------------------------------------------------------
#=es.L.LOAD
{
	\SP.DELALL

//	WAIT[FRAME=5]
	//\WA(1)

	STR[$fn=$_PSTR(1)]
	INT[@dno=@_PINT(2)]

	LOAD[FILE=$fn DNO=@dno+000 LET=@L.CHRNO()]
	LOAD[FILE=$fn DNO=@dno+001 LET=@L.LZCNT()]
	LOAD[FILE=$fn DNO=@dno+002 LET=@L.FTYPE()]
	LOAD[FILE=$fn DNO=@dno+003 LET=$L.SPID()]
	LOAD[FILE=$fn DNO=@dno+004 LET=$L.FCG()]
	LOAD[FILE=$fn DNO=@dno+005 LET=$L.FTR()]
	LOAD[FILE=$fn DNO=@dno+006 LET=$L.TXF()]
	LOAD[FILE=$fn DNO=@dno+007 LET=$L.TXS()]
	LOAD[FILE=$fn DNO=@dno+008 LET=@L.TXV()]
	LOAD[FILE=$fn DNO=@dno+009 LET=@L.TRA()]
	LOAD[FILE=$fn DNO=@dno+010 LET=@L.TRR()]
	LOAD[FILE=$fn DNO=@dno+011 LET=@L.TIP()]
	LOAD[FILE=$fn DNO=@dno+012 LET=@L.ST()]
	LOAD[FILE=$fn DNO=@dno+013 LET=@L.BL()]

	LOAD[FILE=$fn DNO=@dno+014 LET=@L.HOR()]
	LOAD[FILE=$fn DNO=@dno+015 LET=@L.VER()]
	LOAD[FILE=$fn DNO=@dno+016 LET=@L.REV()]
	LOAD[FILE=$fn DNO=@dno+017 LET=@L.MONO()]
	LOAD[FILE=$fn DNO=@dno+018 LET=@L.BLUR()]
	LOAD[FILE=$fn DNO=@dno+019 LET=@L.MOSA()]
	LOAD[FILE=$fn DNO=@dno+020 LET=@L.DIFF()]
	LOAD[FILE=$fn DNO=@dno+021 LET=@L.ROT()]
	LOAD[FILE=$fn DNO=@dno+022 LET=@L.RAS()]
	LOAD[FILE=$fn DNO=@dno+023 LET=@L.WPL()]
	LOAD[FILE=$fn DNO=@dno+024 LET=@L.AKA()]

	LOAD[FILE=$fn DNO=@dno+025 LET=@L.PARENT()]
	LOAD[FILE=$fn DNO=@dno+026 LET=@L.CHILD()]
	LOAD[FILE=$fn DNO=@dno+027 LET=@L.SX()]
	LOAD[FILE=$fn DNO=@dno+028 LET=@L.SY()]
	LOAD[FILE=$fn DNO=@dno+029 LET=@L.LV()]
	LOAD[FILE=$fn DNO=@dno+030 LET=@L.CX()]
	LOAD[FILE=$fn DNO=@dno+031 LET=@L.CY()]
	LOAD[FILE=$fn DNO=@dno+032 LET=@L.A()]
	LOAD[FILE=$fn DNO=@dno+033 LET=@L.AX()]
	LOAD[FILE=$fn DNO=@dno+034 LET=@L.AY()]
	LOAD[FILE=$fn DNO=@dno+035 LET=@L.AZ()]
	LOAD[FILE=$fn DNO=@dno+036 LET=@L.ABX()]
	LOAD[FILE=$fn DNO=@dno+037 LET=@L.ABY()]
	LOAD[FILE=$fn DNO=@dno+038 LET=@L.F1()]
	LOAD[FILE=$fn DNO=@dno+039 LET=@L.F2()]
	LOAD[FILE=$fn DNO=@dno+040 LET=@L.MX()]
	LOAD[FILE=$fn DNO=@dno+041 LET=@L.MY()]
	LOAD[FILE=$fn DNO=@dno+042 LET=@L.MZ()]
	LOAD[FILE=$fn DNO=@dno+043 LET=@L.QX()]
	LOAD[FILE=$fn DNO=@dno+044 LET=@L.QY()]
	LOAD[FILE=$fn DNO=@dno+045 LET=@L.QZ()]
	LOAD[FILE=$fn DNO=@dno+046 LET=@L.RX()]
	LOAD[FILE=$fn DNO=@dno+047 LET=@L.RY()]
	LOAD[FILE=$fn DNO=@dno+048 LET=@L.RZ()]
	LOAD[FILE=$fn DNO=@dno+049 LET=@L.CLBX()]
	LOAD[FILE=$fn DNO=@dno+050 LET=@L.CLBY()]
	LOAD[FILE=$fn DNO=@dno+051 LET=@L.CLA()]
	LOAD[FILE=$fn DNO=@dno+052 LET=@L.CLH()]
	LOAD[FILE=$fn DNO=@dno+053 LET=@L.CLTP()]
	LOAD[FILE=$fn DNO=@dno+054 LET=@L.CLV()]
	LOAD[FILE=$fn DNO=@dno+055 LET=@L.CLW()]
	LOAD[FILE=$fn DNO=@dno+056 LET=@L.CLX()]
	LOAD[FILE=$fn DNO=@dno+057 LET=@L.CLY()]
	LOAD[FILE=$fn DNO=@dno+058 LET=@L.CLZ()]
	LOAD[FILE=$fn DNO=@dno+059 LET=@L.CLRX()]
	LOAD[FILE=$fn DNO=@dno+060 LET=@L.CLRY()]
	LOAD[FILE=$fn DNO=@dno+061 LET=@L.CLRZ()]
	LOAD[FILE=$fn DNO=@dno+062 LET=@L.BX()]
	LOAD[FILE=$fn DNO=@dno+063 LET=@L.BY()]
	LOAD[FILE=$fn DNO=@dno+064 LET=@L.H()]
	LOAD[FILE=$fn DNO=@dno+065 LET=@L.TP()]
	LOAD[FILE=$fn DNO=@dno+066 LET=@L.V()]
	LOAD[FILE=$fn DNO=@dno+067 LET=@L.W()]
	LOAD[FILE=$fn DNO=@dno+068 LET=@L.X()]
	LOAD[FILE=$fn DNO=@dno+069 LET=@L.Y()]
	LOAD[FILE=$fn DNO=@dno+070 LET=@L.Z()]
	LOAD[FILE=$fn DNO=@dno+071 LET=@L.SD()]
	LOAD[FILE=$fn DNO=@dno+072 LET=@L.MD()]

	LOAD[FILE=$fn DNO=@dno+073 LET=$L.EMVO()]
	LOAD[FILE=$fn DNO=@dno+074 LET=@L.EMVO()]
	LOAD[FILE=$fn DNO=@dno+075 LET=$L.EMV()]
	LOAD[FILE=$fn DNO=@dno+076 LET=$L.EMP()]
	LOAD[FILE=$fn DNO=@dno+077 LET=$L.EMS()]
	LOAD[FILE=$fn DNO=@dno+078 LET=$L.EMPA()]
	LOAD[FILE=$fn DNO=@dno+079 LET=$L.EMSA()]

	LOAD[FILE=$fn DNO=@dno+080 LET=@L.ANFLAG()]
	LOAD[FILE=$fn DNO=@dno+081 LET=@L.ANC()]
	LOAD[FILE=$fn DNO=@dno+082 LET=@L.ANC2()]
//	LOAD[FILE=$fn DNO=@dno+083 LET=@L.ANC3()]
	LOAD[FILE=$fn DNO=@dno+084 LET=@L.ANC4()]
	LOAD[FILE=$fn DNO=@dno+085 LET=@L.ANX()]
	LOAD[FILE=$fn DNO=@dno+086 LET=@L.ANY()]
	LOAD[FILE=$fn DNO=@dno+087 LET=@L.ANNUM()]
	LOAD[FILE=$fn DNO=@dno+088 LET=@L.ANTIME()]
	LOAD[FILE=$fn DNO=@dno+089 LET=@L.ANSTOP()]
	LOAD[FILE=$fn DNO=@dno+090 LET=@L.ANLOOP()]

	LOAD[FILE=$fn DNO=@dno+100 LET=@S.FLAG()]
	LOAD[FILE=$fn DNO=@dno+101 LET=@S.FLAG.END()]
	LOAD[FILE=$fn DNO=@dno+102 LET=@S.TNOW()]
	LOAD[FILE=$fn DNO=@dno+103 LET=@S.TOLD()]
	LOAD[FILE=$fn DNO=@dno+104 LET=$S.NAME()]
	LOAD[FILE=$fn DNO=@dno+105 LET=$S.SPID()]
	LOAD[FILE=$fn DNO=@dno+106 LET=@S.QNO()]
	LOAD[FILE=$fn DNO=@dno+107 LET=@S.QNO2()]
	LOAD[FILE=$fn DNO=@dno+108 LET=@S.LNO()]
	LOAD[FILE=$fn DNO=@dno+109 LET=@S.COM()]
	LOAD[FILE=$fn DNO=@dno+110 LET=@S.FTYPE()]
	LOAD[FILE=$fn DNO=@dno+111 LET=$S.FCG()]
	LOAD[FILE=$fn DNO=@dno+112 LET=$S.FTR()]
	LOAD[FILE=$fn DNO=@dno+113 LET=$S.TXF()]
	LOAD[FILE=$fn DNO=@dno+114 LET=$S.TXS()]
	LOAD[FILE=$fn DNO=@dno+115 LET=@S.YMP()]
	LOAD[FILE=$fn DNO=@dno+116 LET=@S.TIP()]
	LOAD[FILE=$fn DNO=@dno+117 LET=@S.SK()]
	LOAD[FILE=$fn DNO=@dno+118 LET=@S.I1()]
	LOAD[FILE=$fn DNO=@dno+119 LET=@S.I2()]
	LOAD[FILE=$fn DNO=@dno+120 LET=@S.I3()]
	LOAD[FILE=$fn DNO=@dno+121 LET=@S.I4()]
	LOAD[FILE=$fn DNO=@dno+122 LET=@S.F1()]
	LOAD[FILE=$fn DNO=@dno+123 LET=@S.F2()]
	LOAD[FILE=$fn DNO=@dno+124 LET=@S.L1()]
	LOAD[FILE=$fn DNO=@dno+125 LET=@S.L2()]
	LOAD[FILE=$fn DNO=@dno+126 LET=@S.L3()]
	LOAD[FILE=$fn DNO=@dno+127 LET=@S.L4()]
	LOAD[FILE=$fn DNO=@dno+128 LET=@S.N()]
	LOAD[FILE=$fn DNO=@dno+129 LET=@S.T()]
	LOAD[FILE=$fn DNO=@dno+130 LET=@S.AC()]
	LOAD[FILE=$fn DNO=@dno+131 LET=$S.PARENT()]
	LOAD[FILE=$fn DNO=@dno+132 LET=@S.SDMD.NA()]
	LOAD[FILE=$fn DNO=@dno+133 LET=@S.F3()]
	LOAD[FILE=$fn DNO=@dno+134 LET=@S.F4()]

	LOAD[FILE=$fn DNO=@dno+135 LET=$S.EMVO()]
	LOAD[FILE=$fn DNO=@dno+136 LET=$S.EMV()]
	LOAD[FILE=$fn DNO=@dno+137 LET=$S.EMP()]
	LOAD[FILE=$fn DNO=@dno+138 LET=$S.EMS()]
	LOAD[FILE=$fn DNO=@dno+139 LET=$S.EMPA()]
	LOAD[FILE=$fn DNO=@dno+140 LET=$S.EMSA()]

	LOAD[FILE=$fn DNO=@dno+200 LET=@P.I1()]
	LOAD[FILE=$fn DNO=@dno+201 LET=@P.I2()]
	LOAD[FILE=$fn DNO=@dno+202 LET=@P.I3()]
	LOAD[FILE=$fn DNO=@dno+203 LET=@P.I4()]
	LOAD[FILE=$fn DNO=@dno+204 LET=@P.F1()]
	LOAD[FILE=$fn DNO=@dno+205 LET=@P.F2()]
	LOAD[FILE=$fn DNO=@dno+206 LET=@P.L1()]
	LOAD[FILE=$fn DNO=@dno+207 LET=@P.L2()]
	LOAD[FILE=$fn DNO=@dno+208 LET=@P.L3()]
	LOAD[FILE=$fn DNO=@dno+209 LET=@P.L4]
	LOAD[FILE=$fn DNO=@dno+210 LET=$P.S1()]
	LOAD[FILE=$fn DNO=@dno+211 LET=$P.S2()]
	LOAD[FILE=$fn DNO=@dno+212 LET=@P.N()]
	LOAD[FILE=$fn DNO=@dno+213 LET=@P.T()]
	LOAD[FILE=$fn DNO=@dno+214 LET=@P.AC()]
	LOAD[FILE=$fn DNO=@dno+215 LET=$P.PARENT()]
	LOAD[FILE=$fn DNO=@dno+216 LET=@P.SDMD.NA()]

	LOAD[FILE=$fn DNO=@dno+221 LET=@QUE.R]
	LOAD[FILE=$fn DNO=@dno+222 LET=@QUE.W]
	LOAD[FILE=$fn DNO=@dno+223 LET=@g.QNOW]
	LOAD[FILE=$fn DNO=@dno+224 LET=@COMQNOR()]
	LOAD[FILE=$fn DNO=@dno+225 LET=@COMQNOW()]

	LOAD[FILE=$fn DNO=@dno+231 LET=@es.EF.SAIDO]
	LOAD[FILE=$fn DNO=@dno+232 LET=@es.EF.MEIDO]

	LOAD[FILE=$fn DNO=@dno+241 LET=@es.MIMI.STOP()]
//	LOAD[FILE=$fn DNO=@dno+242 LET=@es.MIMI.COM.INIT()]
//	LOAD[FILE=$fn DNO=@dno+243 LET=@es.MIMI.COM.COUNT()]
//	LOAD[FILE=$fn DNO=@dno+244 LET=@es.MIMI.COM.WAIT()]

	LOAD[FILE=$fn DNO=@dno+251 LET=@SPLN.LX()]
	LOAD[FILE=$fn DNO=@dno+252 LET=@SPLN.LY()]
	LOAD[FILE=$fn DNO=@dno+253 LET=@SPLN.LZ()]
	LOAD[FILE=$fn DNO=@dno+254 LET=@SPLN.PXNUM()]

	LOAD[FILE=$fn DNO=@dno+261 LET=@spln.a()]
	LOAD[FILE=$fn DNO=@dno+262 LET=@spln.b()]
	LOAD[FILE=$fn DNO=@dno+263 LET=@spln.c()]
	LOAD[FILE=$fn DNO=@dno+264 LET=@spln.d()]
	LOAD[FILE=$fn DNO=@dno+265 LET=@spln.t()] //２点間の移動時間
//	LOAD[FILE=$fn DNO=@dno+266 LET=@spln.x()]
//	LOAD[FILE=$fn DNO=@dno+267 LET=@spln.y()]
//	LOAD[FILE=$fn DNO=@dno+268 LET=@spln.z()]

	LOAD[FILE=$fn DNO=@dno+270 LET=$L.EMDATA()]



	INT[@sdmd.na]
	INT[@No]
	STR[$LB1]
//	STR[$LB2]
	STR[$LB11]
	STR[$LB12]
	STR[$L1]
	STR[$lp.fn]
	STR[$loadfilename]

	INT[@LNO]
	LOOP[SET=(@LMAX)]
	{
		@LNO=@_LC

		IF[@L.FTYPE(@LNO)==6]
		{
			GOSUB[#=es.L.YMV.INIT pint=@LNO]
		}
		ELSE[$L.FCG(@LNO)=="***"]
		{
			GOSUB[#=es.SP.LOADCGE PINT=@LNO PINT2=0 PINT3=@L.SX(@LNO) PINT4=@L.SY(@LNO)]
			GOSUB[#=es.SP.LOADCGT PINT=@LNO PINT2=@L.TXV(@LNO)]
		}
		ELSE[$L.FCG(@LNO)!="" && $L.SPID(@LNO)!="LNO_CM" && $L.SPID(@LNO)!="LNO_CMF"] // && $L.SPID(@LNO)!="LNO_FD"] //幕レイヤは読込必要.
		{
			//読み込み処理
				@No=@LNO
				$LB1=$LIDBUF+$(1+@No*100)
//				$LB2=$LIDBUF+$(2+@No*100)
				$LB11=$LIDBUF+$(11+@No*100)
				$LB12=$LIDBUF+$(12+@No*100)
				$L1=$LID+$(1+@No*100)

				$lp.fn = $L.FCG(@LNO)

///				IF[@L.FTYPE(@No)==5]
///					GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$lp.fn] IF[$_RSTR(1)!=""] $lp.fn=$_RSTR(1)+$lp.fn IFEND[]
///				IFEND[]

	GOSUB[#=es.CGCXY.DEF.SEARCH pstr=$lp.fn pint2=(@L.FTYPE(@LNO)==1)]
	@L.CX(@No) = @_RINT(1)
	@L.CY(@No) = @_RINT(2)
/*	@LNO_BGZ   = @_RINT(3)
	IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
	{
		@LNO_BGZ = @DEFZ
	}
	IFEND[]

	IF[@LNO_CMFLAG==1] //背景・イベ絵変更時、カメラ位置指定
	{
		//\BG.CMXYZ,\EV.CMXYZ で設定済
	}
	ELSE[]
	{
		@LNO_CMV = @_RINT(4)
		@LNO_CMW = 0
		@LNO_CMX = @_RINT(5)
		@LNO_CMY = @_RINT(6)
		@LNO_CMZ = @_RINT(7)

		IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
		{
			@LNO_CMV = 0
			@LNO_CMW = 0
			@LNO_CMX = 0
			@LNO_CMY = 0
			@LNO_CMZ = 0
		}
		IFEND[]
	}
	IFEND[]

	IF[@No==@LNO_BG]
		@L.Z(@LNO_BG)=@LNO_BGZ
		@L.V(@LNO_CM)=@LNO_CMV
		@L.W(@LNO_CM)=@LNO_CMW
		@L.X(@LNO_CM)=@LNO_CMX
		@L.Y(@LNO_CM)=@LNO_CMY
		@L.Z(@LNO_CM)=@LNO_CMZ
	IFEND[]
	IF[@No==@LNO_BGF]
		@L.Z(@LNO_BGF)=@LNO_BGZ
		@L.V(@LNO_CMF)=@LNO_CMV
		@L.W(@LNO_CMF)=@LNO_CMW
		@L.X(@LNO_CMF)=@LNO_CMX
		@L.Y(@LNO_CMF)=@LNO_CMY
		@L.Z(@LNO_CMF)=@LNO_CMZ
	IFEND[]
*/


//\_dmes("NO="+$(@LNO)+", $L.FCG(@LNO)="+$L.FCG(@LNO)+", $loadfilename="+$loadfilename)

				//画像合成判定
				GOSUB[#=es.SP.PRO.CHECKCG pstr=$lp.fn]
				STR[$fnA=$_RSTR(1)]
				STR[$fnB=$_RSTR(2)]
				INT[@MX=@_RINT(3)]
				INT[@MY=@_RINT(4)]
				INT[@COMP=@_RINT(5)]

				IF[@L.FTYPE(@LNO)==5]
					GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnA] IF[$_RSTR(1)!=""] $fnA=$_RSTR(1)+$fnA IFEND[]
					GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnB] IF[$_RSTR(1)!=""] $fnB=$_RSTR(1)+$fnB IFEND[]
				IFEND[]

				IF[$fnA!=""] $fnA=$PATH(@L.FTYPE(@LNO))+$fnA IFEND[]
				IF[$fnB!=""] $fnB=$PATH(@L.FTYPE(@LNO))+$fnB IFEND[]

				//ＣＧ読込
				IF[@L.ANFLAG(@LNO)==0 || @L.ANFLAG(@LNO)==3]
				{
					GOSUB[#=es.SP.PRO.LOADCG pstr=$LB1 pstr2=$fnA pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@LNO) pint8=@L.SD(@LNO)]
					CG[ID=$LB1 E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(@L.BL(@LNO))]
				}
				ELSE[@L.ANFLAG(@LNO)==1] //連番アニメ
				{
					LOOP[SET=@L.ANNUM(@LNO)]
					{
						\_inttostr(@_LC,2)
						GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(@_LC+@LNO*100) pstr2=$fnA+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@LNO)]
						CG[ID=$LB1 E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(@L.BL(@LNO))]
					}
					LOOPEND[]
				}
				ELSE[@L.ANFLAG(@LNO)==2] //パターンアニメ
				{
					GOSUB[#=es.SPA2.DEF.SEARCH pstr=$lp.fn]
					INT[@pno=@_RINT(1)]
				//	@Annum=@_RINT(2)
				//	@L.ANLOOP(@No)	= @_RINT(3)

				//	\_dmes("パターン定義アニメ. FN="+$lp.fn+", NUM="+$(@Annum))

					INT[@AN_A]
					INT[@AN_SRCX]
					INT[@AN_SRCY]
					INT[@AN_SRCSX]
					INT[@AN_SRCSY]
					INT[@sx]
					INT[@sy]
					LOOP[SET=@L.ANNUM(@No)]
					{
						GOSUB[#=es.SPA2.GET.PDATA pint=@pno+@_LC-1]
						@AN_A    =@_RINT(2)
						@AN_SRCX =@_RINT(3)
						@AN_SRCY =@_RINT(4)
						@AN_SRCSX=@_RINT(5)
						@AN_SRCSY=@_RINT(6)
						GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(@_LC+@No*100) pstr2="cg/"+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=0 pint7=@L.FTYPE(@No)]

						CGINFO[ID=$LIDBUF+$(@_LC+@No*100) SX=1 LET=@sx]
						CGINFO[ID=$LIDBUF+$(@_LC+@No*100) SY=1 LET=@sy]

						//サイズ指定が無かったら、レイヤサイズをセット.
						IF[@AN_SRCSX==0] @AN_SRCSX=@sx IFEND[]
						IF[@AN_SRCSY==0] @AN_SRCSY=@sy IFEND[]

						//はみ出たら調整
						IF[@AN_SRCX+@AN_SRCSX >= @sx] @AN_SRCSX = @sx - @AN_SRCX IFEND[]
						IF[@AN_SRCY+@AN_SRCSY >= @sy] @AN_SRCSY = @sy - @AN_SRCY IFEND[]

						CGACT[ID=$LIDBUF+$(@_LC+@No*100) SIZE=1 X=@AN_SRCX Y=@AN_SRCY X2=@AN_SRCX+@AN_SRCSX Y2=@AN_SRCY+@AN_SRCSY SX=@AN_SRCSX SY=@AN_SRCSY]

						//不透明度加工
						IF[@AN_A<256]
							CG[ID="ANM.TMP" Z=1 A=@AN_A E=0 FILE=""]
							CGACT[ID=$LIDBUF+$(@_LC+@No*100) ID2="ANM.TMP" COPY2=1]
							CGACT[ID=$LIDBUF+$(@_LC+@No*100) RECTPAINT3=1 SET=0]
							CGACT[ID="ANM.TMP" ID2=$LIDBUF+$(@_LC+@No*100) MERGE2=1]
							CGEND[ID="ANM.TMP"]
						IFEND[]

						CG[ID=$LIDBUF+$(@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]
					}
					LOOPEND[]

				//	@L.ANFLAG(@No)	= 2

				//	GOSUB[#=es.SPA2.GET.PDATA2 pint=@pno]
				//	@L.ANTIME(@No)	= @_RINT(1) //最初のフレームの表示時間を格納
				//	@L.ANSTOP(@No)	= 0
				//	@L.ANC(@No)	= 1
				//	@L.YMTIME(@No)	= @_OS_TIME(1)

				//	@L.ANNUM(@No)	= @Annum
				}
				IFEND[]

				//1x1なら(画像が無かったら)完全透明にしておく
				INT[@lllsx]CGINFO[ID=$LB1 SX=1 LET=@lllsx]
				INT[@lllsy]CGINFO[ID=$LB1 SY=1 LET=@lllsy]
				IF[@lllsx==1 && @lllsy==1] CGACT[ID=$LB1 RECTPAINT3=1 SET=0] IFEND[]

				/*
				IF[@L.FTYPE(@No)==1 || @L.FTYPE(@No)==2] // 1x1 分引き延ばす
				{
					CGACT[ID=$LB1 RESIZE=1 X=1 X2=1 Y=1 Y2=1]
				}
				IFEND[]
				*/

				//幕レイヤなら強制的に @es.GSX x @es.GSY へ
		//		IF[@No==@LNO_FD] CGACT[ID=$LB1 SIZE=1 SX=@es.GSX SY=@es.GSY] IFEND[]

				//画像サイズ取得
				CGINFO[ID=$LB1 SX=1 LET=@L.SX(@No)]
				CGINFO[ID=$LB1 SY=1 LET=@L.SY(@No)]

				IF[@L.SD(@No)!=     128] CGACT[ID=$LB1  SAIDO=1 SET=@L.SD(@No)] IFEND[]
				IF[@L.MD(@No)!=0x808080] CGACT[ID=$LB1  MEIDO=1 SET=@L.MD(@No)] IFEND[]
/*
				IF[@sdmd.na==0]
					IF[@es.EF.SAIDO!=     128] CGACT[ID=$LB1 SAIDO=1 SET=@es.EF.SAIDO] IFEND[]
					IF[@es.EF.MEIDO!=0x808080] CGACT[ID=$LB1 MEIDO=1 SET=@es.EF.MEIDO] IFEND[]
				IFEND[]
*/
				CG[ID=$LB1 TEX=@_DXMODE]

IF[@_DXMODE==0]
	CG[ID=$L1 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@L.BL(@LNO)) FILE=""] //実際の表示レイヤ
	CGACT[ID=$L1 RECTPAINT3=1 SET=0x00000000]
IFEND[]

				//レイヤ中心点設定
				IF[@L.CX(@No)==-9999999] @L.CX(@No) = @L.SX(@No) / 2 IFEND[]
				IF[@L.CY(@No)==-9999999] @L.CY(@No) = @L.SY(@No) / 2 IFEND[]




	//立ち絵アニメデータ読み込み
	STR[$spa.fn]
	STR[$spa.fn2]
	INT[@compmode]

	GOSUB[#=es.SPA.DEF.SEARCH pstr=$lp.fn]
	IF[$_RSTR(1)!=""]
	{
		$spa.fn  = $_RSTR(1)
		@L.ANFLAG(@No) = 3
		@L.ANX(@No) = @_RINT(2)
		@L.ANY(@No) = @_RINT(3)
		@L.ANNUM(@No) = @_RINT(4)
		@L.ANTIME(@No) = @_RINT(5)
		@compmode = @_RINT(6)

		IF[@L.FTYPE(@No)==5]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$spa.fn] IF[$_RSTR(1)!=""] $spa.fn=$_RSTR(1)+$spa.fn IFEND[]
		IFEND[]

		IF[$spa.fn!=""] $spa.fn=$PATH(@L.FTYPE(@No))+$spa.fn IFEND[]

		GOSUB[#=es.SP.PRO.LOADCG.2 pstr=$LIDBUF pstr2=$LIDBUF pstr3=$fnA pstr4=$spa.fn pint5=@L.ANX(@No) pint6=@L.ANY(@No) pint7=@compmode pint8=@No pint9=@L.ANNUM(@No) pint10=@L.MD(@No)*65536+@L.SD(@No)]

		LOOP[SET=@L.ANNUM(@No)]
		{
/*
			\_inttostr(@_LC, 2)($spa.fn2)
	//		CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0) FILE=$spa.fn+$spa.fn2] //データバッファ

			//ＣＧ読込
			GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(1+@_LC+@No*100) pstr2=$fnA pstr3=$spa.fn+$spa.fn2 pint4=@L.ANX(@No) pint5=@L.ANY(@No) pint6=@compmode pint7=@L.FTYPE(@No)]
*/
			CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

//			IF[@L.SD(@No)!=     128] CGACT[ID=$LIDBUF+$(1+@_LC+@No*100) SAIDO=1 SET=@L.SD(@No)] IFEND[]
//			IF[@L.MD(@No)!=0x808080] CGACT[ID=$LIDBUF+$(1+@_LC+@No*100) MEIDO=1 SET=@L.MD(@No)] IFEND[]

				//	CG[ID=$LIDBUF+$(@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化
					CG[ID=$LIDBUF+$(1+@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化

		}
		LOOPEND[]
	}
	IFEND[]



///xE-mote
	INT[@texchk]
	CGINFO[ID=$LIDBUF+$(1+@LNO*100) TEX=1 LET=@texchk]
	IF[@texchk==2]
	{
		EMOTE[ID=$LIDBUF+$(1+@LNO*100) DATA=$L.EMDATA(@LNO)]

//		\_dmes("$L.SPID = "+$L.SPID(@LNO)+$_CHR(13)+"DATA = "+$L.EMDATA(@LNO))

		IF[$L.EMP(@LNO)!=""]
		{
			EMOTE[ID=$LIDBUF+$(1+@LNO*100) LABEL=$L.EMP(@LNO) PLAY=1]
		}
		IFEND[]
		IF[$L.EMPA(@LNO)!=""]
		{
			EMOTE[ID=$LIDBUF+$(1+@LNO*100) LABEL=$L.EMPA(@LNO) PLAY=2]
		}
		IFEND[]

	}
	IFEND[]






			//トランジション画像読み込み
			IF[$L.FTR(@No)!=""]
			{
				//	\_dmes("$L.FTR = "+$L.FTR(@No))


						INT[@Rev=@L.TRR(@No)]

					//	STR[$L1    =$LID     +$(1+@No*100)]
						STR[$TR1   =$LIDTR   +$(1+@No*100)]
						STR[$TRBUF1=$LIDTRBUF+$(1+@No*100)]

						STR[$TR]
						STR[$loadfilenameTR]

						{
							//----------------------------------------------------------------
							// TR 定義文字列か否か調べる.
							//----------------------------------------------------------------
								INT[@TRA] //精度
								GOSUB[#=es.TRDEF.CHECK PSTR=$L.FTR(@No)]
								$TR		= $_RSTR(1)
								@TRA	= @_RINT(2)

								//これは要らない
								//IF[@Ta!=-1] @TRA=@Ta IFEND[] //トランジション精度の指定があった場合はそちらを優先.

								\_range(@TRA, 0, 256)

								@L.TRA(@No) = @TRA
								@L.TRR(@No)	= 0

								$loadfilenameTR = $PATH(4)+$TR

								IF[$TR!=""] //定義文字列あった場合
								{
									//----------------------------------------------------------------
									// トランジション画像をロード
									//----------------------------------------------------------------
										CG[ID=$TRBUF1 Z=1 E=0 A=0                                         FILE=$loadfilenameTR]

					///xS
					//一瞬でもトランジションサイズが違ってしまうのを防ぐ.
					//INT[@sx]INT[@sy]
					//CGINFO[ID=$TRBUF1 SX=1 LET=@sx]
					//CGINFO[ID=$TRBUF1 SY=1 LET=@sy]
								//		CG[ID=$TR1    Z=1 E=0 A=0 SX=@sx SY=@sy                           FILE=""]
										CG[ID=$TR1    Z=1 E=0 A=0 SX=1   SY=1                             FILE=""]
					/*
											CGACT[ID=$TRBUF1 ID2=$TR1 SIZE=1 SX=@sx SY=@sy]
					*/
										IF[@_DXMODE==0]
											IF[@Rev==1] @L.TRR(@No)=1; CGACT[ID=$TRBUF1 REVERSE=1] IFEND[]
										ELSE[]
//
										IFEND[]

										CG[ID=$L1 TID=""] //初期化しておく

								}
								IFEND[]
						}

			}
			IFEND[]


IF[@_DEBUGMODE>=@dbg.val]

	//チップ画像読み込み
	//
	IF[@L.FTYPE(@No)==1 || @L.FTYPE(@No)==2] //BGEV
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF0 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000000000000+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF3 ID2=CP+$(@No) COPY2=1]
	}
	ELSE[@L.FTYPE(@No)!=5] //その他立ち絵以外
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF1 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000000000000+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF3 ID2=CP+$(@No) COPY2=1]
	}
	ELSE[] //前景
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF2 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000000000000+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF4 ID2=CP+$(@No) COPY2=1]
	}
	IFEND[]


IFEND[]


//				@DRAW.FLAG(@LNO) = 2 //最終描画

				GOSUB[#=es.SP.DRAW pint=@LNO pint2=1 pint3=1] //pint2=1→最終描画フラグ

		}
		IFEND[]

	}
	LOOPEND[]


	LOOP[SET=@QUE.MAX]
	{
		IF[@S.TOLD(@_LC)] @S.TOLD(@_LC) = @_OS_TIME(1) IFEND[]
	}
	LOOPEND[]


/*
	INT[@LNO]

	LOOP[SET=@LMAX+1]
	{
		@LNO=@_LC-1

		IF[@LNO>0]
		{
			CGEND[ID=$LIDBUF+$(1+@LNO*100)] //データバッファ
			CGEND[ID=$LID   +$(1+@LNO*100)] //実際の表示レイヤ
		}
		IFEND[]
	}
	LOOPEND[]
*/

	return[]
}


#=es.L.LOAD2
{
	INT[@r]

	LOOP[SET=(@LMAX+1)]
	{
		@LNO=@_LC-1

		CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
		IF[@r==0 && @LNO!=@LNO_CM && @LNO!=@LNO_CMF]
		{
			LOOPCONTINUE[]
		}
		IFEND[]

		@DRAW.FLAG(@LNO)=1
	}
	LOOPEND[]

	//-------------------------------------------------------------------------
	// 描画
	//-------------------------------------------------------------------------
	LOOP[SET=(@LMAX)]
	{
		IF[@DRAW.FLAG(@_LC)==1]
			GOSUB[#=es.SP.DRAW pint=@_LC pint2=0 pint3=@DIR_CAMERA] //pint2=0→描画途中フラグ
		ELSE[@DRAW.FLAG(@_LC)==2]
			GOSUB[#=es.SP.DRAW pint=@_LC pint2=1 pint3=@DIR_CAMERA] //pint2=1→最終描画フラグ
		IFEND[]
	}
	LOOPEND[]

	//-------------------------------------------------------------------------
	// POST描画
	//-------------------------------------------------------------------------
	GOSUB[#=es.SP.DRAW.POST]

	//-------------------------------------------------------------------------
	// 初期化
	//-------------------------------------------------------------------------
	LOOP[SET=(@LMAX+1)]
	{
		@DRAW.FLAG(@_LC-1)=0
	}
	LOOPEND[]

/*
	LOOP[SET=@QUE.MAX]
	{
		IF[@S.TOLD(@_LC)] @S.TOLD(@_LC) = @_OS_TIME(1) IFEND[]
	}
	LOOPEND[]
*/
	return[]
}


//-------------------------------------------------------------------------
//■バッファデータ変更
//-------------------------------------------------------------------------
#=es.SP.INFO.CHANGE
{
	INT[@No=@_PINT(1)]
//FILEACT[ID=$LIDBUF +$(1+@No*100) FILE="1_LIDBUF1"]
//FILEACT[ID=$LIDBUF2+$(1+@No*100) FILE="1_LIDBUF2"]
	CGACT[COPY2=1 ID=$LIDBUF2+$(1+@No*100) ID2=$LIDBUF+$(1+@No*100)] //データバッファ
//FILEACT[ID=$LIDBUF +$(1+@No*100) FILE="2_LIDBUF1"]
//FILEACT[ID=$LIDBUF2+$(1+@No*100) FILE="2_LIDBUF2"]

	CG[ID=$LIDBUF+$(1+@No*100) TEX=@_DXMODE]

	return[]
}

//-------------------------------------------------------------------------
//■情報保持値初期化
//-------------------------------------------------------------------------
#=es.SP.INFO.INIT
{
	INT[@No=@_PINT(1)]

	IF[@No!=@LNO_BG && @No!=@LNO_BGF && @No!=@LNO_CM && @No!=@LNO_CMF && @No!=@LNO_FD]
		$L.SPID(@No) = ""
	ELSE[]
//		\_dmes($L.SPID(@No))
	IFEND[]

	$L.FCG(@No)		= ""
	$L.FTR(@No)		= ""
	@L.YMTIME(@No)	= 0
	@L.YMFPS(@No)	= 0

	@L.TRA(@No)		= 0
	@L.TRR(@No)		= 0
	@L.CHRNO(@No)	= 0
	@L.LZCNT(@No)	= 0
	@L.FTYPE(@No)	= 0
	@L.TIP(@No)		= 0
	@L.ST(@No)		= 0
	@L.BL(@No)		= 0

	@L.HOR(@No)		= 0
	@L.VER(@No)		= 0
	@L.REV(@No)		= 0
	@L.MONO(@No)	= 0
	@L.BLUR(@No)	= 0
	@L.MOSA(@No)	= 0
	@L.DIFF(@No)	= 0
	@L.ROT(@No)		= 0
	@L.RAS(@No)		= 0
	@L.WPL(@No)		= 0
	@L.AKA(@No)		= 128

	@L.PARENT(@No)	= 0
	@L.CHILD(@No)	= 0
	@L.SX(@No)		= 0
	@L.SY(@No)		= 0
	@L.LV(@No)		= @es.Z.SP + @No
	@L.CX(@No)		= 0
	@L.CY(@No)		= 0
	@L.A(@No)		= 0
	@L.F1(@No)		= 0
	@L.F2(@No)		= 0
	@L.AX(@No)		= 0
	@L.AY(@No)		= 0
	@L.AZ(@No)		= 0
	@L.ABX(@No)		= 0
	@L.ABY(@No)		= 0
	@L.MX(@No)		= 100
	@L.MY(@No)		= 100
	@L.MZ(@No)		= 100
	@L.QX(@No)		= 0
	@L.QY(@No)		= 0
	@L.QZ(@No)		= 0
	@L.RX(@No)		= 0
	@L.RY(@No)		= 0
	@L.RZ(@No)		= 0
	@L.CLBX(@No)	= 0
	@L.CLBY(@No)	= 0
	@L.CLA(@No)		= 0
	@L.CLH(@No)		= 0
	@L.CLTP(@No)	= 0
	@L.CLV(@No)		= 0
	@L.CLW(@No)		= 0
	@L.CLX(@No)		= 0
	@L.CLY(@No)		= 0
	@L.CLZ(@No)		= 0
	@L.CLRX(@No)	= 0
	@L.CLRY(@No)	= 0
	@L.CLRZ(@No)	= 0
	@L.BX(@No)		= 100
	@L.BY(@No)		= 100
	@L.H(@No)		= 256
	@L.TP(@No)		= 256
	@L.V(@No)		= 0
	@L.W(@No)		= 0
	@L.X(@No)		= 0
	@L.Y(@No)		= 0
	@L.Z(@No)		= @DEFZ
	@L.SD(@No)		= 128
	@L.MD(@No)		= 0x808080

	@L.TXV(@No)		= 0
	$L.TXF(@No)		= ""
	$L.TXS(@No)		= ""

	$L.EMVO(@No)	= ""
	@L.EMVO(@No)	= 0
	@L.EMVOL(@No)	= 0
	$L.EMV(@No)		= ""
	$L.EMP(@No)		= ""
	$L.EMS(@No)		= ""
	$L.EMPA(@No)	= ""
	$L.EMSA(@No)	= ""

	@L.ANFLAG(@No)	= 0
	@L.ANC(@No)		= 0
	@L.ANC2(@No)	= 0
	@L.ANC3(@No)	= 0
	@L.ANC4(@No)	= 0
	@L.ANX(@No)		= 0
	@L.ANY(@No)		= 0
	@L.ANNUM(@No)	= 0
	@L.ANTIME(@No)	= 0
	@L.ANSTOP(@No)	= 99999
	@L.ANLOOP(@No)	= 0

	@STA.PrevVal(@No) = 0

	@DBG.LX(@No)	= 0
	@DBG.LY(@No)	= 0
	@DBG.LZ(@No)	= 0

	@USR.LX(@No)	= 0
	@USR.LY(@No)	= 0
	@USR.LZ(@No)	= 0

	return[]
}


//----------------------------------------------------------------------------
//■パラメータ初期化
//----------------------------------------------------------------------------
#=es.SP.P.INIT
{
	INT[@No = @_PINT(1)]

	@P.I1(@No)		= 0
	@P.I2(@No)		= 0
	@P.I3(@No)		= 0
	@P.I4(@No)		= 0
	@P.F1(@No)		= 0
	@P.F2(@No)		= 0
	$P.S1(@No)		= ""
	$P.S2(@No)		= ""
	@P.SDMD.NA(@No)	= 0

	return[]
}

//----------------------------------------------------------------------------
//■キュー初期化
//----------------------------------------------------------------------------
#=es.SP.QUE.INIT.ONE
{
	INT[@No = @_PINT(1)]
//\_log("☆QUE.INIT:"+$(@No))

	@S.TNOW(@No)	= 0
	@S.TOLD(@No)	= 0
	$S.NAME(@No)	= ""
	$S.SPID(@No)	= ""
	$S.FCG(@No)		= ""
	$S.FTR(@No)		= ""
	$S.TXF(@No)		= ""
	$S.TXS(@No)		= ""
	@S.YMP(@No)		= 0
	@S.QNO(@No)		= 0
	@S.QNO2(@No)	= 0
	@S.LNO(@No)		= 0
	@S.COM(@No)		= 0
	@S.FTYPE(@No)	= 0

	$S.EMVO(@No)	= ""
	$S.EMV(@No)		= ""
	$S.EMP(@No)		= ""
	$S.EMS(@No)		= ""
	$S.EMPA(@No)	= ""
	$S.EMSA(@No)	= ""

	@S.I1(@No)		= 0
	@S.I2(@No)		= 0
	@S.I3(@No)		= 0
	@S.I4(@No)		= 0
	@S.F1(@No)		= 0
	@S.F2(@No)		= 0
	@S.F3(@No)		= 0
	@S.F4(@No)		= 0
	@S.N(@No)		= 0
	@S.T(@No)		= 0
	@S.AC(@No)		= 0
	$S.PARENT(@No)	= ""
	@S.SDMD.NA(@No)	= 0
	@S.TIP(@No)		= 0
	@S.SK(@No)		= 0

//	GOSUB[#=es.SP.HCOM.INIT]

	return[]
}

#=es.SP.QUE.INIT.ALL
{
///xS暫定的
	LOOP[SET=(4)]
	{
		GOSUB[#=es.SP.P.INIT pint=@_LC-1]
	}
	LOOPEND[]

	LOOP[SET=(@LMAX+1)]
	{
		GOSUB[#=es.SP.INFO.INIT pint=@_LC-1]
	}
	LOOPEND[]

	LOOP[SET=@QUE.MAX+1]
	{
		GOSUB[#=es.SP.QUE.INIT.ONE pint=@_LC-1]
		@S.FLAG(@_LC-1)		= 0
		@S.FLAG.END(@_LC-1)	= 1
	}
	LOOPEND[]

	GOSUB[#=es.SP.HCOM.INIT]

	return[]
}

#=es.SP.HCOM.INIT
{
	LOOP[SET=(77)] @H.COM(@_LC-1)=0 LOOPEND[]
	return[]
}




//////


#=es.MIMI.STOP.CSEARCH
{
	INT[@no=@_PINT(1)]
	INT[@ret]
/*
	IF[$L.SPID(@no)=="xxx"] @ret=@es.MIMI.STOP(1) IFEND[]
	IF[$L.SPID(@no)=="xxx"] @ret=@es.MIMI.STOP(2) IFEND[]
	IF[$L.SPID(@no)=="xxx"] @ret=@es.MIMI.STOP(4) IFEND[]
	IF[$L.SPID(@no)=="xxx"] @ret=@es.MIMI.STOP(5) IFEND[]
	IF[$L.SPID(@no)=="xxx"] @ret=@es.MIMI.STOP(6) IFEND[]
*/
	return[rint=@ret]
}

//■立ち絵アニメ
#=es.L.STA.MAIN
{

	INT[@no1]
	INT[@flag]


	//----------------------------------------------------------------
	// ボイス再生状況取得
	//----------------------------------------------------------------
///xE-mote
		INT[@voplayflag]
		INT[@voplaychara]
		FLT[@voplayvol]
		FLT[@voplayvol2]
		FLT[@vodif]
		STR[$emvo]

		//パターン@
	//		\VO.PCHK;@voplayflag=@_RINT(1)
		//パターンA
		LOOP[SET=10]
			\VO.VCHK(@_LC);@voplayflag=@_RINT(1)
			IF[@voplayflag>0] @voplaychara=@_RINT(2);@voplayvol=@_RFLT(3)*3;LOOPBREAK[] IFEND[]
		LOOPEND[]


	LOOP[SET=@LMAX]
	{
		@no1=@_LC

///xE-mote
		//----------------------------------------------------------------
		// ボイス連動口パク
		//----------------------------------------------------------------
			IF[@L.EMVO(@no1)>0]
			{
				@voplayvol2 = 0
				IF[@L.EMVO(@no1)==@voplaychara] @voplayvol2 = @voplayvol IFEND[]

				//口の極端な動きを抑制
				@vodif = @voplayvol2 - @L.EMVOL(@no1)
				IF[@vodif> 1] @vodif= 1 IFEND[]
				IF[@vodif<-1] @vodif=-1 IFEND[]
				@L.EMVOL(@no1)+=@vodif
				@voplayvol2=@L.EMVOL(@no1)

				$emvo = $L.EMVO(@no1)
				EMOTE[ID=$LIDBUF +$(1+@no1*100) VAR=$emvo VAR2=@voplayvol2 VARNUM=1 TIME=0]
			}
			IFEND[]



		IF[@L.ANFLAG(@no1)==3]
		{
//			IF[(@L.A(@no1)+@L.CLA(@no1))!=256 || @L.TP(@no1)+@L.CLTP(@no1)!=256 || @L.F2(@no1)>0]
			IF[(@L.A(@no1)+@L.CLA(@no1))!=256 || @L.F2(@no1)>0]
//			IF[0]
			{

					IF[@L.F2(@no1)>0]

					/*
						//ひとつでもアニメしたら、他の『立ち絵』も全て更新する
						//→立ち絵優先順位が同じキャラに関して、チラチラ前後しないようにするための処置.
						//
						LOOP[SET=(@LMAX+1)]
							//IF[@L.FTYPE(@_LC-1)==5] @DRAW.FLAG(@_LC-1)=1 IFEND[]
							@DRAW.FLAG(@_LC-1)=1
						LOOPEND[]
					*/
						///xTOC本当は↑だけどこちらで様子見る.
						//
						@flag=1

					IFEND[]

					@L.ANC(@no1)=0
					@L.ANC2(@no1)=0
					@L.ANC3(@no1)=0
					@L.ANC4(@no1)=0
					@STA.PrevVal(@no1)=0

			}
			ELSE[]
			{

				IF[@L.ANC3(@no1)==0]
				{
					@L.ANC(@no1)=0
					\_rnd(2000, 5000)
//					\_rnd(100, 100)
					@L.ANC3(@no1)=@_OS_TIME(1)+@_RINT(1)

					@flag=1
				}
				IFEND[]

			//	IF[1]
			//	{
					IF[@_OS_TIME(1)-@L.ANC3(@no1)>=@L.ANTIME(@no1)]
					{
					//	@L.ANC3(@no1)=@_OS_TIME(1)
						@L.ANC3(@no1)+=@L.ANTIME(@no1)

						IF[@L.ANC(@no1)==0] //順モード
						{
							@L.ANC2(@no1)+=1
							IF[@L.ANC2(@no1)>@L.ANNUM(@no1)]
							{
								@L.ANC(@no1)=1
								@L.ANC2(@no1)-=1
							}
							IFEND[]
						}
						ELSE[]
						{
							@L.ANC2(@no1)-=1
							IF[@L.ANC2(@no1)<0]
							{
								@L.ANC(@no1)=0
								@L.ANC2(@no1)=0

								\_rnd(500+(@STA.PrevVal(@no1)<1500)*3000, 8000)(@STA.PrevVal(@no1))
//								\_rnd(100, 100)(@STA.PrevVal(@no1))
								@L.ANC3(@no1)=@_OS_TIME(1)+@STA.PrevVal(@no1)
							}
							IFEND[]
						}
						IFEND[]

						@flag=1
					}
					IFEND[]
			//	}
			//	IFEND[]

			}
			IFEND[]

			IF[@flag]
			{
				LOOP[SET=98] CG[ID=$LID   +$(1+@no1*100+@_LC-1) A=0] LOOPEND[]
				LOOP[SET=98] CG[ID=$LIDBUF+$(1+@no1*100+@_LC-1) A=0] LOOPEND[]

				@DRAW.FLAG(@no1)=1
			}
			IFEND[]
		}
		IFEND[]
	}
	LOOPEND[]



	INT[@mX]
	INT[@mY]
	INT[@lp.no=1]
	INT[@no=11]
	INT[@pasttime]

	//----------------------------------------------------------------
	// アニメ処理
	//----------------------------------------------------------------
	LOOP[SET=@LMAX]
	{
		@no1=@_LC

		IF[@L.ANFLAG(@no1)==1 || @L.ANFLAG(@no1)==2] //連番アニメorパターンアニメ
		{

			//99999なら強制アニメ停止
			IF[@L.ANSTOP(@no1)<99999]
			{
				//指定したコマになったらアニメ停止
			//	IF[@L.ANLOOP(@no1)==1 && @L.ANSTOP(@no1)==@L.ANC2(@no1)] @L.ANSTOP(@no1)=99999;IFBREAK[] IFEND[]

				//時間計算
				@pasttime = @_OS_TIME(1) - @L.YMTIME(@no1)
				@L.YMTIME(@no1) = @_OS_TIME(1)

				IF[@L.ANC(@no1)>0 && (@es.GSD(112,01)==0 || @es.SP.AUTO==1)]
				{
					LOOP[SET=10000] //
					{
						IF[@L.ANC(@no1)>@L.ANTIME(@no1)]
						{
							@L.ANC(@no1)-=@L.ANTIME(@no1)
							@L.ANC2(@no1)+=1
							IF[@L.ANC2(@no1)==@L.ANNUM(@no1)]
							{
								@L.ANLOOP(@no1)-=1
								IF[@L.ANLOOP(@no1)==0]
								{
									@L.ANC2(@no1)-=1 //値を最後のコマに戻して終了
									@L.ANSTOP(@no1)=99999
									@flag=1
									LOOPBREAK[]
								}
								ELSE[]
								{
									@L.ANC2(@no1)=0
								}
								IFEND[]
							}
							IFEND[]

							IF[@L.ANFLAG(@no1)==2] //パターンアニメなら
							{
								//次フレームの情報を得る
								GOSUB[#=es.SPA2.DEF.SEARCH pstr=$L.FCG(@no1)]
								GOSUB[#=es.SPA2.GET.PDATA2 pint=@_RINT(1)+@L.ANC2(@no1)]
								@L.ANTIME(@no1)=@_RINT(1)
								@L.AX(@no1)=@_RINT(2)
								@L.AY(@no1)=@_RINT(3)
								@L.AZ(@no1)=@_RINT(4)
								@L.ABX(@no1)=@_RINT(5)
								@L.ABY(@no1)=@_RINT(6)

								CGINFO[ID=$LIDBUF+$(1+@no1*100+@L.ANC2(@no1)) SX=1 LET=@L.SX(@no1)]
								CGINFO[ID=$LIDBUF+$(1+@no1*100+@L.ANC2(@no1)) SY=1 LET=@L.SY(@no1)]
								@L.CX(@no1)=@L.SX(@no1)/2
								@L.CY(@no1)=@L.SY(@no1)/2

							}
							IFEND[]

							@flag=1
							LOOPCONTINUE[]
						}
						IFEND[]

						LOOPBREAK[]
					}
					LOOPEND[]

					@L.ANC(@no1)+=@pasttime

				}
				IFEND[]
			}
			IFEND[]

			IF[@flag]
			{
				LOOP[SET=98] CG[ID=$LID   +$(1+@no1*100+@_LC-1) A=0] LOOPEND[]
				LOOP[SET=98] CG[ID=$LIDBUF+$(1+@no1*100+@_LC-1) A=0] LOOPEND[]

				@DRAW.FLAG(@no1)=1
			}
			IFEND[]
		}
		IFEND[]
	}
	LOOPEND[]


	return[]
}


//////

//--------------------------------------------------------------------
//
// レイヤリサイズルーチン・改善版
// (中心点を基準にリサイズ)
//
//--------------------------------------------------------------------
#=es.SP.RESIZE
{
	STR[$SRC=$_PSTR(1)]
	STR[$DST=$_PSTR(2)]
	INT[@ACX=@_PINT(3)]
	INT[@ACY=@_PINT(4)]
	INT[@BCX=@_PINT(5)]
	INT[@BCY=@_PINT(6)]

	INT[@ASX]INT[@ASY]CGINFO[ID=$SRC SX=1 LET=@ASX]CGINFO[ID=$SRC SY=1 LET=@ASY]
	INT[@BSX]INT[@BSY]CGINFO[ID=$DST SX=1 LET=@BSX]CGINFO[ID=$DST SY=1 LET=@BSY]

	INT[@AX1=-@ACX]
	INT[@AY1=-@ACY]
	INT[@AX2=@AX1+@ASX-1]
	INT[@AY2=@AY1+@ASY-1]
	INT[@BX1=-@BCX]
	INT[@BY1=-@BCY]
	INT[@BX2=@BX1+@BSX-1]
	INT[@BY2=@BY1+@BSY-1]

	INT[@src_left]
	INT[@src_right]
	INT[@src_top]
	INT[@src_bottom]
	INT[@dst_left]
	INT[@dst_right]
	INT[@dst_top]
	INT[@dst_bottom]

	//SRC, DST どちらかのレイヤが、上下左右それぞれにおいて、
	//@top, @bottom, @left, @right の値分だけ拡張される

	//-------------------------------------------------------- TOP
	IF[@AY1 < @BY1]
	{
		@dst_top = @BY1-@AY1
//		@BCY += @dst_top
		CGACT[RESIZE=1 ID=$DST X=0 Y=@dst_top X2=0 Y2=0]
	}
	IFEND[]

	IF[@AY1 > @BY1]
	{
		@src_top = @AY1-@BY1
//		@ACY += @src_top
		CGACT[RESIZE=1 ID=$SRC X=0 Y=@src_top X2=0 Y2=0]
	}
	IFEND[]

	//-------------------------------------------------------- BOTTOM
	IF[@AY2 < @BY2]
	{
		@src_bottom = @BY2-@AY2
		CGACT[RESIZE=1 ID=$SRC X=0 Y=0 X2=0 Y2=@src_bottom]
	}
	IFEND[]

	IF[@AY2 > @BY2]
	{
		@dst_bottom = @AY2-@BY2
		CGACT[RESIZE=1 ID=$DST X=0 Y=0 X2=0 Y2=@dst_bottom]
	}
	IFEND[]

	//-------------------------------------------------------- LEFT
	IF[@AX1 < @BX1]
	{
		@dst_left = @BX1-@AX1
//		@BCX += @dst_left
		CGACT[RESIZE=1 ID=$DST X=@dst_left Y=0 X2=0 Y2=0]
	}
	IFEND[]

	IF[@AX1 > @BX1]
	{
		@src_left = @AX1-@BX1
//		@ACX += @src_left
		CGACT[RESIZE=1 ID=$SRC X=@src_left Y=0 X2=0 Y2=0]
	}
	IFEND[]

	//-------------------------------------------------------- RIGHT
	IF[@AX2 < @BX2]
	{
		@src_right = @BX2-@AX2
		CGACT[RESIZE=1 ID=$SRC X=0 Y=0 X2=@src_right Y2=0]
	}
	IFEND[]

	IF[@AX2 > @BX2]
	{
		@dst_right = @AX2-@BX2
		CGACT[RESIZE=1 ID=$DST X=0 Y=0 X2=@dst_right Y2=0]
	}
	IFEND[]

	return[rint=@dst_top rint2=@dst_bottom rint3=@dst_left rint4=@dst_right rint5=@src_top rint6=@src_bottom rint7=@src_left rint8=@src_right]
}


//----------------------------------------------------------------------------
//■画像読込
//----------------------------------------------------------------------------
#=es.SP.LOADCG
{
	INT[@No=@_PINT(1)]
	INT[@sdmd.na=@_PINT(2)]
	INT[@Annum=@_PINT(3)]

	INT[@bgcopyflag]
	INT[@evcopyflag]
	IF[@L.FTYPE(@No)==991] //CGCOPY(BG)
		@L.FTYPE(@No)=1 //BG
		@bgcopyflag = 1
	IFEND[]
	IF[@L.FTYPE(@No)==992] //CGCOPY(EV)
		@L.FTYPE(@No)=2 //EV
		@evcopyflag = 1
	IFEND[]

//\_dmes("LOADCG LNO="+$(@No))

	STR[$lp.fn]
	\_strlower($L.FCG(@No))($lp.fn)


	GOSUB[#=es.CGCXY.DEF.SEARCH pstr=$lp.fn pint2=(@L.FTYPE(@No)==1)]
	@L.CX(@No) = @_RINT(1)
	@L.CY(@No) = @_RINT(2)
	@LNO_BGZ   = @_RINT(3)
//\_dmes("@LNO_BGZ = "+$(@LNO_BGZ))
	IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
	{
		///xTOC暫定
		IF[@es.LSD(092,02)!=-9999999]
			@LNO_BGZ = @es.LSD(092,02)
		ELSE[]
			@LNO_BGZ = @DEFZ
		IFEND[]
	}
	IFEND[]

	IF[@LNO_CMFLAG==1] //背景・イベ絵変更時、カメラ位置指定
	{
		//\BG.CMXYZ,\EV.CMXYZ で設定済
	}
	ELSE[]
	{
		@LNO_CMV = @_RINT(4)
		@LNO_CMW = 0
		@LNO_CMX = @_RINT(5)
		@LNO_CMY = @_RINT(6)
		@LNO_CMZ = @_RINT(7)

		IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
		{
			@LNO_CMV = 0
			@LNO_CMW = 0
			@LNO_CMX = 0
			@LNO_CMY = 0
			@LNO_CMZ = 0
		}
		IFEND[]
	}
	IFEND[]

	IF[@No==@LNO_BG]
		@L.Z(@LNO_BG)=@LNO_BGZ
		@L.V(@LNO_CM)=@LNO_CMV
		@L.W(@LNO_CM)=@LNO_CMW
		@L.X(@LNO_CM)=@LNO_CMX
		@L.Y(@LNO_CM)=@LNO_CMY
		@L.Z(@LNO_CM)=@LNO_CMZ
	IFEND[]
	IF[@No==@LNO_BGF]
		@L.Z(@LNO_BGF)=@LNO_BGZ
		@L.V(@LNO_CMF)=@LNO_CMV
		@L.W(@LNO_CMF)=@LNO_CMW
		@L.X(@LNO_CMF)=@LNO_CMX
		@L.Y(@LNO_CMF)=@LNO_CMY
		@L.Z(@LNO_CMF)=@LNO_CMZ
	IFEND[]

	@LNO_CMFLAG = 0


		//画像読み込み
		LOOP[SET=100] CGEND[ID=$LIDBUF+$(1+@No*100+@_LC-1)] LOOPEND[]
	//	LOOP[SET=100] CGEND[ID=$LID   +$(1+@No*100+@_LC-1)] LOOPEND[]


		//画像合成判定
		GOSUB[#=es.SP.PRO.CHECKCG pstr=$lp.fn]
		STR[$fnA=$_RSTR(1)]
		STR[$fnB=$_RSTR(2)]
		INT[@MX=@_RINT(3)]
		INT[@MY=@_RINT(4)]
		INT[@COMP=@_RINT(5)]

		IF[@L.FTYPE(@No)==5]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnA] IF[$_RSTR(1)!=""] $fnA=$_RSTR(1)+$fnA IFEND[]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnB] IF[$_RSTR(1)!=""] $fnB=$_RSTR(1)+$fnB IFEND[]
		IFEND[]

		IF[$fnA!=""] $fnA=$PATH(@L.FTYPE(@No))+$fnA IFEND[]
		IF[$fnB!=""] $fnB=$PATH(@L.FTYPE(@No))+$fnB IFEND[]


	STR[$LB1=$LIDBUF+$(1+@No*100)]
//	STR[$LB2=$LIDBUF+$(2+@No*100)]
	STR[$L1 =$LID+$(1+@No*100)]
//	STR[$L2 =$LID+$(2+@No*100)]

	INT[@fbx]
	INT[@fby]
	INT[@fex]
	INT[@fey]

		IF[@_DXMODE] //E-mote用
			@L.SD(@No)=@es.EF.SAIDO
		IFEND[]

		//ＣＧ読込
		IF[@Annum==0] //通常ＣＧ
		{
			IF[@bgcopyflag] //CGCOPY(BG)
				//BGFからのコピー処理
				CGACT[ID=$LIDBUF+$(1+@LNO_BGF*100) ID2=$LB1 COPY2=1]
			ELSE[@evcopyflag] //CGCOPY(EV)
				//BGFからのコピー処理
				CGACT[ID=$LIDBUF+$(1+@LNO_BGF*100) ID2=$LB1 COPY2=1]
			ELSE[]
				GOSUB[#=es.SP.PRO.LOADCG pstr=$LB1 pstr2=$fnA pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@No) pint8=@L.SD(@No)]
			IFEND[]

			CG[ID=$LB1 E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

//			CG[ID=$LB1 TEX=@_DXMODE] //テクスチャ化
		}
		ELSE[@Annum>0] //連番アニメ
		{
			LOOP[SET=@Annum]
			{
				\_inttostr(@_LC,2)
				GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(@_LC+@No*100) pstr2=$fnA+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@No)]
				CG[ID=$LIDBUF+$(@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

//				CG[ID=$LIDBUF+$(@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化
			}
			LOOPEND[]

			@L.ANFLAG(@No)	= 1

		}
		ELSE[@Annum<0] //パターンアニメ
		{
			GOSUB[#=es.SPA2.DEF.SEARCH pstr=$lp.fn]
			INT[@pno=@_RINT(1)]
			@Annum=@_RINT(2)
			@L.ANLOOP(@No)	= @_RINT(3)

		//	\_dmes("パターン定義アニメ. FN="+$lp.fn+", NUM="+$(@Annum))

			INT[@AN_A]
			INT[@AN_SRCX]
			INT[@AN_SRCY]
			INT[@AN_SRCSX]
			INT[@AN_SRCSY]
			INT[@sx]
			INT[@sy]
			LOOP[SET=@Annum]
			{
				GOSUB[#=es.SPA2.GET.PDATA pint=@pno+@_LC-1]
				@AN_A    =@_RINT(2)
				@AN_SRCX =@_RINT(3)
				@AN_SRCY =@_RINT(4)
				@AN_SRCSX=@_RINT(5)
				@AN_SRCSY=@_RINT(6)
				GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(@_LC+@No*100) pstr2="cg/"+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=0 pint7=@L.FTYPE(@No)]

				CGINFO[ID=$LIDBUF+$(@_LC+@No*100) SX=1 LET=@sx]
				CGINFO[ID=$LIDBUF+$(@_LC+@No*100) SY=1 LET=@sy]

				//サイズ指定が無かったら、レイヤサイズをセット.
				IF[@AN_SRCSX==0] @AN_SRCSX=@sx IFEND[]
				IF[@AN_SRCSY==0] @AN_SRCSY=@sy IFEND[]

				//はみ出たら調整
				IF[@AN_SRCX+@AN_SRCSX >= @sx] @AN_SRCSX = @sx - @AN_SRCX IFEND[]
				IF[@AN_SRCY+@AN_SRCSY >= @sy] @AN_SRCSY = @sy - @AN_SRCY IFEND[]

				CGACT[ID=$LIDBUF+$(@_LC+@No*100) SIZE=1 X=@AN_SRCX Y=@AN_SRCY X2=@AN_SRCX+@AN_SRCSX Y2=@AN_SRCY+@AN_SRCSY SX=@AN_SRCSX SY=@AN_SRCSY]

				//不透明度加工
				IF[@AN_A<256]
					CG[ID="ANM.TMP" Z=1 A=@AN_A E=0 FILE=""]
					CGACT[ID=$LIDBUF+$(@_LC+@No*100) ID2="ANM.TMP" COPY2=1]
					CGACT[ID=$LIDBUF+$(@_LC+@No*100) RECTPAINT3=1 SET=0]
					CGACT[ID="ANM.TMP" ID2=$LIDBUF+$(@_LC+@No*100) MERGE2=1]
					CGEND[ID="ANM.TMP"]
				IFEND[]

				CG[ID=$LIDBUF+$(@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

//				CG[ID=$LIDBUF+$(@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化
			}
			LOOPEND[]

			@L.ANFLAG(@No)	= 2

			GOSUB[#=es.SPA2.GET.PDATA2 pint=@pno]
			@L.ANTIME(@No)	= @_RINT(1) //最初のフレームの表示時間を格納
			@L.ANSTOP(@No)	= 0
			@L.ANC(@No)	= 1
			@L.YMTIME(@No)	= @_OS_TIME(1)

			@L.ANNUM(@No)	= @Annum
		}
		IFEND[]


		//1x1なら(画像が無かったら)完全透明にしておく
		INT[@lllsx]CGINFO[ID=$LB1 SX=1 LET=@lllsx]
		INT[@lllsy]CGINFO[ID=$LB1 SY=1 LET=@lllsy]
		IF[@lllsx==1 && @lllsy==1] CGACT[ID=$LB1 RECTPAINT3=1 SET=0] IFEND[]

		/*
		IF[@L.FTYPE(@No)==1 || @L.FTYPE(@No)==2] // 1x1 分引き延ばす
		{
			CGACT[ID=$LB1 RESIZE=1 X=1 X2=1 Y=1 Y2=1]
		}
		IFEND[]
		*/

		//幕レイヤなら強制的に @es.GSX x @es.GSY へ
//		IF[@No==@LNO_FD] CGACT[ID=$LB1 SIZE=1 SX=@es.GSX SY=@es.GSY] IFEND[]

		//画像サイズ取得
		CGINFO[ID=$LB1 SX=1 LET=@L.SX(@No)]
		CGINFO[ID=$LB1 SY=1 LET=@L.SY(@No)]

		INT[@sd=@es.EF.SAIDO]
		INT[@md=@es.EF.MEIDO]
	//	IF[@L.SD(@No)!=     128] @sd=@L.SD(@No) IFEND[]
	//	IF[@L.MD(@No)!=0x808080] @md=@L.MD(@No) IFEND[]

	//	IF[@sdmd.na==0]
			@L.SD(@No)=@sd; IF[@sd!=     128] CGACT[ID=$LB1 SAIDO=1 SET=@sd] IFEND[]
			@L.MD(@No)=@md; IF[@md!=0x808080] CGACT[ID=$LB1 MEIDO=1 SET=@md] IFEND[]
	//	IFEND[]


		CG[ID=$LB1 TEX=@_DXMODE] //テクスチャ化



	//立ち絵アニメデータ読み込み
	STR[$spa.fn]
	STR[$spa.fn2]
	INT[@compmode]

	GOSUB[#=es.SPA.DEF.SEARCH pstr=$lp.fn]
	IF[$_RSTR(1)!=""]
	{
		$spa.fn  = $_RSTR(1)
		@L.ANFLAG(@No) = 3
		@L.ANX(@No) = @_RINT(2)
		@L.ANY(@No) = @_RINT(3)
		@L.ANNUM(@No) = @_RINT(4)
		@L.ANTIME(@No) = @_RINT(5)
		@compmode = @_RINT(6)

		IF[@L.FTYPE(@No)==5]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$spa.fn] IF[$_RSTR(1)!=""] $spa.fn=$_RSTR(1)+$spa.fn IFEND[]
		IFEND[]

		IF[$spa.fn!=""] $spa.fn=$PATH(@L.FTYPE(@No))+$spa.fn IFEND[]

		@L.SD(@No)=@sd
		@L.MD(@No)=@md
		GOSUB[#=es.SP.PRO.LOADCG.2 pstr=$LIDBUF pstr2=$LIDBUF pstr3=$fnA pstr4=$spa.fn pint5=@L.ANX(@No) pint6=@L.ANY(@No) pint7=@compmode pint8=@No pint9=@L.ANNUM(@No) pint10=@L.MD(@No)*65536+@L.SD(@No)]

		LOOP[SET=@L.ANNUM(@No)]
		{
/*			\_inttostr(@_LC, 2)($spa.fn2)
	//		CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0) FILE=$spa.fn+$spa.fn2] //データバッファ

			//ＣＧ読込
			GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(1+@_LC+@No*100) pstr2=$fnA pstr3=$spa.fn+$spa.fn2 pint4=@L.ANX(@No) pint5=@L.ANY(@No) pint6=@compmode pint7=@L.FTYPE(@No)]
*/			CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

//			@L.SD(@No)=@sd; IF[@sd!=     128] CGACT[ID=$LIDBUF+$(1+@_LC+@No*100) SAIDO=1 SET=@sd] IFEND[]
//			@L.MD(@No)=@md; IF[@md!=0x808080] CGACT[ID=$LIDBUF+$(1+@_LC+@No*100) MEIDO=1 SET=@md] IFEND[]

			CG[ID=$LIDBUF+$(1+@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化
		}
		LOOPEND[]
	}
	IFEND[]



///tri
	IF[@es.CGMODE.NODEF.FLAG==1]
	{
//		\_dmes(NODEF)
		@es.CGMODE.NODEF.FLAG=0
	}
	ELSE[]
	{
//		\_dmes(DEF)
		STR[$str.nopath]
		INT[@str.nopathlen]
		\_strlen($L.FCG(@No))(@str.nopathlen)
		\_strleft($L.FCG(@No), 3);\_strlower($_RSTR(1))($str.nopath)
//		\_dmes($L.FCG(@No)+", "+$str.nopath)

		\CG.SET($L.FCG(@No)) //ＣＧ鑑賞フラグ登録

		IF[$str.nopath=="ev/"]
		{
			\_strright($L.FCG(@No), @str.nopathlen-3)($str.nopath)
//			\_dmes("登録. "+$str.nopath)
			\CG.SET($str.nopath) //ＣＧ鑑賞フラグ登録
		}
		IFEND[]
	}
	IFEND[]

IF[@_DXMODE==0]
//	CG[ID=$L1 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@S.I1(@wn)) FILE=""] //実際の表示レイヤ
	CG[ID=$L1 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(0) FILE=""] //実際の表示レイヤ
	CGACT[ID=$L1 RECTPAINT3=1 SET=0x00000000]
IFEND[]

IF[@_DEBUGMODE>=@dbg.val]

	//チップ画像読み込み
	//
	IF[@L.FTYPE(@No)==1 || @L.FTYPE(@No)==2] //BGEV
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF0 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000*@es.ZEX+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF3 ID2=CP+$(@No) COPY2=1]
	}
	ELSE[@L.FTYPE(@No)!=5] //その他立ち絵以外
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF1 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000*@es.ZEX+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF3 ID2=CP+$(@No) COPY2=1]
	}
	ELSE[]
	{
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF2 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000*@es.ZEX+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF4 ID2=CP+$(@No) COPY2=1]
	}
	IFEND[]


IFEND[]



	//レイヤ中心点設定
	IF[@L.CX(@No)==-9999999] @L.CX(@No) = @L.SX(@No) / 2 IFEND[]
	IF[@L.CY(@No)==-9999999] @L.CY(@No) = @L.SY(@No) / 2 IFEND[]


//\_dmes("CX="+$(@L.CX(@No))+", CY="+$(@L.CY(@No)))


	return[]
}


#=es.SP.LOADCGE
{
	INT[@No=@_PINT(1)]
	INT[@sdmd.na=@_PINT(2)]

	INT[@sx=@_PINT(3)]
	INT[@sy=@_PINT(4)]

	STR[$LB1 =$LIDBUF+$(1+@No*100)]
	STR[$L1=$LID+$(1+@No*100)]

//\_dmes("LOADCG LNO="+$(@No))

	GOSUB[#=es.CGCXY.DEF.SEARCH pstr="" pint2=(@L.FTYPE(@No)==1)]
	@L.CX(@No) = @_RINT(1)
	@L.CY(@No) = @_RINT(2)
	@LNO_BGZ   = @_RINT(3)
//\_dmes("@LNO_BGZ = "+$(@LNO_BGZ))
	IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
	{
		///xTOC暫定
		IF[@es.LSD(092,02)!=-9999999]
			@LNO_BGZ = @es.LSD(092,02)
		ELSE[]
			@LNO_BGZ = @DEFZ
		IFEND[]
	}
	IFEND[]

	IF[@LNO_CMFLAG==1] //背景・イベ絵変更時、カメラ位置指定
	{
		//\BG.CMXYZ,\EV.CMXYZ で設定済
	}
	ELSE[]
	{
		@LNO_CMV = @_RINT(4)
		@LNO_CMW = 0
		@LNO_CMX = @_RINT(5)
		@LNO_CMY = @_RINT(6)
		@LNO_CMZ = @_RINT(7)

		IF[@L.CX(@No)==-9999999 || @L.CY(@No)==-9999999]
		{
			@LNO_CMV = 0
			@LNO_CMW = 0
			@LNO_CMX = 0
			@LNO_CMY = 0
			@LNO_CMZ = 0
		}
		IFEND[]
	}
	IFEND[]

	IF[@No==@LNO_BG]
		@L.Z(@LNO_BG)=@LNO_BGZ
		@L.V(@LNO_CM)=@LNO_CMV
		@L.W(@LNO_CM)=@LNO_CMW
		@L.X(@LNO_CM)=@LNO_CMX
		@L.Y(@LNO_CM)=@LNO_CMY
		@L.Z(@LNO_CM)=@LNO_CMZ
	IFEND[]
	IF[@No==@LNO_BGF]
		@L.Z(@LNO_BGF)=@LNO_BGZ
		@L.V(@LNO_CMF)=@LNO_CMV
		@L.W(@LNO_CMF)=@LNO_CMW
		@L.X(@LNO_CMF)=@LNO_CMX
		@L.Y(@LNO_CMF)=@LNO_CMY
		@L.Z(@LNO_CMF)=@LNO_CMZ
	IFEND[]

	@LNO_CMFLAG = 0


		//画像読み込み
		LOOP[SET=100] CGEND[ID=$LIDBUF+$(1+@No*100+@_LC-1)] LOOPEND[]
	//	LOOP[SET=100] CGEND[ID=$LID   +$(1+@No*100+@_LC-1)] LOOPEND[]


		//ＣＧ読込
	//	CG[ID=$LB1 E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(@S.I1(@wn)) FILE=""]
		CG[ID=$LB1 E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0) FILE=""]
		CGACT[ID=$LB1 RECTPAINT3=1 SET=0x00000000]
		CGACT[ID=$LB1 SIZE=1 SX=@sx SY=@sy]
	@L.CHRNO(@No)=0

		//画像サイズ取得
		CGINFO[ID=$LB1 SX=1 LET=@L.SX(@No)]
		CGINFO[ID=$LB1 SY=1 LET=@L.SY(@No)]

		IF[@sdmd.na==0]
			IF[@es.EF.SAIDO!=128]
				@L.SD(@No)=@es.EF.SAIDO
				IF[@es.EF.SAIDO!=     128] CGACT[ID=$LB1  SAIDO=1 SET=@es.EF.SAIDO] IFEND[]
			IFEND[]
			IF[@es.EF.MEIDO!=0x808080]
				@L.MD(@No)=@es.EF.MEIDO
				IF[@es.EF.MEIDO!=0x808080] CGACT[ID=$LB1  MEIDO=1 SET=@es.EF.MEIDO] IFEND[]
			IFEND[]
		IFEND[]

/*
		INT[@MIPMAP=1]
	//	IF[@L.FTYPE(@No)==5] \_dmes(立ち絵) IFEND[]
		IF[@L.SX(@No)<=1024 && @L.SY(@No)<=2048] @MIPMAP=2 IFEND[]
	//	IF[@L.SX(@No)<=2400 && @L.SY(@No)<=2048] @MIPMAP=2 IFEND[]
*/
		CG[ID=$LB1 TEX=@_DXMODE] //テクスチャ化



IF[@_DXMODE==0]
//	CG[ID=$L1 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@S.I1(@wn)) FILE=""] //実際の表示レイヤ
	CG[ID=$L1 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(0) FILE=""] //実際の表示レイヤ
//	CG[ID=$L11 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@S.I1(@wn)) FILE=""] //実際の表示レイヤ
//	CG[ID=$L11 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(0) FILE=""] //実際の表示レイヤ
//	CG[ID=$L12 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@S.I1(@wn)) FILE=""] //実際の表示レイヤ
//	CG[ID=$L12 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(0) FILE=""] //実際の表示レイヤ
	CGACT[ID=$L1 RECTPAINT3=1 SET=0x00000000]
//	CGACT[ID=$L11 RECTPAINT3=1 SET=0x00000000]
//	CGACT[ID=$L12 RECTPAINT3=1 SET=0x00000000]
IFEND[]


IF[@_DEBUGMODE>=@dbg.val]

	//チップ画像読み込み
	//
		//[SpriteView]チップ読込
		CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF1 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

		//[ゲーム画面]チップ読込
		CG[ID=CP+$(@No) Z=900000*@es.ZEX+@No A=128 X=8000 Y=6000 FILE=""]
		CGACT[ID=CPBUF3 ID2=CP+$(@No) COPY2=1]

IFEND[]


	//レイヤ中心点設定
	IF[@L.CX(@No)==-9999999] @L.CX(@No) = @L.SX(@No) / 2 IFEND[]
	IF[@L.CY(@No)==-9999999] @L.CY(@No) = @L.SY(@No) / 2 IFEND[]


//\_dmes("CX="+$(@L.CX(@No))+", CY="+$(@L.CY(@No)))


	return[]
}


#=es.SP.LOADCGT
{
	INT[@No=@_PINT(1)]
	INT[@txv=@_PINT(2)]
	STR[$LB1 =$LIDBUF+$(1+@No*100)]

	IF[@txv>=10000000]
		$L.TXS(@No) = $L(@txv-10000000)
	ELSE[]
		$L.TXS(@No) = $G(@txv)
	IFEND[]

	GOSUB[#=es.TDDEF.SEARCH pstr=$L.TXF(@No)]
	INT[@FS.SX = @_RINT(1) / 65536]
	INT[@FS.SY = @_RINT(1) % 65536]
	INT[@FS.COLOR  = @_RINT(2)]
	INT[@FS.COLOR2 = @_RINT(3)]
	INT[@FS.SHADE.X = @_RINT(5) / 65536]
	INT[@FS.SHADE.Y = @_RINT(5) % 65536]
	INT[@FS.SHADE.COLOR = @_RINT(6)]
	INT[@FS.OUTLINE.COLOR = @_RINT(7)]
	STR[$FS.FONT = $_RSTR(8)]

//	FONT[DRAWMODE=1]
	CGACT[ID=$LB1 RECTPAINT3=1 SET=0x00000000]

	\FONT.FONT( $FS.FONT )
	\FONT.COLOR( @FS.COLOR )
	\FONT.SIZE( @FS.SX, @FS.SY )
	\FONT.XY( 4 , 4 )
	IF[@es.GSD(115,14)==1] \FONT.BOLD( 1 ) IFEND[]
	IF[@es.GSD(115,09)==1] \FONT.SHADE( @FS.SHADE.X, @FS.SHADE.Y, @FS.SHADE.COLOR ) IFEND[]
	IF[@es.GSD(115,08)==1] \FONT.OUTLINE( @FS.OUTLINE.COLOR ) IFEND[]
	IF[@es.GSD(115,15)==1] \FONT.COLOR( @FS.COLOR, @FS.COLOR2 ) IFEND[]
	\FONT.DRAW($LB1, $L.TXS(@No))
//	CGACT[ID=$LB1 TEXT=1 SET=1 SETSTR=$L.TXS(@No)]

	CGACT[ID=$LB1 ID2=$LB1 TEXCOPY=1]

	return[]
}


//-------------------------------------------------------------------------
//遷移画像読込
//
#=es.SP.LOADCGF
{
	INT[@No		=@_PINT(1)]
	INT[@Annum  =@_PINT(2)]

	INT[@type	=@L.FTYPE(@No)]
	STR[$lp.fn	=$L.FCG(@No)]
	STR[$fn2]


//	IF[@es.LOADTHRU==0 && @es.SP.AUTOSKIP==0]
	{

///xTOC 表情切り替えるなら、この段階でアニメ初期化しとかないと、チラつく.
//
@L.ANC(@No)=0
@L.ANC2(@No)=0
@L.ANC3(@No)=0
@L.ANC4(@No)=0
@L.ANNUM(@No)=0
@STA.PrevVal(@No)=0
@es.MIMI.COM.INIT(@No)=0
@es.MIMI.COM.COUNT(@No)=0
@es.MIMI.COM.WAIT(@No)=0


/*
		//ZAR目パチルーチン
		STR[$strdir]
		STR[$strdir2]
		STR[$str99]
		STR[$strnn]
		STR[$lp.fn2]
		STR[$lp.fn3]
		INT[@lp.no]
		INT[@lp.num]
		INT[@mergex]
		INT[@mergey]
		INT[@mLen]

		\_strlower($lp.fn)($lp.fn)

		\_strleft($lp.fn, 6);\_strlower($_RSTR(1))($strdir)
		\_strleft($lp.fn, 13);\_strlower($_RSTR(1))($strdir2)
		\_strmid($lp.fn, 14, 99);\_strlower($_RSTR(1))($str99)

		IF[$strdir=="stand/"]
		{
			LOOP[SET=@es.STA.DEFNUM]	//登録文字列と比較
			{
				@mLen = @es.STA.SRCLEN(@_LC)
				IF[@lp.num<@mLen]
				{
					\_strleft($str99, @mLen)
					IF[$es.STA.SRC(@_LC)==$_RSTR(1)] //マッチするか
					{
						@lp.num = @mLen
						@lp.no  = @_LC
						$lp.fn2 = $strdir2 + $es.STA.DST(@lp.no)

						//読み込む
				//		\_dmes("目パチ読み込み。["+$lp.fn2+"]")

					//	LOOPBREAK[]
					}
					IFEND[]
				}
				IFEND[]
			}
			LOOPEND[]
		}
		IFEND[]
*/

		//画像合成判定
		GOSUB[#=es.SP.PRO.CHECKCG pstr=$lp.fn]
		STR[$fnA=$_RSTR(1)]
		STR[$fnB=$_RSTR(2)]
		INT[@MX=@_RINT(3)]
		INT[@MY=@_RINT(4)]
		INT[@COMP=@_RINT(5)]

		IF[@L.FTYPE(@No)==5]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnA] IF[$_RSTR(1)!=""] $fnA=$_RSTR(1)+$fnA IFEND[]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$fnB] IF[$_RSTR(1)!=""] $fnB=$_RSTR(1)+$fnB IFEND[]
		IFEND[]

		IF[$fnA!=""] $fnA=$PATH(@type)+$fnA IFEND[]
		IF[$fnB!=""] $fnB=$PATH(@type)+$fnB IFEND[]

		STR[$lidbuf]

		INT[@sx]
		INT[@sy]


		IF[@_DXMODE] //E-mote用
			@L.SD(@No)=@es.EF.SAIDO
		IFEND[]

		//ＣＧ読込
		IF[@Annum==0] //通常ＣＧ
		{
			$lidbuf=$LIDBUF2+$(1+@No*100)

			GOSUB[#=es.SP.PRO.LOADCG pstr=$lidbuf pstr2=$fnA pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@No) pint8=@L.SD(@No)]
			CG[ID=$lidbuf E=0 A=0 X=0 Y=0 Z=1 MODE=0]	//MODE=0でいい.

			@L.CHRNO(@No)=@_RINT(1)
			/*
			IF[@_RINT(2)] //耳パタなら
				CG[ID=$LIDBUF2+$(11+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=0]	//MODE=0でいい.
				CG[ID=$LIDBUF2+$(12+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=0]	//MODE=0でいい.
				@L.ANNUM(@No)=2
			IFEND[]
			*/
		}
		ELSE[@Annum>0] //連番アニメ
		{
			LOOP[SET=@Annum]
			{
				IF[@_LC==1]	$lidbuf=$LIDBUF2+$(@_LC+@No*100)
				ELSE[]		$lidbuf=$LIDBUF+$(@_LC+@No*100)
				IFEND[]

				\_inttostr(@_LC,2)
				GOSUB[#=es.SP.PRO.LOADCG pstr=$lidbuf pstr2=$fnA+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@No)]
				CG[ID=$lidbuf E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]
			}
			LOOPEND[]

			@L.ANFLAG(@No)	= 1

		}
		ELSE[@Annum<0] //パターンアニメ
		{
			GOSUB[#=es.SPA2.DEF.SEARCH pstr=$lp.fn]
			INT[@pno=@_RINT(1)]
			@Annum=@_RINT(2)
			@L.ANLOOP(@No)	= @_RINT(3)

		//	\_dmes("パターン定義アニメ. FN="+$lp.fn+", NUM="+$(@Annum))

			INT[@AN_A]
			INT[@AN_SRCX]
			INT[@AN_SRCY]
			INT[@AN_SRCSX]
			INT[@AN_SRCSY]
			LOOP[SET=@Annum]
			{
				IF[@_LC==1]	$lidbuf=$LIDBUF2+$(@_LC+@No*100)
				ELSE[]		$lidbuf=$LIDBUF+$(@_LC+@No*100)
				IFEND[]

				GOSUB[#=es.SPA2.GET.PDATA pint=@pno+@_LC-1]
				@AN_A    =@_RINT(2)
				@AN_SRCX =@_RINT(3)
				@AN_SRCY =@_RINT(4)
				@AN_SRCSX=@_RINT(5)
				@AN_SRCSY=@_RINT(6)
				GOSUB[#=es.SP.PRO.LOADCG pstr=$lidbuf pstr2="cg/"+$_RSTR(1) pstr3=$fnB pint4=@MX pint5=@MY pint6=@COMP pint7=@L.FTYPE(@No)]

				@sx=0;@sy=0
				CGINFO[ID=$lidbuf SX=1 LET=@sx]
				CGINFO[ID=$lidbuf SY=1 LET=@sy]

				//サイズ指定が無かったら、レイヤサイズをセット.
				IF[@AN_SRCSX==0] @AN_SRCSX=@sx IFEND[]
				IF[@AN_SRCSY==0] @AN_SRCSY=@sy IFEND[]

				//はみ出たら調整
				IF[@AN_SRCX+@AN_SRCSX >= @sx] @AN_SRCSX = @sx - @AN_SRCX IFEND[]
				IF[@AN_SRCY+@AN_SRCSY >= @sy] @AN_SRCSY = @sy - @AN_SRCY IFEND[]

				CGACT[ID=$lidbuf SIZE=1 X=@AN_SRCX Y=@AN_SRCY X2=@AN_SRCX+@AN_SRCSX Y2=@AN_SRCY+@AN_SRCSY SX=@AN_SRCSX SY=@AN_SRCSY]

				//不透明度加工
				IF[@AN_A<256]
					CG[ID="ANM.TMP" Z=1 A=@AN_A E=0 FILE=""]
					CGACT[ID=$lidbuf ID2="ANM.TMP" COPY2=1]
					CGACT[ID=$lidbuf RECTPAINT3=1 SET=0]
					CGACT[ID="ANM.TMP" ID2=$lidbuf MERGE2=1]
					CGEND[ID="ANM.TMP"]
				IFEND[]

				CG[ID=$lidbuf E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]
			}
			LOOPEND[]

			@L.ANFLAG(@No)	= 2

			GOSUB[#=es.SPA2.GET.PDATA2 pint=@pno]
			@L.ANTIME(@No)	= @_RINT(1) //最初のフレームの表示時間を格納
			@L.ANSTOP(@No)	= 0
			@L.ANC(@No)	= 1
			@L.YMTIME(@No)	= @_OS_TIME(1)

			@L.ANNUM(@No)	= @Annum
		}
		IFEND[]



		//1x1なら(画像が無かったら)完全透明にしておく
		INT[@lllsx]CGINFO[ID=$LIDBUF2+$(1+@No*100) SX=1 LET=@lllsx]
		INT[@lllsy]CGINFO[ID=$LIDBUF2+$(1+@No*100) SY=1 LET=@lllsy]
		IF[@lllsx==1 && @lllsy==1] CGACT[ID=$LIDBUF2+$(1+@No*100) RECTPAINT3=1 SET=0] IFEND[]


		INT[@sd=@es.EF.SAIDO]
		INT[@md=@es.EF.MEIDO]
	//	IF[@L.SD(@No)!=     128] @sd=@L.SD(@No) IFEND[]
	//	IF[@L.MD(@No)!=0x808080] @md=@L.MD(@No) IFEND[]

	//	IF[@sdmd.na==0]
			@L.SD(@No)=@sd; IF[@sd!=     128] CGACT[ID=$LIDBUF2+$( 1+@No*100) SAIDO=1 SET=@sd] IFEND[]
			@L.MD(@No)=@md; IF[@md!=0x808080] CGACT[ID=$LIDBUF2+$( 1+@No*100) MEIDO=1 SET=@md] IFEND[]
	//	IFEND[]

//		IF[@es.EF.SAIDO!=     128] CGACT[ID=$LIDBUF2+$(11+@No*100) SAIDO=1 SET=@es.EF.SAIDO] IFEND[]
//		IF[@es.EF.SAIDO!=     128] CGACT[ID=$LIDBUF2+$(12+@No*100) SAIDO=1 SET=@es.EF.SAIDO] IFEND[]
//		IF[@es.EF.MEIDO!=0x808080] CGACT[ID=$LIDBUF2+$(11+@No*100) MEIDO=1 SET=@es.EF.MEIDO] IFEND[]
//		IF[@es.EF.MEIDO!=0x808080] CGACT[ID=$LIDBUF2+$(12+@No*100) MEIDO=1 SET=@es.EF.MEIDO] IFEND[]


		INT[@texchk]
		CGINFO[ID=$LIDBUF2+$( 1+@No*100) TEX=1 LET=@texchk]
		IF[@texchk==2]
		{
			//IFBREAK[LV=2]
			GO[#=es.SP.LOADCGF.LP1]
		}
		IFEND[]


		INT[@mOLD.CX=@L.CX(@No)]
		INT[@mOLD.CY=@L.CY(@No)]
		GOSUB[#=es.CGCXY.DEF.SEARCH pstr=$lp.fn pint2=(@L.FTYPE(@No)==1)]
		@L.CX(@No)=@_RINT(1)
		@L.CY(@No)=@_RINT(2)
		//画像サイズ一旦取得
		@sx=0;@sy=0
		CGINFO[ID=$LIDBUF2+$(1+@No*100) SX=1 LET=@sx]
		CGINFO[ID=$LIDBUF2+$(1+@No*100) SY=1 LET=@sy]
		IF[@L.CX(@No)==-9999999] @L.CX(@No)=@sx/2 IFEND[]
		IF[@L.CY(@No)==-9999999] @L.CY(@No)=@sy/2 IFEND[]

		//立ち絵の前と後で同サイズになるようリサイズ
//\_dmes("@mOLD.CX="+$(@mOLD.CX)+",@mOLD.CY="+$(@mOLD.CY)+",@L.CX(@No)="+$(@L.CX(@No))+",@L.CY(@No)="+$(@L.CY(@No)) )
		GOSUB[#=es.SP.RESIZE pstr=$LIDBUF +$( 1+@No*100) pstr2=$LIDBUF2+$( 1+@No*100) pint3=@mOLD.CX pint4=@mOLD.CY pint5=@L.CX(@No) pint6=@L.CY(@No)]
//		GOSUB[#=es.SP.RESIZE pstr=$LIDBUF2+$( 1+@No*100) pstr2=$LIDBUF +$( 1+@No*100) pint3=@mOLD.CX pint4=@mOLD.CY pint5=@L.CX(@No) pint6=@L.CY(@No)]

INT[@dst_top    = @_RINT(1)]
INT[@dst_bottom = @_RINT(2)]
INT[@dst_left   = @_RINT(3)]
INT[@dst_right  = @_RINT(4)]

		@L.CX(@No)+=@dst_left //@dst_left
		@L.CY(@No)+=@dst_top  //@dst_top

/*
INT[@dst_top    =@_RINT(1)]
INT[@dst_bottom =@_RINT(2)]
INT[@dst_left   =@_RINT(3)]
INT[@dst_right  =@_RINT(4)]
INT[@src_top    =@_RINT(5)]
INT[@src_bottom =@_RINT(6)]
INT[@src_left   =@_RINT(7)]
INT[@src_right  =@_RINT(8)]

\_dmes("@src_left="+$(@src_left)+",@src_right="+$(@src_right)+",@src_top="+$(@src_top)+",@src_bottom="+$(@src_bottom)+\_R+"@dst_left="+$(@dst_left)+",@dst_right="+$(@dst_right)+",@dst_top="+$(@dst_top)+",@dst_bottom="+$(@dst_bottom) )
*/

/*
//リサイズ後のそれぞれのレイヤサイズを表示
INT[@asx]CGINFO[ID=$LIDBUF +$(1+@No*100) SX=1 LET=@asx]
INT[@asy]CGINFO[ID=$LIDBUF +$(1+@No*100) SY=1 LET=@asy]
INT[@bsx]CGINFO[ID=$LIDBUF2+$(1+@No*100) SX=1 LET=@bsx]
INT[@bsy]CGINFO[ID=$LIDBUF2+$(1+@No*100) SY=1 LET=@bsy]
\_dmes("@asx="+$(@asx)+",@asy="+$(@asy)+",@bsx="+$(@bsx)+",@bsy="+$(@bsy) )
*/


/*
		INT[@mR1=@_RINT(3)]
		INT[@mR2=@_RINT(1)]
		@L.X(@No) -=@mR1
		@L.Y(@No) -=@mR2
*/
//		@L.CX(@No)-=@mR1
//		@L.CY(@No)-=@mR2
//\_dmes("@mR1="+$(@mR1)+",@mR2="+$(@mR2) )

	//	GOSUB[#=es.SP.RESIZE pstr=$LIDBUF+$(1+@No*100) pstr2=$LIDBUF2+$(1+@No*100)]
	//	INT[@mR1=@_RINT(1)]
	//	INT[@mR2=@_RINT(2)]
	//	INT[@mR5=@_RINT(5)]
	//	INT[@mR6=@_RINT(6)]



	@L.ANFLAG(@No)=0

	//立ち絵アニメデータ読み込み
	STR[$spa.fn]
	STR[$spa.fn2]
	INT[@compmode]

	GOSUB[#=es.SPA.DEF.SEARCH pstr=$lp.fn]
	IF[$_RSTR(1)!=""]
	{
		$spa.fn  = $_RSTR(1)
		@L.ANFLAG(@No) = 3
		@L.ANX(@No) = @_RINT(2)
		@L.ANY(@No) = @_RINT(3)
		@L.ANNUM(@No) = @_RINT(4)
		@L.ANTIME(@No) = @_RINT(5)
		@compmode = @_RINT(6)
			IF[@dst_left<0] @L.ANX(@No)-=@dst_left IFEND[]
			IF[@dst_top <0] @L.ANY(@No)-=@dst_top  IFEND[]

		IF[@L.FTYPE(@No)==5]
			GOSUB[#=es.SP.FOLDER.DEF.SEARCH pstr=$spa.fn] IF[$_RSTR(1)!=""] $spa.fn=$_RSTR(1)+$spa.fn IFEND[]
		IFEND[]

		IF[$spa.fn!=""] $spa.fn=$PATH(@L.FTYPE(@No))+$spa.fn IFEND[]

		GOSUB[#=es.SP.PRO.LOADCG.2 pstr=$LIDBUF pstr2=$LIDBUF2 pstr3=$fnA pstr4=$spa.fn pint5=@L.ANX(@No) pint6=@L.ANY(@No) pint7=@compmode pint8=@No pint9=@L.ANNUM(@No) pint10=@L.MD(@No)*65536+@L.SD(@No)]

		LOOP[SET=@L.ANNUM(@No)]
		{
/*
			\_inttostr(@_LC, 2)($spa.fn2)
	//		CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0) FILE=$spa.fn+$spa.fn2] //データバッファ

			//ＣＧ読込
			GOSUB[#=es.SP.PRO.LOADCG pstr=$LIDBUF+$(1+@_LC+@No*100) pstr2=$fnA pstr3=$spa.fn+$spa.fn2 pint4=@L.ANX(@No) pint5=@L.ANY(@No) pint6=@compmode pint7=@L.FTYPE(@No)]
*/
			CG[ID=$LIDBUF+$(1+@_LC+@No*100) E=0 A=0 X=0 Y=0 Z=1 MODE=@es.BL(0)]

			//立ち絵の前と後で同サイズになるようリサイズ
			IF[@dst_top   >0] CGACT[RESIZE=1 ID=$LIDBUF+$(1+@_LC+@No*100) X=0 Y=@dst_top X2=0 Y2=0] IFEND[]
			IF[@dst_bottom>0] CGACT[RESIZE=1 ID=$LIDBUF+$(1+@_LC+@No*100) X=0 Y=0 X2=0 Y2=@dst_bottom] IFEND[]
			IF[@dst_left  >0] CGACT[RESIZE=1 ID=$LIDBUF+$(1+@_LC+@No*100) X=@dst_left Y=0 X2=0 Y2=0] IFEND[]
			IF[@dst_right >0] CGACT[RESIZE=1 ID=$LIDBUF+$(1+@_LC+@No*100) X=0 Y=0 X2=@dst_right Y2=0] IFEND[]
//	\_dmes("@mOLD.CX="+$(@mOLD.CX)+",@mOLD.CY="+$(@mOLD.CY)+",@L.CX(@No)="+$(@L.CX(@No))+",@L.CY(@No)="+$(@L.CY(@No)) )
//			GOSUB[#=es.SP.RESIZE pstr=$LIDBUF+$(1+@No*100) pstr2=$LIDBUF+$(1+@_LC+@No*100) pint3=@mOLD.CX pint4=@mOLD.CY pint5=@L.CX(@No) pint6=@L.CY(@No)]

				//	CG[ID=$LIDBUF+$(@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化
					CG[ID=$LIDBUF+$(1+@_LC+@No*100) TEX=@_DXMODE] //テクスチャ化

		}
		LOOPEND[]
	}
	IFEND[]


#=es.SP.LOADCGF.LP1

		//画像サイズ取得
		CGINFO[ID=$LIDBUF2+$(1+@No*100) SX=1 LET=@L.SX(@No)]
		CGINFO[ID=$LIDBUF2+$(1+@No*100) SY=1 LET=@L.SY(@No)]

		//
IF[@_DXMODE==0]
		CG[ID=$LIDBUF3+$( 1+@No*100) A=0 E=0 Z=1 SX=@L.SX(@No) SY=@L.SY(@No) FILE=""]
		CGACT[ID=$LIDBUF3+$( 1+@No*100) RECTPAINT3=1 SET=0x00000000]
IFEND[]

IF[@_DXMODE]
//	//	@MIPMAP=2 //絶対に立ち絵なので2固定.
//		@MIPMAP=1
//		IF[@L.SX(@No)<=1024 && @L.SY(@No)<=2048] @MIPMAP=2 IFEND[]
	//	CG[ID=$LIDBUF +$(1+@No*100) TEX=@_DXMODE]
		CG[ID=$LIDBUF2+$(1+@No*100) TEX=@_DXMODE]
IFEND[]


		//リサイズしたものを、即正しい位置に描画するために、
		//強制描画する
		//
		GOSUB[#=es.SP.DRAW pint=@No pint2=1 pint3=1] //pint2=1→最終描画フラグ


/*
INT[@msx1]
INT[@msy1]
INT[@msx2]
INT[@msy2]
CGINFO[ID=$LIDBUF +$(1+@No*100) SX=1 LET=@msx1]
CGINFO[ID=$LIDBUF +$(1+@No*100) SY=1 LET=@msy1]
CGINFO[ID=$LIDBUF2+$(1+@No*100) SX=1 LET=@msx2]
CGINFO[ID=$LIDBUF2+$(1+@No*100) SY=1 LET=@msy2]
\_dmes( "msx1="+$(@msx1)+", msy1="+$(@msy1)+" msx2="+$(@msx2)+", msy2="+$(@msy2) )
*/

//\_dmes("Xずれ="+$(@mR1)+", Yずれ="+$(@mR2))

	}
//	IFEND[]

	return[]
}


//-------------------------------------------------------------------------
//トランジション読込
//
#=es.SP.LOADTR
{
	INT[@wn =@_PINT(1)]
	INT[@Rev=@_PINT(2)]
	INT[@Ta =@_PINT(3)]
	INT[@No=@S.LNO(@wn)]
	STR[$L1    =$LID     +$(1+@No*100)]
	STR[$TR1   =$LIDTR   +$(1+@No*100)]
	STR[$TRBUF1=$LIDTRBUF+$(1+@No*100)]

	STR[$TR]
	STR[$loadfilename]
	STR[$tr=$S.FTR(@wn)]

	$L.FTR(@No) = $S.FTR(@wn)

	IF[$tr!=""]
	{
		//----------------------------------------------------------------
		// TR 定義文字列か否か調べる.
		//----------------------------------------------------------------
			INT[@TRA] //精度
			GOSUB[#=es.TRDEF.CHECK PSTR=$tr]
			$TR		= $_RSTR(1)
			@TRA	= @_RINT(2)

			IF[@Ta!=-1] @TRA=@Ta IFEND[] //トランジション精度の指定があった場合はそちらを優先.

			\_range(@TRA, 0, 256)

			@L.TRA(@No) = @TRA
			@L.TRR(@No) = 0

			$loadfilename = $PATH(4)+$TR

			//ファイル存在チェック
			IF[@_DEBUGMODE==1]
			{
				\_cg.exist($loadfilename)
				IF[@_RINT(1)==0 && $tr!=""]
				{
					IF[@T(37,55)] \_mes("★["+$loadfilename+"]が存在しませんでした。") IFEND[]
					\MAKELOG2("★["+$loadfilename+"]が存在しませんでした。")
					$loadfilename = $T(38,01)+"black"
				}
				IFEND[]
			}
			IFEND[]

			IF[$TR!=""] //定義文字列あった場合
			{
				//----------------------------------------------------------------
				// トランジション画像をロード
				//----------------------------------------------------------------
					CG[ID=$TRBUF1 Z=1 E=0 A=0                                         FILE=$loadfilename]

///xS
//一瞬でもトランジションサイズが違ってしまうのを防ぐ.
//INT[@sx]INT[@sy]
//CGINFO[ID=$TRBUF1 SX=1 LET=@sx]
//CGINFO[ID=$TRBUF1 SY=1 LET=@sy]
			//		CG[ID=$TR1    Z=1 E=0 A=0 SX=@sx SY=@sy                           FILE=""]
					CG[ID=$TR1    Z=1 E=0 A=0 SX=1   SY=1                             FILE=""]
/*
						CGACT[ID=$TRBUF1 ID2=$TR1 SIZE=1 SX=@sx SY=@sy]
	IF[@_DXMODE]
//
	IFEND[]
*/
					IF[@_DXMODE==0]
						IF[@Rev==1] @L.TRR(@No)=1; CGACT[ID=$TRBUF1 REVERSE=1] IFEND[]
					ELSE[]
//
					IFEND[]

					CG[ID=$L1 TID=""] //初期化しておく

			}
			IFEND[]
	}
	IFEND[]

	return[]
}

//-------------------------------------------------------------------------
//トランジション反転
//
#=es.SP.LOADTR.REV
{
	INT[@wn =@_PINT(1)]
	INT[@No=@S.LNO(@wn)]
	STR[$TR1   =$LIDTR   +$(1+@No*100)]
	STR[$TRBUF1=$LIDTRBUF+$(1+@No*100)]
	CGACT[ID=$TRBUF1 REVERSE=1]
	CGACT[ID=$TR1 REVERSE=1]

	return[]
}


//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)各種演出指定
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

#=es.SP.CG.SET		{ @H.COM(@e_CG)+=1;@P.I2(@e_CG)=@_PINT(1);$P.S1(@e_CG)=$_PSTR(2);$P.S2(@e_CG)=$_PSTR(3);@P.I1(@e_CG)=@_PINT(4);@P.SDMD.NA(@e_CG)=@_PINT(5);@P.I3(@e_CG)=0;return[] }
#=es.SP.ANCG.SET	{ @H.COM(@e_CG)+=1;@P.I2(@e_CG)=@_PINT(1);$P.S1(@e_CG)=$_PSTR(2);$P.S2(@e_CG)="";@P.I1(@e_CG)=0;@P.SDMD.NA(@e_CG)=0;@P.I3(@e_CG)=@_PINT(3);@P.T(@e_CG)=@_PINT(4);@P.AC(@e_CG)=0;@P.N(@e_CG)=@_PINT(5);return[] }
#=es.SP.ANST.SET	{ @H.COM(@e_CG)+=1;@P.I2(@e_CG)=@_PINT(1);$P.S1(@e_CG)=$_PSTR(2);$P.S2(@e_CG)="";@P.I1(@e_CG)=0;@P.SDMD.NA(@e_CG)=0;@P.I3(@e_CG)=@_PINT(3);@P.T(@e_CG)=@_PINT(4);@P.AC(@e_CG)=0;@P.N(@e_CG)=@_PINT(5);\SP.2F1(,256,@_PINT(4),0);\SP.2F2(,256,@_PINT(4),0);return[] }
#=es.SP.ANPT.SET	{ @H.COM(@e_CG)+=1;@P.I2(@e_CG)=@_PINT(1);$P.S1(@e_CG)=$_PSTR(2);$P.S2(@e_CG)="";@P.I1(@e_CG)=0;@P.SDMD.NA(@e_CG)=0;@P.I3(@e_CG)=@_PINT(3);@P.T(@e_CG)=@_PINT(4);@P.AC(@e_CG)=0;@P.N(@e_CG)=@_PINT(5);return[] }
#=es.SP.ST.SET		{ @H.COM(@e_CG)+=1;@P.I2(@e_CG)=@_PINT(1);$P.S1(@e_CG)=$_PSTR(2);$P.S2(@e_CG)='';@P.I1(@e_CG)=0;@P.SDMD.NA(@e_CG)=0;@P.I3(@e_CG)=0;\SP.2F1(,256,@_PINT(3),0);\SP.2F2(,256,@_PINT(3),0);return[] }

#=es.SP.ECG.SET		{ @H.COM(@e_ECG)+=1;@P.I2(@e_ECG)=@_PINT(1);@P.I3(@e_ECG)=@_PINT(2);$P.S2(@e_ECG)=$_PSTR(3);@P.I1(@e_ECG)=@_PINT(4);@P.SDMD.NA(@e_ECG)=@_PINT(5);return[] }
#=es.SP.TXG.SET		{ @H.COM(@e_TXG)+=1;@P.I1(@e_TXG)=@_PINT(1);$P.S1(@e_TXG)=$_PSTR(2);return[] }
#=es.SP.TXL.SET		{ @H.COM(@e_TXL)+=1;@P.I1(@e_TXL)=@_PINT(1);$P.S1(@e_TXL)=$_PSTR(2);return[] }
//#=es.SP.TXS.SET		{ @H.COM(@e_TXS)+=1;@P.I1(@e_TXS)=-1;$P.S1(@e_TXS)=$_PSTR(1);return[] }

#=es.SP.ANMV.SET	{ \HQEXEC(@e_MV);@P.I2(@e_MV)=@_PINT(1);$P.S1(@e_MV)=$_PSTR(2);$P.S2(@e_MV)=$_PSTR(3);@P.I1(@e_MV)=@_PINT(4);@P.SDMD.NA(@e_MV)=@_PINT(5);;@P.I3(@e_MV)=0;return[] }
#=es.SP.ANLP.SET	{ \HQEXEC(@e_ANLP);@P.I1(@e_ANLP)=@_PINT(1);@P.I2(@e_ANLP)=@_PINT(2);@P.I3(@e_ANLP)=@_PINT(3);@P.I4(@e_ANLP)=@_PINT(4);@P.T(@e_ANLP)=0;@P.AC(@e_ANLP)=0;@P.N(@e_ANLP)=1;return[] }
#=es.SP.TR.SET		{ \HQEXEC(@e_TR);$P.S1(@e_TR)=$_PSTR(1);@P.I1(@e_TR)=@_PINT(2);@P.N(@e_TR)=1;@P.I3(@e_TR)=0;return[] }
#=es.SP.MP.SET		{ \HQEXEC(@e_MP);@P.I1(@e_MP)=@_PINT(1);@P.N(@e_MP)=1;return[] }
#=es.SP.BL.SET		{ \HQEXEC(@e_BL);@P.I1(@e_BL)=@_PINT(1);@P.N(@e_BL)=1;return[] }

#=es.SP.EM.VO.SET
{
	@EM_VO_CNT+=1
	IF[@EM_VO_CNT==1] \HQEXEC(@e_EM_VO);$P.S1(@e_EM_VO)="";@P.T(@e_EM_VO)=0;@P.AC(@e_EM_VO)=0;@P.N(@e_EM_VO)=1 IFEND[]

	INT[@cno=@_PINT(2)]
	INT[@param=@_PFLT(3)*100]
	$P.S1(@e_EM_VO)+=$_PSTR(1)+\EM.SEP+$(@cno)+\EM.SEP+$(@param)+\EM.SEP

	return[]
}


#=es.SP.EM.VAR.SET
{
	@EM_VAR_CNT+=1
	IF[@EM_VAR_CNT==1] \HQEXEC(@e_EM_VAR);$P.S1(@e_EM_VAR)="";@P.T(@e_EM_VAR)=0;@P.AC(@e_EM_VAR)=0;@P.N(@e_EM_VAR)=1 IFEND[]

	INT[@val=@_PFLT(2)*100]
	INT[@time=@_PINT(3)]
	$P.S1(@e_EM_VAR)+=$_PSTR(1)+\EM.SEP+$(@val)+\EM.SEP+$(@time)+\EM.SEP

	//一番長い時間にセットする
	IF[@P.T(@e_EM_VAR)<@time] @P.T(@e_EM_VAR)=@time IFEND[]

	return[]
}

#=es.SP.EM.PLAY.SET
{
	@EM_TLP_CNT+=1
	IF[@EM_TLP_CNT==1] \HQEXEC(@e_EM_TLP);$P.S1(@e_EM_TLP)="";@P.T(@e_EM_TLP)=0;@P.AC(@e_EM_TLP)=0;@P.N(@e_EM_TLP)=1 IFEND[]

	INT[@time=@_PINT(2)]
	INT[@ratio=@_PFLT(3)*100]
	$P.S1(@e_EM_TLP)+=$_PSTR(1)+\EM.SEP+$(@time)+\EM.SEP+$(@ratio)+\EM.SEP

	//一番長い時間にセットする
	IF[@P.T(@e_EM_TLP)<@time] @P.T(@e_EM_TLP)=@time IFEND[]

	return[]
}

#=es.SP.EM.DPLAY.SET
{
	@EM_TLPA_CNT+=1
	IF[@EM_TLPA_CNT==1] \HQEXEC(@e_EM_TLPA);$P.S1(@e_EM_TLPA)="";@P.T(@e_EM_TLPA)=0;@P.AC(@e_EM_TLPA)=0;@P.N(@e_EM_TLPA)=1 IFEND[]

	INT[@time=@_PINT(2)]
	INT[@ratio=@_PFLT(3)*100]
	$P.S1(@e_EM_TLPA)+=$_PSTR(1)+\EM.SEP+$(@time)+\EM.SEP+$(@ratio)+\EM.SEP

	//一番長い時間にセットする
	IF[@P.T(@e_EM_TLPA)<@time] @P.T(@e_EM_TLPA)=@time IFEND[]

	return[]
}

#=es.SP.EM.STOP.SET
{
	@EM_TLS_CNT+=1
	IF[@EM_TLS_CNT==1] \HQEXEC(@e_EM_TLS);$P.S1(@e_EM_TLS)="";@P.T(@e_EM_TLS)=0;@P.AC(@e_EM_TLS)=0;@P.N(@e_EM_TLS)=1 IFEND[]

	INT[@time=@_PINT(2)]
	INT[@ratio=@_PFLT(3)*100]
	$P.S1(@e_EM_TLS)+=$_PSTR(1)+\EM.SEP+$(@time)+\EM.SEP+$(@ratio)+\EM.SEP

	//一番長い時間にセットする
	IF[@P.T(@e_EM_TLS)<@time] @P.T(@e_EM_TLS)=@time IFEND[]

	return[]
}

#=es.SP.EM.DSTOP.SET
{
	@EM_TLSA_CNT+=1
	IF[@EM_TLSA_CNT==1] \HQEXEC(@e_EM_TLSA);$P.S1(@e_EM_TLSA)="";@P.T(@e_EM_TLSA)=0;@P.AC(@e_EM_TLSA)=0;@P.N(@e_EM_TLSA)=1 IFEND[]

	INT[@time=@_PINT(2)]
	INT[@ratio=@_PFLT(3)*100]
	$P.S1(@e_EM_TLSA)+=$_PSTR(1)+\EM.SEP+$(@time)+\EM.SEP+$(@ratio)+\EM.SEP

	//一番長い時間にセットする
	IF[@P.T(@e_EM_TLSA)<@time] @P.T(@e_EM_TLSA)=@time IFEND[]

	return[]
}

#=es.SP.HOR.SET		{ \HQEXEC(@e_HOR);@P.I1(@e_HOR)=@_PINT(1);@P.N(@e_HOR)=1;return[] }
#=es.SP.VER.SET		{ \HQEXEC(@e_VER);@P.I1(@e_VER)=@_PINT(1);@P.N(@e_VER)=1;return[] }
#=es.SP.MONO.SET	{ \HQEXEC(@e_MONO);@P.I1(@e_MONO)=@_PINT(1);@P.N(@e_MONO)=1;return[] }
#=es.SP.AKA.SET		{ \HQEXEC(@e_AKA);@P.I1(@e_AKA)=@_PINT(1);@P.I2(@e_AKA)=@_PINT(2);@P.T(@e_AKA)=@_PINT(3);@P.AC(@e_AKA)=@_PINT(4);@P.N(@e_AKA)=@_PINT(5);return[] }
#=es.SP.MOSA.SET	{ \HQEXEC(@e_MOSA);@P.I1(@e_MOSA)=@_PINT(1);@P.I2(@e_MOSA)=@_PINT(2);@P.T(@e_MOSA)=@_PINT(3);@P.AC(@e_MOSA)=@_PINT(4);@P.N(@e_MOSA)=@_PINT(5);return[] }
#=es.SP.BLUR.SET	{ \HQEXEC(@e_BLUR);@P.I1(@e_BLUR)=@_PINT(1);@P.I2(@e_BLUR)=@_PINT(2);@P.T(@e_BLUR)=@_PINT(3);@P.AC(@e_BLUR)=@_PINT(4);@P.N(@e_BLUR)=@_PINT(5);return[] }
#=es.SP.DIFF.SET	{ \HQEXEC(@e_DIFF);@P.I1(@e_DIFF)=@_PINT(1);@P.I2(@e_DIFF)=@_PINT(2);@P.T(@e_DIFF)=@_PINT(3);@P.AC(@e_DIFF)=@_PINT(4);@P.N(@e_DIFF)=@_PINT(5);return[] }
#=es.SP.WPL.SET		{ \HQEXEC(@e_WPL);@P.I1(@e_WPL)=@_PINT(1);@P.I2(@e_WPL)=@_PINT(2);@P.T(@e_WPL)=@_PINT(3);@P.AC(@e_WPL)=@_PINT(4);@P.N(@e_WPL)=@_PINT(5);return[] }
#=es.SP.ROT.SET		{ \HQEXEC(@e_ROT);@P.I1(@e_ROT)=@_PINT(1);@P.I2(@e_ROT)=@_PINT(2);@P.T(@e_ROT)=@_PINT(3);@P.AC(@e_ROT)=@_PINT(4);@P.N(@e_ROT)=@_PINT(5);return[] }
#=es.SP.RAS.SET		{ \HQEXEC(@e_RAS);@P.I1(@e_RAS)=@_PINT(1);@P.I2(@e_RAS)=@_PINT(2);@P.T(@e_RAS)=@_PINT(3);@P.AC(@e_RAS)=@_PINT(4);@P.N(@e_RAS)=@_PINT(5);return[] }
#=es.SP.REV.SET		{ \HQEXEC(@e_REV);@P.I1(@e_REV)=@_PINT(1);@P.I2(@e_REV)=@_PINT(2);@P.T(@e_REV)=@_PINT(3);@P.AC(@e_REV)=@_PINT(4);@P.N(@e_REV)=@_PINT(5);return[] }

//#=es.SP.SK.SET		{ \HQEXEC(@e_SK);@P.I1(@e_SK)=@_PINT(1);@P.I2(@e_SK)=@_PINT(2);@P.N(@e_SK)=1;return[] }
#=es.SP.SK.SET		{ @es.LSD(033,11)=@_PINT(1);@es.LSD(033,12)=@_PINT(2);return[] }

#=es.SP.NOP.SET		{ \HQEXEC(@e_NOP);@P.T(@e_NOP)=@_PINT(1);@P.AC(@e_NOP)=0;@P.N(@e_NOP)=1;return[] }
#=es.SP.END.SET		{ \HQEXEC(@e_END);@P.T(@e_END)=0;@P.AC(@e_END)=0;@P.N(@e_END)=1;return[] }
//#=es.SP.SD.SET	{ \HQEXEC(@e_SD);@P.I1(@e_SD)=@_PINT(1);@P.I2(@e_SD)=@_PINT(2);@P.T(@e_SD)=@_PINT(3);@P.AC(@e_SD)=@_PINT(4);@P.N(@e_SD)=@_PINT(5);return[] }
//#=es.SP.MD.SET	{ \HQEXEC(@e_MD);@P.I1(@e_MD)=@_PINT(1);@P.I2(@e_MD)=@_PINT(2);@P.T(@e_MD)=@_PINT(3);@P.AC(@e_MD)=@_PINT(4);@P.N(@e_MD)=@_PINT(5);return[] }
#=es.SP.SD.SET		{ \HQEXEC(@e_SD);@P.I1(@e_SD)=@_PINT(1);@P.I2(@e_SD)=@_PINT(1);@P.T(@e_SD)=0;@P.AC(@e_SD)=0;@P.N(@e_SD)=1;return[] }
#=es.SP.MD.SET		{ \HQEXEC(@e_MD);@P.I1(@e_MD)=@_PINT(1);@P.I2(@e_MD)=@_PINT(1);@P.T(@e_MD)=0;@P.AC(@e_MD)=0;@P.N(@e_MD)=1;return[] }
#=es.SP.A.SET		{ \HQEXEC(@e_A );@P.I1(@e_A )=@_PINT(1);@P.I2(@e_A )=@_PINT(2);@P.T(@e_A)=@_PINT(3);@P.AC(@e_A)=@_PINT(4);@P.N(@e_A)=@_PINT(5);return[] }
#=es.SP.F1.SET		{ \HQEXEC(@e_F1);@P.I1(@e_F1)=@_PINT(1);@P.I2(@e_F1)=@_PINT(2);@P.T(@e_F1)=@_PINT(3);@P.AC(@e_F1)=@_PINT(4);@P.N(@e_F1)=@_PINT(5);return[] }
#=es.SP.F2.SET		{ \HQEXEC(@e_F2);@P.I1(@e_F2)=@_PINT(1);@P.I2(@e_F2)=@_PINT(2);@P.T(@e_F2)=@_PINT(3);@P.AC(@e_F2)=@_PINT(4);@P.N(@e_F2)=@_PINT(5);return[] }
#=es.SP.H.SET		{ \HQEXEC(@e_H );@P.I1(@e_H )=@_PINT(1);@P.I2(@e_H )=@_PINT(2);@P.T(@e_H)=@_PINT(3);@P.AC(@e_H)=@_PINT(4);@P.N(@e_H)=@_PINT(5);return[] }
#=es.SP.MX.SET		{ \HQEXEC(@e_MX);@P.I1(@e_MX)=@_PINT(1);@P.N(@e_MX)=1;return[] }
#=es.SP.MY.SET		{ \HQEXEC(@e_MY);@P.I1(@e_MY)=@_PINT(1);@P.N(@e_MY)=1;return[] }
#=es.SP.MZ.SET		{ \HQEXEC(@e_MZ);@P.I1(@e_MZ)=@_PINT(1);@P.N(@e_MZ)=1;return[] }
#=es.SP.QX.SET		{ \HQEXEC(@e_QX);@P.I1(@e_QX)=@_PINT(1);@P.T(@e_QX)=@_PINT(2);@P.AC(@e_QX)=@_PINT(3);@P.N(@e_QX)=@_PINT(4);return[] }
#=es.SP.QY.SET		{ \HQEXEC(@e_QY);@P.I1(@e_QY)=@_PINT(1);@P.T(@e_QY)=@_PINT(2);@P.AC(@e_QY)=@_PINT(3);@P.N(@e_QY)=@_PINT(4);return[] }
#=es.SP.QZ.SET		{ \HQEXEC(@e_QZ);@P.I1(@e_QZ)=@_PINT(1);@P.T(@e_QZ)=@_PINT(2);@P.AC(@e_QZ)=@_PINT(3);@P.N(@e_QZ)=@_PINT(4);return[] }
#=es.SP.RX.SET		{ \HQEXEC(@e_RX);@P.F1(@e_RX)=@_PINT(1);@P.F2(@e_RX)=@_PINT(2);@P.T(@e_RX)=@_PINT(3);@P.AC(@e_RX)=@_PINT(4);@P.N(@e_RX)=@_PINT(5);return[] }
#=es.SP.RY.SET		{ \HQEXEC(@e_RY);@P.F1(@e_RY)=@_PINT(1);@P.F2(@e_RY)=@_PINT(2);@P.T(@e_RY)=@_PINT(3);@P.AC(@e_RY)=@_PINT(4);@P.N(@e_RY)=@_PINT(5);return[] }
#=es.SP.RZ.SET		{ \HQEXEC(@e_RZ);@P.F1(@e_RZ)=@_PINT(1);@P.F2(@e_RZ)=@_PINT(2);@P.T(@e_RZ)=@_PINT(3);@P.AC(@e_RZ)=@_PINT(4);@P.N(@e_RZ)=@_PINT(5);return[] }
#=es.SP.BX.SET		{ \HQEXEC(@e_BX);@P.F1(@e_BX)=@_PINT(1);@P.F2(@e_BX)=@_PINT(2);@P.T(@e_BX)=@_PINT(3);@P.AC(@e_BX)=@_PINT(4);@P.N(@e_BX)=@_PINT(5);return[] }
#=es.SP.BY.SET		{ \HQEXEC(@e_BY);@P.F1(@e_BY)=@_PINT(1);@P.F2(@e_BY)=@_PINT(2);@P.T(@e_BY)=@_PINT(3);@P.AC(@e_BY)=@_PINT(4);@P.N(@e_BY)=@_PINT(5);return[] }
#=es.SP.TP.SET		{ \HQEXEC(@e_TP);@P.I1(@e_TP)=@_PINT(1);@P.I2(@e_TP)=@_PINT(2);@P.I3(@e_TP)=(@_PINT(1)==257);IF[@_PINT(1)==257] @P.I1(@e_TP)=256 IFEND[];@P.T(@e_TP)=@_PINT(3);@P.AC(@e_TP)=@_PINT(4);@P.N(@e_TP)=@_PINT(5);return[] }
#=es.SP.X.SET		{ \HQEXEC(@e_X );@P.F1(@e_X)=@_PFLT(1);@P.F2(@e_X)=@_PFLT(2);@P.T(@e_X)=@_PINT(3);@P.AC(@e_X)=@_PINT(4);@P.N(@e_X)=@_PINT(5);return[] }
#=es.SP.Y.SET		{ \HQEXEC(@e_Y );@P.F1(@e_Y)=@_PFLT(1);@P.F2(@e_Y)=@_PFLT(2);@P.T(@e_Y)=@_PINT(3);@P.AC(@e_Y)=@_PINT(4);@P.N(@e_Y)=@_PINT(5);return[] }
#=es.SP.Z.SET		{ \HQEXEC(@e_Z );@P.F1(@e_Z)=@_PFLT(1);@P.F2(@e_Z)=@_PFLT(2);@P.T(@e_Z)=@_PINT(3);@P.AC(@e_Z)=@_PINT(4);@P.N(@e_Z)=@_PINT(5);return[] }
#=es.SP.CLBX.SET	{ \HQEXEC(@e_CLBX);@P.I1(@e_CLBX)=@_PINT(1);@P.T(@e_CLBX)=@_PINT(2);@P.N(@e_CLBX)=@_PINT(3);@P.I3(@e_CLBX)=@_PINT(4);return[] }
#=es.SP.CLBY.SET	{ \HQEXEC(@e_CLBY);@P.I1(@e_CLBY)=@_PINT(1);@P.T(@e_CLBY)=@_PINT(2);@P.N(@e_CLBY)=@_PINT(3);@P.I3(@e_CLBY)=@_PINT(4);return[] }
#=es.SP.CLA.SET		{ \HQEXEC(@e_CLA);@P.I1(@e_CLA)=@_PINT(1);@P.T(@e_CLA)=@_PINT(2);@P.N(@e_CLA)=@_PINT(3);@P.I3(@e_CLA)=@_PINT(4);return[] }
#=es.SP.CLH.SET		{ \HQEXEC(@e_CLH);@P.I1(@e_CLH)=@_PINT(1);@P.T(@e_CLH)=@_PINT(2);@P.N(@e_CLH)=@_PINT(3);@P.I3(@e_CLH)=@_PINT(4);return[] }
#=es.SP.CLTP.SET	{ \HQEXEC(@e_CLTP);@P.I1(@e_CLTP)=@_PINT(1);@P.T(@e_CLTP)=@_PINT(2);@P.N(@e_CLTP)=@_PINT(3);@P.I3(@e_CLTP)=@_PINT(4);return[] }
#=es.SP.CLX.SET		{ \HQEXEC(@e_CLX);@P.I1(@e_CLX)=@_PINT(1);@P.T(@e_CLX)=@_PINT(2);@P.N(@e_CLX)=@_PINT(3);@P.I3(@e_CLX)=@_PINT(4);return[] }
#=es.SP.CLY.SET		{ \HQEXEC(@e_CLY);@P.I1(@e_CLY)=@_PINT(1);@P.T(@e_CLY)=@_PINT(2);@P.N(@e_CLY)=@_PINT(3);@P.I3(@e_CLY)=@_PINT(4);return[] }
#=es.SP.CLZ.SET		{ \HQEXEC(@e_CLZ);@P.I1(@e_CLZ)=@_PINT(1);@P.T(@e_CLZ)=@_PINT(2);@P.N(@e_CLZ)=@_PINT(3);@P.I3(@e_CLZ)=@_PINT(4);return[] }
#=es.SP.CLRX.SET	{ \HQEXEC(@e_CLRX);@P.I1(@e_CLRX)=@_PINT(1);@P.T(@e_CLRX)=@_PINT(2);@P.N(@e_CLRX)=@_PINT(3);@P.I3(@e_CLRX)=@_PINT(4);return[] }
#=es.SP.CLRY.SET	{ \HQEXEC(@e_CLRY);@P.I1(@e_CLRY)=@_PINT(1);@P.T(@e_CLRY)=@_PINT(2);@P.N(@e_CLRY)=@_PINT(3);@P.I3(@e_CLRY)=@_PINT(4);return[] }
#=es.SP.CLRZ.SET	{ \HQEXEC(@e_CLRZ);@P.I1(@e_CLRZ)=@_PINT(1);@P.T(@e_CLRZ)=@_PINT(2);@P.N(@e_CLRZ)=@_PINT(3);@P.I3(@e_CLRZ)=@_PINT(4);return[] }
#=es.SP.FIN.SET		{ \HQEXEC(@e_FIN);@P.T(@e_FIN)=@_PINT(1);@P.N(@e_FIN)=1;return[] }


//#=es.SP.PXY0.SET	{ @P.L1(1)=@_PFLT(1);@P.L2(1)=@_PFLT(2);@P.L4=1;return[] }
#=es.SP.PXY1.SET	{ @P.L1(2)=@_PFLT(1);@P.L2(2)=@_PFLT(2);@P.L4=2;return[] }
#=es.SP.PXY2.SET	{ @P.L1(3)=@_PFLT(1);@P.L2(3)=@_PFLT(2);@P.L4=3;return[] }
#=es.SP.PXY3.SET	{ @P.L1(4)=@_PFLT(1);@P.L2(4)=@_PFLT(2);@P.L4=4;return[] }
#=es.SP.PXY4.SET	{ @P.L1(5)=@_PFLT(1);@P.L2(5)=@_PFLT(2);@P.L4=5;return[] }
#=es.SP.PXY5.SET	{ @P.L1(6)=@_PFLT(1);@P.L2(6)=@_PFLT(2);@P.L4=6;return[] }
#=es.SP.PXY6.SET	{ @P.L1(7)=@_PFLT(1);@P.L2(7)=@_PFLT(2);@P.L4=7;return[] }
#=es.SP.PXY7.SET	{ @P.L1(8)=@_PFLT(1);@P.L2(8)=@_PFLT(2);@P.L4=8;return[] }
#=es.SP.PXY8.SET	{ @P.L1(9)=@_PFLT(1);@P.L2(9)=@_PFLT(2);@P.L4=9;return[] }
#=es.SP.PXY9.SET	{ @P.L1(10)=@_PFLT(1);@P.L2(10)=@_PFLT(2);@P.L4=10;return[] }
#=es.SP.PXY10.SET	{ @P.L1(11)=@_PFLT(1);@P.L2(11)=@_PFLT(2);@P.L4=11;return[] }

//#=es.SP.PXYZ0.SET	{ @P.L1(1)=@_PFLT(1);@P.L2(1)=@_PFLT(2);@P.L3(1)=@_PFLT(3);@P.L4=1;return[] }
#=es.SP.PXYZ1.SET	{ @P.L1(2)=@_PFLT(1);@P.L2(2)=@_PFLT(2);@P.L3(2)=@_PFLT(3);@P.L4=2;return[] }
#=es.SP.PXYZ2.SET	{ @P.L1(3)=@_PFLT(1);@P.L2(3)=@_PFLT(2);@P.L3(3)=@_PFLT(3);@P.L4=3;return[] }
#=es.SP.PXYZ3.SET	{ @P.L1(4)=@_PFLT(1);@P.L2(4)=@_PFLT(2);@P.L3(4)=@_PFLT(3);@P.L4=4;return[] }
#=es.SP.PXYZ4.SET	{ @P.L1(5)=@_PFLT(1);@P.L2(5)=@_PFLT(2);@P.L3(5)=@_PFLT(3);@P.L4=5;return[] }
#=es.SP.PXYZ5.SET	{ @P.L1(6)=@_PFLT(1);@P.L2(6)=@_PFLT(2);@P.L3(6)=@_PFLT(3);@P.L4=6;return[] }
#=es.SP.PXYZ6.SET	{ @P.L1(7)=@_PFLT(1);@P.L2(7)=@_PFLT(2);@P.L3(7)=@_PFLT(3);@P.L4=7;return[] }
#=es.SP.PXYZ7.SET	{ @P.L1(8)=@_PFLT(1);@P.L2(8)=@_PFLT(2);@P.L3(8)=@_PFLT(3);@P.L4=8;return[] }
#=es.SP.PXYZ8.SET	{ @P.L1(9)=@_PFLT(1);@P.L2(9)=@_PFLT(2);@P.L3(9)=@_PFLT(3);@P.L4=9;return[] }
#=es.SP.PXYZ9.SET	{ @P.L1(10)=@_PFLT(1);@P.L2(10)=@_PFLT(2);@P.L3(10)=@_PFLT(3);@P.L4=10;return[] }
#=es.SP.PXYZ10.SET	{ @P.L1(11)=@_PFLT(1);@P.L2(11)=@_PFLT(2);@P.L3(11)=@_PFLT(3);@P.L4=11;return[] }

#=es.SP.SPXY.SET
{
	\HQEXEC(@e_PXY)
	@P.T(@e_PXY)=@_PINT(1);@P.AC(@e_PXY)=@_PINT(2);@P.N(@e_PXY)=1
	@P.F1(@e_PXY)=@es.SVAL
	return[]
}
#=es.SP.S2PXY.SET
{
	\HQEXEC(@e_PXY)
	@P.T(@e_PXY)=@_PINT(1);@P.AC(@e_PXY)=@_PINT(2);@P.N(@e_PXY)=1
	@P.F1(@e_PXY)=@es.S2VAL
	return[]
}
#=es.SP.ZPXY.SET
{
	\HQEXEC(@e_PXY)
	@P.T(@e_PXY)=@_PINT(1);@P.AC(@e_PXY)=@_PINT(2);@P.N(@e_PXY)=@_PINT(3)
	@P.F1(@e_PXY)=@es.ZVAL
	return[]
}

#=es.SP.SPXYZ.SET
{
	\HQEXEC(@e_PXYZ)
	@P.T(@e_PXYZ)=@_PINT(1);@P.AC(@e_PXYZ)=@_PINT(2);@P.N(@e_PXYZ)=1
	@P.F1(@e_PXYZ)=@es.SVAL
	return[]
}
#=es.SP.S2PXYZ.SET
{
	\HQEXEC(@e_PXYZ)
	@P.T(@e_PXYZ)=@_PINT(1);@P.AC(@e_PXYZ)=@_PINT(2);@P.N(@e_PXYZ)=1
	@P.F1(@e_PXYZ)=@es.S2VAL
	return[]
}
#=es.SP.ZPXYZ.SET
{
	\HQEXEC(@e_PXYZ)
	@P.T(@e_PXYZ)=@_PINT(1);@P.AC(@e_PXYZ)=@_PINT(2);@P.N(@e_PXYZ)=@_PINT(3)
	@P.F1(@e_PXYZ)=@es.ZVAL
	return[]
}



//==========================================================.FINISH
#=es.SP.FINISH.SET
{
/*	STR[$spid=$_PSTR(1)]
	STR[$name=$_PSTR(2)] //演出名

	@finflag=1
	$finspid=$spid
	$finname=$name

	return[]
}

#=es.SP.FINISH.GO
{
*/
	STR[$spid=$_PSTR(1)]
	STR[$name=$_PSTR(2)] //演出名

	INT[@restartflag]
	INT[@count]

	IF[$spid==""] //スプライト名の指定なし
	{
//			\SP.GO

			LOOP[]
			{
				@count+=1
				@restartflag=0

				LOOP[SET=@QUE.MAX]	//演出中の全演出を終了させる
				{
					IF[@S.FLAG(@_LC)>0]
					{
						@restartflag=1 //もう一度やりなおし
					}
					IFEND[]
					IF[@S.FLAG(@_LC)==4]
					{
						@S.N(@_LC)=1
						@S.TNOW(@_LC)=@S.T(@_LC)
				//		@S.FLAG.END(@_LC)=999
				//		GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
					}
					IFEND[]
				}
				LOOPEND[]

				IF[@restartflag==0] LOOPBREAK[] IFEND[] //指定したスプライトが無くなったら終了.

				IF[@count==@QUE.MAX*2] \_mes("内部の問題により演出が終了出来ません。");END[] IFEND[]

				GOSUB[#=es.EF.TASK.MAIN] //連続演出をどんどん終わらせる
			}
			LOOPEND[]
	}
	ELSE[]
	{
		IF[$name==""] //演出名の指定なし
		{
//			\SP.GO($spid)

			LOOP[]
			{
				@count+=1
				@restartflag=0

				LOOP[SET=@QUE.MAX]	//$spidで演出中の全演出を終了させる
				{
					IF[$S.SPID(@_LC)==$spid]
					{
						@restartflag=1 //もう一度やりなおし

						IF[@S.FLAG(@_LC)==4]
						{
							@S.N(@_LC)=1
							@S.TNOW(@_LC)=@S.T(@_LC)
					//		@S.FLAG.END(@_LC)=999
					//		GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
						}
						IFEND[]
					}
					IFEND[]
				}
				LOOPEND[]

				IF[@restartflag==0] LOOPBREAK[] IFEND[] //指定したスプライトが無くなったら終了.

				IF[@count==@QUE.MAX*2] \_mes("内部の問題により演出が終了出来ません。");END[] IFEND[]

				GOSUB[#=es.EF.TASK.MAIN] //連続演出をどんどん終わらせる
			}
			LOOPEND[]
		}
		ELSE[] //演出名の指定あり
		{
//			\SP.GO($spid, $name)

			LOOP[]
			{
				@count+=1
				@restartflag=0

				LOOP[SET=@QUE.MAX]	//$spidで演出中の全演出を終了させる
				{
					IF[$S.SPID(@_LC)==$spid && $S.NAME(@_LC)==$name]
					{
						@restartflag=1 //もう一度やりなおし
/*
						IF[@count==@QUE.MAX*2]
							IF[@S.FLAG(@_LC)>0]
								\_dmes("$spid="+$spid+" $SPID="+$S.SPID(@_LC)+" COM="+$comstr(@S.COM(@_LC))+" S.FLAG="+$(@S.FLAG(@_LC)))
							IFEND[]
						IFEND[]
*/
						IF[@S.FLAG(@_LC)==4]
						{
							@S.N(@_LC)=1
							@S.TNOW(@_LC)=@S.T(@_LC)
					//		@S.FLAG.END(@_LC)=999
					//		GOSUB[#=es.EF.END pint=@_LC pstr2=$S.SPID(@_LC)]
						}
						IFEND[]
					}
					IFEND[]
				}
				LOOPEND[]

				IF[@restartflag==0] LOOPBREAK[] IFEND[] //指定したスプライトが無くなったら終了.

				IF[@count==@QUE.MAX*2] \_mes("内部の問題により演出が終了出来ません。");END[] IFEND[]

				GOSUB[#=es.EF.TASK.MAIN] //連続演出をどんどん終わらせる
			}
			LOOPEND[]
		}
		IFEND[]
	}
	IFEND[]

//	#=es.SP.FINISH.GO.LEnd
	return[]
}


//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)アニメ開始
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
/*
#=es.SP.ANSTART.SET
{
	INT[@No   = @_PINT(1)]
	INT[@Coma = @_PINT(2)]
	GOSUB[#=es.SP.MINMAX.CHECK pint=@No]

	//IF[@Coma==0]
	{
		@L.ANC(@No)    = 1
		@L.ANC2(@No)   = 0
		@L.ANC3(@No)   = 0
		@L.ANC4(@No)   = 0
		@L.ANX(@No)    = 0
		@L.ANY(@No)    = 0
		@L.ANSTOP(@No) = 0
	}
	//IFEND[]

	//@L.ANSTOP(@No) = @Coma

	return[]
}
*/

//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)アニメ停止
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
#=es.SP.ANSTOP.SET
{
	INT[@No   = @_PINT(1)]
	INT[@Coma = @_PINT(2)]
	GOSUB[#=es.SP.MINMAX.CHECK pint=@No]

	IF[@Coma==0]
	{
		@L.ANSTOP(@No) = 99999
	}
	IFEND[]

	//@L.ANSTOP(@No) = @Coma

	return[]
}

/*
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)演出スキップモード設定
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
#=es.SP.SKIPMODE.SET
{
	@SP.SKIPMODE = @_PINT(1)
	return[]
}
*/
#=es.SP.SKDEF.SET
{
	@es.LSD(033,01) = @_PINT(1)
	@es.LSD(033,02) = @_PINT(2)
	return[]
}
#=es.WA.SKDEF.SET
{
	@es.LSD(033,03) = @_PINT(1)
	@es.LSD(033,04) = @_PINT(2)
	return[]
}
#=es.BG.SKDEF.SET
{
	@es.LSD(033,05) = @_PINT(1)
	@es.LSD(033,06) = @_PINT(2)
	return[]
}
#=es.EV.SKDEF.SET
{
	@es.LSD(033,07) = @_PINT(1)
	@es.LSD(033,08) = @_PINT(2)
	return[]
}
#=es.VO.SKDEF.SET
{
	@es.LSD(033,13) = @_PINT(1)
	return[]
}

//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)演出スキップモード設定
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
#=es.MENU.SKIP.OFF.SET
#=es.TX.SKIP.OFF
{
	//@SP.MENU.SKIPMODE = @_PINT(1)
	@es.TX.SKIP = 0
	return[]
}


//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//■(SET)演出開始
//@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
#=es.SP.SET.SET
{
	STR[$SPID = $_PSTR(1)]
//	\SP.FINISH($SPID)

	GOSUB[#=es.SP.SETADD.SET pstr=$SPID pint2=@_PINT(3) pstr3=$_PSTR(2) pint4=@_PINT(4)] ///x安全面から、時間指定を止めたVer.
//	GOSUB[#=es.SP.SETADD.SET pstr=$SPID pint2=@_PINT(2) pstr3=$_PSTR(3) pint4=@_PINT(4)]

	@EM_VO_CNT=0
	@EM_VAR_CNT=0
	@EM_TLP_CNT=0
	@EM_TLS_CNT=0
	@EM_TLPA_CNT=0
	@EM_TLSA_CNT=0

	GOSUB[#=es.SP.GO.SET pstr=$SPID]
	\SCRIPTPOS_SAVE

	return[]
}

#=es.SP.SETADD.SET
{
	//スキップ中(エンディングのみ)ならスルー
	IF[@es.SP.AUTOSKIP==1 && @es.SP.AUTONO>0] GOSUB[#=es.SP.SETADD.SET.LEnd] IFEND[]
	//ロード中ならスルー
	IF[@es.LOADTHRU] GOSUB[#=es.SP.SETADD.SET.LEnd] IFEND[]

	STR[$SPID  =  $_PSTR(1)] // スプライト名
	INT[@TIME  = -@_PINT(2)] // 開始時間
	STR[$NAME  =  $_PSTR(3)] // 演出名

	INT[@wn]

	//命令重複チェック
	LOOP[SET=(77)-1]
		IF[@H.COM(@_LC)>1] \_mes("\\SP."+$comstr(@_LC)+" 命令が多重に指定されています。");END[] IFEND[]
	LOOPEND[]

	IF[@es.GSD(112,01)==1] //エフェクトOFF(==1)なら
	{
		//CL系命令切る.
		@H.COM(@e_CLBX)	=0
		@H.COM(@e_CLBY)	=0
		@H.COM(@e_CLA)	=0
	//	@H.COM(@e_CLH)	=0
		@H.COM(@e_CLTP)	=0
		@H.COM(@e_CLV)	=0
		@H.COM(@e_CLW)	=0
		@H.COM(@e_CLX)	=0
		@H.COM(@e_CLY)	=0
		@H.COM(@e_CLZ)	=0
		@H.COM(@e_CLRX)	=0
		@H.COM(@e_CLRY)	=0
		@H.COM(@e_CLRZ)	=0

		//RZ命令切る.
		@H.COM(@e_RZ)	=0
	}
	IFEND[]


	STR[$str]STR[$ext]INT[@chk]

	@g.QNOW+=1 //\SP.GOする毎に+1する


	INT[@FLAG_SK]

	IF[@es.LSD(033,11)==-1]
		@FLAG_SK =(@es.LSD(033,01)==1)*2
	ELSE[]
		@FLAG_SK =(@es.LSD(033,11)==1)*2
	IFEND[]

	IF[@es.LSD(033,12)==-1]
		@FLAG_SK+=(@es.LSD(033,02)==1)
	ELSE[]
		@FLAG_SK+=(@es.LSD(033,12)==1)
	IFEND[]

	@es.LSD(033,11)=-1
	@es.LSD(033,12)=-1


	LOOP[SET=(77)-1]
	{
		IF[@H.COM(@_LC)>0]
		{
			IF[@_LC==@e_CG || @_LC==@e_TR || @_LC==@e_MV]
			{
				//ファイル拡張子簡易チェック
				\_strlower($P.S1(@_LC))($str);\_strlen($str)
				\_strmid($str, @_RINT(1)-3, 4)($ext)
				@chk=($ext==".bmp")+($ext==".png")+($ext==".jpg")+($ext==".gif")+($ext==".ymv")
				IF[@chk] \_mes("[仕様制限]ファイル名に拡張子は記入できません。");END[] IFEND[]
			}
			IFEND[]

			GOSUB[#=es.SP.QUE.EMPTYGET];@wn=@_RINT(1)
			@S.COM(@wn)	= @_LC

			@S.SK(@wn) = @FLAG_SK

			IF[@_LC==@e_CG || @_LC==@e_TR || @_LC==@e_MV] //必要ないけど一応
			{
				@S.FTYPE(@wn)	= @P.I2(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_ECG]
			{
				@S.FTYPE(@wn) = 0
			}
			IFEND[]

			@S.QNO(@wn)		= @g.QNOW
	//		@S.QNO2(@wn)	= @COMQNOW(@_LC)
			@S.QNO2(@wn)	= @H.QNOW(@_LC)

			IF[@_LC==@e_CG || @_LC==@e_MV]
			{
				@S.TIP(@wn)		= @P.I1(@_LC)
				@S.SDMD.NA(@wn)	= @P.SDMD.NA(@_LC)
				$S.FCG(@wn)		= $P.S1(@_LC)
				$S.PARENT(@wn)	= $P.S2(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_ECG]
			{
				@S.TIP(@wn)		= @P.I1(@_LC)
				@S.SDMD.NA(@wn)	= @P.SDMD.NA(@_LC)
				$S.FCG(@wn)		= "***"
				$S.PARENT(@wn)	= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_TR]
			{
				$S.FTR(@wn)		= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_TXL]
			{
				$S.TXF(@wn)		= $P.S1(@_LC)
				$S.TXS(@wn)		= $L(@P.I1(@_LC))
			}
			IFEND[]
			IF[@_LC==@e_TXG]
			{
				$S.TXF(@wn)		= $P.S1(@_LC)
				$S.TXS(@wn)		= $G(@P.I1(@_LC))
			}
			IFEND[]
			IF[@_LC==@e_EM_VO]
			{
				$S.EMVO(@wn)	= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_EM_VAR]
			{
				$S.EMV(@wn)		= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_EM_TLP]
			{
				$S.EMP(@wn)		= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_EM_TLPA]
			{
				$S.EMPA(@wn)	= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_EM_TLS]
			{
				$S.EMS(@wn)		= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_EM_TLSA]
			{
				$S.EMSA(@wn)	= $P.S1(@_LC)
			}
			IFEND[]
			IF[@_LC==@e_PXY]
			{
				LOOP[SET=11]
				{
					@S.L1(@wn,@_LC)	= @P.L1(@_LC)
					@S.L2(@wn,@_LC)	= @P.L2(@_LC)
					@S.L3(@wn,@_LC)	= @P.L3(@_LC)
					@P.L1(@_LC) = 0
					@P.L2(@_LC) = 0
					@P.L3(@_LC) = 0
				}
				LOOPEND[]

				@S.L4(@wn)		= @P.L4

				@P.L4			= 0
			}
			IFEND[]
			IF[@_LC==@e_PXYZ]
			{
				LOOP[SET=11]
				{
					@S.L1(@wn,@_LC)	= @P.L1(@_LC)
					@S.L2(@wn,@_LC)	= @P.L2(@_LC)
					@S.L3(@wn,@_LC)	= @P.L3(@_LC)
					@P.L1(@_LC) = 0
					@P.L2(@_LC) = 0
					@P.L3(@_LC) = 0
				}
				LOOPEND[]

				@S.L4(@wn)		= @P.L4

				@P.L4			= 0
			}
			IFEND[]


			@S.I1(@wn)		= @P.I1(@_LC)
			@S.I2(@wn)		= @P.I2(@_LC)
			@S.I3(@wn)		= @P.I3(@_LC)
			@S.I4(@wn)		= @P.I4(@_LC)
			@S.F1(@wn)		= @P.F1(@_LC)
			@S.F2(@wn)		= @P.F2(@_LC)
			@S.T(@wn)		= @P.T(@_LC)
			@S.AC(@wn)		= @P.AC(@_LC)
			@S.N(@wn)		= @P.N(@_LC)
			@S.TNOW(@wn)	= @TIME
			$S.NAME(@wn)	= $NAME
			$S.SPID(@wn)	= $SPID

			@S.FLAG(@wn)	= 1	//スタック有りの状態に.

		}
		IFEND[]
	}
	LOOPEND[]


	#=es.SP.SETADD.SET.LEnd

	LOOP[SET=(4)]
	{
		GOSUB[#=es.SP.P.INIT pint=0]
	}
	LOOPEND[]

	GOSUB[#=es.SP.QUE.INIT.ONE pint=0]
	@S.FLAG(0)		= 0
	@S.FLAG.END(0)	= 1

	GOSUB[#=es.SP.HCOM.INIT]

	return[]
}

#=es.SP.GO.SET
{
	STR[$SPID=$_PSTR(1)]

	//セットされているキューに開始フラグを立てる
	IF[$SPID==""] //カメラを除く全キューに対して
	{
		LOOP[SET=@QUE.MAX]
		{
			IF[@S.FLAG(@_LC)==1 && $S.SPID(@_LC)!="LNO_CM" && $S.SPID(@_LC)!="LNO_CMF"]
			{
			//	@S.FLAG(@_LC)=2
				@S.FLAG(@_LC)=3
			}
			IFEND[]
		}
		LOOPEND[]
	}
	ELSE[] //特定レイヤに対してのキューだけ
	{
		LOOP[SET=@QUE.MAX]
		{
			IF[@S.FLAG(@_LC)==1 && $S.SPID(@_LC)==$SPID]
			{
			//	@S.FLAG(@_LC)=2
				@S.FLAG(@_LC)=3
			}
			IFEND[]
		}
		LOOPEND[]
	}
	IFEND[]

	return[]
}


#=es.CM.GO.SET
{
	\SP.GO("LNO_CM")
	return[]
}


#=es.CM.SD.SET
{
	\WA(1)
	@es.EF.SAIDO = @_PINT(1)
	return[]
}


#=es.CM.MD.SET
{
	\WA(1)
	@es.EF.MEIDO = @_PINT(1)
	return[]
}


//----------------------------------------------------------------------------
//■演出終了するまでウェイト
//----------------------------------------------------------------------------
#=es.SP.WA.SET
{
	STR[$SPID=$_PSTR(1)]
	INT[@Time=@_PINT(2)]
	INT[@Erase=@_PINT(3)]

//	INT[@WaitCount]
	INT[@f]

//	IF[@es.SP.AUTOSKIP] GO[#=es.SP.WA.SET.LEnd] IFEND[]
	IF[@es.LOADTHRU] GO[#=es.SP.WA.SET.LEnd] IFEND[]

	INT[@mTime]
	INT[@mTAdd]
	INT[@mTOLD=@_OS_TIME(1)]

//	IF[@es.LOADTHRU==0 && @es.MG.AUTOSKIP==0]
	{
		@es.SP.WA.MODE = 1
		IF[@Erase==0] @es.SP.WA.MODE = 2 IFEND[]

//		@WaitCount=0

		IF[$SPID==""] //全演出待機
		{
//\_dmes("全レイヤWAIT待ちします。")

			LOOP[]
			{
//					IF[@WaitCount==0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)]
//					ELSE[]
						WAIT[FRAME=@L.WAIT]
//					IFEND[]
//					@WaitCount+=1

					@mTAdd = @_OS_TIME(1) - @mTOLD
					@mTOLD = @_OS_TIME(1)

IF[@es.NGSKIP==0]
				IF[@es.SP.AUTO==0 || (@es.SP.AUTO==1 && @es.SP.AUTONO==0)]
				{
			//		IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP || @es.GSD(112,01)==1)] @mTAdd *= @es.GSD(120,05) IFEND[]
					IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)] @mTAdd *= @es.GSD(120,05) IFEND[]
					IF[@es.GSD(112,01)==1] @mTAdd = 999999999 IFEND[]
					IF[@es.TEXT.TIPCLICK==1] @mTAdd = 999999999 IFEND[]
				}
				IFEND[]
IFEND[]

					@mTime += @mTAdd
/*
					IF[@_KEY_E>0]
					{
						LOOP[SET=@QUE.MAX]
						{
							IF[@S.FLAG.END(@_LC)!=1] \_dmes($(@_LC)+":"+$S.SPID(@_LC)) IFEND[]
						}
						LOOPEND[]
						LOOPBREAK[]
					}
					IFEND[]
*/
					@f=0
					LOOP[SET=@QUE.MAX]
					{

						IF[@S.FLAG.END(@_LC)!=1] @f=1 IFEND[]
				//		IF[@S.FLAG(@_LC)==4] @f=1 IFEND[]
					}
					LOOPEND[]
					IF[@f==0] LOOPBREAK[] IFEND[]

					IF[@Time!=-1 && @mTime>=@Time] LOOPBREAK[] IFEND[]

					IF[@es.ESCMODE || @es.HELPMODE] WAIT[FRAME=@L.WAIT] LOOPCONTINUE[] IFEND[]

			}
			LOOPEND[]
		}
		ELSE[]
		{
		//	INT[@LNO]
			//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
		//	GOSUB[#=es.LNO.GET pstr=$SPID];@LNO=@_RINT(1)

//\_dmes("SPID="+$SPID+" 、レイヤ番号="+$(@LNO)+"でWAIT待ちします。")

			LOOP[]
			{
//					IF[@WaitCount==0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)]
//					ELSE[]
						WAIT[FRAME=@L.WAIT]
//					IFEND[]
//					@WaitCount+=1

					@mTAdd = @_OS_TIME(1) - @mTOLD
					@mTOLD = @_OS_TIME(1)

IF[@es.NGSKIP==0]
				IF[@es.SP.AUTO==0 || (@es.SP.AUTO==1 && @es.SP.AUTONO==0)]
				{
			//		IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP || @es.GSD(112,01)==1)] @mTAdd *= @es.GSD(120,05) IFEND[]
					IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)] @mTAdd *= @es.GSD(120,05) IFEND[]
					IF[@es.GSD(112,01)==1] @mTAdd = 999999999 IFEND[]
					IF[@es.TEXT.TIPCLICK==1] @mTAdd = 999999999 IFEND[]
				}
				IFEND[]
IFEND[]

					@mTime += @mTAdd

					@f=0
					LOOP[SET=@QUE.MAX]
					{
						IF[@S.FLAG(@_LC)>=3 && $S.SPID(@_LC)==$SPID] @f=1 IFEND[]
//						IF[@S.FLAG.END(@_LC)==4 && @S.LNO(@_LC)==@LNO] @f=1 IFEND[]
/*						IF[@S.LNO(@_LC)==@LNO]
						{
							@f=1
\_dmes("WAIT:"+$(@S.FLAG(@_LC)))
						}
						IFEND[]
*/
					}
					LOOPEND[]
					IF[@f==0] LOOPBREAK[] IFEND[]

					IF[@Time!=-1 && @mTime>=@Time] LOOPBREAK[] IFEND[]

					IF[@es.ESCMODE || @es.HELPMODE] WAIT[FRAME=@L.WAIT] LOOPCONTINUE[] IFEND[]
			}
			LOOPEND[]
		}
		IFEND[]

//\_dmes("WAIT待ち終了しました。")

	}
//	IFEND[]


	#=es.SP.WA.SET.LEnd

	//最後の１フレームがカクつかないように...
//	IF[@es.TX.CSKIP==0 && @es.TX.SKIP==0] WAIT[FRAME=@L.WAIT] IFEND[]
//	WAIT[FRAME=@L.WAIT]

	@es.SP.WA.MODE = 0

	return[]
}




//----------------------------------------------------------------------------
//■通常ウェイト
//----------------------------------------------------------------------------
#=es.WA.SET
{
	INT[@Time=@_PINT(1)]
	INT[@Erase=@_PINT(2)]
	INT[@ClickSkipFlag=@_PINT(3)]
	INT[@CTRLSkipFlag=@_PINT(4)]

	IF[@ClickSkipFlag==-2] @ClickSkipFlag=@es.LSD(033,03) IFEND[]
	IF[@CTRLSkipFlag ==-2] @CTRLSkipFlag =@es.LSD(033,04) IFEND[]

//	INT[@WaitCount]
//\_dmes("@ClickSkipFlag="+$(@ClickSkipFlag))

	IF[@Time>=0]
	{
		IF[@es.SP.AUTOSKIP                   ] WAIT[FRAME=1] GO[#=es.WA.SET.LEnd] IFEND[]
		IF[@es.SP.AUTOSKIP && @es.SP.AUTONO>0]               GO[#=es.WA.SET.LEnd] IFEND[]
		IF[@es.LOADTHRU]    WAIT[FRAME=1] GO[#=es.WA.SET.LEnd] IFEND[]
	}
	IFEND[]

	INT[@mTime]
	INT[@mTAdd]
	INT[@mTOLD=@_OS_TIME(1)]

	{
		@es.WA.MODE = 1
		IF[@Erase==0] @es.WA.MODE = 2 IFEND[]


//		@WaitCount=0

			LOOP[]
			{
//					IF[@WaitCount==0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)]
//					ELSE[]
						WAIT[FRAME=@L.WAIT]
//					IFEND[]
//					@WaitCount+=1

					@mTAdd = @_OS_TIME(1) - @mTOLD
					@mTOLD = @_OS_TIME(1)

IF[@es.NGSKIP==0]
				IF[@es.SP.AUTO==0 || (@es.SP.AUTO==1 && @es.SP.AUTONO==0)]
				{
					IF[@CTRLSkipFlag==0]
					{
				//		IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP || @es.GSD(112,01)==1)] @mTAdd *= @es.GSD(120,05) IFEND[]
						IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)] @mTAdd *= @es.GSD(120,05) IFEND[]
					}
					ELSE[@CTRLSkipFlag==2]
					{
				//		IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP || @es.GSD(112,01)==1)] @mTAdd = 999999999 IFEND[]
						IF[@SP.SKIPMODE>0 && (@es.TX.CSKIP>0 || @es.TX.SKIP)] @mTAdd = 999999999 IFEND[]
					}
					IFEND[]

					IF[@es.GSD(112,01)==1] @mTAdd = 999999999 IFEND[]
				}
				IFEND[]
IFEND[]

					@mTime += @mTAdd

				IF[@es.SP.AUTO==0 || (@es.SP.AUTO==1 && @es.SP.AUTONO==0)]
				{
					IF[@ClickSkipFlag==0]
						IF[@es.TEXT.TIPCLICK==1] LOOPBREAK[] IFEND[]
					IFEND[]
				}
				IFEND[]

					IF[@Time!=-1 && @mTime>=@Time] LOOPBREAK[] IFEND[]

					IF[@es.ESCMODE || @es.HELPMODE] WAIT[FRAME=@L.WAIT] LOOPCONTINUE[] IFEND[]

			}
			LOOPEND[]

	}

	//最後の１フレームがカクつかないように...
//	IF[@es.SP.AUTOSKIP==0 && @es.TX.CSKIP==0 && @es.TX.SKIP==0] WAIT[FRAME=@L.WAIT] IFEND[]
//	WAIT[FRAME=@L.WAIT]

	#=es.WA.SET.LEnd

//	@es.WA.COUNT-=1

	@es.WA.MODE = 0

	return[]

}


//-------------------------------------------------------------------------
//■視野角設定
//-------------------------------------------------------------------------
#=es.CMVIEW.SET
{
	INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@LNO = @_LC-1

	//	CGINFO[ID=$LIDBUF+$(1+@LNO*100) EXIST=1 LET=@r]
	//	IF[@r==0 && @LNO!=@LNO_CM && @LNO!=@LNO_CMF]
		IF[@LNO!=@LNO_CM && @LNO!=@LNO_CMF]
		{
			IF[$L.SPID(@LNO)!=""]
			{
				@L.MX(@LNO)=@_PINT(1)
				@L.MY(@LNO)=@_PINT(2)
				@L.MZ(@LNO)=@_PINT(3)
				@DRAW.FLAG(@LNO)=2
			}
			IFEND[]
		}
		IFEND[]
	}
	LOOPEND[]

	return[]
}



#=es.SP.ACC.GET
{
	INT[@mAcc=@_PINT(1)]
	FLT[@mPer=@_PFLT(2)]

	//範囲制限
	IF[@mPer<  0] @mPer=  0 IFEND[]
	IF[@mPer>1.0] @mPer=1.0 IFEND[]

	FLT[@ret = @mPer]
	FLT[@temp]

	//加速 高→低
	IF[@mAcc==1]
	{
		MATH[SIN=1 SET=(@mPer*90)*0.017453 LET=@temp];@ret=@temp
	}
	IFEND[]

	//加速 低→高
	IF[@mAcc==2]
	{
		MATH[COS=1 SET=(@mPer*90)*0.017453 LET=@temp];@ret=1.0-@temp
	}
	IFEND[]

	//加速 低→高→低 (0.0〜0.5〜1.0の場合分けで対応)
	IF[@mAcc==3]
	{
		IF[@mPer<0.5] MATH[COS=1 SET=((@mPer    )*2*90)*0.017453 LET=@temp];@ret=0.5-(@temp/2.0)
		ELSE[]		  MATH[SIN=1 SET=((@mPer-0.5)*2*90)*0.017453 LET=@temp];@ret=0.5+(@temp/2.0)
		IFEND[]
	}
	IFEND[]

	//加速 高→低→高 (0.0〜0.5〜1.0の場合分けで対応)
	IF[@mAcc==4]
	{
		IF[@mPer<0.5] MATH[SIN=1 SET=((@mPer    )*2*90)*0.017453 LET=@temp];@ret=0.0+(@temp/2.0)
		ELSE[]		  MATH[COS=1 SET=((@mPer-0.5)*2*90)*0.017453 LET=@temp];@ret=1.0-(@temp/2.0)
		IFEND[]
	}
	IFEND[]

	return[rflt=@ret]
}

//-------------------------------------------------------------------------
//■通常計算
//-------------------------------------------------------------------------
#=es.SP.VAL.GET
{
	FLT[@mVal1=@_PFLT(1)]
	FLT[@mVal2=@_PFLT(2)]
	FLT[@mPer =@_PFLT(3)]
	return[rflt=(@mVal1 + (@mVal2 - @mVal1) * @mPer)]
}

//-------------------------------------------------------------------------
//■明度計算
//-------------------------------------------------------------------------
#=es.SP.MEIDO.VAL.GET
{
	INT[@src=@_PINT(1)]
	INT[@dst=@_PINT(2)]
	INT[@per=@_PFLT(3)*256.0]
//	FLT[@per=@_PFLT(3)*256.0] ///x不具合発生する

	INT[@srcR = (@src / 65536) & 0xFF]
	INT[@srcG = (@src /   256) & 0xFF]
	INT[@srcB = (@src        ) & 0xFF]
	INT[@dstR = (@dst / 65536) & 0xFF]
	INT[@dstG = (@dst /   256) & 0xFF]
	INT[@dstB = (@dst        ) & 0xFF]
	INT[@RGB  = (@srcR+(@dstR-@srcR)*@per/256)*65536 + (@srcG+(@dstG-@srcG)*@per/256)*256 + (@srcB+(@dstB-@srcB)*@per/256)]

	return[rint=@RGB]
}

//-------------------------------------------------------------------------
//■クエイク計算
//-------------------------------------------------------------------------
#=es.SP.QUAKE.VAL.GET
{
	INT[@mQ =@_PINT(1)]
	FLT[@per=@_PFLT(2)]
	INT[@acc=@_PINT(3)] //0…一定速/1…だんだん収束/2…だんだん増幅/3…小→大→小

	  IF[@per>=0.99999] @per=1.0 //複数回ループ時に間隔を設けたときに、振動し続けないよう
	ELSE[@acc==0] @per=0
	ELSE[@acc==2] @per=1.0-@per
	ELSE[@acc==3] IF[@per<0.5] @per=1.0-@per*2 ELSE[] @per=    (@per-0.5)*2 IFEND[]
	ELSE[@acc==4] IF[@per<0.5] @per=    @per*2 ELSE[] @per=1.0-(@per-0.5)*2 IFEND[]
	IFEND[]

	FLT[@mI]INT[@mJ]
	@mI = @mQ * (1.0-@per) + 1
	MATH[RND=1 LET=@mJ SET=0 SET2=@mI-1]
	FLT[@r = @mJ - @mI / 2]

	return[rflt=@r]
}

//-------------------------------------------------------------------------
//■周期計算
//-------------------------------------------------------------------------
#=es.SP.CYCLE.VAL.GET
{
	FLT[@per=@_PFLT(1)]
	INT[@ang=@_PINT(2)] //初期角度
	FLT[@fr]
	MATH[SIN=1 LET=@fr SET=(@ang/360.0+@per)*2*@_PAI]

	return[rflt=@fr]
}


//-------------------------------------------------------------------------
//■
//-------------------------------------------------------------------------
#=es.SP.MINMAX.CHECK
{
	INT[@No=@_PINT(1)]
	IF[@No<0 || @No>@LMAX]
	{
		\_mes("スプライト番号 "+$(@No)+" 番は使用できません。");END[]
	}
	IFEND[]

	return[]
}



//----------------------------------------------------------------
//■レイヤ計算
//----------------------------------------------------------------
#=es.SP.XYZCALC
{
	INT[@lno = @_PINT(1)]
	INT[@lbg = @_PINT(2)]
	INT[@lcm = @_PINT(3)]
	INT[@lpr = @L.PARENT(@lno)]
	INT[@WSX = @_PINT(4)]
	INT[@WSY = @_PINT(5)]

	@M3D.I(01) = @lno
	@M3D.I(02) = @lbg
	@M3D.I(03) = @lcm
	@M3D.I(04) = @lpr
	@M3D.I(05) = @WSX
	@M3D.I(06) = @WSY
	@M3D.I(07) = @L.TIP(@lno)

	@M3D.F(03) = @DBG.LX(@lcm)+@USR.LX(@lcm)+@L.X(@lcm)+@L.AX(@lcm)+@L.QX(@lcm)+@L.CLX(@lcm)
	@M3D.F(04) = @DBG.LY(@lcm)+@USR.LY(@lcm)+@L.Y(@lcm)+@L.AY(@lcm)+@L.QY(@lcm)+@L.CLY(@lcm)
	@M3D.F(05) = @DBG.LZ(@lcm)+@USR.LZ(@lcm)+@L.Z(@lcm)+@L.AZ(@lcm)+@L.QZ(@lcm)+@L.CLZ(@lcm)
	@M3D.F(06) = @DBG.LX(@lbg)+@USR.LX(@lbg)+@L.X(@lbg)+@L.AX(@lbg)+@L.QX(@lbg)+@L.CLX(@lbg)
	@M3D.F(07) = @DBG.LY(@lbg)+@USR.LY(@lbg)+@L.Y(@lbg)+@L.AY(@lbg)+@L.QY(@lbg)+@L.CLY(@lbg)
	@M3D.F(08) = @DBG.LZ(@lbg)+@USR.LZ(@lbg)+@L.Z(@lbg)+@L.AZ(@lbg)+@L.QZ(@lbg)+@L.CLZ(@lbg)
	@M3D.F(09) = @L.CX(@lbg)
	@M3D.F(10) = @L.CY(@lbg)
	@M3D.F(11) = @L.CLX(@lbg)
	@M3D.F(12) = @L.CLY(@lbg)
	@M3D.F(13) = @DBG.LX(@lno)+@USR.LX(@lno)+@L.X(@lno)+@L.AX(@lno)+@L.QX(@lno)+@L.CLX(@lno)
	@M3D.F(14) = @DBG.LY(@lno)+@USR.LY(@lno)+@L.Y(@lno)+@L.AY(@lno)+@L.QY(@lno)+@L.CLY(@lno)
	@M3D.F(15) = @DBG.LZ(@lno)+@USR.LZ(@lno)+@L.Z(@lno)+@L.AZ(@lno)+@L.QZ(@lno)+@L.CLZ(@lno)
	@M3D.F(16) = @L.BX(@lno)+@L.ABX(@lno)+@L.CLBX(@lno)
	@M3D.F(17) = @L.BY(@lno)+@L.ABY(@lno)+@L.CLBY(@lno)
	@M3D.F(18) = @L.CX(@lno)
	@M3D.F(19) = @L.CY(@lno)
	@M3D.F(20) = @L.MX(@lno)
	@M3D.F(21) = @L.MY(@lno)
	@M3D.F(22) = @DBG.LX(@lpr)+@USR.LX(@lpr)+@L.X(@lpr)+@L.AX(@lpr)+@L.QX(@lpr)+@L.CLX(@lpr)
	@M3D.F(23) = @DBG.LY(@lpr)+@USR.LY(@lpr)+@L.Y(@lpr)+@L.AY(@lpr)+@L.QY(@lpr)+@L.CLY(@lpr)
	@M3D.F(24) = @DBG.LZ(@lpr)+@USR.LZ(@lpr)+@L.Z(@lpr)+@L.AZ(@lpr)+@L.QZ(@lpr)+@L.CLZ(@lpr)
	@M3D.F(25) = @L.CX(@lpr)
	@M3D.F(26) = @L.CY(@lpr)
	@M3D.F(27) = @DEFZ

	MATH3D[INT=@M3D.I() FLT=@M3D.F()] //ERIS専用命令(高速計算用命令) ※暫定命令につきいずれ無くなる予定.

	return[rflt=@M3D.F(31) rflt2=@M3D.F(32) rflt3=@M3D.F(33) rflt4=@M3D.F(34) rflt5=@M3D.F(05) rflt6=@M3D.F(13) rflt7=@M3D.F(15) rflt8=@M3D.F(22) rflt9=@M3D.F(24)]
}



//----------------------------------------------------------------
//■レイヤ表示範囲チェック
//----------------------------------------------------------------
#=es.SP.DRAWCHECK
{
	INT[@LNO = @_PINT(1)]

	INT[@WSX = @es.GSX]
	INT[@WSY = @es.GSY]

	FLT[@RZ = @L.RZ(@LNO) + @L.CLRZ(@LNO)]

	INT[@ROLL_CHK = @RZ]
	@ROLL_CHK%=360
	IF[@_DXMODE==0 && @ROLL_CHK]
	{
		@WSX = @WSX.BIG
		@WSY = @WSY.BIG
	}
	IFEND[]

	INT[@lbg = @LNO_BG]
	INT[@lcm = @LNO_CM]

	IF[@LNO==@LNO_BGF]
	{
		@lbg = @LNO_BGF
		@lcm = @LNO_CMF
	}
	IFEND[]

	//----------------------------------------------------------------
	// 座標計算
	//----------------------------------------------------------------
		GOSUB[#=es.SP.XYZCALC pint=@LNO pint2=@lbg pint3=@lcm pint4=@WSX pint5=@WSY]
		FLT[@lx = @_RFLT(1)]
		FLT[@ly = @_RFLT(2)]
		FLT[@zx = @_RFLT(3)]
		FLT[@zy = @_RFLT(4)]

	//----------------------------------------------------------------
	// 座標チェック
	//----------------------------------------------------------------
		GOSUB[#=es.CGACT_SIZECHECK PFLT=@L.SX(@LNO) PFLT2=@L.SY(@LNO) PFLT3=@lx PFLT4=@ly PFLT5=@zx PFLT6=@zy]

	return[rint=@_RINT(1) rint2=@_RINT(2) rint3=@_RINT(3) rint4=@_RINT(4)]
}



//----------------------------------------------------------------
//■POSTスプライト描画
//----------------------------------------------------------------
#=es.SP.DRAW.POST
{

/*
	INT[@POSTF_HORIZONTAL	=(@L.HOR(@LNO_CM)!=0)]
	INT[@POSTF_VERTICAL		=(@L.VER(@LNO_CM)!=0)]
	INT[@POSTF_REVERSE		=(@L.REV(@LNO_CM)!=0)]
	INT[@POSTF_MONO			=(@L.MONO(@LNO_CM)!=0)]
	INT[@POSTF_BLUR			=(@L.BLUR(@LNO_CM)!=0)]
	INT[@POSTF_MOSAIC		=(@L.MOSA(@LNO_CM)!=0)]
	INT[@POSTF_DIFFUSION	=(@L.DIFF(@LNO_CM)!=0)]
	INT[@POSTF_ROTATION		=(@L.ROT(@LNO_CM)!=0)]
	INT[@POSTF_RASTER		=(@L.RAS(@LNO_CM)!=0)]
	INT[@POSTF_WHIRLPOOL	=(@L.WPL(@LNO_CM)!=0)]
	INT[@POSTF_AKARUSA		=(@L.AKA(@LNO_CM)!=128)]
//	INT[@POSTF_SAIDO		=(@L.SD(@LNO_CM)!=0)]
//	INT[@POSTF_MEIDO		=(@L.MD(@LNO_CM)!=0)]

	//処理数取得
	INT[@POSTF_NUM]
	INT[@POSTF_CNT]
	@POSTF_NUM+=@POSTF_HORIZONTAL	//@L.HOR
	@POSTF_NUM+=@POSTF_VERTICAL		//@L.VER
	@POSTF_NUM+=@POSTF_REVERSE		//@L.REV
	@POSTF_NUM+=@POSTF_MONO			//@L.MONO
	@POSTF_NUM+=@POSTF_BLUR			//@L.BLUR
	@POSTF_NUM+=@POSTF_MOSAIC		//@L.MOSA
	@POSTF_NUM+=@POSTF_DIFFUSION	//@L.DIFF
	@POSTF_NUM+=@POSTF_ROTATION		//@L.ROT
	@POSTF_NUM+=@POSTF_RASTER		//@L.RAS
	@POSTF_NUM+=@POSTF_WHIRLPOOL	//@L.WPL
	@POSTF_NUM+=@POSTF_AKARUSA		//@L.AKA
//	@POSTF_NUM+=@POSTF_SAIDO		//@L.SD
//	@POSTF_NUM+=@POSTF_MEIDO		//@L.MD


	IF[@POSTF_NUM==0] //何も処理しないなら
	{

			//レイヤセットのほうを見えるように
			CG[ID="SP/" E=1]

			CG[ID="SPLDST"  E=0]
			CG[ID="SPLDST2" E=0]

	}
	ELSE[] //何か処理するなら
	{

			//レイヤセットのほうは見えなくする.
			CG[ID="SP/" E=0]

			CG[ID="SPLDST"  E=1]
			CG[ID="SPLDST2" E=1 A=@L.REV(@LNO_CM)]


			//まずはコピーする(複数処理できるように)
		//	CGACT[ID="SP/" ID2="SPLDST" COPY2=1]


			//回転
			IF[@POSTF_ROTATION]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" ROTATION=1 SET=@L.ROT(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" ROTATION=1 SET=@L.ROT(@LNO_CM)]
				IFEND[]
			}
			IFEND[]

			//ラスター
			IF[@POSTF_RASTER]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" RASTER=1 SET=@L.RAS(@LNO_CM) SET2=@es.RASTER.CNT]
				ELSE[]
					CGACT[          ID="SPLDST" RASTER=1 SET=@L.RAS(@LNO_CM) SET2=@es.RASTER.CNT]
				IFEND[]
			}
			IFEND[]

			//渦巻き
			IF[@POSTF_WHIRLPOOL]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" WHIRLPOOL=1 SET=@L.WPL(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" WHIRLPOOL=1 SET=@L.WPL(@LNO_CM)]
				IFEND[]
			}
			IFEND[]

			//モザイク
			IF[@POSTF_MOSAIC]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" MOSAIC=1 SET=@L.MOSA(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" MOSAIC=1 SET=@L.MOSA(@LNO_CM)]
				IFEND[]
			}
			IFEND[]

			//拡散
			IF[@POSTF_DIFFUSION]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" DIFFUSION=1 SET=@L.DIFF(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" DIFFUSION=1 SET=@L.DIFF(@LNO_CM)]
				IFEND[]
			}
			IFEND[]

			//水平反転
			IF[@POSTF_HORIZONTAL]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" HORIZONTAL=1]
				ELSE[]
					CGACT[          ID="SPLDST" HORIZONTAL=1]
				IFEND[]
			}
			IFEND[]

			//垂直反転
			IF[@POSTF_VERTICAL]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" VERTICAL=1]
				ELSE[]
					CGACT[          ID="SPLDST" VERTICAL=1]
				IFEND[]
			}
			IFEND[]

			//ネガポジ反転
			IF[@POSTF_REVERSE]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" COPY2=1]
				IFEND[]

				CG[ID="SPLDST2" A=@L.REV(@LNO_CM)]
*/

/*
				//@L.AKA(@LNO_CM)
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" COPY2=1]
					CG[ID="es.WHITE" Z=1 SX=800 SY=600 FILE=""]
					CGACT[ID="es.WHITE" RECTPAINT=1 SET=0xffffff]
					CGACT[ID="SPLDST" COPY2=1]
					CGEND[ID="es.WHITE"]

//					CGACT[ID="SP/" ID2="SPLDST" REVERSE=1]
				ELSE[]
					CGACT[          ID="SPLDST" REVERSE=1]
				IFEND[]
*/

/*
			}
			IFEND[]

			//二値化
			IF[@POSTF_MONO]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" MONO=1 SET=128]
				ELSE[]
					CGACT[          ID="SPLDST" MONO=1 SET=128]
				IFEND[]
			}
			IFEND[]

			//ブラー
			IF[@POSTF_BLUR]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" BLUR=1 SET=@L.BLUR(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" BLUR=1 SET=@L.BLUR(@LNO_CM)]
				IFEND[]
			}
			IFEND[]

			//明るさ
			IF[@POSTF_AKARUSA]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" AKARUSA=1 SET=@L.AKA(@LNO_CM)]
				ELSE[]
					CGACT[          ID="SPLDST" AKARUSA=1 SET=@L.AKA(@LNO_CM)]
				IFEND[]
			}
			IFEND[]
*/
/*
			//彩度
			IF[@POSTF_SAIDO]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" SAIDO=1 SET=0]
				ELSE[]
					CGACT[          ID="SPLDST" SAIDO=1 SET=0]
				IFEND[]
			}
			IFEND[]

			//明度
			IF[@POSTF_MEIDO]
			{
				@POSTF_CNT+=1
				IF[@POSTF_CNT==1]
					CGACT[ID="SP/" ID2="SPLDST" MEIDO=1 SET=0x404080]
				ELSE[]
					CGACT[          ID="SPLDST" MEIDO=1 SET=0x404080]
				IFEND[]
			}
			IFEND[]
*/
/*
	}
	IFEND[]
*/
	return[]
}


//----------------------------------------------------------------
//■スプライト描画
//----------------------------------------------------------------
#=es.SP.DRAW
{
	INT[@LNO   =@_PINT(1)]
	INT[@TIMING=@_PINT(2)] //0=描画中, 1=描画終了時
	INT[@CAM   =@_PINT(3)] //0=カメラ停止中, 1=カメラ動作中

	IF[@LNO==@LNO_CM || @LNO==@LNO_CMF] GO[#=es.SP.DRAW.LEnd] IFEND[]

IF[@L.FTYPE(@LNO)==6]
	GOSUB[#=es.L.YMV.MAIN pint=@LNO]
IFEND[]

	FLT[@HOSEI_X]
	FLT[@HOSEI_Y]

	INT[@WSX = @es.GSX]
	INT[@WSY = @es.GSY]

	FLT[@RZ = @L.RZ(@LNO) + @L.CLRZ(@LNO)]

	INT[@ROLL_CHK = @RZ]
	@ROLL_CHK%=360
	IF[@_DXMODE==0 && @ROLL_CHK]
	{
		@WSX = @WSX.BIG
		@WSY = @WSY.BIG
	}
	IFEND[]

	INT[@lbg = @LNO_BG]
	INT[@lcm = @LNO_CM]

	IF[@LNO==@LNO_BGF]
	{
		@lbg = @LNO_BGF
		@lcm = @LNO_CMF
	}
	IFEND[]


	//================================================================================
	// 座標計算
	//================================================================================
		GOSUB[#=es.SP.XYZCALC pint=@LNO pint2=@lbg pint3=@lcm pint4=@WSX pint5=@WSY]
		FLT[@lx    = @_RFLT(1)]
		FLT[@ly    = @_RFLT(2)]
		FLT[@zx    = @_RFLT(3)]
		FLT[@zy    = @_RFLT(4)]
		FLT[@CMZ   = @_RFLT(5)]
		FLT[@LN.XX = @_RFLT(6)]
		FLT[@LN.ZZ = @_RFLT(7)]
		FLT[@LP.XX = @_RFLT(8)]
		FLT[@LP.ZZ = @_RFLT(9)]

		//E-moteレイヤなら
		INT[@texchk]
		CGINFO[ID=$LIDBUF+$(1+@LNO*100) TEX=1 LET=@texchk]
		IF[@texchk==2]
		{
		//	GOSUB[#=es.SP.XYZ.INFO.GET pint=@LNO]
		//	CG[ID=$LIDBUF+$(1+@LNO*100) FEX=@_RFLT(1)*100.0 FEY=@_RFLT(2)*100.0]
			FLT[@ex = @DBG.LX(@LNO)+@USR.LX(@LNO)+@L.X(@LNO)+@L.AX(@LNO)+@L.QX(@LNO)+@L.CLX(@LNO)]
			FLT[@ey = @DBG.LY(@LNO)+@USR.LY(@LNO)+@L.Y(@LNO)+@L.AY(@LNO)+@L.QY(@LNO)+@L.CLY(@LNO)]
			CG[ID=$LIDBUF +$(1+@LNO*100) FEX=@ex*100.0 FEY=@ey*100.0 FSD=@L.SD(@LNO) FMD=@L.MD(@LNO)]
			CG[ID=$LIDBUF2+$(1+@LNO*100) FEX=@ex*100.0 FEY=@ey*100.0 FSD=@L.SD(@LNO) FMD=@L.MD(@LNO)]
//EMOTE[ID=$LIDBUF +$(1+@LNO*100) SKIP=1]
//EMOTE[ID=$LIDBUF2+$(1+@LNO*100) SKIP=1]
		}
		IFEND[]


		INT[@lns   = @L.PARENT(@LNO)]

/*
//警告
INT[@lz = @L.Z(@LNO) + @L.QZ(@LNO) + @L.CLZ(@LNO)]
INT[@cm = @L.Z(@lcm) + @L.QZ(@lcm) + @L.CLZ(@lcm)]

IF[@L.FTYPE(@LNO)==5]
{
	//
	IF[@es.ERRMSG==0]
	{
		IF[@lz - @cm > 155.1 && @lz - @cm < 169.9]
		{
			IF[$L.SPID(@LNO)!="XXX" && $L.SPID(@LNO)!="xxx"]
			{
				@es.ERRMSG = 1
				\_dmes("[お知らせ] 立ち絵スプライト「"+$L.SPID(@LNO)+"」がカメラから 155 以上 170 未満の距離に入りました。"+\_R+"なるべくこの領域には入らないで下さい。")
			}
			IFEND[]
		}
		IFEND[]
	}
	IFEND[]
	//近すぎ警告
	IF[@es.ERRMSG2==0]
	{
		IF[@lz - @cm < 94.9]
		{
			IF[$L.SPID(@LNO)!="XXX" && $L.SPID(@LNO)!="xxx"]
			{
				@es.ERRMSG2 = 1
				\_dmes("[お知らせ] 立ち絵スプライト「"+$L.SPID(@LNO)+"」がカメラから 95 未満の距離に入りました。"+\_R+"なるべくこの領域には入らないで下さい。")
			}
			IFEND[]
		}
		IFEND[]
	}
	IFEND[]
}
IFEND[]
*/


	//================================================================================
	// 描画
	//================================================================================

		//----------------------------------------------------------------
		// レイヤ属性取得(いじる可能性があるため必須)
		//----------------------------------------------------------------
			INT[@A]
			INT[@S]
			INT[@TP]

			IF[@L.PARENT(@LNO)==0] //通常レイヤの場合
			{
				@A=(@L.A(@LNO)+@L.CLA(@LNO))*@L.F1(@LNO)/256
				@S=@L.H(@LNO)+@L.CLH(@LNO)
				@TP=@L.TP(@LNO)+@L.CLTP(@LNO)

				\_range(@A, 0, 256)
				\_range(@S, 0, 256)
				\_range(@TP, 0, 256)

				@A *= (@S>=128)

				IF[@L.TRA(@LNO)==0] @A=@A*@TP/256 IFEND[]
			}
			ELSE[] //子レイヤの場合
			{
				@A=(@L.A(@lns)+@L.CLA(@lns))*@L.F1(@lns)/256
				@S=@L.H(@lns)+@L.CLH(@lns)
				@TP=@L.TP(@lns)+@L.CLTP(@lns)

				IF[@L.F2(@lns)>0] @A=256-@L.F2(@lns)*1.5 IFEND[]

				\_range(@A, 0, 256)
				\_range(@S, 0, 256)
				\_range(@TP, 0, 256)

				@A *= (@S>=128)

				IF[@L.TRA(@lns)==0] @A=@A*@TP/256 IFEND[]
			}
			IFEND[]


		//----------------------------------------------------------------
		// 画質セット
		//----------------------------------------------------------------
			//0…画質・低 (SIZE=1)
			//1…画質・中 (SIZE2=1)
			INT[@quo]
			IF[@TIMING==0] //0…描画中
			{
				  IF[@LNO==@LNO_BG ] @quo=1 //背景なら画質・中
				ELSE[@LNO==@LNO_BGF] @quo=1 //背景なら画質・中
				ELSE[]               @quo=1 //それ以外なら画質・中の上
				IFEND[]

				IF[@ROLL_CHK] @quo=0 IFEND[] //回転中なら画質・低
			}
			ELSE[]         //1=描画終了時
			{
				IF[@CAM==0] //カメラは止まっている
				{
				//	  IF[@LNO==@LNO_BG ] @quo=2 //背景なら画質・中
				//	ELSE[@LNO==@LNO_BGF] @quo=2 //背景なら画質・中
				//	ELSE[]               @quo=2 //それ以外なら画質・中の上
				//	IFEND[]
					@quo=1
				}
				ELSE[] //カメラが動いているが故の再描画なら
				{
					  IF[@LNO==@LNO_BG ] @quo=1 //背景なら画質・中
					ELSE[@LNO==@LNO_BGF] @quo=1 //背景なら画質・中
					ELSE[]               @quo=1 //それ以外なら画質・中の上
					IFEND[]
				}
				IFEND[]
			}
			IFEND[]

			IF[@T(17,06)==0] @quo=0 IFEND[]


		//----------------------------------------------------------------
		// 描画開始
		//----------------------------------------------------------------
			STR[$L1 =$LID    +$(1+@LNO*100+@L.ANC2(@LNO))]
			STR[$LB1=$LIDBUF +$(1+@LNO*100+@L.ANC2(@LNO))]
			STR[$LB2=$LIDBUF2+$(1+@LNO*100+@L.ANC2(@LNO))]
			STR[$LB3=$LIDBUF3+$(1+@LNO*100+@L.ANC2(@LNO))]
			STR[$TR1   =$LIDTR   +$(1+@LNO*100)]
			STR[$TRBUF1=$LIDTRBUF+$(1+@LNO*100)]

IF[@_DXMODE]
{
			$L1 =$LIDBUF +$(1+@LNO*100+@L.ANC2(@LNO)) //これで合ってる
			$LB1=$LIDBUF +$(1+@LNO*100+@L.ANC2(@LNO))
			$LB2=$LIDBUF2+$(1+@LNO*100+@L.ANC2(@LNO))
		//	$TR1   =$LIDTRBUF+$(1+@LNO*100)
		//	$TRBUF1=$LIDTRBUF+$(1+@LNO*100)
}
IFEND[]


IF[@_DXMODE==0]
{
		//	LOOP[SET=@L.ANNUM(@LNO)] CG[ID=$LID+$(1+@LNO*100+@_LC-1) A=0] LOOPEND[]
			LOOP[SET=100] CG[ID=$LID+$(1+@LNO*100+@_LC-1) A=0] LOOPEND[]
}
ELSE[]
{
		//	LOOP[SET=@L.ANNUM(@LNO)] CG[ID=$LIDBUF+$(1+@LNO*100+@_LC-1) A=0] LOOPEND[]
			LOOP[SET=100] CG[ID=$LIDBUF+$(1+@LNO*100+@_LC-1) A=0] LOOPEND[]
}
IFEND[]



			INT[@bl =@es.BL(@L.BL(@LNO))]
			FLT[@fx =@lx*100.0]
			FLT[@fy =@ly*100.0]
			FLT[@fbx=@zx*100.0]
			FLT[@fby=@zy*100.0]
			FLT[@frx=@L.RX(@LNO)*100.0]
			FLT[@fry=@L.RY(@LNO)*100.0]
			FLT[@frz=@RZ*100.0]
		//	FLT[@fcx=(@lx+(@L.CX(@LNO)+@L.CRX(@LNO))*@zx/100.0)*100.0]
		//	FLT[@fcy=(@ly+(@L.CY(@LNO)+@L.CRY(@LNO))*@zy/100.0)*100.0]
			FLT[@fcx=(@lx+(@L.CX(@LNO)+0)*@zx/100.0)*100.0]
			FLT[@fcy=(@ly+(@L.CY(@LNO)+0)*@zy/100.0)*100.0]
			INT[@fsd=@L.SD(@LNO)]
			INT[@fmd=@L.MD(@LNO)]
			STR[$fid]
			INT[@f]



			IF[@L.TIP(@LNO)==0 && (@LN.ZZ<@CMZ || @LN.ZZ-@CMZ>(1000))]
			{
				@A=0
				CG[ID=$L1 E=1 A=@A MODE=@es.BL(@L.BL(@LNO))]
			}
			ELSE[]
			{

				IF[@L.ST(@LNO)!=0] //遷移モードなら
				{
					IF[@_DXMODE==0]
					{
						CGACT[TRANSITION=1 SET=@L.F2(@LNO) ID=$LB1 ID2=$LB2 ID3=$LB3]

						GOSUB[#=es.CGACT_SIZE PSTR=$LB3 PSTR2=$L1 PFLT3=@lx PFLT4=@ly PFLT5=@zx PFLT6=@zy PINT7=@quo PINT8=@ROLL_CHK]
						CG[ID=$L1 E=1 A=@A MODE=@es.BL(@L.BL(@LNO))]
					}
					ELSE[]
					{
						$fid=$LB2
						@f  =@L.F2(@LNO)

$L1=$LB2
//IF[@es.SMTEST==0]
IF[0]
						CG[ID=$LB1 E=1 A=@A MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy FSD=@fsd FMD=@fmd FID=$fid F=@f]
ELSE[]
						CG[ID=$LB1 E=1 A=@A MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy                   FID=$fid F=@f]
						CG[ID=$LB2 E=1 A=1  MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy FSD=@fsd FMD=@fmd]
IFEND[]
					}
					IFEND[]
				}
				ELSE[]
				{
					IF[@_DXMODE==0]
					{
						GOSUB[#=es.CGACT_SIZE PSTR=$LB1 PSTR2=$L1 PFLT3=@lx PFLT4=@ly PFLT5=@zx PFLT6=@zy PINT7=@quo PINT8=@ROLL_CHK]
						CG[ID=$L1 E=1 A=@A MODE=@es.BL(@L.BL(@LNO))]
						CG[ID=$LB1 E=0 A=0]
					}
					ELSE[]
					{

						$fid=""
						@f  =0

						IF[@BGF.FLAG>0 && @LNO==@LNO_BGF]
						{
							@BGF.FLAG=0

							CG[ID=$LB1 E=0]
//IF[@es.SMTEST==0]
IF[0]
							CG[ID=$LB2 E=1 A=256 MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy FSD=@fsd FMD=@fmd FID=$fid F=@f]
ELSE[]
							CG[ID=$LB2 E=1 A=256 MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy                   FID=$fid F=@f]
IFEND[]
							//現在のLB1を画面上に表示したものをSSする
					//		CG[ID=$LB1 DXDRAW=1]
					//		CG[ID=$LB1 TSX=1024 TSY=1024 TEX=1 FQU=1] //512x512ではトランジション乱れる
///x↓暫定的に無効.
			//				CGACT[ID=$LB1 ID2=$LB2 TEXSSCOPY=1]
			//				CG[ID=$LB2 E=1 A=256 TSX=1024 TSY=1024 TEX=1 FQU=1] //512x512ではトランジション乱れる
						}
///x↓
/*					//	IFEND[]
					//	IF[@LNO==@LNO_BGF]
						ELSE[@LNO==@LNO_BGF]
						{
							CG[ID=$LB1 E=0]
//IF[@es.SMTEST==0]
IF[0]
							CG[ID=$LB2 E=1 A=@A MODE=@bl FX=0 FY=0 FBX=10000 FBY=10000 FRX=0 FRY=0 FRZ=0 FCX=5000 FCY=5000 FSD=@L.SD(@LNO) FMD=@L.MD(@LNO) FID="" F=0]
ELSE[]
							CG[ID=$LB2 E=1 A=@A MODE=@bl FX=0 FY=0 FBX=10000 FBY=10000 FRX=0 FRY=0 FRZ=0 FCX=5000 FCY=5000                                 FID="" F=0]
IFEND[]
						}
*/
///x↑ここまで.
						ELSE[]
						{
//IF[@es.SMTEST==0]
IF[0]
							CG[ID=$LB1 E=1 A=@A MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy FSD=@fsd FMD=@fmd FID=$fid F=@f]
ELSE[]
							CG[ID=$LB1 E=1 A=@A MODE=@bl FX=@fx FY=@fy FBX=@fbx FBY=@fby FRX=@frx FRY=@fry FRZ=@frz FCX=@fcx FCY=@fcy                   FID=$fid F=@f]
IFEND[]
						}
						IFEND[]

					}
					IFEND[]
				}
				IFEND[]


IF[@_DXMODE==0]
{
				//Z回転
				IF[@RZ!=0]
				{
					//角度を求める
					GOSUB[#=es.CalcAngle PFLT=(@WSX/2) PFLT2=(@WSY/2) PFLT3=(@lx+@L.CX(@LNO)*@zx/100) PFLT4=(@ly+@L.CY(@LNO)*@zy/100)]
					FLT[@mR1=@_RFLT(1)]
					FLT[@mR2]
					FLT[@X1_LEN=(@lx+@L.CX(@LNO)*@zx/100)-(@WSX/2)]
					FLT[@Y1_LEN=(@ly+@L.CY(@LNO)*@zy/100)-(@WSY/2)]
					FLT[@X2_LEN]
					FLT[@Y2_LEN]
					FLT[@R] MATH[LET=@R SQRT=1 SET=@X1_LEN*@X1_LEN+@Y1_LEN*@Y1_LEN] //半径

					//角度に回転角を足す
					@mR2=@mR1+@RZ
			//		@mR2=@mR1-@RZ

					//半径と回転角から、@X2_LEN, @Y2_LEN を求める
					MATH[COS=1 LET=@X2_LEN SET=@mR2*@_PAI/180];@X2_LEN*=@R
					MATH[SIN=1 LET=@Y2_LEN SET=@mR2*@_PAI/180];@Y2_LEN*=@R


					//INT[@HOSEI_XI=@HOSEI_X]
					//INT[@HOSEI_YI=@HOSEI_Y]
					//INT[@mR1I=@mR1]
					//INT[@mR2I=@mR2]
					//INT[@X1_LEI=@X1_LEN]
					//INT[@Y1_LEI=@Y1_LEN]
					//INT[@X2_LEI=@X2_LEN]
					//INT[@Y2_LEI=@Y2_LEN]
					//\DBG.STR(4, "F="+$(@mR1I)+" F2="+$(@mR2I)+" X1LEN="+$(@X1_LEI)+" Y1LEN="+$(@Y1_LEI)+" X2LEN="+$(@X2_LEI)+" Y2LEN="+$(@Y2_LEI)+" @HOSEI_XI="+$(@HOSEI_XI)+" @HOSEI_YI="+$(@HOSEI_YI) )

					@HOSEI_X=@X1_LEN-@X2_LEN
					@HOSEI_Y=@Y1_LEN-@Y2_LEN
			//		CGACT[ID=$L1 ROTATION=1 SET=360*1000000+@RZ]
					CGACT[ID=$L1 ROTATION=1 SET=360*1000000-@RZ]
				}
				IFEND[]
}
IFEND[]



IF[@_DXMODE==0]
{
				//彩度
		//		IF[@L.SD(@LNO)!=     128] CGACT[ID=$L1 SAIDO=1 SET=@L.SD(@LNO)] IFEND[]

				//明度
		//		IF[@L.MD(@LNO)!=0x808080] CGACT[ID=$L1 MEIDO=1 SET=@L.MD(@LNO)] IFEND[]
}
ELSE[]
{
				//彩度
//

				//明度
//
}
IFEND[]



IF[@L.TRA(@LNO)>0]
{
				//トランジション処理
				//----------------------------------------------------------------
				// サイズを合わせる
				//----------------------------------------------------------------
					INT[@lsx1]CGINFO[ID=$L1  SX=1 LET=@lsx1]
					INT[@lsy1]CGINFO[ID=$L1  SY=1 LET=@lsy1]
					INT[@lsx2]CGINFO[ID=$TR1 SX=1 LET=@lsx2]
					INT[@lsy2]CGINFO[ID=$TR1 SY=1 LET=@lsy2]

IF[@texchk==2]
	@lsx1=@es.GSX
	@lsy1=@es.GSY
IFEND[]

					IF[@lsx1!=@lsx2 || @lsy1!=@lsy2]
					{
//\_dmes("$TRBUF1="+$TRBUF1+", $TR1="+$TR1)
					//	CGACT[ID=$TR1 RECTPAINT3=1 SET=0xff000000]
						IF[@lsx1>0 && @lsy1>0]
							CGACT[ID=$TRBUF1 ID2=$TR1 SIZE=1 SX=@lsx1 SY=@lsy1]
						IFEND[]
//FILEACT[ID=$TR1 FILE="TEST"]
	IF[@_DXMODE]
						CG[ID=$TR1 TEX=@_DXMODE]
	IFEND[]
					}
					IFEND[]

					CG[ID=$L1 TID=$TR1 T=@TP TA=@L.TRA(@LNO)]
}
IFEND[]


///xCOS
				GOSUB[#=es.L.CUTIN.REF pint=@LNO]

			}
			IFEND[]


IF[@_DXMODE==0]
{
			//回転用
			CG[ID=$L1 X+=(@es.GSX/2)-(@WSX/2) Y+=(@es.GSY/2)-(@WSY/2)]
			CG[ID=$L1 X+=@HOSEI_X Y+=@HOSEI_Y]
}
IFEND[]




			INT[@POSTF_HORIZONTAL	=(@L.HOR(@LNO)!=0)]
			INT[@POSTF_VERTICAL		=(@L.VER(@LNO)!=0)]
			INT[@POSTF_REVERSE		=(@L.REV(@LNO)!=0)]
			INT[@POSTF_MONO			=(@L.MONO(@LNO)!=0)]
			INT[@POSTF_BLUR			=(@L.BLUR(@LNO)!=0)]
			INT[@POSTF_MOSAIC		=(@L.MOSA(@LNO)!=0)]
			INT[@POSTF_DIFFUSION	=(@L.DIFF(@LNO)!=0)]
			INT[@POSTF_ROTATION		=(@L.ROT(@LNO)!=0)]
			INT[@POSTF_RASTER		=(@L.RAS(@LNO)!=0)]
			INT[@POSTF_WHIRLPOOL	=(@L.WPL(@LNO)!=0)]
			INT[@POSTF_AKARUSA		=(@L.AKA(@LNO)!=128)]
		//	INT[@POSTF_SAIDO		=(@L.SD(@LNO)!=0)]
		//	INT[@POSTF_MEIDO		=(@L.MD(@LNO)!=0)]

			//回転
			IF[@POSTF_ROTATION]
			{
					CGACT[ID=$L1 ROTATION=1 SET=@L.ROT(@LNO)]
			}
			IFEND[]

			//ラスター
			IF[@POSTF_RASTER]
			{
					CGACT[ID=$L1 RASTER=1 SET=@L.RAS(@LNO) SET2=@es.RASTER.CNT]
			}
			IFEND[]

			//渦巻き
			IF[@POSTF_WHIRLPOOL]
			{
					CGACT[ID=$L1 WHIRLPOOL=1 SET=@L.WPL(@LNO)]
			}
			IFEND[]

			//モザイク
			IF[@POSTF_MOSAIC]
			{
					CGACT[ID=$L1 MOSAIC=1 SET=@L.MOSA(@LNO)]
			}
			IFEND[]

			//拡散
			IF[@POSTF_DIFFUSION]
			{
					CGACT[ID=$L1 DIFFUSION=1 SET=@L.DIFF(@LNO)]
			}
			IFEND[]

			//水平反転
			IF[@POSTF_HORIZONTAL]
			{
					CGACT[ID=$L1 HORIZONTAL=1]
			}
			IFEND[]

			//垂直反転
			IF[@POSTF_VERTICAL]
			{
					CGACT[ID=$L1 VERTICAL=1]
			}
			IFEND[]

			//ネガポジ反転
			IF[@POSTF_REVERSE]
			{
					CGACT[ID=$L1 REVERSE=1]
			}
			IFEND[]

			//二値化
			IF[@POSTF_MONO]
			{
					CGACT[ID=$L1 MONO=1 SET=128]
			}
			IFEND[]

			//ブラー
			IF[@POSTF_BLUR]
			{
					CGACT[ID=$L1 BLUR=1 SET=@L.BLUR(@LNO)]
			}
			IFEND[]

			//明るさ
			IF[@POSTF_AKARUSA]
			{
					CGACT[ID=$L1 AKARUSA=1 SET=@L.AKA(@LNO)]
			}
			IFEND[]





			//優先順位
			IF[@L.TIP(@LNO)==0] //通常レイヤ
			{
				IF[@L.PARENT(@LNO)==0] //子レイヤでない場合
				{
					IF[0]
					ELSE[@LNO==@LNO_BG]
						CG[ID=$L1 Z=@es.Z.SP                                  ]
					ELSE[@LNO==@LNO_BGF]
						CG[ID=$L1 Z=@es.Z.SP+10000*@es.ZEX                    ]
					ELSE[]
//※キャラ番号毎に立ち絵優先順位を決定する場合
IF[@ST.Z.MODE==1 && @L.FTYPE(@LNO)==5]
						CG[ID=$L1 Z=@es.Z.SP+09000*@es.ZEX-@LN.ZZ*@es.ZEX+@CHRLZ(@L.CHRNO(@LNO))]
ELSE[]
//※キャラ表示した順番毎に優先順位を決定する場合
						CG[ID=$L1 Z=@es.Z.SP+09000*@es.ZEX-@LN.ZZ*@es.ZEX+@L.LZCNT(@LNO)]
IFEND[]
					IFEND[]
				}
				ELSE[] //子レイヤの場合、親レイヤのZ値+1の優先順位とする
				{
IF[@ST.Z.MODE==1 && @L.FTYPE(@lns)==5]
						CG[ID=$L1 Z=@es.Z.SP+09000*@es.ZEX-@LP.ZZ*@es.ZEX+@CHRLZ(@L.CHRNO(@lns))+1]
ELSE[]
//※キャラ表示した順番毎に優先順位を決定する場合
						CG[ID=$L1 Z=@es.Z.SP+09000*@es.ZEX-@LP.ZZ*@es.ZEX+@L.LZCNT(@lns)+1]
IFEND[]
				}
				IFEND[]
			}
			ELSE[] //チップレイヤ
			{
					IF[@LNO==@LNO_FD]
						CG[ID=$L1 Z=@es.Z.SP+10000*@es.ZEX+1]
					ELSE[]
						CG[ID=$L1 Z=@es.Z.SP+09000*@es.ZEX-@LN.ZZ*@es.ZEX]
					IFEND[]
			}
			IFEND[]


		//----------------------------------------------------------------
		// デバッグ用描画
		//----------------------------------------------------------------
			IF[@_DEBUGMODE>=@dbg.val]


				//拡大縮小点表示
				IF[@es.GSD(094,01)]
			//	IF[@DBG.SW]
				{
					CG[ID=CP+$(@LNO) E=1 X=@lx+@L.CX(@LNO)*@zx/100-7 Y=@ly+@L.CY(@LNO)*@zy/100-7]
				}
				ELSE[]
				{
					CG[ID=CP+$(@LNO) E=0]
				}
				IFEND[]

				IF[@es.GSD(094,01)==1 || @es.GSD(094,01)==3]
				{
					CG[ID=GR01Y E=1]
					CG[ID=GR02Y E=1]
					CG[ID=GR03Y E=1]
				}
				ELSE[]
				{
					CG[ID=GR01Y E=0]
					CG[ID=GR02Y E=0]
					CG[ID=GR03Y E=0]
				}
				IFEND[]

				IF[@es.GSD(094,01)>=2]
				{
					CG[ID=GR01X E=1]
					CG[ID=GR02X E=1]
					CG[ID=GR03X E=1]
				}
				ELSE[]
				{
					CG[ID=GR01X E=0]
					CG[ID=GR02X E=0]
					CG[ID=GR03X E=0]
				}
				IFEND[]

				CG[ID=CP+$(@LNO) X+=(@es.GSX/2)-(@WSX/2) Y+=(@es.GSY/2)-(@WSY/2)]


				//[SpriteView]各チップ表示
				IF[@L.TIP(@LNO)==0] //チップレイヤでなければ
				{
					//チップサイズを調節する
					INT[@bx=(@L.BX(@LNO)+@L.ABX(@LNO)+@L.CLBX(@LNO))]
					INT[@sx=(@L.SX(@LNO)*@bx/1000)]
					IF[@sx<1] @sx=1 IFEND[]

					IF[@L.FTYPE(@LNO)==1 || @L.FTYPE(@LNO)==2] //背景
					{
						CGACT[ID=CPBUF0 ID2=":W2/CP"+$(@LNO) SIZE=1 SX=@sx SY=11]
					}
					ELSE[@L.FTYPE(@LNO)!=5] //その他立ち絵以外
					{
						CGACT[ID=CPBUF1 ID2=":W2/CP"+$(@LNO) SIZE=1 SX=@sx SY=11]
					}
					ELSE[]
					{
						CGACT[ID=CPBUF2 ID2=":W2/CP"+$(@LNO) SIZE=1 SX=@sx SY=11]
					}
					IFEND[]

					IF[@L.PARENT(@LNO)==0] //子レイヤでない場合
						CG[ID=:W2/CP+$(@LNO) X=200+(@LN.XX       -(@L.CX(@LNO)+60)*@bx/100)/10.0 Y=300-6-(@LN.ZZ)/2.0] //-60(/10.0)→6はチップ自体の幅の半分
					ELSE[]
						CG[ID=:W2/CP+$(@LNO) X=200+(@LN.XX+@LP.XX-(@L.CX(@LNO)+60)*@bx/100)/10.0 Y=300-6-(@LP.ZZ)/2.0] //-60(/10.0)→6はチップ自体の幅の半分
					IFEND[]

					@A=(96)+(@A*(256-96)/256)*(@S>=128) //完全透明時は A==96
					CG[ID=:W2/CP+$(@LNO) A=@A]
				}
				IFEND[]

			IFEND[]


	#=es.SP.DRAW.LEnd

	return[]
}



//----------------------------------------------------------------------------
//■リフレッシュ
//----------------------------------------------------------------------------
#=es.L.CUTIN.REF
{
	INT[@lno=@_PINT(1)]
	STR[$L1=$LID+$(1+@lno*100+@L.ANC2(@lno))]
	STR[$LB1=$LIDBUF+$(1+@lno*100+@L.ANC2(@lno))]

///xEUP
	IF[$L.SPID(@lno)!=""]
	{
		IF[@es.GSD(116,01)==0]
		{
			IF[$L.SPID(@lno)==$T(92,01)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,11)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		ELSE[]
		{
			IF[$L.SPID(@lno)==$T(92,02)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,12)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		IFEND[]

		IF[@es.GSD(116,02)==0]
		{
			IF[$L.SPID(@lno)==$T(92,03)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,13)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		ELSE[]
		{
			IF[$L.SPID(@lno)==$T(92,04)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,14)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		IFEND[]

		IF[@es.GSD(116,03)==0]
		{
			IF[$L.SPID(@lno)==$T(92,05)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,15)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		ELSE[]
		{
			IF[$L.SPID(@lno)==$T(92,06)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,16)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		IFEND[]

		IF[@es.GSD(116,04)==0]
		{
			IF[$L.SPID(@lno)==$T(92,07)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,17)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		ELSE[]
		{
			IF[$L.SPID(@lno)==$T(92,08)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
			IF[$L.SPID(@lno)==$T(92,18)] CG[ID=$LB1 X=8000] CG[ID=$L1 X=8000] IFEND[]
		}
		IFEND[]

	}
	IFEND[]

	return[]
}


//-------------------------------------------------------------------------
//
//-------------------------------------------------------------------------
///xFSM
#=es.CGACT_SIZECHECK
{
	FLT[@lsx=@_PFLT(1)]			//lsx
	FLT[@lsy=@_PFLT(2)]			//lsy
	FLT[@mlx=@_PFLT(3)]			//(左上座標X)
	FLT[@mly=@_PFLT(4)]			//(左上座標Y)
	FLT[@mlxz=100.0/@_PFLT(5)]	//(拡縮率X)
	FLT[@mlyz=100.0/@_PFLT(6)]	//(拡縮率Y)
	FLT[@mlxz2=@_PFLT(5)]		//(拡縮率X)
	FLT[@mlyz2=@_PFLT(6)]		//(拡縮率Y)

	FLT[@msx = @lsx*@mlxz2/100.0]	//(左上座標X)
	FLT[@msy = @lsy*@mlyz2/100.0]	//(左上座標Y)

	INT[@WSX = @es.GSX]
	INT[@WSY = @es.GSY]

	FLT[@fx1 = -@mlx*@mlxz]
	FLT[@fy1 = -@mly*@mlyz]
	FLT[@fx2 = @WSX*@mlxz+@fx1-1]
	FLT[@fy2 = @WSY*@mlyz+@fy1-1]

	INT[@out_u]
	INT[@out_d]
	INT[@out_l]
	INT[@out_r]

	///xFSM
	  IF[@mlx>=-0 && @mlx+@msx<=@WSX+0]                   //LR:00
	ELSE[@mlx>=-0 && @mlx+@msx> @WSX+0] @out_r=1          //LR:01
	ELSE[@mlx< -0 && @mlx+@msx<=@WSX+0] @out_l=1          //LR:10
	ELSE[@mlx< -0 && @mlx+@msx> @WSX+0] @out_l=1;@out_r=1 //LR:11
	IFEND[]
	  IF[@mly>=-0 && @mly+@msy<=@WSY+0]                   //UD:00
	ELSE[@mly>=-0 && @mly+@msy> @WSY+0] @out_d=1          //UD:01
	ELSE[@mly< -0 && @mly+@msy<=@WSY+0] @out_u=1          //UD:10
	ELSE[@mly< -0 && @mly+@msy> @WSY+0] @out_u=1;@out_d=1 //UD:11
	IFEND[]

	//はみ出し情報を返す.
	return[rint=@out_u rint2=@out_d rint3=@out_l rint4=@out_r]
}

//-------------------------------------------------------------------------
//■CGACT_SIZE ラッパー関数
//  表示左上座標と拡縮率、画面サイズから、適切に画像を表示してくれる関数
//  拡縮率が100%の時は SIZE=1 になる
//
// pstr1 → src ID
// pstr2 → dst ID
// pint3 → (左上座標X)
// pint4 → (左上座標Y)
// pflt5 → (拡縮率X)
// pflt6 → (拡縮率Y)
// pint7 → (画質)0〜3
// pint8 → 回転用dst範囲拡大フラグ ///xS専用
//-------------------------------------------------------------------------
#=es.CGACT_SIZE
{
	STR[$src=$_PSTR(1)]			//src ID
	STR[$dst=$_PSTR(2)]			//dst ID
	FLT[@mlx=@_PFLT(3)]			//(左上座標X)
	FLT[@mly=@_PFLT(4)]			//(左上座標Y)
	FLT[@mlxz=100.0/@_PFLT(5)]	//(拡縮率X)
	FLT[@mlyz=100.0/@_PFLT(6)]	//(拡縮率Y)
	FLT[@mlxz2=@_PFLT(5)]		//(拡縮率X)
	FLT[@mlyz2=@_PFLT(6)]		//(拡縮率Y)
	INT[@quo=@_PINT(7)]			//(画質)0〜1
	IF[@T(17,06)==0] @quo=0 IFEND[]

	//レイヤサイズ取得
	FLT[@lsx]
	FLT[@lsy]
	CGINFO[ID=$src SX=1 LET=@lsx]
	CGINFO[ID=$src SY=1 LET=@lsy]

	FLT[@msx = @lsx*@mlxz2/100.0]	//(左上座標X)
	FLT[@msy = @lsy*@mlyz2/100.0]	//(左上座標Y)

	INT[@WSX = @es.GSX]
	INT[@WSY = @es.GSY]
	IF[@_PINT(8)]				//回転用dst範囲拡大フラグ ///xS専用
		@WSX = @WSX.BIG
		@WSY = @WSY.BIG
	IFEND[]

	FLT[@fx1 = -@mlx*@mlxz]
	FLT[@fy1 = -@mly*@mlyz]
	FLT[@fx2 = @fx1+@WSX*@mlxz-1]
	FLT[@fy2 = @fy1+@WSY*@mlyz-1]


	//
	FLT[@LEFT_X=@mlx]
	FLT[@LEFT_Y=@mly]
	IF[@mlx<0] @LEFT_X=0 IFEND[]
	IF[@mly<0] @LEFT_Y=0 IFEND[]


	FLT[@SIZE_X]
	FLT[@SIZE_Y]
	FLT[@X1]FLT[@X2]
	FLT[@Y1]FLT[@Y2]
/*
	  IF[@mlx>=0 && @mlx+@msx< @WSX] @X1=                  0;@X2=@lsx-1                 ;@SIZE_X=1+@msx      //LR:00
	ELSE[@mlx>=0 && @mlx+@msx>=@WSX] @X1=                  0;@X2=(@WSX-@mlx+1)*@lsx/@msx;@SIZE_X=1+@WSX-@mlx //LR:01
	ELSE[@mlx< 0 && @mlx+@msx< @WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=@lsx-1                 ;@SIZE_X=1+@msx+@mlx //LR:10
	ELSE[@mlx< 0 && @mlx+@msx>=@WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=(@WSX-@mlx+1)*@lsx/@msx;@SIZE_X=1+@WSX      //LR:11
	IFEND[]
	  IF[@mly>=0 && @mly+@msy< @WSY] @Y1=                  0;@Y2=@lsy-1                 ;@SIZE_Y=@msy        //UD:00
	ELSE[@mly>=0 && @mly+@msy>=@WSY] @Y1=                  0;@Y2=(@WSY-@mly+1)*@lsy/@msy;@SIZE_Y=@WSY-@mly   //UD:01
	ELSE[@mly< 0 && @mly+@msy< @WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=@lsy-1                 ;@SIZE_Y=@msy+@mly   //UD:10
	ELSE[@mly< 0 && @mly+@msy>=@WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=(@WSY-@mly+1)*@lsy/@msy;@SIZE_Y=@WSY        //UD:11
	IFEND[]
*/
/*
	  IF[@mlx>=0 && @mlx+@msx<=@WSX] @X1=                  0;@X2=@lsx-1               ;@SIZE_X=1+@msx      //LR:00
	ELSE[@mlx>=0 && @mlx+@msx> @WSX] @X1=                  0;@X2=(@WSX-@mlx)*@lsx/@msx;@SIZE_X=1+@WSX-@mlx //LR:01
	ELSE[@mlx< 0 && @mlx+@msx<=@WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=@lsx-1               ;@SIZE_X=1+@msx+@mlx //LR:10
	ELSE[@mlx< 0 && @mlx+@msx> @WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=(@WSX-@mlx)*@lsx/@msx;@SIZE_X=1+@WSX      //LR:11
	IFEND[]
	  IF[@mly>=0 && @mly+@msy<=@WSY] @Y1=                  0;@Y2=@lsy-1               ;@SIZE_Y=@msy        //UD:00
	ELSE[@mly>=0 && @mly+@msy> @WSY] @Y1=                  0;@Y2=(@WSY-@mly)*@lsy/@msy;@SIZE_Y=@WSY-@mly   //UD:01
	ELSE[@mly< 0 && @mly+@msy<=@WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=@lsy-1               ;@SIZE_Y=@msy+@mly   //UD:10
	ELSE[@mly< 0 && @mly+@msy> @WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=(@WSY-@mly)*@lsy/@msy;@SIZE_Y=@WSY        //UD:11
	IFEND[]
*/
/*
	  IF[@mlx>=0 && @mlx+@msx< @WSX] @X1=                  0;@X2=@lsx                 ;@SIZE_X=1+@msx		//LR:00
	ELSE[@mlx>=0 && @mlx+@msx>=@WSX] @X1=                  0;@X2=(@WSX-@mlx)*@lsx/@msx;@SIZE_X=1+@WSX-@mlx	//LR:01
	ELSE[@mlx< 0 && @mlx+@msx< @WSX] @X1=(-@mlx-1)*@lsx/@msx;@X2=@lsx                 ;@SIZE_X=1+@msx+@mlx	//LR:10
	ELSE[@mlx< 0 && @mlx+@msx>=@WSX] @X1=(-@mlx-1)*@lsx/@msx;@X2=(@WSX-@mlx)*@lsx/@msx;@SIZE_X=1+@WSX		//LR:11
	IFEND[]
	  IF[@mly>=0 && @mly+@msy< @WSY] @Y1=                  0;@Y2=@lsy                 ;@SIZE_Y=1+@msy		//UD:00
	ELSE[@mly>=0 && @mly+@msy>=@WSY] @Y1=                  0;@Y2=(@WSY-@mly)*@lsy/@msy;@SIZE_Y=1+@WSY-@mly	//UD:01
	ELSE[@mly< 0 && @mly+@msy< @WSY] @Y1=(-@mly-1)*@lsy/@msy;@Y2=@lsy                 ;@SIZE_Y=1+@msy+@mly	//UD:10
	ELSE[@mly< 0 && @mly+@msy>=@WSY] @Y1=(-@mly-1)*@lsy/@msy;@Y2=(@WSY-@mly)*@lsy/@msy;@SIZE_Y=1+@WSY		//UD:11
	IFEND[]
*/
	  IF[@mlx>=0 && @mlx+@msx< @WSX] @X1=                  0;@X2=@lsx                   -1;@SIZE_X=@msx			//LR:00
	ELSE[@mlx>=0 && @mlx+@msx>=@WSX] @X1=                  0;@X2=(@WSX-@mlx+1)*@lsx/@msx-1;@SIZE_X=@WSX-@mlx+1	//LR:01
	ELSE[@mlx< 0 && @mlx+@msx< @WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=@lsx                   -1;@SIZE_X=@msx+@mlx-1	//LR:10
	ELSE[@mlx< 0 && @mlx+@msx>=@WSX] @X1=(-@mlx+1)*@lsx/@msx;@X2=(@WSX-@mlx+1)*@lsx/@msx-1;@SIZE_X=@WSX			//LR:11
	IFEND[]
	  IF[@mly>=0 && @mly+@msy< @WSY] @Y1=                  0;@Y2=@lsy                   -1;@SIZE_Y=@msy			//UD:00
	ELSE[@mly>=0 && @mly+@msy>=@WSY] @Y1=                  0;@Y2=(@WSY-@mly+1)*@lsy/@msy-1;@SIZE_Y=@WSY-@mly+1	//UD:01
	ELSE[@mly< 0 && @mly+@msy< @WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=@lsy                   -1;@SIZE_Y=@msy+@mly-1	//UD:10
	ELSE[@mly< 0 && @mly+@msy>=@WSY] @Y1=(-@mly+1)*@lsy/@msy;@Y2=(@WSY-@mly+1)*@lsy/@msy-1;@SIZE_Y=@WSY			//UD:11
	IFEND[]


	//表示位置 @LEFT_X, @LEFT_Y の小数点値を拾い、それを CGACT[SIZE2=1 〜] に伝える.
	//
	INT[@FLX=@LEFT_X*100]
	INT[@FLY=@LEFT_Y*100]
	@FLX%=100
	@FLY%=100
	@FLX=-@FLX
	@FLY=-@FLY

	//拡大時のみ小数点値を/2.
	IF[@X2-@X1 <= @SIZE_X] @FLX/=2 IFEND[]
	IF[@Y2-@Y1 <= @SIZE_Y] @FLY/=2 IFEND[]

	IF[@SIZE_X<1 || @SIZE_Y<1] //描画範囲外
	{
		@LEFT_X = 999999999
		@LEFT_Y = 999999999
	}
	ELSE[@_PINT(8)==0 && (@mlx>=0 || @mly>=0 || @mlx+@msx<@WSX || @mly+@msy<@WSY)]  //はみ出し:0000〜1110
	{
		CG[ID=$dst REMALLOC=1] //メモリ再確保しない

		IF[@mlxz==1 && @mlyz==1] //拡縮率が100%の時は SIZE=1
		{
				CGACT[ID=$src ID2=$dst SIZE=1 X=@X1 Y=@Y1 X2=@X2 Y2=@Y2 SX=@SIZE_X SY=@SIZE_Y]
		}
		ELSE[]
		{
			IF[@quo==0] //画質・低 (SIZE=1)
			{
				CGACT[ID=$src ID2=$dst SIZE=1 X=@X1 Y=@Y1 X2=@X2 Y2=@Y2 SX=@SIZE_X SY=@SIZE_Y]
			}
			ELSE[]		//画質・中 (SIZE2=1)
			{
				CGACT[ID=$src ID2=$dst SIZE2=1 FX=@X1*100+@FLX FY=@Y1*100+@FLY FX2=@X2*100+@FLX FY2=@Y2*100+@FLY FSX=@SIZE_X*100 FSY=@SIZE_Y*100]
			}
			IFEND[]
		}
		IFEND[]
	}
	ELSE[]  //はみ出し:1111
	{
		@LEFT_X = 0
		@LEFT_Y = 0

		IF[@mlxz==1 && @mlyz==1] //拡縮率が100%の時は SIZE=1
		{
			CGACT[ID=$src ID2=$dst SIZE=1 X=@fx1 Y=@fy1 X2=@fx2 Y2=@fy2 SX=@WSX SY=@WSY]
		}
		ELSE[]
		{
			  IF[@quo==0] //画質・低 (SIZE=1)
			{
				CGACT[ID=$src ID2=$dst SIZE=1 X=@fx1 Y=@fy1 X2=@fx2 Y2=@fy2 SX=@WSX SY=@WSY]
			}
			ELSE[@quo==1] //画質・中 (SIZE2=1)
			{
				CGACT[ID=$src ID2=$dst SIZE2=1 FX=@fx1*100+@FLX FY=@fy1*100+@FLY FX2=@fx2*100+@FLX FY2=@fy2*100+@FLY FSX=@WSX*100 FSY=@WSY*100]
			}
			ELSE[@quo==2] //画質・中(上) (SIZE2=1, SIZE4=1)
			{
		//		CGACT[ID=$src ID2=$LID1612 SIZE2=1 FX=@fx1*100+@FLX FY=@fy1*100+@FLY FX2=@fx2*100+@FLX FY2=@fy2*100+@FLY FSX=(@WSX*2)*100 FSY=(@WSY*2)*100]
		//		CGACT[ID=$LID1612 ID2=$dst SIZE4=1 SX=@WSX SY=@WSY]
			}
			IFEND[]
		}
		IFEND[]

	}
	IFEND[]

	CG[ID=$dst X=@LEFT_X Y=@LEFT_Y]

	return[]
}



//-------------------------------------------------------------------------
//２点から角度を求める関数
//
//@_PFLT(1):不動点X
//@_PFLT(2):不動点Y
//@_PFLT(3):動点X
//@_PFLT(4):動点Y
//
//戻り値
//@_RFLT(1):角度
//-------------------------------------------------------------------------
#=es.CalcAngle
{
	FLT[@X1=@_PFLT(1)]
	FLT[@Y1=@_PFLT(2)]
	FLT[@X2=@_PFLT(3)]
	FLT[@Y2=@_PFLT(4)]
	FLT[@angle]

	MATH[ATAN2=1 LET=@angle SET=@Y2-@Y1 SET2=@X2-@X1] //Y-Xの順に注意.

	IF[@Y2>=@Y1] //動点が不動点より下の場合
		@angle =       (@angle * 180.0 / @_PAI)
	ELSE[]       //上の場合
		@angle = 360 + (@angle * 180.0 / @_PAI)
	IFEND[]

	return[rflt=@angle]
}





//-------------------------------------------------------------------------
//スプライト情報取得:(スプライトの有無)
//(簡易版)
//戻り値 : 1=有/0=無
//-------------------------------------------------------------------------
#=es.SP.EX.GET
{
	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$_PSTR(1)]
	return[rint=(@_RINT(1)>0)]
}


//-------------------------------------------------------------------------
//スプライト情報取得:A
//(簡易版)
//戻り値 : 0〜256=スプライトの不透明度/-1=スプライト無
//-------------------------------------------------------------------------
#=es.SP.A.GET
{
	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$_PSTR(1)]
	INT[@lno=@_RINT(1)]

	INT[@a=-1]

	IF[@lno>0]
	{
		@a = @L.A(@lno) + @L.CLA(@lno) //+@L.F1(@lno)

		//範囲制限
		IF[@a<  0] @a=  0 IFEND[]
		IF[@a>256] @a=256 IFEND[]
	}
	IFEND[]

	return[rint=@a]
}



//-------------------------------------------------------------------------
//スプライト情報取得:NO
//(簡易版)
//戻り値 : 1〜200=スプライト番号の不透明度/0=なし
//-------------------------------------------------------------------------
#=es.SP.NO.GET
{
	//レイヤＩＤからレイヤ番号を調べる(無い場合は0)
	GOSUB[#=es.LNO.GET pstr=$_PSTR(1)]
	INT[@lno=@_RINT(1)]

	return[rint=@lno]
}












//////


//■ムービー演出
#=es.L.YMV.INIT
{
	INT[@No=@_PINT(1)]
	INT[@MIPMAP]

	STR[$LB1 =$LIDBUF+$( 1+@No*100)]
	STR[$L1 =$LID+$( 1+@No*100)]

	//----------------------------------------------------------------
	IF[@L.YMFPS(@No)==0]
	{
//\_dmes("YMVFILE="+$PATH(6)+$L.FCG(@No)+".ymv")

		//画像読み込み
		LOOP[SET=100] CGEND[ID=$LIDBUF+$(1+@No*100+@_LC-1)] LOOPEND[]
	//	LOOP[SET=100] CGEND[ID=$LID   +$(1+@No*100+@_LC-1)] LOOPEND[]

		CG[ID=$LIDBUF+$(1+@No*100) E=0 A=0 X=0 Y=0 SX=1 SY=1 Z=1 FILE=""]
		CGACT[ID=$LIDBUF+$(1+@No*100) RECTPAINT3=1 SET=0x00000000]

			YMV[ID=$LIDBUF+$(1+@No*100) FILE=$PATH(6)+$L.FCG(@No)+".ymv"]

			YMVINFO[ID=$LIDBUF+$(1+@No*100) NUM=1 LET=@L.ANNUM(@No)]	//フレーム数取得
			YMVINFO[ID=$LIDBUF+$(1+@No*100) SX=1 LET=@L.SX(@No)]		//画像サイズ取得
			YMVINFO[ID=$LIDBUF+$(1+@No*100) SY=1 LET=@L.SY(@No)]		//画像サイズ取得
			YMVINFO[ID=$LIDBUF+$(1+@No*100) FPS=1 LET=@L.YMFPS(@No)]	//ＦＰＳ取得
			@L.CX(@No) = @L.SX(@No)/2.0
			@L.CY(@No) = @L.SY(@No)/2.0

		CGACT[ID=$LIDBUF+$(1+@No*100) SIZE=1 SX=@L.SX(@No) SY=@L.SY(@No)]

		CG[ID=$LIDBUF+$(1+@No*100) TEX=@_DXMODE] //テクスチャ化

		IF[@_DXMODE==0]
			CG[ID=$L1  X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@No) FILE=""] //実際の表示レイヤ
	//		CG[ID=$L11 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@No) FILE=""] //実際の表示レイヤ
	//		CG[ID=$L12 X=0 Y=0 Z=@L.LV(@No) E=0 A=0 MODE=@es.BL(@No) FILE=""] //実際の表示レイヤ
			CGACT[ID=$L1  RECTPAINT3=1 SET=0x00000000]
	//		CGACT[ID=$L11 RECTPAINT3=1 SET=0x00000000]
	//		CGACT[ID=$L12 RECTPAINT3=1 SET=0x00000000]
		IFEND[]

	//	IF[@sdmd.na==0]
			IF[@es.EF.SAIDO!=128]
				@L.SD(@LNO)=@es.EF.SAIDO
				IF[@es.EF.SAIDO!=     128] CGACT[ID=$LIDBUF+$(1+@No*100) SAIDO=1 SET=@es.EF.SAIDO] IFEND[]
			IFEND[]
			IF[@es.EF.MEIDO!=0x808080]
				@L.MD(@No)=@es.EF.MEIDO
				IF[@es.EF.MEIDO!=0x808080] CGACT[ID=$LIDBUF+$(1+@No*100) MEIDO=1 SET=@es.EF.MEIDO] IFEND[]
			IFEND[]
	//	IFEND[]


IF[@_DEBUGMODE>=@dbg.val]

		//チップ画像読み込み
		//
			//[SpriteView]チップ読込
			CG[ID=":W2/CP"+$(@No) Z=100+@No X=8000 Y=6000 FILE=""]
			CGACT[ID=CPBUF2 ID2=":W2/CP"+$(@No) SIZE=1 SX=(@L.SX(@No)/10)+1 SY=11]

			//[ゲーム画面]チップ読込
			CG[ID=CP+$(@No) Z=900000*@es.ZEX+@No A=128 X=8000 Y=6000 FILE=""]
			CGACT[ID=CPBUF4 ID2=CP+$(@No) COPY2=1]

IFEND[]

		YMV[ID=$LIDBUF+$(1+@No*100) FRAME=0]
		IF[@_DXMODE]
			CGACT[ID=$LIDBUF+$(1+@No*100) ID2=$LIDBUF+$(1+@No*100) TEXCOPY=1]
		IFEND[]

		@L.YMTIME(@No) = @_OS_TIME(1)
	}
	IFEND[]

	return[]
}

#=es.L.YMV.MAIN
{
	INT[@No=@_PINT(1)]
	FLT[@pasttime]
	FLT[@onefps]
	INT[@refreshflg]

	STR[$LB1=$LIDBUF+$( 1+@No*100)]
	STR[$L1 =$LID   +$( 1+@No*100)]

	IF[@L.YMFPS(@No)>0]
	{
		@onefps = 1000.0 / @L.YMFPS(@No)

		//時間計算
		@pasttime = @_OS_TIME(1) - @L.YMTIME(@No)
		@L.YMTIME(@No) = @_OS_TIME(1)

		IF[@pasttime>100] @pasttime=100 IFEND[] //一定時間以上経過したらそれ以上の時間は切り捨てる(フリーズ防止)

		LOOP[]
		{
			IF[@L.ANSTOP(@No)<99999]
			{
				IF[@pasttime>@onefps]
				{
					@refreshflg = 1

					@pasttime -= @onefps

					@L.ANC4(@No)+=1
					IF[@L.ANC4(@No)>=@L.ANNUM(@No)]
					{
						@L.ANLOOP(@No)-=1
						IF[@L.ANLOOP(@No)!=0]
							@L.ANC4(@No)=0
						ELSE[]
							@L.ANC4(@No)-=1
							@L.ANSTOP(@No)=99999
						IFEND[]
						LOOPCONTINUE[]
					}
					IFEND[]

					LOOPCONTINUE[]
				}
				IFEND[]
			}
			IFEND[]

			@L.YMTIME(@No) -= @pasttime
			LOOPBREAK[]
		}
		LOOPEND[]

		IF[@refreshflg]
		{
			YMV[ID=$LIDBUF+$(1+@No*100) FRAME=@L.ANC4(@No)]

///xUSO
//			IF[@L.ANSTOP(@No)==99999 && $L.SPID(@No)!="MV"] CGACT[ID=$LIDBUF+$(1+@No*100) RECTPAINT3=1 SET=0] IFEND[]

			IF[@_DXMODE] CGACT[ID=$LIDBUF+$(1+@No*100) ID2=$LIDBUF+$(1+@No*100) TEXCOPY=1] IFEND[]
		}
		IFEND[]

	}
	IFEND[]

	return[]
}



#=es.MIMI
{
	INT[@no]

	\WA(1) //演出始まるのを待ち

	LOOP[SET=\.SP.MAX+1]
	{
		@no=@_LC-1

		IF[$L.SPID(@no)==$_PSTR(1)]
		{
			@es.MIMI.COM.INIT(@no)  = 1
			@es.MIMI.COM.COUNT(@no) = @_PINT(2)
			@es.MIMI.COM.WAIT(@no)  = @_PINT(3)
//\_dmes("@cno="+$(@cno)+", @_PINT(2)="+$(@_PINT(2)))
		}
		IFEND[]
	}
	LOOPEND[]

	return[]
}

#=es.MIMI.ON
{
/*
	IF[$_PSTR(1)==""]		LOOP[SET=10] @es.MIMI.STOP(@_LC)=0 LOOPEND[]
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(1)=0
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(2)=0
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(4)=0
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(5)=0
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(6)=0
	IFEND[]
*/
	return[]
}

#=es.MIMI.OFF
{
/*
	IF[$_PSTR(1)==""]		LOOP[SET=10] @es.MIMI.STOP(@_LC)=1 LOOPEND[]
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(1)=1
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(2)=1
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(4)=1
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(5)=1
	ELSE[$_PSTR(1)=="xxx"]	@es.MIMI.STOP(6)=1
	IFEND[]
*/
	return[]
}



//====================================================================
//
//■スクリプトウェイト処理
//
//====================================================================

//■スタティック変数宣言
{
	S_INT[@WAIT.TIME]
	S_INT[@WAIT.STARTTIME]
	S_INT[@mWTEMP]
	S_INT[@mWTADD]
	S_INT[@mWTIME]
}


//====================================================================
//
//■WAIT マクロ
//
//====================================================================
#=es.WAIT
{
	INT[@mTime = @_PINT(1)]
	INT[@mSkip = @_PINT(2)]

	IF[@WAIT.TIME==0] @WAIT.TIME = @_OS_TIME(1) IFEND[]

	IF[@es.MG.AUTO==1] @mSkip=0 IFEND[]

	LOOP[]
	{
		IF[@mSkip]
		{
			IF[@es.TEXT.TIPCLICK==1] LOOPBREAK[] IFEND[]
//			IF[@_MOUSE_L  ==1] LOOPBREAK[] IFEND[]
			IF[@es.TX.CSKIP>0] LOOPBREAK[] IFEND[]
			IF[@_KEY_ENTER==1] LOOPBREAK[] IFEND[]
			IF[@_KEY_SPACE==1] LOOPBREAK[] IFEND[]
		}
		IFEND[]

		IF[@_OS_TIME(1) - @WAIT.TIME >= @mTime] LOOPBREAK[] IFEND[]

		WAIT[FRAME=1]
	}
	LOOPEND[]

	@WAIT.TIME = 0

	return[]
}


#=es.WAIT.COUNTSTART
{
	@WAIT.TIME = @_OS_TIME(1)
	return[]
}


#=es.WAIT.COUNTUNTIL
{
	INT[@time=@_PINT(1)]
	LOOP[]
	{
		WAIT[FRAME=1]
		IF[@_OS_TIME(1)-@WAIT.TIME>=@time] LOOPBREAK[] IFEND[]
	}
	LOOPEND[]

	return[]
}


//--------------------------------------------------------------------
// 経過時間から、その時点のXYZ座標を取得する
//--------------------------------------------------------------------
#=SP.SPLN.XYZ.GET
{
	FLT[@time=@_PFLT(1)]
	INT[@no =1] //点
	INT[@no2=1] //細かい点

	LOOP[]
	{
		IF[@time >= @spln.t(@SNO,@no,@no2)]
		{
			@time -= @spln.t(@SNO,@no,@no2)
			@no2+=1
			IF[@no2>@SPLN.DIVNUM]
			{
				@no2=1
				@no+=1
				IF[@no>@SPLN.PXNUM(@SNO)] @no=@SPLN.PXNUM(@SNO);LOOPBREAK[] IFEND[]
			}
			IFEND[]

			LOOPCONTINUE[]
		}
		IFEND[]

		LOOPBREAK[]
	}
	LOOPEND[]

	GOSUB[#=SP.SPLN.CALC pflt=@no + ((@no2-1) + @time / @spln.t(@SNO,@no,@no2)) * 1.0 / @SPLN.DIVNUM pint2=@SNO]
	return[rflt=@_RFLT(1) rflt2=@_RFLT(2) rflt3=@_RFLT(3)]
}


//--------------------------------------------------------------------
// スプラインデータ初期化
//--------------------------------------------------------------------
#=SP.SPLN.INIT
{
	INT[@time=@_PINT(1)]
	INT[@sno=@_PINT(2)]

	FLT[@spln.lmax] //長さの合計
	FLT[@a]
	FLT[@b]
	FLT[@c]
	INT[@i]
	INT[@mode]

	FLT[@spln.l(12,21)]	//２点間の長さ
	FLT[@spln.r(12,21)]	//２点間の長さの割合(全部足すと1.0)
	FLT[@spln.x(12,21)]
	FLT[@spln.y(12,21)]
	FLT[@spln.z(12,21)]

	LOOP[SET=3]
	{
		@i=@_LC-1
		LOOP[SET=@SPLN.DIVNUM+1]
			@spln.a(@sno,@i,@_LC-1)=0
			@spln.b(@sno,@i,@_LC-1)=0
			@spln.c(@sno,@i,@_LC-1)=0
			@spln.d(@sno,@i,@_LC-1)=0
		LOOPEND[]
	}
	LOOPEND[]

	LOOP[SET=@SPLN.PXMAX+1]
		@i=@_LC-1
		LOOP[SET=@SPLN.DIVNUM+1]
//			@spln.l(@i,@_LC-1)=0
//			@spln.r(@i,@_LC-1)=0
			@spln.t(@sno,@i,@_LC-1)=0
			@spln.x(@i,@_LC-1)=0
			@spln.y(@i,@_LC-1)=0
			@spln.z(@i,@_LC-1)=0
		LOOPEND[]
	LOOPEND[]

	//----------------------------------------------------------------
	//
    //３次多項式の0次係数(a)を設定
	//
	LOOP[SET=@SPLN.PXNUM(@sno)+1]
		@spln.a(@sno,0,@_LC-1)=@SPLN.LX(@sno,@_LC-1)
		@spln.a(@sno,1,@_LC-1)=@SPLN.LY(@sno,@_LC-1)
		@spln.a(@sno,2,@_LC-1)=@SPLN.LZ(@sno,@_LC-1)
	LOOPEND[]

	LOOP[SET=(3)]
	{
		@mode=@_LC-1

	    //３次多項式の2次係数(c)を計算
	    //連立方程式を解く。
	    //但し、一般解法でなくスプライン計算にチューニングした方法
		//
		@spln.c(@sno,@mode,0)=0; @spln.c(@sno,@mode,@SPLN.PXNUM(@sno))=0
		LOOP[SET=@SPLN.PXNUM(@sno)-1]
		{
			@spln.c(@sno,@mode,@_LC) = 3.0 * (@spln.a(@sno,@mode,@_LC-1) - 2.0 * @spln.a(@sno,@mode,@_LC) + @spln.a(@sno,@mode,@_LC+1));
		}
		LOOPEND[]

	    //左下を消す
		//
		FLT[@tmp]
		FLT[@w(101)]
		@w(0)=0
		LOOP[SET=@SPLN.PXNUM(@sno)-1]
		{
			@i=@_LC
			@tmp = 4.0 - @w(@i-1)
			@spln.c(@sno,@mode,@i) = (@spln.c(@sno,@mode,@i) - @spln.c(@sno,@mode,@i-1)) / @tmp
			@w(@i) = 1.0 / @tmp
		}
		LOOPEND[]

	    //右上を消す
		//
		@i = @SPLN.PXNUM(@sno)-1
		LOOP[]
		{
			IF[@i<=0] LOOPBREAK[] IFEND[]
			@spln.c(@sno,@mode,@i) = @spln.c(@sno,@mode,@i) - @spln.c(@sno,@mode,@i+1) * @w(@i)
			@i-=1
		}
		LOOPEND[]

	    //３次多項式の1次係数(b)と3次係数(b)を計算
		//
		@spln.b(@sno,@mode,@SPLN.PXNUM(@sno))=0; @spln.d(@sno,@mode,@SPLN.PXNUM(@sno))=0
		LOOP[SET=@SPLN.PXNUM(@sno)]
		{
			@i=@_LC-1
			@spln.d(@sno,@mode,@i) = (@spln.c(@sno,@mode,@i+1) - @spln.c(@sno,@mode,@i)) / 3.0;
			@spln.b(@sno,@mode,@i) = @spln.a(@sno,@mode,@i+1) - @spln.a(@sno,@mode,@i) - @spln.c(@sno,@mode,@i) - @spln.d(@sno,@mode,@i);
		}
		LOOPEND[]
	}
	LOOPEND[]

	//----------------------------------------------------------------
	//各点の位置を測る
	LOOP[SET=@SPLN.PXNUM(@sno)]
	{
		@i=@_LC-1
		LOOP[SET=@SPLN.DIVNUM+1]
		{
			@a = (@i) + ((@_LC-1) * 1.0 / @SPLN.DIVNUM)
			GOSUB[#=SP.SPLN.CALC pflt=@a pint2=@sno]
			@spln.x(@i, @_LC-1) = @_RFLT(1)
			@spln.y(@i, @_LC-1) = @_RFLT(2)
			@spln.z(@i, @_LC-1) = @_RFLT(3)
		}
		LOOPEND[]
	}
	LOOPEND[]

	//----------------------------------------------------------------
	//各点間の距離(長さ)を調べる
	LOOP[SET=@SPLN.PXNUM(@sno)]
	{
		@i=@_LC
		@spln.l(@i,0)=0
		LOOP[SET=@SPLN.DIVNUM]
		{
			@a = @spln.x(@i, @_LC) - @spln.x(@i, @_LC-1);IF[@a<0] @a=-@a IFEND[]
			@b = @spln.y(@i, @_LC) - @spln.y(@i, @_LC-1);IF[@b<0] @b=-@b IFEND[]
			MATH[SQRT=1 SET=@a*@a+@b*@b LET=@c]

	//		@a = @c
	//		@b = @spln.y(@i, @_LC) - @spln.y(@i, @_LC-1);IF[@b<0] @b=-@b IFEND[]
	//		MATH[SQRT=1 SET=@a*@a+@b*@b LET=@c]

			@spln.l(@i, @_LC)=@c
			@spln.l(@i,0)+=@c
		}
		LOOPEND[]
		@spln.lmax += @spln.l(@i,0)
	}
	LOOPEND[]

	//----------------------------------------------------------------
	//距離から、各点間の割合を求める
	LOOP[SET=@SPLN.PXNUM(@sno)]
	{
		@i=@_LC
		@spln.r(@i,0) = @spln.l(@i,0) / (@spln.lmax-1)
		LOOP[SET=@SPLN.DIVNUM] @spln.r(@i,@_LC) = @spln.l(@i, @_LC) / @spln.l(@i,0) LOOPEND[]
	}
	LOOPEND[]

	//----------------------------------------------------------------
	//各点へ到達する所要時間を計算する
	LOOP[SET=@SPLN.PXNUM(@sno)]
	{
		@i=@_LC
		@spln.t(@sno,@i,0) = @time * @spln.r(@i,0)
		LOOP[SET=@SPLN.DIVNUM] @spln.t(@sno,@i,@_LC) = @spln.r(@i,@_LC) * @spln.t(@sno,@i,0) LOOPEND[]
	}
	LOOPEND[]


	return[]
}


//--------------------------------------------------------------------
// 媒介変数(0〜num-1の実数）に対する値を計算
//--------------------------------------------------------------------
#=SP.SPLN.CALC
{
	INT[@j=@_PFLT(1)] //小数点以下切捨て
	INT[@sno=@_PINT(2)]
	IF[@j<0] @j=0 ELSE[@j>=@SPLN.PXNUM(@sno)] @j=@SPLN.PXNUM(@sno)-1 IFEND[] //丸め誤差を考慮
	FLT[@dt=@_PFLT(1)-@j]

	return[rflt=@spln.a(@sno,0,@j)+(@spln.b(@sno,0,@j)+(@spln.c(@sno,0,@j)+@spln.d(@sno,0,@j)*@dt)*@dt)*@dt rflt2=@spln.a(@sno,1,@j)+(@spln.b(@sno,1,@j)+(@spln.c(@sno,1,@j)+@spln.d(@sno,1,@j)*@dt)*@dt)*@dt rflt3=@spln.a(@sno,2,@j)+(@spln.b(@sno,2,@j)+(@spln.c(@sno,2,@j)+@spln.d(@sno,2,@j)*@dt)*@dt)*@dt]
}



/*
#=ES.CSEL.BTN.U.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	IF[@es.FORBIT.U==0] @USR.LY(@LNO_CM)-=4 IFEND[] //上(Y-)

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}

#=ES.CSEL.BTN.D.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	IF[@es.FORBIT.D==0] @USR.LY(@LNO_CM)+=4 IFEND[] //下(Y+)

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}

#=ES.CSEL.BTN.L.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	IF[@es.FORBIT.L==0] @USR.LX(@LNO_CM)-=4 IFEND[] //左(X-)

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}

#=ES.CSEL.BTN.R.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	IF[@es.FORBIT.R==0] @USR.LX(@LNO_CM)+=4 IFEND[] //右(X+)

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}

#=ES.CSEL.BTN.ZOOMIN.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	IF[@USR.LZ(@LNO_CM) + 150+2 <=@L.Z(@LNO_BG)] @USR.LZ(@LNO_CM)+=2 IFEND[] //後(Z+)

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}

#=ES.CSEL.BTN.ZOOMOUT.ON
{
	@es.FORBIT.U=0
	@es.FORBIT.D=0
	@es.FORBIT.L=0
	@es.FORBIT.R=0
	GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
	IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
	IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
	IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
	IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

	@USR.LZ(@LNO_CM)-=2 //前(Z-)

		LOOP[SET=100]
		{
			@es.FORBIT.U=0
			@es.FORBIT.D=0
			@es.FORBIT.L=0
			@es.FORBIT.R=0
			GOSUB[#=es.SP.DRAWCHECK pint=@LNO_BG]
			IF[@_RINT(1)==0] @es.FORBIT.U=1 IFEND[]
			IF[@_RINT(2)==0] @es.FORBIT.D=1 IFEND[]
			IF[@_RINT(3)==0] @es.FORBIT.L=1 IFEND[]
			IF[@_RINT(4)==0] @es.FORBIT.R=1 IFEND[]

			IF[@es.FORBIT.U==0 && @es.FORBIT.D==0 && @es.FORBIT.L==0 && @es.FORBIT.R==0] LOOPBREAK[] IFEND[] //0000

			IF[@es.FORBIT.L==1 && @es.FORBIT.R==0] @USR.LX(@LNO_CM)+=4;LOOPCONTINUE[] IFEND[] //LR10
			IF[@es.FORBIT.L==0 && @es.FORBIT.R==1] @USR.LX(@LNO_CM)-=4;LOOPCONTINUE[] IFEND[] //LR01
			IF[@es.FORBIT.U==1 && @es.FORBIT.D==0] @USR.LY(@LNO_CM)+=4;LOOPCONTINUE[] IFEND[] //UD10
			IF[@es.FORBIT.U==0 && @es.FORBIT.D==1] @USR.LY(@LNO_CM)-=4;LOOPCONTINUE[] IFEND[] //UD01

			IF[@es.FORBIT.U==1 && @es.FORBIT.D==1] @USR.LZ(@LNO_CM)+=2;LOOPBREAK[] IFEND[] //UD11
			IF[@es.FORBIT.L==1 && @es.FORBIT.R==1] @USR.LZ(@LNO_CM)+=2;LOOPBREAK[] IFEND[] //LR11

			LOOPBREAK[]
		}
		LOOPEND[]

	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]

	return[]
}


#=es.FSM.USR.LXYZ.INIT
{
	LOOP[SET=(@LMAX+1)]
	{
		@USR.LX(@_LC-1)=0
		@USR.LY(@_LC-1)=0
		@USR.LZ(@_LC-1)=0
	}
	LOOPEND[]
	INT[@lno]INT[@r]
	LOOP[SET=(@LMAX+1)]
	{
		@lno=@_LC-1
		CGINFO[ID=$LIDBUF+$(1+@lno*100) EXIST=1 LET=@r]
		IF[@r==0 && @lno!=@LNO_CM && @lno!=@LNO_CMF] LOOPCONTINUE[] IFEND[]
		@DRAW.FLAG(@lno)=1
	}
	LOOPEND[]


	return[]
}

*/

