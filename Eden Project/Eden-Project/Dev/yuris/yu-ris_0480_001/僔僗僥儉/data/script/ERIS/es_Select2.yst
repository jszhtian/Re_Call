//=========================================================================
//
//■汎用選択肢
//
//=========================================================================

//■スタティック変数宣言
{
	S_INT[@SEL.TIME]				//選択肢番号

	S_INT[@SEL.RET]					//何番目のパラメータにあたる選択肢を選んだか

	S_INT[@SEL.AUTOFLAG]			//オートモードで選択肢に入ってきたか
	S_INT[@SEL.SKIPFLAG]			//スキップモードで選択肢に入ってきたか

	S_INT[@SEL.CurNo]
	S_INT[@SEL.Num]

	S_INT[@STARTTIME]

	S_INT[@cou]

	S_STR[$BID="ES.CSEL."]

}



//=========================================================================
//■ボタン表示非表示処理
//=========================================================================
#=ES.CSEL.BTLOOP
{
//	IF[@es.CSEL.HIDE==0]
	IF[@es.SCENARIOSTOP==0]
	{
		LOOP[SET=100] \BT.W1($BID+"BTN.SEL", @_LC) LOOPEND[]
	}
	ELSE[]
	{
		LOOP[SET=100] \BT.W0($BID+"BTN.SEL", @_LC) LOOPEND[]
	}
	IFEND[]

	RETURN[]
}



//=========================================================================
//■選択肢
//=========================================================================
#=ES.CSEL
{
	//----------------------------------------------------------------
	// 文字情報取得
	//----------------------------------------------------------------
/*
		STR[$str="＜選択肢＞"]
		GOSUB[#=es.TX.SETTASK pstr=$str]
		\LOG.W.NMTXVO("", $str, $_RSTR(1))
*/


	@SEL.Num = 0

	INT[@AUTOSAVE.LOADTHRU]
	IF[@es.LOADTHRU]
		@AUTOSAVE.LOADTHRU=1
	IFEND[]

///rin
	IF[$es.RIN.LFNAME!=""]
	{
		LOAD[FILE=$es.RIN.LFNAME DNO=0005 LET=@L()]	// データ
		LOAD[FILE=$es.RIN.LFNAME DNO=0006 LET=$L()]	// データ

		$es.RIN.LFNAME=""
	}
	IFEND[]

	@es.LOADTHRU = 0


	//----------------------------------------------------------------
	// ウェイト ※名前消す
	//----------------------------------------------------------------
//		WAIT[FRAME=1]

	//----------------------------------------------------------------
	// 非アクティブなら点滅させる
	//----------------------------------------------------------------
		INT[@FW_TIME=500]
		INT[@FW_COUNT=5]
	///x

	//----------------------------------------------------------------
	// 一時セーブ
	//----------------------------------------------------------------
///xB4うまく動かないので暫定的に切る
//
//		\SAVE(@es.sdprevselno+1, 2) //0=save,1=qsave,2=prevselsave

	//----------------------------------------------------------------
	// オートモード状態、スキップモード状態の取得
	//----------------------------------------------------------------
//		@SEL.AUTOFLAG = @es.TX.AUTO
//		@SEL.SKIPFLAG = @es.TX.SKIP

	//----------------------------------------------------------------
	// 変数初期化
	//----------------------------------------------------------------
		@SEL.RET = 0
		$es.SEL.GO = ""

//		@es.TX.SKIP = 0

	//----------------------------------------------------------------
	// フェイスウィンドウ非表示
	//----------------------------------------------------------------
	//	GOSUB[#=es.FaceWindow.Disabled]


	//----------------------------------------------------------------
	//
	// 選択肢バー作成＆表示
	//
	//----------------------------------------------------------------

		\BTDEF.LOAD(ES.CSEL, @es.LSD(093,01))

	//	\BT.N1(ES.GAMEMAIN.BTN.VOICE)


	//--------------------------------------------------------------------------------
	// 選択肢用テキストレイヤ各種設定
	//--------------------------------------------------------------------------------
		@SEL.CurNo=1
		GOSUB[#=ES.CSEL.REF]

//	WAIT[FRAME=1]


\BT.ES20.ALL("ES.GAMEMAIN")
	//--------------------------------------------------------------------------------
	// 
	//--------------------------------------------------------------------------------
		GOSUB[#=es.BT.DRAW]

	//----------------------------------------------------------------
	// スクリーンショット
	//----------------------------------------------------------------
		CG[ID="_TMP" Z=@es.63BITMAX E=1 A=0 FILE=""]
		CGACT[COPY2=1 ID=":/W0/" ID2="_TMP"]


	\BT.ES0("ES.CSEL.TIP.BACK")
	LOOP[SET=(100)] \BT.ES0("ES.CSEL.BTN.SEL", @_LC) LOOPEND[]
	GOSUB[#=es.BT.DRAW]

	//--------------------------------------------------------------------------------
	// 若干フェードして出す
	//--------------------------------------------------------------------------------
		INT[@NTIME=@_OS_TIME(1)]
		INT[@TTIME=@es.LSD(093,03)]
		INT[@TIME]
		INT[@mA]
		LOOP[]
		{
			@TIME = (@_OS_TIME(1)-@NTIME)
			IF[@TIME>@TTIME] @TIME=@TTIME IFEND[]

			@mA = 256.0 * @TIME / @TTIME

			CG[ID="_TMP" A=@mA]

//			\BT.A.SET("ES.CSEL.TIP.BACK", , @mA)
//			LOOP[SET=(100)] \BT.A.SET("ES.CSEL.BTN.SEL", @_LC, @mA) LOOPEND[]

			WAIT[FRAME=1]

			IF[@TIME==@TTIME] LOOPBREAK[] IFEND[]
		}
		LOOPEND[]

	CGEND[ID="_TMP"]

\BT.ES21.ALL("ES.GAMEMAIN")

	\BT.ES1("ES.CSEL.TIP.BACK")
	LOOP[SET=(100)] \BT.ES1("ES.CSEL.BTN.SEL", @_LC) LOOPEND[]


	//--------------------------------------------------------------------------------
	// 
	//--------------------------------------------------------------------------------
/*
	IF[@es.RPMODE==0]
	{
		IF[@AUTOSAVE.LOADTHRU==0] //ロード時で無ければ、オートセーブする
		{
			\AUTOSAVE.SS
			\AUTOSAVE(1)
		}
		IFEND[]
	}
	IFEND[]

		@AUTOSAVE.LOADTHRU=0
*/

	@STARTTIME = @_OS_TIME(1)

	return[]
}

//----------------------------------------------------------------
//
// 選択処理
//
//----------------------------------------------------------------
/*
#=ES.CSEL.LOOP
{
	return[]
}
*/

#=ES.CSEL.QUIT
{

	//----------------------------------------------------------------
	// 選択肢決定直後処理
	//----------------------------------------------------------------
		\_gosub(ES.CSEL.OKEXEC, @SEL.Num, @SEL.RET)


	//----------------------------------------------------------------
	// ログに選択結果を出力する
	//----------------------------------------------------------------
/*
		IF[@T(22,05)]
		{
			STR[$str]

			IF[@SEL.RET]
				$str="＜選択肢："+$SEL.TX(@SEL.RET)+"＞"
			ELSE[]
				$str="＜選択肢：未選択＞"
			IFEND[]

			GOSUB[#=es.TX.SETTASK pstr=$str]
			\LOG.W.NMTXVO.ALL("", $str, $_RSTR(1))
			\LOG.ADD
		}
		IFEND[]
*/

	//----------------------------------------------------------------
	// ログ記録
	//----------------------------------------------------------------
/*
		STR[$sr]
		\_strleft($SEL.GO(@SEL.RET), 4)($sr)
		IF[$sr=="jump"]
			\_log("■■■■■"+$SEL.TX(@SEL.RET)+" "+$SEL.GO(@SEL.RET))
		ELSE[]
			\_log("＜選択肢："+$SEL.TX(@SEL.RET)+"＞ "+$SEL.GO(@SEL.RET))
		//	\_log("＜選択肢："+"＞")
		IFEND[]
*/

		//@es.SELR = @SEL.RET
		//$es.SELSTR = $SEL.TX(@SEL.RET)


	//----------------------------------------------------------------
	// 選択肢／後処理
	//----------------------------------------------------------------
		GOSUB[#=ES.CSEL.ENDEXEC PINT=@SEL.Num]


	//----------------------------------------------------------------
	// 一時ファイルをコピー
	//----------------------------------------------------------------
	//	\SAVECOPY(@es.sdprevselno+1, @es.sdprevselno)


	//----------------------------------------------------------------
	// スクリプト位置を記憶する
	//----------------------------------------------------------------
		\SCRIPTPOS_SAVE


	return[]
}


//============================================================================
//
//■選択肢 REFRESH
//
//============================================================================
#=ES.CSEL.REF
{
	return[]
}


#=ES.CSEL.INIT
{
	@es.SELMODE = 0

	@SEL.AUTOFLAG = 0
	@SEL.SKIPFLAG = 0

	return[]
}


//============================================================================
//
//■終了処理
//
//============================================================================
#=ES.CSEL.ENDEXEC
{
	INT[@num=@_PINT(1)]

	//----------------------------------------------------------------
	// ＣＧレイヤ削除
	//----------------------------------------------------------------
		\BT.END(ES.CSEL)

	//----------------------------------------------------------------
	// フラグを０に初期化
	//----------------------------------------------------------------
		@SEL.TIME=0

	//----------------------------------------------------------------
	// オートモードを解除するか否か
	//----------------------------------------------------------------
		IF[@es.GSD(110,06)==1] //オートモードを継続する設定である.
		{
			@es.TX.AUTO = @SEL.AUTOFLAG
		}
		ELSE[]
		{
			@es.TX.AUTO = 0 //強制的にオートモード解除
		}
		IFEND[]

	//----------------------------------------------------------------
	// スキップを解除するか否か
	//----------------------------------------------------------------
		IF[@es.GSD(110,07)==1] //スキップを継続する設定である.
		{
			@es.TX.SKIP = @SEL.SKIPFLAG

			///xスキップ継続のための暫定措置.
			@_KEYLAST=0
			@_MOUSELAST=0
		}
		ELSE[]
		{
			@es.TX.SKIP = 0 //強制的にスキップモード解除
		}
		IFEND[]


	return[]
}


//============================================================================
//
//■選択肢の一時的非表示
//
//============================================================================
#=ES.CSEL.HIDE
{
	@es.CSEL.HIDE = 1
	return[]
}


//============================================================================
//
//■選択肢の表示
//
//============================================================================
#=ES.CSEL.APPEAR
{
	@es.CSEL.HIDE = 0
	return[]
}


#=ES.CSEL.BTN.SEL.ON
{
	INT[@no=@_PINT(1)]

	//バーを連打できないように
//	\BT.W0.ALL(ES.CSEL)

\BT.ES20.ALL("ES.GAMEMAIN")
	//--------------------------------------------------------------------------------
	// 
	//--------------------------------------------------------------------------------
		GOSUB[#=es.BT.DRAW]

	//----------------------------------------------------------------
	// スクリーンショット
	//----------------------------------------------------------------
		CG[ID="_TMP" Z=@es.63BITMAX E=1 A=0 FILE=""]
		CGACT[COPY2=1 ID=":/W0/" ID2="_TMP"]

	//----------------------------------------------------------------
	// ＣＧレイヤ削除
	//----------------------------------------------------------------
		\BT.END(ES.CSEL)

	//----------------------------------------------------------------
	// 
	//----------------------------------------------------------------
		//フェードアウト
		INT[@NTIME=@_OS_TIME(1)]
		INT[@TTIME=@es.LSD(093,04)]
		INT[@TIME]
		INT[@mA]
		LOOP[]
		{
			@TIME = (@_OS_TIME(1)-@NTIME)
			IF[@TIME>@TTIME] @TIME=@TTIME IFEND[]

			@mA = 256 - (256.0 * @TIME / @TTIME)

			CG[ID="_TMP" A=@mA]

//			\BT.A.SET("ES.CSEL.TIP.BACK", , @mA)
//			LOOP[SET=(100)] \BT.A.SET("ES.CSEL.BTN.SEL", @_LC, @mA) LOOPEND[]

			WAIT[FRAME=1]

			IF[@TIME==@TTIME] LOOPBREAK[] IFEND[]
		}
		LOOPEND[]

		CGEND[ID="_TMP"]

\BT.ES21.ALL("ES.GAMEMAIN")

	//----------------------------------------------------------------
	// オートモード状態、スキップモード状態の取得
	//----------------------------------------------------------------
		@SEL.AUTOFLAG = @es.TX.AUTO
		@SEL.SKIPFLAG = @es.TX.SKIP

//	\_dmes($(@no)+"番を選択しました。")

@es.SELMODE = 0

	@SEL.RET  = @no
	@es.LSD(093,05) = @no
//	$es.SEL.GO= $SEL.GO(@no)

	GOSUB[#=ES.CSEL.QUIT]

	return[]
}



//============================================================================
//■選択肢のGOジャンプ先の設定
//============================================================================
#=ES.CSEL.GO
{
	return[]
}

//============================================================================
//■選択肢選択直後にGOSUBジャンプするラベルの設定
//============================================================================
#=ES.CSEL.AFTER
{
	return[]
}

//============================================================================
//■選択肢の制限時間の設定
//============================================================================
#=ES.CSEL.TIME
{
	@SEL.TIME = @_PINT(1)
	return[]
}

//============================================================================
//■選択肢番号の設定 (0〜29)
//============================================================================
#=ES.CSEL.NO
{
	return[]
}


//--------------------------------------------------------------------
//■(SAVE)選択肢情報保存
//--------------------------------------------------------------------
#=ES.CSEL.SAVE
{
	return[]
}

#=ES.CSEL.FILESAVE
{
	return[]
}


//--------------------------------------------------------------------
//■(LOAD)選択肢情報読込
//--------------------------------------------------------------------
#=ES.CSEL.LOAD
{
	return[]
}

#=ES.CSEL.FILELOAD
{
	return[]
}


//////


//▼選択肢モードON ＆ 選択肢文字列セット @@@@@@@@@@@@@@@@@@@@@@@@@@@@@
//
#=ES.CSEL.SET
{
	GOSUB[#=es.Voice.DataInit]

	\BT.N1(ES.GAMEMAIN.BTN.VOICE)

	@es.SELMODE=2

	@es.LSD(093,01) = @_PINT(1)
	@es.LSD(093,02) = @_PINT(2)
	@es.LSD(093,03) = @_PINT(3)
	@es.LSD(093,04) = @_PINT(4)

	GOSUB[#=ES.CSEL]

	LOOP[]
	{
		IF[@es.SELMODE==0] LOOPBREAK[] IFEND[]

		//時間制限処理
		IF[@es.LSD(093,02)!=-1 && @es.LSD(093,02) <= @_OS_TIME(1)-@STARTTIME] //制限時間になったら0番のボタンが押されたことにして処理
			@es.LSD(093,02)=-1
			GOSUB[#=ES.CSEL.BTN.SEL.ON pint=0]
		IFEND[]

		WAIT[FRAME=1]
	}
	LOOPEND[]

	return[]
}

