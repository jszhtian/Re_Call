Title: 吉里吉里/KAGEX ワールド拡張機能
Author: 合資会社ワムソフト 渡邊剛

●KAGEX ワールド拡張機能概要

KAGEX からさらに world.ks をプラグインとして読み込むことで、
特殊な「ワールド機能」が使えるようになります。

◇環境オブジェクト

背景の状態や、時間状態などを制御します
※KAGEX の stage レイヤを参照して動作します。

◇環境キャラクタオブジェクト

「キャラクタ」の立ち絵やボイスなどを制御します
※KAGEX の前景レイヤを参照して動作します。

◇環境レイヤオブジェクト

画面効果素材としての「レイヤ画像」を制御します
※KAGEX の前景レイヤを参照して動作します。

◇イベントレイヤオブジェクト

「イベントレイヤ」を制御するための専用オブジェクトです。
※KAGEX の event レイヤを参照して動作します。

いずれのオブジェクトも次のような特徴をもちます

(1) KAG における「属性」の名前をコマンドとみなす
(2) KAG における「属性値」をそのコマンドに対するパラメータとみなす

●導入方法

first.ks に以下の表示を追加します

----------------------------------
@loadplugin module=wuvorbis.dll   ; ogg を使えるようにする場合
@loadplugin module=extrans.dll    ; 拡張トランジションを使えるようにする場合
@call storage="world.ks"          ; ワールド機能の読み込み
----------------------------------

●拡張タグ

◇基本処理の拡張

KAGEX のタグの処理が次のように拡張されます

・ENV タグは「環境」に対するコマンドになります。
・EVENT または EV タグは「イベントレイヤ」に対するコマンドになります。
・タグ名に合致するキャラクタが存在する場合は該当キャラに対するコマンドになります
・タグ名に合致するレイヤが存在する場合はレイヤに対するコマンドになります。
・タグ名に合致する「環境」のコマンドはそのまま機能します
・KAGEX の名前処理機能はキャラクタボイスと同期して処理されます。

・EV タグを使って描画イベント絵を描画した場合、
　sflags に 「cg_名前」という値が自動的に登録されます。

・bgm タグは 「ＢＧＭオブジェクト」に対するコマンドになります

  ※"bgm" で始まる指定は、それをファイル名とみなした
　  [BGM play=名前] と等価の扱いになります。

  ※BGM タグを使ってBGMを再生した場合、
　  sflags に 「bgm_名前」という値が自動的に登録されます。

・SE タグは「ＳＥオブジェクト群」に対するコマンドになります。

  ※"se" で始まる名前の指定を行った場合、その名前で
　  再生中の se に対する指定とみなされます
　再生中の se がない場合は [SE play=名前] と等価の扱いになります。

◇命令の拡張

◆begintrans

画面全体へのトランジションを準備します。
・表画面の内容が裏画面にコピーされます
・これ以降、endTrans 命令を実行するまで、環境関係オブジェクトの描画
　はすべて裏画面に対して実行されます

◆endtrans

画面全体へのトランジションを完了させます。
・指定されたパラメータで画面全体へのトランジションを実行します

属性
	trans	トランジション名指定（※詳細は後述）
	fade	フェード指定ショートカット（※詳細は後述）

◆msgoff

メッセージ窓を消去します.

属性
	trans	トランジション名指定
	fade	フェード指定
	nofade	自動フェードを抑制する

trans も fade も指定しなかった場合は、
裏表画面ではなく不透明度を利用した規定のフェード処理が行われます。
この場合のフェード時間は kag.messageeFadeTime で指定可能です

◆msgon

メッセージ窓を表示します

属性
	trans	トランジション名指定
	fade	フェード指定

msgoff 同様、trans も fade も指定しない場合は規定のフェード処理になります。

◆clear

画面の全消去処理を行います。
 ・舞台
 ・イベント絵
 ・キャラクタ
 ・環境レイヤ
 ・メッセージ窓
すべてが消去されます。

属性
	trans	トランジション名指定
	fade	フェード指定

メッセージ窓も一括消去されます。
ただ、本システムの方向的には、

[env hideall msgoff trans=...]

の記述スタイルを推奨します。この場合は
・メッセージ窓消去
・全表示消去してトランジション実行の２段階表示になります。

◆newlay

新規に環境レイヤオブジェクトを生成します。

属性
	name	レイヤの識別名です

※生成したタグでそのまま環境レイヤ用のコマンドを使用可能です

◆dellay

環境レイヤオブジェクトを破棄します

属性
	name	レイヤの識別名です

◆layer

環境レイヤオブジェクトに対する命令として機能します

属性
	name	レイヤの識別名です

※マクロなどでレイヤ名をパラメータ指定したい場合に使用できます

◆newchar

新規に環境キャラクタオブジェクトを生成します。

属性
	name		キャラクタ名です
	initname	初期化名

※生成したタグでそのままキャラクタ用のコマンドをしよう可能です

環境キャラクタオブジェクトは、通常、特に新規に生成しなくても
参照時に初期化名を使って自動的に作成されます。この機能は、
「別名」で同じ初期化データをもったキャラクタを生成したい場合に
利用します。

◆delchar

環境キャラクタオブジェクトを破棄します

属性
	name	キャラクタ名を指定します

◆char

環境キャラクタオブジェクトに対する命令として機能します

属性
	name	キャラクタ名を指定します

※マクロなどでキャラクタ名をパラメータ指定したい場合に使用できます

◆allchar

全キャラに対して同じ命令を実行します

◆alllayer

全レイヤに対して同じ命令を実行します

◆allse

全SEに対して同じ命令を実行します


●ワールド拡張における記述の省略

ワールド拡張ではさまざまな省略記法が有効です。

◇環境属性指定の省略

-------------------------
[env stage=学校]
-------------------------

環境の舞台を「学校」に指定する表記です
登録済みの名前がほかの指定とかぶらない場合、これは次のように省略可能です

-------------------------
[env 学校]
-------------------------

◇環境名の省略

属性値がほかのタグとかぶってない場合は、さらに次のように省略可能です。

-------------------------
[学校]
-------------------------

「学校」というタグは存在しないため、環境に対する命令におきかえて
実行され、[env 学校] と等価になります。

◇キャラクタ指定

-------------------------
[みなせ dress=制服 pos=中]
-------------------------

「みなせ」というタグも、環境に対する命令も存在しないため、
「みなせ」というキャラクタに対する命令として処理します。
※キャラクタがあらかじめ envinit.tjs に登録されている必要があります。

 newlayer で作成したレイヤも同様の動作になります

◇キャラクタ属性の省略

-------------------------
[みなせ 制服 中]
-------------------------

環境と同様、名前がほかと重複してない場合、
パラメータ名の指定は省略できます。レイヤも同様です。

◇キャラクタのボイス再生

---------------------------------------------
【妙/声】「起きて……ねぇ、起きてってば……」
---------------------------------------------

・キャラクタ「妙」のその時点での既定のボイスを再生します
・メッセージ窓に「声」として名前を表示します
・メッセージ窓の表情欄を「妙」の現在の表情＋ポーズで自動表示します

●トランジションについて

ワールド拡張では基本的には以下の２つのいずれかの方法で
トランジションを行います。

◇個別トランジション

個別の命令の trans または fade オプションでトランジションを指定できます。

-- COLUMN  fade と trans の違い ----------
 fade は基本的には crossfade 指定の trans と等価です。
 ただし、キャラクタ・レイヤ・環境の操作において、
「まだ出現してない場合」および「消去される場合」には、
 fade 指定ではトランジションを使わずに、不透明度の制御
 でのフェード処理を行うことでパフォーマンスをあげています。
-----------------------------------------------------------

◇全体トランジション


●オブジェクトの機能

◇共通機能

背景、イベント、環境キャラクター、環境レイヤそれぞれで
共通的に使うことができるコマンド群です。

属性
	type		合成モード
	opacity		不透明度(0-255)。初期化・相対指定有効
	rotate		回転角度（度）。初期化・相対指定有効
	zoom		拡大率（％）。初期化・相対指定有効
	afx			回転・拡大の原点指定X座標
	afy			回転・拡大の原点指定Y座標
	reset		表示状態の初期化
	xpos		X位置指定。初期化・相対指定有効
	ypos		Y位置指定。初期化・相対指定有効
	accel		xpos, ypos の追加パラメータ。負:減速 0:線形 1:加速

	time		変更にかかる時間指定(ms) opacity, rotate, zoom, xpos, ypos
				などに作用します

	action		アクション名指定（※詳細後述)
	sync		指定されるとアクション完了まで次の命令にうつらなくなります
	trans		トランジション名指定（※詳細後述）
	visible		表示状態 true なら表示、false なら非表示
	show		visible=true と等価
	hide		visible=false と等価


	fade		表示される場合 [対象 opacity=255:0 time=時間] と等価
				消去される場合 [対象 opacity=0 time=時間] と等価
				 ※時間を省略した場合はenvinit.tjs で定義した時間になります。

	grayscale   true にするとロードされた画像の表示がグレースケールになります
    rgamma      ロードされた画像のガンマ補正を行います
    ggamma      ロードされた画像のガンマ補正を行います
    bgamma      ロードされた画像のガンマ補正を行います
    resetcolor  grayscale/rgamma/ggamma/bgamma を初期化します

    ※環境オブジェクトで colorall が指定されている場合は、環境オブジェクトの
      grayscale/rgamma/ggamma/bgamma がすべてに対して有効になります

	※初期化指定
		通常の記述	data = to
		初期化指定	data = to:from
		コロンで区切ってパラメータを多重にすると、
		(1) from の値で即時に初期化
		(2) to の値にむかって変動
		という動きになる。time 指定がある場合のみ意味がある

	※相対指定

	 @100 , @-100 などのように、頭に@をつけると
     現在の値からの相対指定になります。

     100%, @100% などのように、末尾に% をつけると最大値
　　　・座標だと画面の端
　　　・もともとが％指定ならそのまま
　　　・回転だと 360度
     に対する%指定になります

●環境オブジェクトの機能

属性
	init		状態を初期化します。
				キャラクタとレイヤすべて消去され、
				舞台やイベントも表示なしの状態になります。

	stage		舞台名を指定します
				舞台はあらかじめ envinit.tjs で登録しておきます。

	stime		舞台の時間名を指定します。
				時間はあらかじめ envinit.tjs で登録しておきます。
				※時間ごとに色補正パラメータが指定できます

	hide            舞台を非表示にします（※共通機能）
    hideevent       イベント絵を非表示にします
	hidebase        舞台とイベント絵を非表示にします
	hidecharacters	環境キャラクタをすべて非表示にします
	hidelayers		環境レイヤをすべて非表示にします
	hidefore		環境キャラクタ/レイヤをすべて非表示にします。
    hideall         舞台・イベント絵・環境キャラクタ/レイヤを非表示にします

    colorall    true の場合、環境の grayscale/rgamma/ggamma/bgamma の指定を
　　　　　　　　全オブジェクト対して適用します

●イベントオブジェクトの機能

属性
	file	イベント絵として表示する画像を指定します

●キャラクタオブジェクトの機能

◇立ち絵の指定

属性
	pose		キャラクタのポーズを指定します
				※「表情」を使いまわしできるものが 同一ポーズ扱いになります。

	dress		ポーズの服装のバリエーションを指定します
				例：制服/私服/パジャマ などなど

	face		ポーズの表情のバリエーションを指定します
				例：笑/泣/怒

	image		キャラクタの立ち絵画像を直接指定します。
				image が有効な場合は pose 系の指定は無視されます。
				pose 系の指定を再度行うことで解除できます。

	pos			立ち絵を表示する位置を指定します。初期化指定有効
				前後指定（レベル指定）と左右指定は独立して指定できます。

	※いずれも指定するパラメータ名（文字列）は envinit.tjs で登録しておきます

	front	キャラクタ立ち絵の重なり順を同じレベル内での一番上にします
	back	キャラクタ立ち絵の重なり順を同じレベル内での一番下にします。

◇ボイスの指定

行頭に【名前】の記述があった場合、自動的にボイス再生されます。

基本動作
　・数値指定してあると書式にしたがったボイスが再生され、
　　数値カウンタがインクリメントされます
　・文字列指定がある場合、数値指定に優先して再生され、
　　数値カウンタは変更されません
　・文字列指定は１回かぎり有効です

属性
	voice		次に鳴らすボイスを指定します
　　　voice=数値        再生数値カウンタを指定する
　　　voice=文字列      １回再生にわりこむ
　　　voice=ignore      １回だけ再生を無視する（文字列扱い）

　  once        数値指定で１回再生にわりこみます（文字列扱いになる）
　  incvoice    文字列指定の時にも数値カウンタをあげる
    noincvoice  数値カウントをあげない（incvoice より強い指定）

	clearvoice	次からボイス再生を停止します（初期状態に戻す）
    nextvoice   指定すると次のほかのキャラのボイス再生と同時にボイス再生します


例:ボイス番号を指定して再生
------------------------------------
[妙 voice=1000]
【妙】おはよう
------------------------------------

例:ボイスファイルを指定して再生
------------------------------------
[妙 voice="tae1000"]
【妙】おはよう
------------------------------------

例: 次からボイス再生をなくす
------------------------------------
[妙 clearvoice]
------------------------------------

例:１つボイスがぬけていた場合の対応
------------------------------------
[妙 voice=1000 once]
【妙】おはよう
------------------------------------

例:１つボイスを差し替えた場合の対応
------------------------------------
[妙 voice=1000 once incvoice]
【妙】おはよう
------------------------------------

例:１つ無音を挟む場合の対応（カウントは継続）
------------------------------------
[妙 voice=ignore]
【妙】……
------------------------------------

例:１つボイスを無しにする場合の対応（該当カウントを破棄）
------------------------------------
[妙 voice=ignore incvoice]
【妙】……
------------------------------------

・環境の初期化処理ですべてのキャラクタのボイスは「なし」に初期化されます
・数値指定の場合の実際のファイル名は envinit.tjs で書式指定します。

※ボイス指定時の待ち時間について

ボイス再生が行われた場合、
自動再生時のページまちでの待ち時間が次のように変更されます。

通常
　指定した時間だけまつ
ボイス再生時
　待ちが開始した時点での残りボイス時間（ボイス長さから算出）＋指定した時間まつ
クリックすることで待ちは解除されて次の会話に処理が進行します。

playVoice=voice名
	指定したボイスを直接再生します。
	ボイス名を指定した場合は内部情報のボイスカウントには影響はありません
	ボイス名を指定しなかった場合は内部カウントを参照して動作し、
	カウントはインクリメントされます。

waitVoice=スキップ指定
	再生中のボイスの終了を待ちます。
	スキップ指定が true (デフォルト) の場合はクリックによるキャンセルが有効です

●環境レイヤの機能

属性
	origin	表示レイヤ原点　左上すみから時計まわりに 123456789(9は中央)
			デフォルトは中央
	vorign  表示画面原点　　左上すみから時計まわりに 123456789(9は中央)
			デフォルトは中央
	front	キャラクタ立ち絵の重なり順を同じレベル内での一番上にします
	back	キャラクタ立ち絵の重なり順を同じレベル内での一番下にします。
	level	レベルを指定します

●BGM オブジェクトの機能

属性
	play			BGM の再生。ファイルを指定する。
		補助パラメータ
		noxchg	前のBGMをすぐ終了する
		loop	ループ指定。省略すると true
		time	フェードイン時間
		start	開始タグ指定
		paused	停止した状態ではじまる。time を指定すると無効
		intime	フェードイン時間。time 指定している場合は無効
		outtime 前のBGMのフェードアウト時間。time 指定している場合は無効
		overlap 前のBGMフェードアウトから新BGMのフェードインまでの待ち時間。
			　　指定するとクロスフェードになる
	stop			BGMの停止。数値指定した場合はフェードアウト
	pause			BGMの一時停止。数値指定するとフェードアウト
	resume			BGMの再開
	fade			BGMの音量制御。指定した音量になる
		補助パラメータ
		time フェードにかかる時間

●SEオブジェクトの機能

属性
	play	SE の再生
		補助パラメータ
		buf		処理対象バッファ指定
		loop	ループ指定。省略すると false
		time	フェードイン時間
	stop	SE の停止。数値指定した場合はフェードアウト
		補助パラメータ
		buf		処理対象バッファ指定
	fade	SE の音量制御。指定した音量になる
		補助パラメータ
		buf		処理対象バッファ指定
		time フェードにかかる時間

処理対象バッファを省略した場合は、適宜「あいているSE」を使います。
あいているSEが存在しない場合は一番古いものが参照されます。
つまり、KAG で numSEBuffers が1より大きい場合は、

[SE se0001][SE se0002] とすると、se0001 も se0002 も両方なることになります。

●ボイス関連の特殊な処理

以下のゲーム変数を参照して特殊な処理が実行可能です

f.voiceBase
f.name
f.family
